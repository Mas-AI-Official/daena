# Smoke tests + manual verification steps (API equivalents of browser checks).
# Runs after backend is started and /health returns 200.
name: Smoke and Manual Verification

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  smoke-and-manual:
    name: Start backend, run smoke + manual verification
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      EXECUTION_TOKEN: ${{ secrets.EXECUTION_TOKEN || 'ci-smoke-token' }}
      DAENA_BASE_URL: http://127.0.0.1:8000
      # Optional: use a CI-only brain dir so CI doesn't touch host paths
      BRAIN_ROOT: ${{ github.workspace }}/.brain-ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fastapi "uvicorn[standard]" pydantic pydantic-settings python-dotenv
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt || true
          fi

      - name: Start backend
        run: |
          python -m uvicorn backend.main:app --host 127.0.0.1 --port 8000 &
          echo "Waiting for backend (poll /health, max 90s)..."
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8000/health >/dev/null 2>&1; then
              echo "Backend up after ${i}*3s"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Backend did not become ready"
              exit 1
            fi
            sleep 3
          done

      - name: Run smoke tests
        run: |
          python scripts/smoke_control_plane.py --base http://127.0.0.1:8000 --token "$EXECUTION_TOKEN"

      - name: Run manual verification steps
        run: |
          python scripts/manual_verification_steps.py

      - name: Run E2E UI flows (optional)
        continue-on-error: true
        run: |
          pip install playwright
          playwright install chromium
          python scripts/daena_ui_e2e_flows.py --base-url http://127.0.0.1:8000 --token "$EXECUTION_TOKEN"
