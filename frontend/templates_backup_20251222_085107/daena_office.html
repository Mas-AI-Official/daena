{% extends "base.html" %}
{% block content %}
<div class="h-[calc(100vh-8rem)] flex gap-6">
    <div class="w-64 glass-panel rounded-xl flex flex-col p-4">
        <h3 class="font-medium text-white mb-4">Sessions</h3>
        <div class="flex-1 text-sm text-gray-500">No active sessions</div>
    </div>
    <div class="flex-1 glass-panel rounded-xl flex flex-col relative overflow-hidden">
        <div class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-black/20">
            <span class="font-medium text-white">Daena VP</span>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-daena-gold flex items-center justify-center text-black font-bold">D
                </div>
                <div class="p-3 bg-white/5 rounded-lg text-gray-200 text-sm">Hello. I am ready to assist.</div>
            </div>
        </div>
        <div class="p-4 border-t border-white/10 bg-black/20">
            <div class="relative">
                <textarea id="chat-input" rows="1"
                    class="w-full bg-black/50 border border-white/10 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:outline-none focus:border-daena-gold/50"></textarea>
                <button id="send-btn" class="absolute right-3 bottom-3 text-daena-gold"><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    let currentSessionId = null;

    async function initChat() {
        try {
            const response = await window.DaenaAPI.startChat();
            currentSessionId = response.session.session_id;
            appendMessage('assistant', response.welcome_message);
        } catch (e) {
            console.error("Failed to start chat", e);
            appendMessage('system', 'Failed to connect to Daena Core.');
        }
    }

    function appendMessage(role, text) {
        const msgs = document.getElementById('chat-messages');
        const isUser = role === 'user';
        const align = isUser ? 'flex-row-reverse' : '';
        const bg = isUser ? 'bg-daena-gold/10' : 'bg-white/5';
        const avatar = isUser ? '' : '<div class="w-8 h-8 rounded-full bg-daena-gold flex items-center justify-center text-black font-bold flex-shrink-0">D</div>';

        const html = `
            <div class="flex gap-4 ${align}">
                ${avatar}
                <div class="p-3 ${bg} rounded-lg text-gray-200 text-sm max-w-[80%]">${text}</div>
            </div>
        `;
        msgs.insertAdjacentHTML('beforeend', html);
        msgs.scrollTop = msgs.scrollHeight;
    }

    document.getElementById('send-btn')?.addEventListener('click', async () => {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        if (!currentSessionId) await initChat();

        appendMessage('user', text);
        input.value = '';

        try {
            const response = await window.DaenaAPI.sendMessage(currentSessionId, text);
            appendMessage('assistant', response.daena_response.content);
        } catch (e) {
            appendMessage('system', 'Error sending message.');
        }
    });

    document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('send-btn').click();
        }
    });

    // Start chat on load
    document.addEventListener('DOMContentLoaded', initChat);
</script>
{% endblock %}