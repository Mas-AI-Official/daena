{% extends "base.html" %}

{% block title %}Approvals Inbox - Daena VP{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">Approvals Inbox</h1>
            <p class="text-gray-400 text-sm mt-1">Approve or deny pending high-risk actions (TTL, reason)</p>
        </div>
        <button onclick="loadApprovals()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-white transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Pending approvals</h2>
        <p class="text-gray-400 text-sm mb-4">Requires Execution Token. Lockdown blocks approve/deny.</p>
        <div id="approvals-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = (window.DAENA_API_BASE || (window.location.origin + '/api/v1')).replace(/\/+$/, '') || (window.location.origin + '/api/v1');

    function getExecutionToken() {
        try { return sessionStorage.getItem('daena_execution_token') || sessionStorage.getItem('execution_token') || ''; } catch (e) { return ''; }
    }

    function escapeHtml(s) {
        if (s == null) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    async function loadApprovals() {
        const el = document.getElementById('approvals-list');
        const token = getExecutionToken();
        if (!token) {
            el.innerHTML = '<p class="text-yellow-400">Set Execution Token in App Setup / Dashboard to list approvals.</p>';
            return;
        }
        try {
            const r = await fetch(API_BASE + '/execution/approvals', { headers: { 'X-Execution-Token': token } });
            const data = await r.json();
            if (r.status === 401) {
                el.innerHTML = '<p class="text-red-400">' + escapeHtml(data.detail || 'Unauthorized') + '</p>';
                return;
            }
            if (!data.success || !data.approvals) {
                el.innerHTML = '<div class="text-gray-500">No pending approvals</div>';
                return;
            }
            el.innerHTML = data.approvals.length === 0
                ? '<p class="text-gray-500">No pending approvals.</p>'
                : data.approvals.map(a => {
                    const typeLabel = (a.request_type === 'execution_request') ? 'Execution request' : (a.task_id ? 'Task approval' : 'Approval');
                    return `
                    <div class="flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10">
                        <div>
                            <span class="text-amber-400/90 text-xs font-medium">${escapeHtml(typeLabel)}</span>
                            <span class="font-medium text-white ml-2">${escapeHtml(a.tool_name || 'Tool')}</span>
                            <span class="text-gray-500 text-xs ml-2">${escapeHtml(a.approval_request_id)}</span>
                            <p class="text-gray-400 text-sm mt-1">${a.task_id ? 'Task: ' + escapeHtml(a.task_id) + ' · ' : ''}${escapeHtml(a.reason || '')}</p>
                            ${(a.agent_id || a.department) ? '<p class="text-gray-500 text-xs mt-1">' + escapeHtml([a.department, a.agent_id].filter(Boolean).join(' · ')) + '</p>' : ''}
                            ${a.created_at ? '<p class="text-gray-500 text-xs mt-1">Created: ' + (typeof a.created_at === 'number' ? new Date(a.created_at * 1000).toISOString() : a.created_at) + '</p>' : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="decide('${escapeHtml(a.approval_request_id)}', true)" class="px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 text-sm">Approve</button>
                            <button onclick="decide('${escapeHtml(a.approval_request_id)}', false)" class="px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm">Deny</button>
                        </div>
                    </div>
                `;
                }).join('');
        } catch (e) {
            el.innerHTML = '<div class="text-red-400">Error: ' + escapeHtml(String(e)) + '</div>';
        }
    }

    async function decide(approvalRequestId, approved) {
        const token = getExecutionToken();
        if (!token) { if (window.showToast) window.showToast('Set Execution Token first', 'error'); return; }
        try {
            const r = await fetch(API_BASE + '/execution/approvals/' + encodeURIComponent(approvalRequestId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Execution-Token': token },
                body: JSON.stringify({ approved })
            });
            const data = await r.json();
            if (data.success) {
                loadApprovals();
                if (window.showToast) window.showToast(approved ? 'Approved' : 'Denied', 'success');
                if (approved && data.execution_result) {
                    const er = data.execution_result;
                    const msg = er.status === 'ok' ? 'Execution OK' : (er.error || 'Execution failed');
                    if (window.showToast) window.showToast(msg, er.status === 'ok' ? 'success' : 'error');
                }
            } else {
                if (window.showToast) window.showToast(data.detail || 'Failed', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Request failed', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadApprovals);
</script>
{% endblock %}
