{% extends "base.html" %}

{% block title %}{{ dept_name }} Office - Daena VP{% endblock %}

{% block head %}
<style>
    .office-container {
        min-height: calc(100vh - 64px);
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 16px;
        padding: 16px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .chat-area {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
    }

    .office-header {
        padding: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .back-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-decoration: none;
        transition: all 0.3s;
    }

    .back-btn:hover {
        background: var(--daena-gold);
        color: black;
    }

    .dept-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .dept-info h1 {
        font-size: 20px;
        font-weight: 700;
        color: white;
        margin-bottom: 2px;
    }

    .dept-info p {
        color: #9CA3AF;
        font-size: 12px;
    }

    .reps-container {
        display: flex;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
    }

    .rep-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
    }

    .rep-card:hover,
    .rep-card.active {
        background: rgba(212, 175, 55, 0.1);
        border-color: var(--daena-gold);
    }

    .rep-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        color: white;
    }

    .rep-info h3 {
        font-weight: 600;
        color: white;
        font-size: 13px;
    }

    .rep-info p {
        color: #9CA3AF;
        font-size: 11px;
    }

    .status-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 8px;
        margin-top: 3px;
        display: inline-block;
    }

    .status-badge.online {
        background: rgba(50, 205, 50, 0.2);
        color: #32CD32;
    }

    .status-badge.daena {
        background: rgba(255, 215, 0, 0.2);
        color: #FFD700;
    }

    .messages-container {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: calc(100vh - 340px);
    }

    .message {
        display: flex;
        gap: 10px;
        max-width: 80%;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
    }

    .message-content {
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 13px;
        line-height: 1.5;
    }

    .message.user .message-content {
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(212, 175, 55, 0.1));
        border: 1px solid rgba(212, 175, 55, 0.3);
        color: white;
    }

    .message.assistant .message-content {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #E5E7EB;
    }

    .input-area {
        padding: 14px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 10px;
    }

    .input-area input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 13px;
    }

    .input-area input:focus {
        outline: none;
        border-color: var(--daena-gold);
    }

    .input-area button {
        padding: 12px 20px;
        border-radius: 10px;
        background: var(--daena-gold);
        color: black;
        font-weight: 600;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }

    .stats-sidebar {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 14px;
    }

    .stat-card h3 {
        font-size: 11px;
        color: #9CA3AF;
        text-transform: uppercase;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: white;
    }

    .stat-label {
        font-size: 11px;
        color: #9CA3AF;
    }

    .team-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .team-member {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.03);
    }

    .team-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        color: white;
    }

    @media (max-width: 900px) {
        .office-container {
            grid-template-columns: 1fr;
        }

        .stats-sidebar {
            order: -1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="office-container" style="--dept-color: {{ dept_color }}">
    <div class="chat-area">
        <div class="office-header">
            <a href="/ui/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <div class="dept-icon" style="background: var(--dept-color)"><i class="fas {{ dept_icon }}"></i></div>
            <div class="dept-info">
                <h1>{{ dept_name }} Office</h1>
                <p>Talk to our team - Daena is always present</p>
            </div>
        </div>

        <div class="reps-container">
            <div class="rep-card active" data-target="rep" onclick="selectRep('rep')">
                <div class="rep-avatar" style="background: var(--dept-color)">{{ rep_initials }}</div>
                <div class="rep-info">
                    <h3>{{ rep_name }}</h3>
                    <p>{{ rep_role }}</p>
                    <span class="status-badge online">Online</span>
                </div>
            </div>
            <div class="rep-card" data-target="daena" onclick="selectRep('daena')">
                <div class="rep-avatar" style="background: linear-gradient(135deg, #FFD700, #FFA500)"><i
                        class="fas fa-brain"></i></div>
                <div class="rep-info">
                    <h3>Daena</h3>
                    <p>AI Vice President</p>
                    <span class="status-badge daena">VP Present</span>
                </div>
            </div>
        </div>

        <div class="messages-container" id="messages">
            <div class="message assistant rep">
                <div class="message-avatar" style="background: var(--dept-color)">{{ rep_initials }}</div>
                <div class="message-content">
                    Welcome to the {{ dept_name }} office! I'm {{ rep_name }}, your {{ rep_role }}.
                    How can I help you today?
                </div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Ask about this department..."
                onkeypress="if(event.key==='Enter')sendMessage()">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
    </div>

    <div class="stats-sidebar">
        <div class="stat-card">
            <h3>Department Stats</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <div class="stat-value" style="color: var(--dept-color)">{{ agent_count | default(6) }}</div>
                    <div class="stat-label">Agents</div>
                </div>
                <div>
                    <div class="stat-value" style="color: #32CD32">94%</div>
                    <div class="stat-label">Efficiency</div>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <h3>Active Tasks</h3>
            <div class="stat-value">12</div>
            <div class="stat-label">In Progress</div>
        </div>

        <div class="stat-card">
            <h3>Team</h3>
            <div class="team-list" id="team-list">
                {% if agents %}
                {% for agent in agents %}
                <div class="team-member">
                    <div class="team-avatar" style="background: var(--dept-color)">{{ (agent.name if agent.name is defined else agent.get('name', 'Ag'))[:2] if agent else 'Ag' }}</div>
                    <div>
                        <div style="color: white; font-size: 12px;">{{ agent.name | default('Agent') }}</div>
                        <div style="color: #9CA3AF; font-size: 10px;">{{ agent.role | default('') }}</div>
                    </div>
                    <span class="status-badge online" style="margin-left: auto;">Online</span>
                </div>
                {% endfor %}
                {% else %}
                <div style="color: #9CA3AF; font-size: 12px;">Loading agents...</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
        <script>
            const deptId = "{{ dept_id }}";
            const deptColor = "{{ dept_color }}";
            const repInitials = "{{ rep_initials }}";

            let currentSessionId = null;
            let chatSessions = [];

            // Load chat sessions and history from backend (single source of truth)
            async function loadChatSessions() {
                try {
                    const response = await fetch(`/api/v1/departments/${deptId}/chat/sessions`);
                    const data = await response.json();
                    if (data.success && data.sessions) {
                        chatSessions = data.sessions;
                        renderChatHistoryList();

                        // Load the most recent session if available and no current session
                        if (!currentSessionId && chatSessions.length > 0) {
                            currentSessionId = chatSessions[0].session_id;
                            await loadChatHistory(currentSessionId);
                        } else if (chatSessions.length === 0) {
                            // No sessions yet, show welcome message
                            const container = document.getElementById('messages');
                            container.innerHTML = `
                        <div class="message assistant rep">
                            <div class="message-avatar" style="background: ${deptColor}">${repInitials}</div>
                            <div class="message-content">Welcome! How can I help you today?</div>
                        </div>
                    `;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load chat sessions:', e);
                    document.getElementById('chat-history-list').innerHTML = '<div style="color: #FF6464; font-size: 11px; text-align: center;">Failed to load</div>';
                }
            }

            function renderChatHistoryList() {
                const container = document.getElementById('chat-history-list');
                if (!container) return;
                if (!chatSessions.length) {
                    container.innerHTML = '<div style="color: #9CA3AF; font-size: 11px; text-align: center; padding: 10px;">No history yet</div>';
                    return;
                }

                container.innerHTML = chatSessions.map(session => `
            <div class="chat-history-row" style="display: flex; align-items: center; gap: 6px; padding: 8px; border-radius: 6px; background: ${session.session_id === currentSessionId ? 'rgba(255,255,255,0.1)' : 'transparent'}; cursor: pointer; transition: background 0.2s;" onclick="switchSession('${(session.session_id || '').replace(/'/g, "\\'")}')">
                <div style="flex: 1; min-width: 0;">
                    <div style="color: white; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${(session.title || 'New Chat').replace(/</g, '&lt;')}</div>
                    <div style="color: #9CA3AF; font-size: 10px;">${session.created_at ? new Date(session.created_at).toLocaleDateString() : ''}</div>
                </div>
                <button type="button" onclick="event.stopPropagation(); deleteDepartmentSession('${(session.session_id || '').replace(/'/g, "\\'")}');" title="Delete chat" style="padding: 4px; background: transparent; border: none; color: #9CA3AF; cursor: pointer; border-radius: 4px;" onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#9CA3AF'"><i class="fas fa-trash-alt" style="font-size: 11px;"></i></button>
            </div>
        `).join('');
            }

            async function deleteDepartmentSession(sessionId) {
                if (!sessionId || !confirm('Delete this chat? This cannot be undone.')) return;
                try {
                    const response = await fetch(`/api/v1/departments/${deptId}/chat/sessions/${sessionId}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (response.ok && (data.success !== false)) {
                        if (currentSessionId === sessionId) {
                            currentSessionId = null;
                            document.getElementById('messages').innerHTML = `
                                <div class="message assistant rep">
                                    <div class="message-avatar" style="background: ${deptColor}">${repInitials}</div>
                                    <div class="message-content">Chat deleted. Start a new conversation below.</div>
                                </div>`;
                        }
                        await loadChatSessions();
                        if (window.showToast) window.showToast('Chat deleted', 'success');
                    } else {
                        if (window.showToast) window.showToast(data.detail || 'Failed to delete', 'error');
                    }
                } catch (e) {
                    console.error('Delete failed:', e);
                    if (window.showToast) window.showToast('Failed to delete chat', 'error');
                }
            }

            async function switchSession(sessionId) {
                if (currentSessionId === sessionId) return;
                currentSessionId = sessionId;
                renderChatHistoryList(); // Update active state
                await loadChatHistory(sessionId);
            }

            async function startNewSession() {
                currentSessionId = null;
                document.getElementById('messages').innerHTML = `
            <div class="message assistant rep">
                <div class="message-avatar" style="background: ${deptColor}">${repInitials}</div>
                <div class="message-content">Starting new conversation...</div>
            </div>
        `;
                renderChatHistoryList(); // Clear active selection
                // The next message sent will create a new session automatically
            }

            async function loadChatHistory(sessionId) {
                const container = document.getElementById('messages');
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9CA3AF;">Loading...</div>';

                try {
                    const response = await fetch(`/api/v1/departments/${deptId}/chat/sessions/${sessionId}`);
                    const data = await response.json();

                    if (data.success && data.messages) {
                        container.innerHTML = ''; // Clear loading
                        data.messages.forEach(msg => {
                            appendMessage(msg.role, msg.content, false);
                        });
                        scrollToBottom();
                    }
                } catch (e) {
                    console.error('Failed to load history:', e);
                    container.innerHTML = '<div style="text-align: center; color: #FF6464;">Failed to load chat history</div>';
                }
            }

            function appendMessage(role, content, animate = true) {
                const container = document.getElementById('messages');
                const isUser = role === 'user';

                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${isUser ? 'user' : 'assistant rep'}`;

                // Avatar
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                if (isUser) {
                    avatar.style.background = '#4B5563';
                    avatar.innerHTML = '<i class="fas fa-user"></i>';
                } else {
                    avatar.style.background = deptColor;
                    avatar.textContent = repInitials;
                }

                // Content
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;

                msgDiv.appendChild(avatar);
                msgDiv.appendChild(contentDiv);
                container.appendChild(msgDiv);

                if (animate) scrollToBottom();
            }

            function scrollToBottom() {
                const container = document.getElementById('messages');
                container.scrollTop = container.scrollHeight;
            }

            async function sendMessage() {
                const input = document.getElementById('messageInput');
                if (!input) return;
                const message = input.value.trim();
                if (!message) return;

                // Clear input
                input.value = '';

                // Show user message
                appendMessage('user', message);

                // Show typing indicator
                const container = document.getElementById('messages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message assistant rep typing';
                typingDiv.innerHTML = `
            <div class="message-avatar" style="background: ${deptColor}">${repInitials}</div>
            <div class="message-content" style="color: #9CA3AF; font-style: italic;">Typing...</div>
        `;
                container.appendChild(typingDiv);
                scrollToBottom();

                try {
                    const response = await fetch(`/api/v1/departments/${deptId}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message,
                            context: { session_id: currentSessionId }
                        })
                    });

                    const data = await response.json();

                    // Remove typing indicator
                    typingDiv.remove();

                    if (data.success) {
                        // Update current session ID if it was new
                        if (data.session_id && data.session_id !== currentSessionId) {
                            currentSessionId = data.session_id;
                            loadChatSessions(); // Refresh list to show new session
                        }

                        appendMessage('assistant', data.response);
                    } else {
                        appendMessage('assistant', 'Sorry, I encountered an error.');
                    }
                } catch (e) {
                    typingDiv.remove();
                    console.error('Chat error:', e);
                    appendMessage('assistant', 'Error connecting to server.');
                    if (window.showToast) window.showToast('Could not send message. Try again.', 'error');
                }
            }

            // Handle Enter key (id matches input: messageInput)
            const msgInput = document.getElementById('messageInput');
            if (msgInput) msgInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                loadChatSessions();
            });
        </script>
        {% endblock %}