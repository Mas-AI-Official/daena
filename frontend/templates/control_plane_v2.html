{% extends "base.html" %}
{% block title %}Daena â€” Control Panel{% endblock %}
{% block head %}
<style>
/* Control Panel: match Daena VP (base) â€” gold, glass, same font sizes (13â€“16px) */
.control-plane-content{
  --gold:var(--daena-gold);--gold-dim:#a07a2e;
  --card:var(--glass-bg);--card-hover:rgba(255,255,255,.08);--surface:rgba(0,0,0,.25);
  --border:var(--glass-border);--border-light:rgba(255,255,255,.15);
  --text:#e5e7eb;--text-dim:#9CA3AF;--text-bright:#fff;
  --green:#3ecf8e;--blue:#5b9bd5;--amber:#f0a84b;--red:#e05565;--purple:#9b7bea;--cyan:#4dd9e6;
  --radius:10px;--radius-lg:14px;--transition:.18s ease;
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  font-size:14px;line-height:1.5;color:var(--text);
}

/* â”€â”€â”€ LAYOUT: SIDEBAR + MAIN â”€â”€â”€ */
.shell{display:flex;height:100vh}

/* SIDEBAR */
.sidebar{
  width:220px;flex-shrink:0;background:var(--surface);
  border-right:1px solid var(--border);display:flex;flex-direction:column;
  overflow-y:auto;
}
.sidebar-logo{
  padding:20px 18px 16px;display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo svg{width:28px;height:28px;flex-shrink:0}
.sidebar-logo-text{font-family:var(--font-mono);font-size:16px;font-weight:600;color:var(--gold);letter-spacing:2px;text-transform:uppercase}
.sidebar-logo-sub{font-size:10px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-top:1px}

.sidebar-section-label{
  font-size:9px;font-weight:600;color:var(--text-dim);
  text-transform:uppercase;letter-spacing:1.5px;
  padding:18px 18px 6px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 18px;
  color:var(--text-dim);cursor:pointer;transition:var(--transition);
  text-decoration:none;font-size:13px;white-space:nowrap;
  border-left:3px solid transparent;position:relative;
}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{
  background:var(--card);color:var(--gold);
  border-left-color:var(--gold);
}
.nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.6}
.nav-item.active svg,.nav-item:hover svg{opacity:1}
.nav-item .badge{
  margin-left:auto;background:var(--red);color:#fff;
  font-size:9px;font-weight:700;padding:1px 6px;border-radius:8px;
}

.sidebar-bottom{
  margin-top:auto;padding:14px 18px;border-top:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
}
.avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--amber));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#0a0e14}
.sidebar-bottom-info{flex:1;min-width:0}
.sidebar-bottom-name{font-size:12px;font-weight:600;color:var(--text-bright);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sidebar-bottom-role{font-size:10px;color:var(--text-dim)}
.backend-sync{font-size:10px;margin-top:6px;padding:4px 8px;border-radius:6px;display:inline-block}
.backend-sync.ok{background:rgba(34,197,94,.2);color:var(--green)}
.backend-sync.off{background:rgba(239,68,68,.2);color:var(--red)}

/* MAIN CONTENT */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* Navbar/topbar: use base + partials/topbar (no overrides so Dashboard, Control Panel, Web3/DeFi match) */

/* AGI AUTOPILOT TOGGLE (in-page only) */
.autopilot-wrap{display:flex;align-items:center;gap:8px}
.autopilot-label{font-size:11px;color:var(--text-dim);font-weight:500}
.toggle-switch{
  width:40px;height:22px;border-radius:11px;
  background:var(--border);position:relative;cursor:pointer;
  transition:background .2s;border:1px solid var(--border-light);
}
.toggle-switch.on{background:var(--green);border-color:var(--green)}
.toggle-switch::after{
  content:'';position:absolute;top:2px;left:2px;
  width:16px;height:16px;border-radius:50%;background:#fff;
  transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);
}
.toggle-switch.on::after{left:20px}
/* Segmented pill (Creator: Founder | Daena | Agent) â€” dark theme, no white dropdown */
.segmented-pill{display:inline-flex;gap:0;border-radius:var(--radius);background:var(--surface);border:1px solid var(--border);padding:2px}
.segmented-pill-btn{
  padding:6px 14px;font-size:12px;font-weight:500;color:var(--text-dim);
  background:transparent;border:none;border-radius:calc(var(--radius) - 2px);
  cursor:pointer;transition:var(--transition)
}
.segmented-pill-btn:hover{color:var(--text);background:var(--card)}
.segmented-pill-btn.active{background:var(--gold);color:#0a0a0a;border-color:var(--gold)}
/* Category chips (single-select, no native select) */
.category-chips{display:flex;flex-wrap:wrap;gap:6px}
.category-chip{
  padding:6px 12px;font-size:11px;font-weight:500;color:var(--text-dim);
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  cursor:pointer;transition:var(--transition)
}
.category-chip:hover{color:var(--text);border-color:var(--gold);background:var(--card)}
.category-chip.active{background:var(--gold);color:#0a0a0a;border-color:var(--gold)}
/* Access scope checkboxes */
.access-scope-row{display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center}
.access-scope-row label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--text)}
.access-scope-row input[type=checkbox]{accent-color:var(--gold)}
.operator-chip{ padding:3px 8px;font-size:10px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text-dim);cursor:pointer;transition:var(--transition) }
.operator-chip:hover{ color:var(--text);border-color:var(--gold) }
.operator-chip.on{ background:var(--gold);color:#0a0a0a;border-color:var(--gold) }
.operator-tabs{ display:inline-flex;gap:2px }
.operator-tab{ padding:6px 12px;font-size:12px;font-weight:500;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text-dim);cursor:pointer;transition:var(--transition) }
.operator-tab:hover{ color:var(--text) }
.operator-tab.active{ background:var(--gold);color:#0a0a0a;border-color:var(--gold) }
.form-hint{margin-top:2px}
.tooltip-wrap{position:relative;display:inline-block}
.tooltip-wrap[data-tooltip]:hover::after{content:attr(data-tooltip);position:absolute;left:0;bottom:100%;margin-bottom:4px;padding:6px 8px;font-size:10px;max-width:240px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);white-space:normal;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.autopilot-mode{font-size:10px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.5px}
.autopilot-mode.manual{color:var(--amber)}

/* TAB NAVIGATION */
.tab-nav{
  display:flex;gap:2px;padding:10px 24px 0;background:var(--surface);
  flex-shrink:0;overflow-x:auto;border-bottom:1px solid var(--border);
}
.tab-btn{
  display:flex;align-items:center;gap:6px;padding:8px 14px;
  border:none;background:transparent;color:var(--text-dim);
  cursor:pointer;font-size:12px;font-family:var(--font-sans);
  border-radius:var(--radius) var(--radius) 0 0;
  white-space:nowrap;transition:var(--transition);position:relative;
  bottom:-1px;
}
.tab-btn:hover{background:var(--card);color:var(--text)}
.tab-btn.active{background:var(--card);color:var(--text-bright);border-bottom:2px solid var(--gold)}
.tab-btn svg{width:14px;height:14px;opacity:.5}
.tab-btn.active svg{opacity:1;color:var(--gold)}
.tab-btn .tab-badge{
  font-size:9px;background:var(--red);color:#fff;
  padding:1px 5px;border-radius:6px;font-weight:600;
}

/* CONTENT AREA */
.content{flex:1;overflow-y:auto;padding:20px 24px;background:var(--bg)}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* â”€â”€â”€ SHARED COMPONENTS â”€â”€â”€ */

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.stat-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:14px 16px;
  transition:var(--transition);position:relative;overflow:hidden;
}
.stat-card:hover{border-color:var(--border-light);box-shadow:var(--shadow)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.c-blue::before{background:var(--blue)}
.stat-card.c-green::before{background:var(--green)}
.stat-card.c-amber::before{background:var(--amber)}
.stat-card.c-red::before{background:var(--red)}
.stat-card.c-purple::before{background:var(--purple)}
.stat-card.c-cyan::before{background:var(--cyan)}
.stat-card.c-gold::before{background:var(--gold)}
.stat-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;font-weight:500;margin-bottom:6px}
.stat-value{font-family:var(--font-mono);font-size:22px;font-weight:700;color:var(--text-bright)}
.stat-value.c-blue{color:var(--blue)}
.stat-value.c-green{color:var(--green)}
.stat-value.c-amber{color:var(--amber)}
.stat-value.c-red{color:var(--red)}
.stat-value.c-purple{color:var(--purple)}
.stat-value.c-cyan{color:var(--cyan)}
.stat-value.c-gold{color:var(--gold)}
.stat-sub{font-size:10px;color:var(--text-dim);margin-top:3px}

/* Section Header */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.section-title{font-size:13px;font-weight:600;color:var(--text-bright);display:flex;align-items:center;gap:8px}
.section-title svg{width:15px;height:15px;color:var(--gold)}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:6px;padding:6px 12px;
  border-radius:var(--radius);border:1px solid var(--border-light);
  background:var(--card);color:var(--text);font-size:11px;font-weight:500;
  cursor:pointer;transition:var(--transition);font-family:inherit;white-space:nowrap;
}
.btn:hover{background:var(--card-hover);border-color:var(--blue);color:var(--text-bright)}
.btn-primary{background:var(--blue);border-color:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue-dim);border-color:var(--blue-dim)}
.btn-green{background:var(--green);border-color:var(--green);color:#0a0e14;font-weight:600}
.btn-green:hover{background:var(--green-dim);border-color:var(--green-dim)}
.btn-danger{background:transparent;border-color:var(--red);color:var(--red)}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-gold{background:var(--gold);border-color:var(--gold);color:#0a0e14;font-weight:600}
.btn-gold:hover{background:var(--gold-dim);border-color:var(--gold-dim)}
.btn svg{width:12px;height:12px}

/* Badges */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;letter-spacing:.3px;text-transform:uppercase}
.badge-active{background:rgba(62,207,142,.12);color:var(--green)}
.badge-pending{background:rgba(240,168,75,.12);color:var(--amber)}
.badge-approved{background:rgba(91,155,213,.12);color:var(--blue)}
.badge-rejected{background:rgba(224,85,101,.12);color:var(--red)}
.badge-sandbox{background:rgba(155,123,234,.12);color:var(--purple)}
.badge-draft{background:rgba(45,160,170,.12);color:var(--cyan)}
.badge-safe{background:rgba(62,207,142,.12);color:var(--green)}
.badge-low{background:rgba(91,155,213,.12);color:var(--blue)}
.badge-medium{background:rgba(240,168,75,.12);color:var(--amber)}
.badge-high{background:rgba(224,85,101,.12);color:var(--red)}
.badge-critical{background:rgba(224,85,101,.25);color:var(--red);font-weight:700}
.badge-online{background:rgba(62,207,142,.12);color:var(--green)}
.badge-idle{background:rgba(107,127,149,.15);color:var(--text-dim)}

/* Table */
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:12px}
th{
  text-align:left;padding:10px 14px;background:var(--card);
  color:var(--text-dim);font-weight:500;font-size:10px;
  text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border);
  white-space:nowrap;
}
td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(22,29,42,.5)}
.td-mono{font-family:var(--font-mono);font-size:11px}

/* Live Feed */
.live-feed{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);
  max-height:280px;overflow-y:auto;
}
.feed-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid var(--border);
  font-size:11px;font-weight:600;color:var(--text-dim);
}
.feed-live{display:flex;align-items:center;gap:5px;color:var(--red);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.feed-live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--red);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.feed-item{
  display:flex;align-items:flex-start;gap:10px;padding:8px 14px;
  border-bottom:1px solid var(--border);animation:feedIn .3s ease;
  font-size:11px;
}
.feed-item:last-child{border-bottom:none}
@keyframes feedIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.feed-time{font-family:var(--font-mono);font-size:10px;color:var(--text-dim);flex-shrink:0;padding-top:1px;width:46px}
.feed-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px}
.feed-dot.blue{background:var(--blue)}
.feed-dot.green{background:var(--green)}
.feed-dot.amber{background:var(--amber)}
.feed-dot.red{background:var(--red)}
.feed-dot.purple{background:var(--purple)}
.feed-text{flex:1;color:var(--text)}
.feed-text strong{color:var(--text-bright)}
.feed-empty{padding:24px;text-align:center;color:var(--text-dim);font-size:11px}

/* Two-col layout */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.two-col.wide{grid-template-columns:2fr 1fr}

/* Input / Form */
.input{
  width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);color:var(--text-bright);font-size:12px;
  font-family:inherit;transition:var(--transition);
}
.input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 2px rgba(91,155,213,.15)}
.input::placeholder{color:var(--text-dim)}
textarea.input{resize:vertical;min-height:80px;font-family:var(--font-mono);font-size:11px}
select.input{appearance:none;cursor:pointer}

/* Modal */
.modal-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(2px);
}
.modal-overlay.open{display:flex}
.modal{
  background:var(--surface);border:1px solid var(--border-light);
  border-radius:12px;width:480px;max-width:90vw;max-height:80vh;
  overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.modal-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 22px;border-bottom:1px solid var(--border);
}
.modal-title{font-size:15px;font-weight:600;color:var(--text-bright)}
.modal-close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:2px 6px;border-radius:4px}
.modal-close:hover{background:var(--card);color:var(--text)}
.modal-body{padding:22px}
.form-row{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:500;color:var(--text-dim);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.form-row-inline{display:flex;gap:10px}
.form-row-inline .form-row{flex:1}
.modal-foot{
  display:flex;align-items:center;justify-content:flex-end;gap:8px;
  padding:14px 22px;border-top:1px solid var(--border);
}

/* Think-Plan-Act Pipeline indicator */
.pipeline{display:flex;align-items:center;gap:4px;margin-bottom:16px}
.pipeline-step{
  display:flex;align-items:center;gap:6px;padding:5px 12px;
  border-radius:14px;font-size:10px;font-weight:600;letter-spacing:.5px;
  text-transform:uppercase;background:var(--card);border:1px solid var(--border);
  color:var(--text-dim);transition:var(--transition);
}
.pipeline-step.active{background:rgba(91,155,213,.12);border-color:var(--blue);color:var(--blue)}
.pipeline-step.done{background:rgba(62,207,142,.12);border-color:var(--green);color:var(--green)}
.pipeline-arrow{color:var(--border);font-size:12px}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-light)}

/* Filter row */
.filter-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.filter-chip{
  padding:4px 10px;border-radius:14px;font-size:11px;cursor:pointer;
  background:var(--card);border:1px solid var(--border);color:var(--text-dim);
  transition:var(--transition);
}
.filter-chip:hover,.filter-chip.active{border-color:var(--blue);color:var(--blue);background:rgba(91,155,213,.08)}

/* Empty state */
.empty-state{padding:40px;text-align:center;color:var(--text-dim);font-size:12px}
.empty-state svg{width:32px;height:32px;opacity:.3;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto}

/* Brain-specific: memory tiers */
.tier-row{display:flex;gap:10px;margin-bottom:16px}
.tier-card{
  flex:1;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:12px 14px;
}
.tier-card.l1{border-top:2px solid var(--green)}
.tier-card.l2{border-top:2px solid var(--blue)}
.tier-card.l3{border-top:2px solid var(--purple)}
.tier-name{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.tier-val{font-family:var(--font-mono);font-size:18px;font-weight:600}
.tier-card.l1 .tier-val{color:var(--green)}
.tier-card.l2 .tier-val{color:var(--blue)}
.tier-card.l3 .tier-val{color:var(--purple)}
.tier-desc{font-size:10px;color:var(--text-dim);margin-top:3px}

/* DeFi scan box */
.scan-box{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:16px;margin-bottom:16px;
}
.scan-input-row{display:flex;gap:8px;align-items:flex-end}
.scan-input-row .form-row{flex:1;margin-bottom:0}

/* Responsive */
@media(max-width:900px){.two-col,.two-col.wide{grid-template-columns:1fr}}
.control-plane-content{display:flex;flex-direction:column;overflow:hidden;min-height:0;flex:1}
@media(max-width:700px){.tab-nav{flex-wrap:wrap}.content{padding:12px}}
</style>
{% endblock %}
{% block content %}
<div class="control-plane-content">
  <!-- TAB BAR (sections inside page; sidebar from base) -->
  <div class="tab-nav" id="tabNav">
    <button class="tab-btn active" data-tab="skills">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h10v10H3z"/><path d="M6 6l2 2 4-3"/></svg>
      Skills
    </button>
    <button class="tab-btn" data-tab="packages">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 5l6-3 6 3v6l-6 3-6-3V5z"/><path d="M2 5l6 3m0 0v6m0-6l6-3"/></svg>
      Packages
    </button>
    <button class="tab-btn" data-tab="governance">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1L1 5v2h14V5z"/><path d="M3 7v5M8 7v5M13 7v5M1 12h14"/></svg>
      Governance
    </button>
    <button class="tab-btn" data-tab="execution">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h12v8H2z"/><path d="M6 8l2 2 4-4"/></svg>
      Execution
    </button>
    <button class="tab-btn" data-tab="daenabot-tools">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h4v4H2z"/><path d="M10 4h4v4h-4z"/><path d="M2 10h4v2H2z"/><path d="M10 10h4v2h-4z"/></svg>
      <span id="daenabot-tools-label">DaenaBot Tools</span><span class="tab-badge" id="daenabot-tools-badge" style="display:none">0</span>
    </button>
    <button class="tab-btn" data-tab="integrations">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v4M8 10v4M4 6h8M6 4v8M10 4v8"/></svg>
      Integrations
    </button>
    <button class="tab-btn" data-tab="proactive">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.5 3.5l1.4 1.4M11.1 11.1l1.4 1.4M3.5 12.5l1.4-1.4M11.1 4.9l1.4-1.4"/></svg>
      Proactive
    </button>
    <button class="tab-btn" data-tab="council">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="6" r="2"/><circle cx="11" cy="6" r="2"/><path d="M2 13c0-2 1.3-3 3-3s3 1 3 3"/><path d="M8.5 13c.3-.9 1-1.7 2.5-1.7s2.5.9 2.5 1.7"/></svg>
      Council
    </button>
    <button class="tab-btn" data-tab="trust">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1L2 4v4c0 3.5 2.5 6.5 6 7.5 3.5-1 6-4 6-7.5V4z"/></svg>
      Trust
    </button>
    <button class="tab-btn" data-tab="shadow">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 13l4-8 3 4 3-6 2 10"/></svg>
      Shadow
    </button>
    <button class="tab-btn" data-tab="treasury">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 4v8M6 5.5h3.5a1.5 1.5 0 010 3H6.5a1.5 1.5 0 000 3H10.5"/></svg>
      Treasury
    </button>
    <button class="tab-btn" data-tab="agents">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="5" r="2"/><circle cx="11" cy="5" r="2"/><circle cx="8" cy="10" r="2"/><path d="M3 14c0-1 .9-2 2-2s2 1 2 2"/><path d="M6 14c0-1 .9-2 2-2s2 1 2 2"/><path d="M9 14c0-1 .9-2 2-2s2 1 2 2"/></svg>
      Agents
    </button>
    <span id="backendSyncStatus" class="backend-sync off" style="margin-left:auto;margin-right:12px">Backend: â€¦</span>
  </div>

  <!-- Hands offline banner (shown when GET /api/v1/system/capabilities says hands_gateway is not available) -->
  <div id="handsOfflineBanner" class="awareness-banner" style="display:none">
    <span>DaenaBot can plan but cannot act (Hands offline).</span>
  </div>

  <!-- CONTENT PANELS (Brain & Web3 at /ui/brain-api and /ui/web3) -->
  <div class="content">

    <!-- â•â•â• SKILLS â•â•â• -->
    <div class="tab-panel active" id="panel-skills">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Total Skills</div><div class="stat-value c-blue" id="skillTotal">â€”</div><div class="stat-sub">Registered</div></div>
        <div class="stat-card c-green"><div class="stat-label">Active</div><div class="stat-value c-green" id="skillActive">â€”</div><div class="stat-sub">Running</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Pending</div><div class="stat-value c-amber" id="skillPending">â€”</div><div class="stat-sub">Awaiting review</div></div>
        <div class="stat-card c-purple"><div class="stat-label">Self-Created</div><div class="stat-value c-purple" id="skillSelf">â€”</div><div class="stat-sub">By Daena</div></div>
      </div>
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h10v10H3z"/><path d="M6 6l2 2 4-3"/></svg> Skill Registry</div>
        <p class="text-dim" style="font-size:11px;margin:0 12px 0 0">Creator = who authored. Operators = who can run.</p>
      </div>
      <!-- Row 1 (primary): Operator tabs â€” who can run -->
      <div class="skill-registry-row-primary" style="margin-bottom:12px">
        <span class="text-dim" style="font-size:11px;margin-right:8px">Operators (who can run):</span>
        <div class="operator-tabs" role="group" aria-label="Filter by operator">
          <button type="button" class="operator-tab active" data-operator="" id="skillOpAll" onclick="setOperatorTab('',this)">All</button>
          <button type="button" class="operator-tab" data-operator="founder" onclick="setOperatorTab('founder',this)">Founder</button>
          <button type="button" class="operator-tab" data-operator="daena" onclick="setOperatorTab('daena',this)">Daena</button>
          <button type="button" class="operator-tab" data-operator="agent" onclick="setOperatorTab('agent',this)">Agents</button>
        </div>
      </div>
      <!-- Row 2 (secondary): Category, Risk, Approval, Enabled, Search -->
      <div class="skill-registry-row-secondary" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px 16px;margin-bottom:12px">
        <span class="text-dim" style="font-size:10px">Category</span>
        <span class="filter-chip active" data-skillcat="" onclick="filterSkillsByCategory('',this)">All</span>
        <span class="filter-chip" data-skillcat="utility" onclick="filterSkillsByCategory('utility',this)">Utility</span>
        <span class="filter-chip" data-skillcat="research" onclick="filterSkillsByCategory('research',this)">Research</span>
        <span class="filter-chip" data-skillcat="security" onclick="filterSkillsByCategory('security',this)">Security</span>
        <span class="filter-chip" data-skillcat="data" onclick="filterSkillsByCategory('data',this)">Data</span>
        <span class="text-dim" style="font-size:10px;margin-left:4px">Risk</span>
        <span class="filter-chip active" data-risk="" onclick="filterSkillsByRisk('',this)">All</span>
        <span class="filter-chip" data-risk="low" onclick="filterSkillsByRisk('low',this)">Low</span>
        <span class="filter-chip" data-risk="medium" onclick="filterSkillsByRisk('medium',this)">Med</span>
        <span class="filter-chip" data-risk="high" onclick="filterSkillsByRisk('high',this)">High</span>
        <span class="text-dim" style="font-size:10px">Approval</span>
        <span class="filter-chip active" data-approval="" onclick="filterSkillsByApproval('',this)">All</span>
        <span class="filter-chip" data-approval="auto" onclick="filterSkillsByApproval('auto',this)">Auto</span>
        <span class="filter-chip" data-approval="approval_required" onclick="filterSkillsByApproval('approval_required',this)">Needs approval</span>
        <span class="filter-chip" data-approval="always_approval" onclick="filterSkillsByApproval('always_approval',this)">Always</span>
        <span class="text-dim" style="font-size:10px">Enabled</span>
        <span class="filter-chip active" data-status="" onclick="filterSkillsByStatus('',this)">All</span>
        <span class="filter-chip" data-status="active" onclick="filterSkillsByStatus('active',this)">Yes</span>
        <span class="filter-chip" data-status="disabled" onclick="filterSkillsByStatus('disabled',this)">No</span>
        <input type="text" class="input" id="skillSearch" placeholder="Search" style="max-width:140px;font-size:11px" oninput="debouncedSkillSearch()"/>
        <button class="btn btn-primary" onclick="openSkillCreateModal()">+ New Skill</button>
      </div>
      <!-- Bulk actions bar (shown when rows selected) -->
      <div id="skillBulkBar" class="skill-bulk-bar" style="display:none;align-items:center;gap:10px;margin-bottom:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)">
        <span class="text-dim" style="font-size:11px"><span id="skillBulkCount">0</span> selected</span>
        <button type="button" class="btn" style="font-size:11px" onclick="bulkUpdateAccessSkills()">Bulk update access</button>
        <button type="button" class="btn" style="font-size:11px" onclick="bulkDisableSkills()">Bulk disable</button>
        <button type="button" class="btn btn-danger" style="font-size:11px" onclick="bulkArchiveSkills()">Bulk archive</button>
        <button type="button" class="btn" style="font-size:11px" onclick="clearSkillSelection()">Clear</button>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th style="width:36px"><input type="checkbox" id="skillSelectAll" title="Select all" onclick="toggleSkillSelectAll(this)"/></th><th>Name</th><th>Category</th><th>Operators (who can run)</th><th>Approval</th><th>Risk</th><th>Creator</th><th>Uses</th><th></th></tr></thead>
        <tbody id="skillsTable"><tr><td colspan="9" class="empty-state">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â• PACKAGES â•â•â• -->
    <div class="tab-panel" id="panel-packages">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Total Requests</div><div class="stat-value c-blue" id="pkgTotal">â€”</div><div class="stat-sub">All time</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Pending Audit</div><div class="stat-value c-amber" id="pkgPending">â€”</div><div class="stat-sub">In pipeline</div></div>
        <div class="stat-card c-green"><div class="stat-label">Approved</div><div class="stat-value c-green" id="pkgApproved">â€”</div><div class="stat-sub">Ready to install</div></div>
        <div class="stat-card c-red"><div class="stat-label">Rejected</div><div class="stat-value c-red" id="pkgRejected">â€”</div><div class="stat-sub">Blocked</div></div>
      </div>
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 5l6-3 6 3v6l-6 3-6-3V5z"/><path d="M2 5l6 3m0 0v6m0-6l6-3"/></svg> Package Audit Queue</div>
        <button class="btn btn-primary" onclick="openModal('package')">+ Request Install</button>
      </div>
      <div class="two-col wide">
        <div class="table-wrap">
          <table><thead><tr><th>Package</th><th>Version</th><th>Manager</th><th>Risk</th><th>Status</th><th></th></tr></thead>
          <tbody id="pkgTable"><tr><td colspan="6" class="empty-state">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Audit Feed</div></div>
          <div class="live-feed" id="pkgFeed">
            <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Package audit eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• GOVERNANCE â•â•â• -->
    <div class="tab-panel" id="panel-governance">
      <div class="stats-row">
        <div class="stat-card c-green"><div class="stat-label">Auto-Approved</div><div class="stat-value c-green" id="govAuto">0</div><div class="stat-sub">Autopilot actions</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Pending Approval</div><div class="stat-value c-amber" id="govPending">0</div><div class="stat-sub">Awaiting Founder</div></div>
        <div class="stat-card c-blue"><div class="stat-label">Actions Today</div><div class="stat-value c-blue" id="govToday">0</div><div class="stat-sub">Last 24h</div></div>
        <div class="stat-card c-red"><div class="stat-label">Blocked</div><div class="stat-value c-red" id="govBlocked">0</div><div class="stat-sub">High/Critical risk</div></div>
      </div>

      <!-- AGI Autopilot (synced with backend: GET/POST /api/v1/brain/autopilot + governance/toggle-autopilot) -->
      <div class="autopilot-wrap" style="margin-bottom:14px">
        <span class="autopilot-label">AGI Autopilot</span>
        <div class="toggle-switch" id="autopilotToggle" onclick="toggleAutopilot()" role="button" aria-pressed="false" title="Toggle autopilot"></div>
        <span class="autopilot-mode" id="autopilotMode">â€”</span>
      </div>
      <!-- DaenaBot Awareness (GET /api/v1/system/capabilities) -->
      <div class="awareness-panel" id="awarenessPanel">
        <div class="ap-title">DaenaBot Awareness</div>
        <div class="ap-row"><span class="ap-label">Hands</span><span class="ap-value" id="awarenessHands">â€”</span></div>
        <div class="ap-row"><span class="ap-label">Local LLM</span><span class="ap-value" id="awarenessLLM">â€”</span></div>
        <div class="ap-row"><span class="ap-label">Governance</span><span class="ap-value" id="awarenessGov">â€”</span></div>
        <div class="ap-row" id="awarenessRemoteRow" style="display:none"><span class="ap-label">Security</span><span class="ap-value off" id="awarenessRemote">â€”</span></div>
      </div>
      <!-- Think-Plan-Act Pipeline Status -->
      <div class="section-header"><div class="section-title">Active Pipeline</div></div>
      <div class="pipeline" id="pipeline">
        <div class="pipeline-step" id="pipe-think">ðŸ§  Think</div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-step" id="pipe-plan">ðŸ“‹ Plan</div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-step" id="pipe-act">âš¡ Act</div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-step" id="pipe-report">ðŸ“Š Report</div>
      </div>

      <div class="two-col">
        <div>
          <div class="section-header"><div class="section-title">Pending Actions (Founder Approval Required)</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Action</th><th>Risk</th><th>Agent</th><th>Time</th><th></th></tr></thead>
            <tbody id="govPendingTable"><tr><td colspan="5" class="empty-state">No pending actions</td></tr></tbody>
            </table>
          </div>
          <div class="section-header" style="margin-top:16px"><div class="section-title">Execution Log</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Action</th><th>Risk</th><th>Outcome</th><th>Time</th></tr></thead>
            <tbody id="govLogTable"><tr><td colspan="4" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Governance Feed</div></div>
          <div class="live-feed" id="govFeed">
            <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Governance eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• EXECUTION â•â•â• -->
    <div class="tab-panel" id="panel-execution">
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h12v8H2z"/></svg> Execution Layer</div>
        <span class="text-dim" style="font-size:11px" id="executionCapSummary">â€”</span>
      </div>
      <p class="text-dim" style="font-size:12px;margin-bottom:12px">Tools and run history. Daena runs approved tools; agents submit requests for approval.</p>
      <!-- Execution token: auth-status + optional paste token for session -->
      <div class="scan-box" id="executionAuthBox" style="margin-bottom:16px">
        <div class="section-header" style="margin-bottom:8px"><div class="section-title">Execution auth</div><span class="badge badge-active" id="executionAuthBadge">â€”</span></div>
        <p class="text-dim" style="font-size:11px;margin-bottom:8px" id="executionAuthMessage">Loadingâ€¦</p>
        <div id="executionTokenRow" style="display:none;align-items:center;gap:8px;flex-wrap:wrap">
          <input type="password" class="input" id="executionTokenInput" placeholder="Paste EXECUTION_TOKEN (from .env)" style="max-width:280px;font-family:var(--font-mono);font-size:12px" autocomplete="off"/>
          <button class="btn btn-primary" onclick="saveExecutionToken()">Save for session</button>
          <button class="btn" onclick="clearExecutionToken()">Clear</button>
        </div>
        <p class="text-dim" style="font-size:10px;margin-top:6px">Token is stored in sessionStorage only; use same value as backend <code>EXECUTION_TOKEN</code>. For local dev, set <code>ALLOW_INSECURE_EXECUTION_LOCAL=1</code> to skip token from 127.0.0.1.</p>
      </div>
      <div class="two-col">
        <div>
          <div class="section-header"><div class="section-title">Execution Log</div><a href="#" onclick="loadExecution();return false" class="btn" style="font-size:11px">Refresh</a></div>
          <div class="table-wrap" style="max-height:320px;overflow:auto">
            <table><thead><tr><th>Time</th><th>Tool</th><th>Result</th></tr></thead>
            <tbody id="executionLogTable"><tr><td colspan="3" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Capability Handshake</div></div>
          <div class="scan-box"><p class="text-dim" style="font-size:11px;margin-bottom:8px">On load, Control Panel calls <code>/api/v1/execution/logs</code> and <code>/api/v1/integrations/mcp-servers</code>. Daena is informed of available tools and MCP servers (subject to approval).</p><p id="capabilitySummary" class="text-dim" style="font-size:11px">â€”</p></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• DAENABOT TOOLS (OpenClaw / Hands) â•â•â• -->
    <div class="tab-panel" id="panel-daenabot-tools">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Gateway</div><div class="stat-value c-blue" id="toolsGatewayStatus">â€”</div><div class="stat-sub" id="toolsGatewaySub">Connection</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Pending</div><div class="stat-value c-amber" id="toolsPendingCount">0</div><div class="stat-sub">Awaiting approval</div></div>
        <div class="stat-card c-green"><div class="stat-label">Display name</div><div class="stat-value c-green" id="toolsDisplayName" style="font-size:12px">â€”</div></div>
      </div>
      <div class="section-header" style="margin-bottom:8px">
        <div class="section-title">Hands connection</div>
        <div style="display:flex;align-items:center;gap:8px">
          <span id="pingHandsResult" class="text-dim" style="font-size:11px"></span>
          <button type="button" class="btn btn-primary" id="pingHandsBtn" onclick="testHandsConnection()">Test Hands Connection</button>
        </div>
      </div>
      <div class="section-header"><div class="section-title">Pending tool requests</div><a href="#" onclick="loadDaenaBotTools();return false" class="btn" style="font-size:11px">Refresh</a></div>
      <div class="table-wrap">
        <table><thead><tr><th>Time</th><th>Requested by</th><th>Risk</th><th>Action</th><th></th></tr></thead>
        <tbody id="toolsQueueTable"><tr><td colspan="5" class="empty-state">Loadingâ€¦</td></tbody></table>
      </div>
      <div class="section-header" style="margin-top:16px"><div class="section-title">Recent history</div></div>
      <div class="table-wrap">
        <table><thead><tr><th>Time</th><th>Requested by</th><th>Risk</th><th>Status</th><th>Result</th></tr></thead>
        <tbody id="toolsHistoryTable"><tr><td colspan="5" class="empty-state">Loadingâ€¦</td></tbody></table>
      </div>
    </div>

    <!-- â•â•â• INTEGRATIONS â•â•â• -->
    <div class="tab-panel" id="panel-integrations">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Integrations</div><div class="stat-value c-blue" id="intTotal">â€”</div></div>
        <div class="stat-card c-green"><div class="stat-label">MCP Servers</div><div class="stat-value c-green" id="intMcp">â€”</div></div>
      </div>
      <div class="section-header"><div class="section-title">Integration List</div></div>
      <div class="table-wrap"><table><thead><tr><th>Name</th><th>Status</th><th>Type</th></tr></thead><tbody id="integrationsTable"><tr><td colspan="3" class="empty-state">Loadingâ€¦</td></tr></tbody></table></div>
      <div class="section-header" style="margin-top:16px"><div class="section-title">MCP Servers</div></div>
      <div class="table-wrap"><table><thead><tr><th>Name</th><th>URL</th><th>Status</th></tr></thead><tbody id="mcpServersTable"><tr><td colspan="3" class="empty-state">Loadingâ€¦</td></tr></tbody></table></div>
    </div>

    <!-- â•â•â• PROACTIVE â•â•â• -->
    <div class="tab-panel" id="panel-proactive">
      <div class="section-header"><div class="section-title">Proactive Rules &amp; Events</div></div>
      <div class="two-col">
        <div><div class="section-header">Rules</div><div id="proactiveRulesList" class="scan-box">Loadingâ€¦</div></div>
        <div><div class="section-header">Recent Events</div><div id="proactiveEventsList" class="scan-box" style="max-height:280px;overflow:auto">Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• COUNCIL â•â•â• -->
    <div class="tab-panel" id="panel-council">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Active Debates</div><div class="stat-value c-blue" id="councilActive">0</div><div class="stat-sub">In progress</div></div>
        <div class="stat-card c-green"><div class="stat-label">Resolved</div><div class="stat-value c-green" id="councilResolved">0</div><div class="stat-sub">Completed</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Pending Vote</div><div class="stat-value c-amber" id="councilPending">0</div><div class="stat-sub">Awaiting decision</div></div>
        <div class="stat-card c-purple"><div class="stat-label">Experts</div><div class="stat-value c-purple" id="councilExperts">0</div><div class="stat-sub">Active members</div></div>
      </div>
      <div class="two-col">
        <div>
          <div class="section-header"><div class="section-title">Active Debates</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Topic</th><th>Status</th><th>Experts</th><th>Started</th></tr></thead>
            <tbody id="councilTable"><tr><td colspan="4" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Council Feed</div></div>
          <div class="live-feed" id="councilFeed">
            <div class="feed-header"><span>Debates</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Council activityâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• TRUST â•â•â• -->
    <div class="tab-panel" id="panel-trust">
      <div class="stats-row">
        <div class="stat-card c-blue"><div class="stat-label">Verifications</div><div class="stat-value c-blue" id="trustVerified">0</div><div class="stat-sub">Content checks</div></div>
        <div class="stat-card c-red"><div class="stat-label">Injections Blocked</div><div class="stat-value c-red" id="trustBlocked">0</div><div class="stat-sub">Prompt attacks</div></div>
        <div class="stat-card c-green"><div class="stat-label">Trusted Sources</div><div class="stat-value c-green" id="trustSources">0</div><div class="stat-sub">Whitelisted</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Stripped</div><div class="stat-value c-amber" id="trustStripped">0</div><div class="stat-sub">Sanitized inputs</div></div>
      </div>
      <div class="two-col">
        <div>
          <div class="section-header">
            <div class="section-title">Verify Content</div>
            <button class="btn btn-primary" onclick="openModal('verify')">+ Verify</button>
          </div>
          <div class="table-wrap">
            <table><thead><tr><th>Source</th><th>Trust Score</th><th>Status</th><th>Last Check</th></tr></thead>
            <tbody id="trustTable"><tr><td colspan="4" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Trust Feed</div></div>
          <div class="live-feed" id="trustFeed">
            <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Trust eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SHADOW â•â•â• -->
    <div class="tab-panel" id="panel-shadow">
      <div class="stats-row">
        <div class="stat-card c-purple"><div class="stat-label">Honeypots Active</div><div class="stat-value c-purple" id="shadowHoney">0</div><div class="stat-sub">Decoy routes</div></div>
        <div class="stat-card c-cyan"><div class="stat-label">Canary Tokens</div><div class="stat-value c-cyan" id="shadowCanary">0</div><div class="stat-sub">Trip wires</div></div>
        <div class="stat-card c-red"><div class="stat-label">Alerts 24h</div><div class="stat-value c-red" id="shadowAlerts">0</div><div class="stat-sub">Recent events</div></div>
        <div class="stat-card c-blue"><div class="stat-label">TTPs Logged</div><div class="stat-value c-blue" id="shadowTTPs">0</div><div class="stat-sub">Attack patterns</div></div>
      </div>
      <div class="two-col">
        <div>
          <div class="section-header"><div class="section-title">Honeypot Routes</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Decoy Path</th><th>Type</th><th>Hits</th><th>Last Hit</th></tr></thead>
            <tbody id="shadowTable"><tr><td colspan="4" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Threat Feed</div></div>
          <div class="live-feed" id="shadowFeed">
            <div class="feed-header"><span>Alerts</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Shadow dept eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• TREASURY â•â•â• -->
    <div class="tab-panel" id="panel-treasury">
      <div class="stats-row">
        <div class="stat-card c-gold"><div class="stat-label">$DAENA Balance</div><div class="stat-value c-gold" id="treasDaena">0</div><div class="stat-sub">Token supply</div></div>
        <div class="stat-card c-purple"><div class="stat-label">NFTs Minted</div><div class="stat-value c-purple" id="treasNFT">0</div><div class="stat-sub">Agent licenses</div></div>
        <div class="stat-card c-blue"><div class="stat-label">ETH Held</div><div class="stat-value c-blue" id="treasETH">0</div><div class="stat-sub">Treasury reserve</div></div>
        <div class="stat-card c-green"><div class="stat-label">Monthly Spend</div><div class="stat-value c-green" id="treasSpend">$0</div><div class="stat-sub">Operations</div></div>
      </div>
      <div class="two-col">
        <div>
          <div class="section-header"><div class="section-title">Treasury Transactions</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Type</th><th>Amount</th><th>Approved By</th><th>Time</th></tr></thead>
            <tbody id="treasTable"><tr><td colspan="4" class="empty-state">No transactions yet</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Treasury Feed</div></div>
          <div class="live-feed" id="treasFeed">
            <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Treasury eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• AGENTS â•â•â• -->
    <div class="tab-panel" id="panel-agents">
      <div class="stats-row">
        <div class="stat-card c-green"><div class="stat-label">Online</div><div class="stat-value c-green" id="agentOnline">0</div><div class="stat-sub">Active agents</div></div>
        <div class="stat-card c-blue"><div class="stat-label">Actions Today</div><div class="stat-value c-blue" id="agentActions">0</div><div class="stat-sub">Executed</div></div>
        <div class="stat-card c-amber"><div class="stat-label">Departments</div><div class="stat-value c-amber" id="agentDepts">8</div><div class="stat-sub">Sunflower structure</div></div>
        <div class="stat-card c-purple"><div class="stat-label">Pending Tasks</div><div class="stat-value c-purple" id="agentPending">0</div><div class="stat-sub">Queued</div></div>
      </div>
      <div class="two-col wide">
        <div>
          <div class="section-header"><div class="section-title">Agent Registry</div></div>
          <div class="table-wrap">
            <table><thead><tr><th>Agent</th><th>Department</th><th>Status</th><th>Last Activity</th><th>Actions</th></tr></thead>
            <tbody id="agentsTable"><tr><td colspan="5" class="empty-state">Loadingâ€¦</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="section-header"><div class="section-title">Agent Activity Feed</div></div>
          <div class="live-feed" id="agentFeed">
            <div class="feed-header"><span>Activity</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Agent eventsâ€¦</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /shell -->

<!-- â•â•â• MODALS â•â•â• -->
<div class="modal-overlay" id="modal-skill">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Create New Skill</span><button class="modal-close" onclick="closeModal('skill')">Ã—</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Skill Name</label><input class="input" id="newSkillName" placeholder="e.g. web_scraper"/></div>
      <div class="form-row"><label class="form-label">Display Name</label><input class="input" id="newSkillDisplay" placeholder="Web Scraper"/></div>
      <div class="form-row"><label class="form-label">Description</label><input class="input" id="newSkillDesc" placeholder="Scrapes web pages and extracts structured data"/></div>
      <div class="form-row">
        <label class="form-label">Category</label>
        <div class="category-chips" role="group" aria-label="Category">
          <button type="button" class="category-chip active" data-cat="utility" id="skillCatUtility" onclick="setSkillCategory('utility')" tabindex="0">Utility</button>
          <button type="button" class="category-chip" data-cat="research" onclick="setSkillCategory('research')">Research</button>
          <button type="button" class="category-chip" data-cat="security" onclick="setSkillCategory('security')">Security</button>
          <button type="button" class="category-chip" data-cat="communication" onclick="setSkillCategory('communication')">Communication</button>
          <button type="button" class="category-chip" data-cat="data" onclick="setSkillCategory('data')">Data</button>
          <button type="button" class="category-chip" data-cat="devops" onclick="setSkillCategory('devops')">DevOps</button>
          <button type="button" class="category-chip" data-cat="web3" onclick="setSkillCategory('web3')">Web3/DeFi</button>
          <button type="button" class="category-chip" data-cat="admin" onclick="setSkillCategory('admin')">Admin</button>
        </div>
        <input type="hidden" id="newSkillCat" value="utility"/>
      </div>
      <div class="form-row">
        <label class="form-label">Creator</label>
        <p class="form-hint" style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Who authored this skill definition (not who can run it).</p>
        <div class="segmented-pill" role="group" aria-label="Creator">
          <button type="button" class="segmented-pill-btn active" data-creator="founder" id="skillCreatorFounder" onclick="setSkillCreator('founder')">Founder</button>
          <button type="button" class="segmented-pill-btn" data-creator="daena" id="skillCreatorDaena" onclick="setSkillCreator('daena')">Daena</button>
          <button type="button" class="segmented-pill-btn" data-creator="agent" id="skillCreatorAgent" onclick="setSkillCreator('agent')">Agent</button>
        </div>
        <input type="hidden" name="creator" id="newSkillCreator" value="founder"/>
      </div>
      <div class="form-row">
        <label class="form-label">Access Scope (who can run this skill)</label>
        <div class="access-scope-row">
          <label><input type="checkbox" id="accessFounder" checked/> Founder</label>
          <label><input type="checkbox" id="accessDaena" checked/> Daena (VP)</label>
          <label><input type="checkbox" id="accessDeptAgents"/> Department Agents</label>
          <label><input type="checkbox" id="accessSpecificDepts"/> Specific Departments</label>
          <label><input type="checkbox" id="accessSpecificAgents"/> Specific Agents</label>
        </div>
        <div style="margin-top:8px;display:none" id="accessSpecificDeptsRow">
          <input class="input" id="accessDeptsList" placeholder="e.g. Finance, Ops, Research" style="max-width:280px;font-size:11px"/>
        </div>
        <div style="margin-top:8px;display:none" id="accessSpecificAgentsRow">
          <input class="input" id="accessAgentsList" placeholder="e.g. agent_1, agent_2" style="max-width:280px;font-size:11px"/>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Execution Policy</label>
        <p class="form-hint" style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Governance: low=auto, medium=approval (or auto in Unleashed), high=always approval. Red-zone always requires founder confirm.</p>
        <div style="display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center">
          <span style="font-size:11px;color:var(--text-dim)">Risk</span>
          <div class="segmented-pill" role="group" aria-label="Risk level">
            <button type="button" class="segmented-pill-btn active" id="riskLow" onclick="setSkillRisk('low')">Low</button>
            <button type="button" class="segmented-pill-btn" id="riskMed" onclick="setSkillRisk('medium')">Medium</button>
            <button type="button" class="segmented-pill-btn" id="riskHigh" onclick="setSkillRisk('high')">High</button>
          </div>
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px">Approval</span>
          <div class="segmented-pill" role="group" aria-label="Approval policy">
            <button type="button" class="segmented-pill-btn active" id="approvalAuto" onclick="setSkillApproval('auto')">Auto</button>
            <button type="button" class="segmented-pill-btn" id="approvalRequired" onclick="setSkillApproval('approval_required')">Needs approval</button>
            <button type="button" class="segmented-pill-btn" id="approvalAlways" onclick="setSkillApproval('always_approval')">Always approval</button>
          </div>
        </div>
        <div class="form-row-inline" style="align-items:center;gap:8px;margin-top:10px">
          <div class="tooltip-wrap" data-tooltip="Credentials entry / money movement / destructive commands always require founder confirm.">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px">
              <input type="checkbox" id="requiresStepUpConfirm" checked/>
              Red-zone: require step-up confirm
            </label>
          </div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Enabled</label>
        <div class="form-row-inline" style="align-items:center;gap:12px">
          <div class="toggle-switch on" id="newSkillEnabledToggle" onclick="toggleNewSkillEnabled()" role="button" aria-pressed="true" title="Skill enabled when created"></div>
          <span class="text-dim" style="font-size:12px" id="newSkillEnabledLabel">On (skill can be used after creation)</span>
        </div>
      </div>
      <div class="form-row"><label class="form-label">Code Body</label><textarea class="input" id="newSkillCode" placeholder="def execute(input_data):\n    # skill implementation\n    pass"></textarea></div>
    </div>
    <input type="hidden" id="editSkillId" value=""/>
    <div class="modal-foot"><button class="btn" onclick="closeModal('skill')">Cancel</button><button class="btn btn-primary" id="skillModalSubmit" onclick="createOrUpdateSkill()">Create Skill</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-access-more">
  <div class="modal" style="max-width:420px">
    <div class="modal-head"><span class="modal-title">Access: Departments &amp; Agents</span><button class="modal-close" onclick="closeModal('access-more')">Ã—</button></div>
    <div class="modal-body">
      <p class="form-hint text-dim" style="font-size:11px;margin-bottom:8px">Optional: restrict who can run by department or specific agent IDs. Leave empty for no restriction.</p>
      <div class="form-row"><label class="form-label">Allowed departments (comma-separated)</label><input class="input" id="accessMoreDepts" placeholder="e.g. Finance, Ops, Research" style="font-size:12px"/></div>
      <div class="form-row"><label class="form-label">Allowed agents (comma-separated)</label><input class="input" id="accessMoreAgents" placeholder="e.g. agent_1, agent_2" style="font-size:12px"/></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('access-more')">Cancel</button><button class="btn btn-primary" onclick="saveAccessMore()">Save</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-package">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Request Package Install</span><button class="modal-close" onclick="closeModal('package')">Ã—</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Package Name</label><input class="input" id="newPkgName" placeholder="e.g. lodash"/></div>
      <div class="form-row-inline">
        <div class="form-row"><label class="form-label">Version</label><input class="input" id="newPkgVer" placeholder="4.17.21"/></div>
        <div class="form-row"><label class="form-label">Manager</label><select class="input" id="newPkgMgr"><option value="npm">npm</option><option value="pip">pip</option><option value="yarn">yarn</option></select></div>
      </div>
      <div class="form-row"><label class="form-label">Requested By</label><input class="input" id="newPkgBy" placeholder="founder" value="founder"/></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('package')">Cancel</button><button class="btn btn-primary" onclick="requestPackage()">Request Install</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-research">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">New Research Query</span><button class="modal-close" onclick="closeModal('research')">Ã—</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Query</label><textarea class="input" id="researchQuery" placeholder="What are the latest DeFi attack vectors in 2026?"></textarea></div>
      <div class="form-row"><label class="form-label">Sources</label><select class="input" id="researchSrc"><option value="all">All Sources</option><option value="web">Web Only</option><option value="memory">Local Memory</option><option value="mcp">MCP Tools</option></select></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('research')">Cancel</button><button class="btn btn-primary" onclick="runResearch()">Run Research</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-verify">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Verify Content</span><button class="modal-close" onclick="closeModal('verify')">Ã—</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Content to Verify</label><textarea class="input" id="verifyContent" placeholder="Paste content to check for prompt injection or manipulationâ€¦"></textarea></div>
      <div class="form-row"><label class="form-label">Source</label><input class="input" id="verifySource" placeholder="e.g. external_api_response"/></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('verify')">Cancel</button><button class="btn btn-primary" onclick="verifyContent()">Verify</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-approve">
  <div class="modal">
    <div class="modal-head"><span class="modal-title" id="approveTitle">Approve Action</span><button class="modal-close" onclick="closeModal('approve')">Ã—</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Action Details</label><div class="input" id="approveDetails" style="background:var(--card);min-height:60px;white-space:pre-wrap;font-family:var(--font-mono);font-size:11px">â€”</div></div>
      <div class="form-row"><label class="form-label">Notes (optional)</label><input class="input" id="approveNotes" placeholder="Approval reasonâ€¦"/></div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal('approve')">Cancel</button>
      <button class="btn btn-danger" onclick="rejectAction()">Reject</button>
      <button class="btn btn-green" onclick="approveAction()">Approve</button>
    </div>
  </div>
</div>

<!-- â•â•â• JAVASCRIPT â•â•â• -->
<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = {
  skills:       '/api/v1/skills',
  packages:     '/api/v1/packages',
  governance:   '/api/v1/governance',
  execution:    '/api/v1/execution',
  tools:        '/api/v1/tools',
  hands:        '/api/v1/hands',
  integrations: '/api/v1/integrations',
  proactive:    '/api/v1/proactive',
  memory:       '/api/v1/memory',
  research:     '/api/v1/research',
  defi:         '/api/v1/defi',
  integrity:    '/api/v1/integrity',
  shadow:       '/api/v1/shadow',
  council:      '/api/v1/council',
  brain:        '/api/v1/brain',
  treasury:     '/api/v1/treasury',
  system:       '/api/v1/system',
  capabilities: '/api/v1/system/capabilities',
  chat:         '/api/v1/daena/chat/stream'
};

let ws = null;
let autopilotState = true;
let currentApproveId = null;
let skillFilter = 'all';
let operatorRoleFilter = '';  // server-side: '' | 'founder' | 'daena' | 'agent' (who can run)
let skillAccessFilter = '';
let skillCategoryFilter = '';
let skillRiskFilter = '';
let skillApprovalFilter = '';
let skillStatusFilter = '';
let skillSearchQuery = '';
let skillSelectAllChecked = false;
let selectedSkillIds = new Set();

// â”€â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(()=>{
  const n=new Date();
  document.getElementById('clock').textContent=n.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
},1000);

// â”€â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>switchTab(btn.dataset.tab));
});
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  const btn=document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  const panel=document.getElementById('panel-'+tab);
  if(btn)btn.classList.add('active');
  if(panel)panel.classList.add('active');
  loadTabData(tab);
}

// â”€â”€â”€ WEBSOCKET (persist on window, reconnect with backoff) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.wsReconnectDelay=3000;
window.wsReconnectMax=60000;
var ws;
function connectWS(){
  try{
    const proto=location.protocol==='https:'?'wss:':'ws:';
    ws=new WebSocket(`${proto}//${location.host}/ws/events`);
    window.ws=ws;
    ws.onopen=()=>{setWSStatus(true);window.wsReconnectDelay=3000};
    ws.onclose=()=>{
      setWSStatus(false);
      const delay=Math.min(window.wsReconnectDelay,window.wsReconnectMax);
      window.wsReconnectDelay=Math.min(delay*2,window.wsReconnectMax);
      setTimeout(connectWS,delay);
    };
    ws.onerror=()=>{};
    ws.onmessage=(e)=>{
      try{handleWSEvent(JSON.parse(e.data))}catch(x){}
    };
  }catch(e){setTimeout(connectWS,window.wsReconnectDelay||3000)}
}
function setWSStatus(on){
  document.getElementById('wsDot').className='ws-dot'+(on?'':' off');
  document.getElementById('wsLabel').textContent=on?'Connected':'Reconnectingâ€¦';
}
function handleWSEvent(ev){
  const type=(ev.event_type||ev.type||'');
  const payload=ev.payload||ev;
  const t=ev.timestamp?new Date(ev.timestamp):new Date();
  const timeStr=t.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const msg=payload.message||ev.message||type;

  if(type.startsWith('agent')||type==='task_created'||type==='task_completed'){
    addFeed('agentFeed',timeStr,'green',msg);
  }
  if(type.startsWith('council')||type==='debate'||type==='vote'){
    addFeed('councilFeed',timeStr,'blue',msg);
  }
  if(type.startsWith('trust')||type==='integrity'||type==='injection_detected'){
    addFeed('trustFeed',timeStr,type.includes('block')||type.includes('inject')?'red':'blue',msg);
  }
  if(type.startsWith('shadow')||type==='threat'||type==='honeypot'||type==='canary'){
    addFeed('shadowFeed',timeStr,'purple',msg);
  }
  if(type.startsWith('treasury')||type==='token'||type==='nft'){
    addFeed('treasFeed',timeStr,'amber',msg);
  }
  if(type.startsWith('package')||type==='audit'){
    addFeed('pkgFeed',timeStr,'blue',msg);
  }
  if(type.startsWith('skill')||type==='skill_update'){
    addFeed('brainFeed',timeStr,'green',msg);
    if(typeof loadSkills==='function')loadSkills();
  }
  if(type.startsWith('governance')||type==='approval'||type==='autopilot'){
    addFeed('govFeed',timeStr,'amber',msg);
    if(payload.stage&&typeof animatePipeline==='function')animatePipeline(payload.stage);
    if(type==='governance_autopilot_changed'&&typeof loadTabData==='function')loadTabData('governance');
  }
  if(type.startsWith('brain')||type==='memory'||type==='research'||type==='llm'){
    addFeed('brainFeed',timeStr,'blue',msg);
  }
  if(type.startsWith('defi')||type==='scan'){
    addFeed('defiFeed',timeStr,'amber',msg);
  }
}
function addFeed(feedId,time,color,html){
  const feed=document.getElementById(feedId);
  if(!feed)return;
  const empty=feed.querySelector('.feed-empty');
  if(empty)empty.remove();
  const item=document.createElement('div');
  item.className='feed-item';
  item.innerHTML=`<span class="feed-time">${time}</span><div class="feed-dot ${color}"></div><div class="feed-text">${html}</div>`;
  const header=feed.querySelector('.feed-header');
  if(header)header.after(item);
  // Keep max 40 items
  const items=feed.querySelectorAll('.feed-item');
  if(items.length>40)items[items.length-1].remove();
}

// â”€â”€â”€ DAENABOT AWARENESS (GET /api/v1/system/capabilities) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAwareness(){
  try {
    const r = await apiRequest(API.capabilities);
    if (!r || r.error) return;
    const avail = r.available || {};
    const health = r.health || {};
    const hands = health.hands || {};
    const llm = health.local_llm || {};
    const gov = health.governance || r.governance || {};
    const banner = document.getElementById('handsOfflineBanner');
    if (banner) {
      if (r.remote_hands_warning) {
        banner.className = 'awareness-banner warning-remote';
        banner.textContent = 'Hands URL is not localhost. Set ENABLE_REMOTE_HANDS=true to acknowledge.';
        banner.style.display = 'block';
      } else if (!avail.hands_gateway) {
        banner.className = 'awareness-banner';
        banner.innerHTML = '<span>DaenaBot can plan but cannot act (Hands offline).</span>';
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }
    const handsEl = document.getElementById('awarenessHands');
    if (handsEl) {
      const conn = hands.connected ? 'Connected' : 'Offline';
      const auth = hands.authenticated ? ', authenticated' : (hands.token_present ? ', auth pending' : '');
      handsEl.textContent = conn + auth + (hands.url_host ? ' (' + hands.url_host + ')' : '');
      handsEl.className = 'ap-value ' + (hands.connected ? 'ok' : 'off');
    }
    const llmEl = document.getElementById('awarenessLLM');
    if (llmEl) {
      const prov = llm.provider || 'â€”';
      const model = llm.model ? ' Â· ' + llm.model : '';
      llmEl.textContent = (llm.healthy ? 'OK' : 'Offline') + ' Â· ' + prov + model;
      llmEl.className = 'ap-value ' + (llm.healthy ? 'ok' : 'off');
    }
    const govEl = document.getElementById('awarenessGov');
    if (govEl) {
      const mode = gov.autopilot_enabled ? 'Autopilot' : 'Manual';
      const pending = (gov.pending_count || 0) > 0 ? ' Â· ' + gov.pending_count + ' pending' : '';
      govEl.textContent = mode + pending;
      govEl.className = 'ap-value';
    }
    const remoteRow = document.getElementById('awarenessRemoteRow');
    const remoteEl = document.getElementById('awarenessRemote');
    if (remoteRow && remoteEl && r.remote_hands_warning) {
      remoteRow.style.display = 'flex';
      remoteEl.textContent = 'Hands URL is not localhost (set ENABLE_REMOTE_HANDS=true to acknowledge)';
    } else if (remoteRow) remoteRow.style.display = 'none';
  } catch (_) {}
}

// â”€â”€â”€ AUTOPILOT TOGGLE (synced: brain/autopilot + governance/toggle-autopilot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAutopilotFromBackend(){
  try {
    const r = await apiRequest('/api/v1/brain/autopilot');
    if (r && typeof r.enabled === 'boolean') {
      autopilotState = r.enabled;
      const el = document.getElementById('autopilotToggle');
      const modeEl = document.getElementById('autopilotMode');
      if (el) { el.className = 'toggle-switch' + (autopilotState ? ' on' : ''); el.setAttribute('aria-pressed', autopilotState); }
      if (modeEl) { modeEl.textContent = autopilotState ? 'On' : 'Manual'; modeEl.className = 'autopilot-mode' + (autopilotState ? '' : ' manual'); }
      if (window.loadTopbarAutopilot) window.loadTopbarAutopilot();
    }
  } catch (_) {}
}
window.refreshControlPanelAutopilot = loadAutopilotFromBackend;
async function toggleAutopilot(){
  const nextState = !autopilotState;
  const el = document.getElementById('autopilotToggle');
  const modeEl = document.getElementById('autopilotMode');
  autopilotState = nextState;
  if (el) { el.className='toggle-switch'+(autopilotState?' on':''); el.setAttribute('aria-pressed', autopilotState); }
  if (modeEl) { modeEl.className='autopilot-mode'+(autopilotState?'':' manual'); modeEl.textContent=autopilotState?'On':'Manual'; }
  try {
    const r = await fetch(API.governance+'/toggle-autopilot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:autopilotState})});
    if (r.ok) {
      if (window.loadTopbarAutopilot) window.loadTopbarAutopilot();
      addFeed('govFeed',new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}),'amber',`<strong>Autopilot</strong> switched to <strong>${autopilotState?'ON':'Manual'}</strong>`);
    } else {
      await loadAutopilotFromBackend();
    }
  } catch (_) {
    await loadAutopilotFromBackend();
  }
}

// â”€â”€â”€ PIPELINE ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animatePipeline(stage){
  const map={think:'pipe-think',plan:'pipe-plan',act:'pipe-act',report:'pipe-report'};
  const order=['think','plan','act','report'];
  const idx=order.indexOf(stage);
  order.forEach((s,i)=>{
    const el=document.getElementById(map[s]);
    if(!el)return;
    el.className='pipeline-step'+(i<idx?' done':(i===idx?' active':''));
  });
}

// â”€â”€â”€ MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id){document.getElementById('modal-'+id).classList.add('open')}
function closeModal(id){ document.getElementById('modal-'+id).classList.remove('open'); if(id==='skill'){ document.getElementById('editSkillId').value=''; const btn=document.getElementById('skillModalSubmit'); if(btn) btn.textContent='Create Skill'; } }
function openSkillCreateModal(){ document.getElementById('editSkillId').value=''; document.getElementById('skillModalSubmit').textContent='Create Skill'; openModal('skill'); }
document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',(e)=>{if(e.target===o)o.classList.remove('open')})});

// â”€â”€â”€ API HELPER (sync with backend; relative URLs so same-origin). Use apiRequest â€” window.api is DaenaAPI instance. â”€â”€â”€
async function apiRequest(url,opts={}){
  try{
    const r=await fetch(url,{headers:{'Content-Type':'application/json'},...opts});
    if(!r.ok){ if(window._controlPanelSyncFail===undefined) window._controlPanelSyncFail=true; return null; }
    return await r.json();
  }catch(e){ if(window._controlPanelSyncFail===undefined) window._controlPanelSyncFail=true; return null; }
}
/** Run once on load: ping backend and show sync status (Backend: OK / Unavailable). */
async function checkBackendSync(){
  const el = document.getElementById('backendSyncStatus');
  if(!el) return;
  try {
    const r = await fetch(API.brain + '/autopilot', { method: 'GET', headers: { 'Content-Type': 'application/json' } });
    if(r.ok){ el.textContent = 'Backend: OK'; el.className = 'backend-sync ok'; }
    else { el.textContent = 'Backend: Unavailable'; el.className = 'backend-sync off'; }
  } catch(e) { el.textContent = 'Backend: Unavailable'; el.className = 'backend-sync off'; }
}

// â”€â”€â”€ EXECUTION TOKEN (sessionStorage; for X-Execution-Token on protected routes) â”€â”€â”€
const EXECUTION_TOKEN_KEY = 'daena_execution_token';
function getExecutionToken(){ try{ return sessionStorage.getItem(EXECUTION_TOKEN_KEY) || null; }catch(e){ return null; } }
function setExecutionToken(val){ try{ if(val) sessionStorage.setItem(EXECUTION_TOKEN_KEY, val); else sessionStorage.removeItem(EXECUTION_TOKEN_KEY); }catch(e){} }
function clearExecutionToken(){ setExecutionToken(null); document.getElementById('executionTokenInput').value=''; loadExecutionAuthStatus(); loadExecution(); }
/** Call execution API with X-Execution-Token when set. Use for /tools, /config, /run, etc. /logs and /request stay token-free. */
async function apiExecution(url,opts={}){
  const token = getExecutionToken();
  const headers = {'Content-Type':'application/json',...(opts.headers||{})};
  if(token) headers['X-Execution-Token'] = token;
  try{
    const r = await fetch(url, { ...opts, headers });
    if(!r.ok) return null;
    return await r.json();
  }catch(e){ return null; }
}
async function loadExecutionAuthStatus(){
  const res = await apiRequest(API.execution+'/auth-status');
  const msgEl = document.getElementById('executionAuthMessage');
  const badgeEl = document.getElementById('executionAuthBadge');
  const rowEl = document.getElementById('executionTokenRow');
  if(!res || !msgEl) return;
  msgEl.textContent = res.message || 'â€”';
  if(res.localhost_bypass){ badgeEl.textContent = 'Local dev (no token)'; badgeEl.className = 'badge badge-active'; rowEl.style.display = 'none'; }
  else if(!res.execution_enabled){ badgeEl.textContent = 'Disabled'; badgeEl.className = 'badge badge-pending'; rowEl.style.display = 'none'; }
  else if(res.token_required_for_ui){ badgeEl.textContent = getExecutionToken() ? 'Token set' : 'Token needed'; badgeEl.className = 'badge ' + (getExecutionToken() ? 'badge-active' : 'badge-pending'); rowEl.style.display = 'flex'; }
  else { badgeEl.textContent = 'OK'; badgeEl.className = 'badge badge-active'; rowEl.style.display = 'none'; }
}
function saveExecutionToken(){
  const val = document.getElementById('executionTokenInput').value.trim();
  setExecutionToken(val || null);
  loadExecutionAuthStatus();
  loadExecution();
  if(window.showToast) window.showToast(val ? 'Token saved for this session' : 'Token cleared', 'info');
}

// â”€â”€â”€ LOAD TAB DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTabData(tab){
  switch(tab){
    case 'brain':        loadBrain();break;
    case 'defi':         loadDefi();break;
    case 'skills':       loadSkills();break;
    case 'packages':     loadPackages();break;
    case 'governance':    loadAutopilotFromBackend(); loadGovernance(); loadAwareness(); break;
    case 'execution':    loadExecution();break;
    case 'daenabot-tools': loadDaenaBotTools();break;
    case 'integrations': loadIntegrations();break;
    case 'proactive':    loadProactive();break;
    case 'council':      loadCouncil();break;
    case 'trust':        loadTrust();break;
    case 'shadow':       loadShadow();break;
    case 'treasury':     loadTreasury();break;
    case 'agents':       loadAgents();break;
  }
}

// â”€â”€â”€ BRAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBrain(){
  const mem=await apiRequest(API.memory+'/stats');
  if(mem){
    const l1=mem.l1||0,l2=mem.l2||0,l3=mem.l3||0;
    document.getElementById('brainL1').textContent=l1;
    document.getElementById('brainL2').textContent=l2;
    document.getElementById('brainL3').textContent=l3;
    document.getElementById('tierL1Val').textContent=l1;
    document.getElementById('tierL2Val').textContent=l2;
    document.getElementById('tierL3Val').textContent=l3;
  }
  const res=await apiRequest(API.research+'/history');
  if(res&&res.length){
    document.getElementById('brainQueries').textContent=res.filter(r=>{const d=new Date(r.created_at||0);return(Date.now()-d)<86400000}).length;
  }
  const sources=await apiRequest(API.research+'/sources');
  if(sources){
    document.getElementById('researchSources').innerHTML=sources.map(s=>`<tr>
      <td class="td-mono">${s.name||''}</td>
      <td>${s.type||''}</td>
      <td><span class="badge badge-active">Active</span></td>
      <td class="td-mono">${timeAgo(s.last_used)}</td>
    </tr>`).join('')||'<tr><td colspan="4" class="empty-state">No sources</td></tr>';
  }
}

// â”€â”€â”€ DEFI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDefi(){
  const tools=await apiRequest(API.defi+'/tools');
  if(tools){
    document.getElementById('defiTools').innerHTML=tools.map(t=>`<tr>
      <td class="td-mono">${t.name}</td>
      <td class="td-mono">${t.version||'â€”'}</td>
      <td><span class="badge ${t.installed?'badge-active':'badge-pending'}">${t.installed?'Installed':'Not Found'}</span></td>
    </tr>`).join('')||'<tr><td colspan="3" class="empty-state">No tools</td></tr>';
  }
}
async function startDefiScan(){
  const val=document.getElementById('defiInput').value.trim();
  if(!val)return;
  addFeed('defiFeed',new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}),'amber',`<strong>Scanning</strong> ${val}â€¦`);
  const r=await apiRequest(API.defi+'/scan',{method:'POST',body:JSON.stringify({contract_path:val})});
  if(r){
    addFeed('defiFeed',new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}),'green',`<strong>Scan started</strong> ID: ${r.scan_id||'â€”'}`);
    loadDefiResults();
  }
}
async function loadDefiResults(){
  const results=await apiRequest(API.defi+'/results');
  if(results&&results.length){
    document.getElementById('defiScans').textContent=results.length;
    const vulns=results.reduce((a,r)=>a+(r.vulnerabilities||0),0);
    document.getElementById('defiVulns').textContent=vulns;
    document.getElementById('defiCritical').textContent=results.reduce((a,r)=>a+(r.critical||0),0);
    document.getElementById('defiOK').textContent=results.filter(r=>!(r.vulnerabilities)).length;
    document.getElementById('defiResults').innerHTML=results.map(r=>`<tr>
      <td class="td-mono">${r.contract||'â€”'}</td>
      <td><span class="badge ${r.status==='complete'?'badge-active':'badge-pending'}">${r.status||'â€”'}</span></td>
      <td>${r.vulnerabilities||0}</td>
      <td class="td-mono">${timeAgo(r.created_at)}</td>
      <td><button class="btn" onclick="viewDefiReport('${r.scan_id}')">Report</button></td>
    </tr>`).join('');
  }
}
function viewDefiReport(id){
  apiRequest(API.defi+'/report/'+id).then(r=>{if(r){document.getElementById('approveTitle').textContent='DeFi Scan Report';document.getElementById('approveDetails').textContent=JSON.stringify(r,null,2);document.getElementById('approveNotes').value='';openModal('approve')}});
}

// â”€â”€â”€ SKILLS (sync: GET /api/v1/skills, GET /stats, POST /toggle) â”€â”€â”€
async function loadSkills(){
  const tableEl = document.getElementById('skillsTable');
  const setTable = (html) => { if (tableEl) tableEl.innerHTML = html; };
  try {
    const stats = await apiRequest(API.skills+'/stats');
    const totalEl = document.getElementById('skillTotal');
    const activeEl = document.getElementById('skillActive');
    const pendingEl = document.getElementById('skillPending');
    const selfEl = document.getElementById('skillSelf');
    if (totalEl) totalEl.textContent = (stats && stats.total != null) ? stats.total : 'â€”';
    if (activeEl) activeEl.textContent = (stats && stats.active != null) ? stats.active : 'â€”';
    if (pendingEl) pendingEl.textContent = (stats && stats.pending != null) ? stats.pending : 'â€”';
    if (selfEl) selfEl.textContent = (stats && stats.self_created != null) ? stats.self_created : 'â€”';

    const url = operatorRoleFilter ? (API.skills + '?operator_role=' + encodeURIComponent(operatorRoleFilter)) : API.skills;
    const res = await apiRequest(url);
    const skills = (res && res.skills && Array.isArray(res.skills)) ? res.skills : (Array.isArray(res) ? res : []);
    let list = skills;
    if (skillFilter !== 'all') list = list.filter(s => (s.enabled ? 'active' : 'disabled') === skillFilter);
    if (skillCategoryFilter) list = list.filter(s => (s.category || '').toLowerCase() === skillCategoryFilter);
    if (skillRiskFilter) list = list.filter(s => (s.risk || '').toLowerCase() === skillRiskFilter);
    if (skillApprovalFilter) list = list.filter(s => (s.approval_policy || 'auto') === skillApprovalFilter);
    if (skillStatusFilter) list = list.filter(s => (s.enabled ? 'active' : 'disabled') === skillStatusFilter);
    if (skillSearchQuery) { const q = skillSearchQuery.toLowerCase(); list = list.filter(s => ((s.name||'')+(s.description||'')).toLowerCase().includes(q)); }
    window._lastSkillsList = list;
    const operatorToggles = (s) => {
      const a = s.access || {};
      const roles = (a.allowed_roles || []).map(r=>r.toLowerCase());
      const idSafe = (s.id||'').toString().replace(/"/g,'&quot;');
      const idEsc = (s.id||'').toString().replace(/'/g,"\\'");
      const isRegistry = s.source === 'registry';
      const F = (label, role) => {
        const on = roles.includes(role);
        if (!isRegistry) return `<span class="badge badge-${on?'active':'pending'}" style="font-size:9px">${label}</span>`;
        return `<button type="button" class="operator-chip ${on?'on':''}" onclick="patchSkillAccess('${idEsc}','${role}',${!on})" title="Toggle ${label}">${label}</button>`;
      };
      const moreBtn = isRegistry ? `<button type="button" class="btn" style="padding:2px 6px;font-size:10px;margin-left:2px" data-skill-id="${idSafe}" onclick="openAccessMorePanel(this)" title="Departments / Agents">â‹¯</button>` : '';
      return F('Founder','founder') + F('Daena','daena') + F('Agents','agent') + moreBtn;
    };
    const approvalLabel = (p) => { const v = (p || 'auto'); return v === 'always_approval' ? 'Always' : v === 'approval_required' ? 'Needs approval' : 'Auto'; };
    setTable(list.map(s => {
      const status = s.enabled ? 'active' : 'disabled';
      const creator = (s.creator || 'â€”').toString().replace(/</g, '&lt;');
      const idSafe = (s.id || '').toString().replace(/"/g, '&quot;').replace(/</g, '&lt;');
      const idEsc = (s.id || '').toString().replace(/'/g, "\\'");
      const name = (s.name || '').toString().replace(/</g, '&lt;');
      const idShort = (s.id || '').toString().replace(/</g, '&lt;').slice(0, 24);
      const risk = (s.risk || 'â€”').toString().replace(/</g, '&lt;').toLowerCase();
      const cat = (s.category || 'â€”').toString().replace(/</g, '&lt;');
      const approval = approvalLabel(s.approval_policy);
      const uses = (s.usage_count != null) ? s.usage_count : 0;
      const checked = skillSelectAllChecked || selectedSkillIds.has(s.id) ? ' checked' : '';
      const canEdit = s.source === 'registry';
      return `<tr>
        <td><input type="checkbox" class="skill-row-cb" data-skill-id="${idSafe}" ${checked} onclick="toggleSkillSelection(this)" ${canEdit ? '' : 'disabled'}/></td>
        <td><strong>${name}</strong><div style="font-size:10px;color:var(--text-dim)">${idShort}${(s.id && s.id.length > 24) ? 'â€¦' : ''}</div></td>
        <td><span class="badge badge-pending" style="font-size:10px">${cat}</span></td>
        <td style="font-size:10px;display:flex;flex-wrap:wrap;gap:4px;align-items:center">${operatorToggles(s)}</td>
        <td><span class="badge badge-${risk==='high'?'pending':risk==='medium'?'pending':'active'}" style="font-size:10px">${approval}</span></td>
        <td><span class="badge badge-${risk==='high'?'high':risk==='medium'?'medium':'low'}" style="font-size:10px">${risk}</span></td>
        <td class="td-mono">${creator}</td>
        <td>${uses}</td>
        <td style="white-space:nowrap">
          <button class="btn" style="padding:3px 8px;font-size:10px" onclick="toggleSkill('${idEsc}',${!s.enabled})">${s.enabled ? 'Disable' : 'Enable'}</button>
          ${canEdit ? `<button class="btn" style="padding:3px 8px;font-size:10px;margin-left:2px" onclick="openEditSkillModal('${idEsc}')" title="Edit">Edit</button>` : ''}
          ${canEdit ? `<button class="btn btn-danger" style="padding:3px 8px;font-size:10px;margin-left:2px" onclick="archiveSkill('${idEsc}')" title="Archive (soft-delete)">Archive</button>` : ''}
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="9" class="empty-state">No skills found</td></tr>');
    updateSkillBulkBar();
  } catch (e) {
    setTable('<tr><td colspan="9" class="empty-state">Error loading skills: ' + (e.message || String(e)).replace(/</g, '&lt;') + '</td></tr>');
  }
}
async function toggleSkill(id,enabled){
  await apiExecution(API.skills+'/toggle',{method:'POST',body:JSON.stringify({skill_id:id,enabled})});
  loadSkills();
}
async function archiveSkill(id){
  if (!confirm('Archive this skill? It will be soft-deleted and removed from the list.')) return;
  const r = await apiRequest(API.skills+'/'+encodeURIComponent(id), { method: 'DELETE' });
  if (r && r.success) { if(window.showToast) window.showToast('Skill archived','success'); loadSkills(); }
  else if(window.showToast) window.showToast(r?.detail||'Archive failed','error');
}
function toggleSkillSelectAll(checkbox){
  skillSelectAllChecked = checkbox && checkbox.checked;
  document.querySelectorAll('.skill-row-cb:not([disabled])').forEach(cb=>{ cb.checked = skillSelectAllChecked; if(skillSelectAllChecked) selectedSkillIds.add(cb.getAttribute('data-skill-id')); else selectedSkillIds.delete(cb.getAttribute('data-skill-id')); });
  updateSkillBulkBar();
}
function toggleSkillSelection(checkbox){
  const id = checkbox && checkbox.getAttribute('data-skill-id');
  if(!id) return;
  if(checkbox.checked) selectedSkillIds.add(id); else selectedSkillIds.delete(id);
  skillSelectAllChecked = false;
  if(document.getElementById('skillSelectAll')) document.getElementById('skillSelectAll').checked = false;
  updateSkillBulkBar();
}
function updateSkillBulkBar(){
  const bar = document.getElementById('skillBulkBar');
  const countEl = document.getElementById('skillBulkCount');
  if(bar && countEl){ const n = selectedSkillIds.size; countEl.textContent = n; bar.style.display = n ? 'flex' : 'none'; }
}
function clearSkillSelection(){
  selectedSkillIds.clear();
  skillSelectAllChecked = false;
  const cb = document.getElementById('skillSelectAll'); if(cb) cb.checked = false;
  document.querySelectorAll('.skill-row-cb').forEach(c=>c.checked = false);
  updateSkillBulkBar();
}
async function bulkUpdateAccessSkills(){
  const ids = Array.from(selectedSkillIds);
  if(!ids.length) return;
  const rolesStr = prompt('Set allowed_roles (comma-separated): founder, daena, agent');
  if(rolesStr === null) return;
  const roles = rolesStr.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(s=>['founder','daena','agent'].includes(s));
  if(!roles.length){ if(window.showToast) window.showToast('Enter at least one role: founder, daena, agent','error'); return; }
  for(const id of ids){
    const s = window._lastSkillsList && window._lastSkillsList.find(x=>x.id===id);
    if(!s || s.source !== 'registry') continue;
    await apiRequest(API.skills+'/'+encodeURIComponent(id)+'/access', { method:'PATCH', body: JSON.stringify({ allowed_roles: roles }) });
  }
  if(window.showToast) window.showToast('Access updated for '+ids.length+' skill(s)','success');
  clearSkillSelection(); loadSkills();
}
async function bulkDisableSkills(){
  const ids = Array.from(selectedSkillIds);
  if(!ids.length) return;
  if(!confirm('Disable '+ids.length+' skill(s)?')) return;
  for(const id of ids){
    await apiRequest(API.skills+'/toggle', { method:'POST', body: JSON.stringify({ skill_id: id, enabled: false }) });
  }
  if(window.showToast) window.showToast('Disabled '+ids.length+' skill(s)','success');
  clearSkillSelection(); loadSkills();
}
async function bulkArchiveSkills(){
  const ids = Array.from(selectedSkillIds);
  if(!ids.length) return;
  if(!confirm('Archive '+ids.length+' skill(s)? They will be soft-deleted.')) return;
  for(const id of ids){
    const s = window._lastSkillsList && window._lastSkillsList.find(x=>x.id===id);
    if(s && s.source === 'registry') await apiRequest(API.skills+'/'+encodeURIComponent(id), { method: 'DELETE' });
  }
  if(window.showToast) window.showToast('Archived '+ids.length+' skill(s)','success');
  clearSkillSelection(); loadSkills();
}
let _accessMoreSkillId = '';
function openAccessMorePanel(btn){
  const skillId = btn && (btn.getAttribute&&btn.getAttribute('data-skill-id'));
  if(!skillId) return;
  const s = window._lastSkillsList && window._lastSkillsList.find(x=>x.id===skillId);
  if(!s || s.source !== 'registry') return;
  _accessMoreSkillId = skillId;
  const a = s.access || {};
  document.getElementById('accessMoreDepts').value = (a.allowed_departments || []).join(', ');
  document.getElementById('accessMoreAgents').value = (a.allowed_agents || []).join(', ');
  openModal('access-more');
}
async function saveAccessMore(){
  if(!_accessMoreSkillId) return;
  const depts = (document.getElementById('accessMoreDepts').value||'').split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
  const agents = (document.getElementById('accessMoreAgents').value||'').split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);
  const s = window._lastSkillsList && window._lastSkillsList.find(x=>x.id===_accessMoreSkillId);
  const roles = (s && s.access && s.access.allowed_roles) ? s.access.allowed_roles : [];
  const res = await apiRequest(API.skills+'/'+encodeURIComponent(_accessMoreSkillId)+'/access', { method:'PATCH', body: JSON.stringify({ allowed_roles: roles, allowed_departments: depts, allowed_agents: agents }) });
  if(res && res.success){ if(window.showToast) window.showToast('Access updated','success'); closeModal('access-more'); loadSkills(); }
  else if(window.showToast) window.showToast(res?.detail||'Update failed','error');
  _accessMoreSkillId = '';
}
async function openEditSkillModal(id){
  const res = await apiRequest(API.skills+'/'+encodeURIComponent(id));
  const s = res && res.skill;
  if(!s){ if(window.showToast) window.showToast('Skill not found','error'); return; }
  if(s.source !== 'registry'){ if(window.showToast) window.showToast('Only registry skills can be edited','error'); return; }
  document.getElementById('editSkillId').value = id;
  document.getElementById('newSkillName').value = s.name || s.id || '';
  document.getElementById('newSkillDisplay').value = s.display_name || s.name || '';
  document.getElementById('newSkillDesc').value = s.description || '';
  const cat = (s.category || s.category_slug || 'utility').toLowerCase();
  setSkillCategory(cat);
  document.getElementById('newSkillCat').value = cat;
  setSkillCreator((s.creator || 'founder').toLowerCase());
  document.getElementById('newSkillCreator').value = s.creator || 'founder';
  const a = s.access || {};
  const roles = (a.allowed_roles || []).map(r=>r.toLowerCase());
  document.getElementById('accessFounder').checked = roles.includes('founder');
  document.getElementById('accessDaena').checked = roles.includes('daena');
  document.getElementById('accessDeptAgents').checked = roles.includes('agent');
  const depts = a.allowed_departments || [];
  const agents = a.allowed_agents || [];
  document.getElementById('accessSpecificDepts').checked = depts.length > 0;
  document.getElementById('accessSpecificAgents').checked = agents.length > 0;
  document.getElementById('accessDeptsList').value = depts.join(', ');
  document.getElementById('accessAgentsList').value = agents.join(', ');
  document.getElementById('accessSpecificDeptsRow').style.display = depts.length > 0 ? 'block' : 'none';
  document.getElementById('accessSpecificAgentsRow').style.display = agents.length > 0 ? 'block' : 'none';
  const risk = (s.risk_level || s.risk || 'low').toLowerCase();
  setSkillRisk(risk);
  window._newSkillRisk = risk;
  const approval = (s.approval_policy || 'auto').toLowerCase();
  setSkillApproval(approval);
  window._newSkillApproval = approval;
  document.getElementById('requiresStepUpConfirm').checked = s.requires_step_up_confirm !== false;
  const enabled = s.enabled !== false;
  const toggleEl = document.getElementById('newSkillEnabledToggle');
  if(toggleEl){ toggleEl.classList.toggle('on', enabled); toggleEl.setAttribute('aria-pressed', enabled); }
  document.getElementById('newSkillEnabledLabel').textContent = enabled ? 'On (skill can be used after save)' : 'Off (skill disabled)';
  document.getElementById('skillModalSubmit').textContent = 'Save';
  openModal('skill');
}
function createOrUpdateSkill(){
  const editId = document.getElementById('editSkillId') && document.getElementById('editSkillId').value;
  if(editId) updateSkill(editId); else createSkill();
}
async function updateSkill(id){
  const display = document.getElementById('newSkillDisplay').value?.trim() || document.getElementById('newSkillName').value?.trim();
  const desc = document.getElementById('newSkillDesc').value?.trim() || '';
  const cat = document.getElementById('newSkillCat').value || 'utility';
  const creator = document.getElementById('newSkillCreator').value || 'founder';
  const enabled = document.getElementById('newSkillEnabledToggle').classList.contains('on');
  if(!window._newSkillRisk) window._newSkillRisk = 'low'; if(!window._newSkillApproval) window._newSkillApproval = 'auto';
  const access = getNewSkillAccessScope();
  const policyObj = getNewSkillExecutionPolicy();
  const payload = { display_name: display, description: desc, category: cat, creator, enabled, access, policy: { risk_level: policyObj.risk_level, approval_policy: policyObj.approval_policy, requires_step_up_confirm: policyObj.requires_step_up_confirm } };
  try {
    const r = await apiRequest(API.skills+'/'+encodeURIComponent(id), { method: 'PUT', body: JSON.stringify(payload) });
    if(r && (r.success || r.id)){ if(window.showToast) window.showToast('Skill updated','success'); document.getElementById('editSkillId').value = ''; document.getElementById('skillModalSubmit').textContent = 'Create Skill'; closeModal('skill'); loadSkills(); }
    else if(window.showToast) window.showToast(r?.detail||'Update failed','error');
  } catch(e){ if(window.showToast) window.showToast('Failed: '+(e.message||e),'error'); }
}
function filterSkills(f,el){
  skillFilter=f;
  document.querySelectorAll('.filter-chip[data-filter]').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  loadSkills();
}
function setOperatorTab(v, el){
  operatorRoleFilter=v;
  document.querySelectorAll('.operator-tab[data-operator]').forEach(c=>c.classList.toggle('active', (c.getAttribute('data-operator')||'')===v));
  loadSkills();
}
function filterSkillsByAccess(v,el){ setOperatorTab(v,el); }
function filterSkillsByCategory(v,el){
  skillCategoryFilter=v;
  document.querySelectorAll('.filter-chip[data-skillcat]').forEach(c=>c.classList.toggle('active', (c.getAttribute('data-skillcat')||'')===v));
  loadSkills();
}
function filterSkillsByStatus(v,el){
  skillStatusFilter=v;
  document.querySelectorAll('.filter-chip[data-status]').forEach(c=>c.classList.toggle('active', (c.getAttribute('data-status')||'')===v));
  loadSkills();
}
let _skillSearchTimer;
function debouncedSkillSearch(){
  clearTimeout(_skillSearchTimer);
  _skillSearchTimer=setTimeout(()=>{ skillSearchQuery=document.getElementById('skillSearch')?.value?.trim()||''; loadSkills(); }, 280);
}
async function patchSkillAccess(skillId, role, add){
  const s = window._lastSkillsList?.find(x=>x.id===skillId); if(!s) return;
  const roles = [...(s.access?.allowed_roles||[])].map(r=>r.toLowerCase());
  const r = role.toLowerCase();
  if(add && !roles.includes(r)) roles.push(r);
  if(!add && roles.includes(r)) roles.splice(roles.indexOf(r),1);
  const res = await apiRequest(API.skills+'/'+encodeURIComponent(skillId)+'/access', { method:'PATCH', body: JSON.stringify({ allowed_roles: roles }) });
  if(res&&res.success) loadSkills(); else if(window.showToast) window.showToast(res?.detail||'Failed to update access','error');
}
function filterSkillsByRisk(v,el){
  skillRiskFilter=v;
  document.querySelectorAll('.filter-chip[data-risk]').forEach(c=>c.classList.toggle('active', c.getAttribute('data-risk')===v));
  loadSkills();
}
function filterSkillsByApproval(v,el){
  skillApprovalFilter=v;
  document.querySelectorAll('.filter-chip[data-approval]').forEach(c=>c.classList.toggle('active', c.getAttribute('data-approval')===v));
  loadSkills();
}
function setSkillCreator(v){
  document.querySelectorAll('.segmented-pill-btn[data-creator]').forEach(b=>b.classList.remove('active'));
  const btn=document.querySelector('.segmented-pill-btn[data-creator="'+v+'"]');
  if(btn)btn.classList.add('active');
  const hid=document.getElementById('newSkillCreator');
  if(hid)hid.value=v;
}
function toggleNewSkillEnabled(){
  const el=document.getElementById('newSkillEnabledToggle');
  const label=document.getElementById('newSkillEnabledLabel');
  if(!el)return;
  const on=!el.classList.contains('on');
  el.classList.toggle('on',on);
  el.setAttribute('aria-pressed',on);
  if(label)label.textContent=on?'On (skill can be used after creation)':'Off (skill disabled when created)';
}
function getNewSkillEnabled(){ return document.getElementById('newSkillEnabledToggle').classList.contains('on'); }
function setSkillCategory(v){
  document.querySelectorAll('.category-chip').forEach(btn=>{ btn.classList.toggle('active', btn.getAttribute('data-cat')===v); });
  const hid=document.getElementById('newSkillCat'); if(hid) hid.value=v;
}
function setSkillRisk(v){
  ['riskLow','riskMed','riskHigh'].forEach((id,i)=>{ const b=document.getElementById(id); if(b) b.classList.toggle('active', ['low','medium','high'][i]===v); });
  window._newSkillRisk=v;
}
function setSkillApproval(v){
  ['approvalAuto','approvalRequired','approvalAlways'].forEach((id,i)=>{ const b=document.getElementById(id); if(b) b.classList.toggle('active', ['auto','approval_required','always_approval'][i]===v); });
  window._newSkillApproval=v;
}
function initAccessScopeToggles(){
  const cbDepts=document.getElementById('accessSpecificDepts'), rowDepts=document.getElementById('accessSpecificDeptsRow');
  const cbAgents=document.getElementById('accessSpecificAgents'), rowAgents=document.getElementById('accessSpecificAgentsRow');
  if(cbDepts&&rowDepts) cbDepts.addEventListener('change',function(){ rowDepts.style.display=this.checked?'block':'none'; });
  if(cbAgents&&rowAgents) cbAgents.addEventListener('change',function(){ rowAgents.style.display=this.checked?'block':'none'; });
}
function getNewSkillAccessScope(){
  const roles=[]; if(document.getElementById('accessFounder')?.checked) roles.push('founder'); if(document.getElementById('accessDaena')?.checked) roles.push('daena'); if(document.getElementById('accessDeptAgents')?.checked) roles.push('agent');
  let depts=[], agents=[]; if(document.getElementById('accessSpecificDepts')?.checked){ const r=document.getElementById('accessDeptsList')?.value?.trim()||''; if(r) depts=r.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean); }
  if(document.getElementById('accessSpecificAgents')?.checked){ const r=document.getElementById('accessAgentsList')?.value?.trim()||''; if(r) agents=r.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean); }
  return { allowed_roles: roles, allowed_departments: depts, allowed_agents: agents };
}
function getNewSkillExecutionPolicy(){ return { risk_level: window._newSkillRisk||'low', approval_policy: window._newSkillApproval||'auto', requires_step_up_confirm: document.getElementById('requiresStepUpConfirm')?.checked!==false }; }
async function createSkill(){
  const name=document.getElementById('newSkillName').value?.trim();
  const display=document.getElementById('newSkillDisplay').value?.trim()||name;
  const desc=document.getElementById('newSkillDesc').value?.trim()||'';
  const cat=document.getElementById('newSkillCat').value||'utility';
  const creator=document.getElementById('newSkillCreator').value||'founder';
  const enabled=getNewSkillEnabled();
  const code=document.getElementById('newSkillCode').value?.trim()||'';
  if(!name){ if(window.showToast) window.showToast('Enter a skill name','error'); return; }
  if(!window._newSkillRisk) window._newSkillRisk='low'; if(!window._newSkillApproval) window._newSkillApproval='auto';
  const access=getNewSkillAccessScope();
  const policy=getNewSkillExecutionPolicy();
  try {
    const payload={ name, display_name: display, description: desc, category: cat, creator, enabled, code_body: code, access, risk_level: policy.risk_level, approval_policy: policy.approval_policy, requires_step_up_confirm: policy.requires_step_up_confirm };
    const r=await apiRequest(API.skills,{method:'POST',body:JSON.stringify(payload)});
    if(r&&(r.id||r.skill_id||r.success)){ if(window.showToast) window.showToast('Skill created','success'); closeModal('skill'); loadSkills(); }
    else{ if(window.showToast) window.showToast(r?.detail||r?.error||'Skill creation: use backend API','info'); closeModal('skill'); loadSkills(); }
  } catch(e){ if(window.showToast) window.showToast('Failed: '+(e.message||e),'error'); }
}

// â”€â”€â”€ PACKAGES (sync: GET /, GET /stats, POST /audit, POST /audit/{id}/run|approve|reject|install) â”€â”€â”€
async function loadPackages(){
  const stats=await apiRequest(API.packages+'/stats');
  if(stats){
    document.getElementById('pkgTotal').textContent=stats.total||stats.queued||0;
    document.getElementById('pkgPending').textContent=stats.pending||stats.pending_approval||0;
    document.getElementById('pkgApproved').textContent=stats.approved||0;
    document.getElementById('pkgRejected').textContent=stats.rejected||0;
  }
  const res=await apiRequest(API.packages+'/');
  const records=(res&&res.records)||[];
  const idKey=(r)=>r.id||r.record_id||r.audit_id||'';
  document.getElementById('pkgTable').innerHTML=records.map(p=>{
    const id=idKey(p);
    const status=(p.status||'').toLowerCase();
    const risk=(p.risk_level||p.risk||'â€”').toLowerCase();
    let actions='';
    if(status==='pending_approval') actions=`<button class="btn btn-green" style="padding:3px 8px;font-size:10px" onclick="approvePkg('${id}')">âœ“</button> <button class="btn btn-danger" style="padding:3px 8px;font-size:10px" onclick="rejectPkg('${id}')">âœ—</button>`;
    else if(status==='approved') actions=`<button class="btn btn-gold" style="padding:3px 8px;font-size:10px" onclick="installPkg('${id}')">Install</button>`;
    if(status==='queued'||status==='pending_audit') actions+=`<button class="btn btn-primary" style="padding:3px 8px;font-size:10px" onclick="auditPkg('${id}')">Run Audit</button>`;
    return `<tr><td class="td-mono"><strong>${p.package_name||p.name||'â€”'}</strong></td><td class="td-mono">${p.version||'â€”'}</td><td>${p.manager||'â€”'}</td><td><span class="badge badge-${risk}">${p.risk_level||p.risk||'â€”'}</span></td><td><span class="badge badge-${status}">${p.status||'â€”'}</span></td><td>${actions}</td></tr>`;
  }).join('')||'<tr><td colspan="6" class="empty-state">No packages</td></tr>';
}
async function requestPackage(){
  const payload={package_name:document.getElementById('newPkgName').value,version:document.getElementById('newPkgVer').value||'latest',manager:document.getElementById('newPkgMgr').value||'npm',requested_by:document.getElementById('newPkgBy').value||'founder'};
  if(!payload.package_name)return;
  await apiRequest(API.packages+'/audit',{method:'POST',body:JSON.stringify(payload)});
  closeModal('package');loadPackages();
}
async function auditPkg(id){await apiRequest(API.packages+'/audit/'+id+'/run',{method:'POST'});loadPackages()}
async function approvePkg(id){await apiRequest(API.packages+'/audit/'+id+'/approve',{method:'POST',body:JSON.stringify({approver:'founder',notes:''})});loadPackages()}
async function rejectPkg(id){await apiRequest(API.packages+'/audit/'+id+'/reject',{method:'POST',body:JSON.stringify({reason:'Founder review',rejector:'founder'})});loadPackages()}
async function installPkg(id){await apiRequest(API.packages+'/audit/'+id+'/install',{method:'POST'});loadPackages()}

// â”€â”€â”€ GOVERNANCE (sync: GET /stats, GET /pending, POST /approve, POST /reject with body.decision_id) â”€â”€â”€
async function loadGovernance(){
  const stats=await apiRequest(API.governance+'/stats');
  if(stats){
    document.getElementById('govAuto').textContent=stats.auto_approved||0;
    document.getElementById('govPending').textContent=stats.pending||0;
    document.getElementById('govToday').textContent=stats.today||0;
    document.getElementById('govBlocked').textContent=stats.blocked||0;
  }
  const pendRes=await apiRequest(API.governance+'/pending');
  const pending=(pendRes&&pendRes.pending)||[];
  const decisionId=(a)=>a.decision_id||a.id||'';
  if(pending.length){
    document.getElementById('govPendingTable').innerHTML=pending.map(a=>{
      const id=decisionId(a);
      const desc=(a.description||a.action||'').replace(/'/g,"\\'");
      return `<tr><td><strong>${a.action_type||a.action||'â€”'}</strong><div style="font-size:10px;color:var(--text-dim)">${a.description||''}</div></td><td><span class="badge badge-${(a.risk_level||a.risk||'').toLowerCase()}">${a.risk_level||a.risk||'â€”'}</span></td><td class="td-mono">${a.agent_id||a.agent||'â€”'}</td><td class="td-mono">${timeAgo(a.created_at)}</td><td><button class="btn btn-green" style="padding:3px 8px;font-size:10px" onclick="openApproveModal('${id}','${(a.action_type||a.action||'').slice(0,30)}','${desc.slice(0,200)}')">Approve</button> <button class="btn btn-danger" style="padding:3px 8px;font-size:10px" onclick="openRejectModal('${id}')">Reject</button></td></tr>`;
    }).join('');
  } else {
    document.getElementById('govPendingTable').innerHTML='<tr><td colspan="5" class="empty-state">No pending actions â€” Autopilot handling everything</td></tr>';
  }
  const logRes=await apiRequest(API.execution+'/logs');
  const log=(logRes&&logRes.logs)||[];
  if(log.length){
    document.getElementById('govLogTable').innerHTML=log.slice(0,20).map(a=>`<tr><td><strong>${a.tool||a.action||'â€”'}</strong></td><td><span class="badge badge-${(a.risk||'').toLowerCase()}">${a.risk||'â€”'}</span></td><td><span class="badge badge-active">${a.status||'â€”'}</span></td><td class="td-mono">${timeAgo(a.timestamp||a.created_at)}</td></tr>`).join('');
  } else {
    document.getElementById('govLogTable').innerHTML='<tr><td colspan="4" class="empty-state">No execution log yet â€” <a href="#" onclick="loadTabData(\'execution\');return false" class="link">View Execution</a></td></tr>';
  }
}
function openApproveModal(id,action,details){
  currentApproveId=id;
  document.getElementById('approveTitle').textContent='Approve: '+action;
  document.getElementById('approveDetails').textContent=details;
  document.getElementById('approveNotes').value='';
  openModal('approve');
}
function openRejectModal(id){currentApproveId=id;document.getElementById('approveTitle').textContent='Reject Action';document.getElementById('approveDetails').textContent='Reject this action?';document.getElementById('approveNotes').value='';openModal('approve')}
async function approveAction(){
  if(!currentApproveId)return;
  await apiRequest(API.governance+'/approve',{method:'POST',body:JSON.stringify({decision_id:currentApproveId,approver_id:'founder',notes:document.getElementById('approveNotes').value})});
  closeModal('approve');loadGovernance();
}
async function rejectAction(){
  if(!currentApproveId)return;
  await apiRequest(API.governance+'/reject',{method:'POST',body:JSON.stringify({decision_id:currentApproveId,approver_id:'founder',notes:document.getElementById('approveNotes').value||'Founder rejected'})});
  closeModal('approve');loadGovernance();
}

// â”€â”€â”€ EXECUTION (sync: GET /logs [no token], GET /tools, /config [with token via apiExecution]) â”€â”€â”€
async function loadExecution(){
  await loadExecutionAuthStatus();
  const logRes=await apiRequest(API.execution+'/logs');
  const logs=(logRes&&logRes.logs)||[];
  const table=document.getElementById('executionLogTable');
  if(table){
    table.innerHTML=logs.slice(0,50).map(e=>`<tr><td class="td-mono">${timeAgo(e.timestamp||e.time)}</td><td>${e.tool||e.name||'â€”'}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${(e.result||e.status||'â€”').toString().slice(0,80)}</td></tr>`).join('')||'<tr><td colspan="3" class="empty-state">No execution log yet</td></tr>';
  }
  let toolsCount = 0;
  const toolsRes = await apiExecution(API.execution+'/tools');
  if(toolsRes&&toolsRes.tools) toolsCount = toolsRes.tools.length;
  const capEl=document.getElementById('capabilitySummary');
  if(capEl) capEl.textContent = toolsCount ? `${logs.length} log entries; ${toolsCount} tools available to Daena (subject to approval).` : logs.length+' log entries. Tools list requires Execution token or localhost bypass.';
}

// â”€â”€â”€ DAENABOT TOOLS (sync: GET /status, /queue, /history; POST /{id}/approve, /{id}/reject) â”€â”€â”€
async function loadDaenaBotTools(){
  try {
    const statusRes = await apiRequest(API.tools+'/status');
    const status = statusRes || {};
    const connected = status.connected === true;
    const displayName = status.display_name || 'DaenaBot';
    const el = document.getElementById('toolsGatewayStatus');
    if(el) { el.textContent = connected ? 'Connected' : 'Disconnected'; el.style.color = connected ? 'var(--green)' : 'var(--text-dim)'; }
    const sub = document.getElementById('toolsGatewaySub');
    if(sub) sub.textContent = status.authenticated ? 'Authenticated' : 'Connection';
    document.getElementById('toolsDisplayName').textContent = displayName;
    const label = document.getElementById('daenabot-tools-label');
    if(label) label.textContent = displayName + ' Tools';

    const queueRes = await apiRequest(API.tools+'/queue');
    const pending = (queueRes && queueRes.pending) || [];
    document.getElementById('toolsPendingCount').textContent = pending.length;
    const badge = document.getElementById('daenabot-tools-badge');
    if(badge) { badge.textContent = pending.length; badge.style.display = pending.length ? 'inline' : 'none'; }

    const queueTable = document.getElementById('toolsQueueTable');
    if(queueTable) {
      queueTable.innerHTML = pending.length ? pending.map(r=>{
        const action = r.action_json || {};
        const actionStr = (action.action_type || action.tool_name || action.type || JSON.stringify(action).slice(0,40)).toString().replace(/</g,'&lt;');
        const idSafe = (r.id||'').toString().replace(/'/g,"\\'");
        return `<tr><td class="td-mono">${timeAgo(r.created_at)}</td><td>${(r.requested_by||'â€”').toString().replace(/</g,'&lt;')}</td><td><span class="badge badge-${(r.risk_level||'medium').toLowerCase()}">${(r.risk_level||'â€”').toString().replace(/</g,'&lt;')}</span></td><td class="td-mono" style="max-width:180px;overflow:hidden;text-overflow:ellipsis">${actionStr}</td><td><button class="btn" style="padding:3px 8px;font-size:10px;margin-right:4px" onclick="approveToolRequest('${idSafe}')">Approve</button><button class="btn" style="padding:3px 8px;font-size:10px" onclick="rejectToolRequest('${idSafe}')">Reject</button></td></tr>`;
      }).join('') : '<tr><td colspan="5" class="empty-state">No pending requests</td></tr>';
    }

    const historyRes = await apiRequest(API.tools+'/history');
    const history = (historyRes && historyRes.history) || [];
    const historyTable = document.getElementById('toolsHistoryTable');
    if(historyTable) {
      historyTable.innerHTML = history.length ? history.slice(0,20).map(r=>{
        const action = r.action_json || {};
        const actionStr = (action.action_type || action.tool_name || action.type || 'â€”').toString().replace(/</g,'&lt;');
        const resultStr = r.result_json ? (r.result_json.success === true ? 'OK' : (r.result_json.error || 'Failed')) : (r.status === 'rejected' ? 'Rejected' : r.status || 'â€”');
        return `<tr><td class="td-mono">${timeAgo(r.created_at)}</td><td>${(r.requested_by||'â€”').toString().replace(/</g,'&lt;')}</td><td><span class="badge">${(r.risk_level||'â€”').toString().replace(/</g,'&lt;')}</span></td><td><span class="badge badge-${(r.status||'').toLowerCase()}">${(r.status||'â€”').toString().replace(/</g,'&lt;')}</span></td><td class="td-mono">${resultStr.toString().replace(/</g,'&lt;').slice(0,30)}</td></tr>`;
      }).join('') : '<tr><td colspan="5" class="empty-state">No history</td></tr>';
    }
  } catch (e) {
    const q = document.getElementById('toolsQueueTable');
    if(q) q.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading: ' + (e.message || String(e)).replace(/</g,'&lt;') + '</td></tr>';
    const h = document.getElementById('toolsHistoryTable');
    if(h) h.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading history</td></tr>';
  }
}
async function testHandsConnection(){
  const btn = document.getElementById('pingHandsBtn');
  const resultEl = document.getElementById('pingHandsResult');
  if(btn) btn.disabled = true;
  if(resultEl) resultEl.textContent = 'Checkingâ€¦';
  try {
    const r = await apiRequest(API.hands + '/status');
    const ok = r && (r.configured === true && r.reachable === true);
    const msg = (r && r.message) ? r.message : (r && r.reachable ? 'Connected' : 'Disconnected');
    if(resultEl) {
      resultEl.textContent = msg;
      resultEl.style.color = ok ? 'var(--green)' : (r && r.configured ? 'var(--text-dim)' : 'var(--red)');
    }
    if(window.showToast) window.showToast(msg, ok ? 'success' : 'error');
    loadDaenaBotTools();
  } catch (e) {
    if(resultEl) { resultEl.textContent = (e.message || String(e)).slice(0,60); resultEl.style.color = 'var(--red)'; }
    if(window.showToast) window.showToast('Check failed: ' + (e.message || e), 'error');
  }
  if(btn) btn.disabled = false;
}
async function approveToolRequest(id){
  if(!id) return;
  try {
    await apiRequest(API.tools+'/'+encodeURIComponent(id)+'/approve', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ approver:'founder', notes:'' }) });
    if(window.showToast) window.showToast('Request approved and executed', 'success');
    loadDaenaBotTools();
  } catch (e) {
    if(window.showToast) window.showToast('Approve failed: ' + (e.message || e), 'error');
    loadDaenaBotTools();
  }
}
async function rejectToolRequest(id){
  if(!id) return;
  try {
    await apiRequest(API.tools+'/'+encodeURIComponent(id)+'/reject', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reason:'Founder rejected', rejector:'founder' }) });
    if(window.showToast) window.showToast('Request rejected', 'info');
    loadDaenaBotTools();
  } catch (e) {
    if(window.showToast) window.showToast('Reject failed: ' + (e.message || e), 'error');
    loadDaenaBotTools();
  }
}

// â”€â”€â”€ INTEGRATIONS (sync: GET /, GET /mcp-servers) â”€â”€â”€
async function loadIntegrations(){
  const list=await apiRequest(API.integrations);
  const integrations=(list&&list.integrations)||(Array.isArray(list)?list:[]);
  document.getElementById('intTotal').textContent=integrations.length||0;
  const mcpRes=await apiRequest(API.integrations+'/mcp-servers');
  const mcp=(mcpRes&&mcpRes.servers)||(mcpRes&&mcpRes.mcp_servers)||[];
  document.getElementById('intMcp').textContent=mcp.length||0;
  const table=document.getElementById('integrationsTable');
  if(table) table.innerHTML=integrations.map(i=>`<tr><td>${i.name||i.id||'â€”'}</td><td><span class="badge badge-${(i.status||'unknown').toLowerCase()}">${i.status||'â€”'}</span></td><td>${i.type||'â€”'}</td></tr>`).join('')||'<tr><td colspan="3" class="empty-state">No integrations</td></tr>';
  const mcpTable=document.getElementById('mcpServersTable');
  if(mcpTable) mcpTable.innerHTML=mcp.map(s=>`<tr><td>${s.name||s.id||'â€”'}</td><td class="td-mono">${(s.url||s.endpoint||'â€”').toString().slice(0,40)}</td><td>${s.status||'â€”'}</td></tr>`).join('')||'<tr><td colspan="3" class="empty-state">No MCP servers</td></tr>';
}

// â”€â”€â”€ PROACTIVE (sync: GET /rules, GET /events) â”€â”€â”€
async function loadProactive(){
  const rulesRes=await apiRequest(API.proactive+'/rules');
  const rules=(rulesRes&&rulesRes.rules)||(Array.isArray(rulesRes)?rulesRes:[]);
  document.getElementById('proactiveRulesList').innerHTML=rules.length?rules.map(r=>`<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">${r.name||r.id||'â€”'}: ${(r.schedule||r.trigger||'â€”')}</div>`).join(''):'<p class="text-dim">No proactive rules</p>';
  const eventsRes=await apiRequest(API.proactive+'/events');
  const events=(eventsRes&&eventsRes.events)||(Array.isArray(eventsRes)?eventsRes:[]);
  document.getElementById('proactiveEventsList').innerHTML=events.length?events.slice(0,20).map(e=>`<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:11px">${timeAgo(e.timestamp||e.time)} â€” ${(e.type||e.name||'â€”').toString().slice(0,40)}</div>`).join(''):'<p class="text-dim">No recent events</p>';
}

// â”€â”€â”€ COUNCIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCouncil(){
  const debates=await apiRequest(API.council+'/debates');
  if(debates&&debates.length){
    document.getElementById('councilActive').textContent=debates.filter(d=>d.status==='active').length;
    document.getElementById('councilResolved').textContent=debates.filter(d=>d.status==='resolved').length;
    document.getElementById('councilPending').textContent=debates.filter(d=>d.status==='pending_vote').length;
    document.getElementById('councilExperts').textContent=[...new Set(debates.flatMap(d=>d.experts||[]))].length;
    document.getElementById('councilTable').innerHTML=debates.map(d=>`<tr>
      <td><strong>${d.topic||'â€”'}</strong></td>
      <td><span class="badge badge-${d.status==='active'?'active':'pending'}">${d.status||'â€”'}</span></td>
      <td>${(d.experts||[]).length}</td>
      <td class="td-mono">${timeAgo(d.created_at)}</td>
    </tr>`).join('');
  } else {
    document.getElementById('councilTable').innerHTML='<tr><td colspan="4" class="empty-state">No active debates</td></tr>';
  }
}

// â”€â”€â”€ TRUST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTrust(){
  const stats=await apiRequest(API.integrity+'/stats');
  if(stats){
    document.getElementById('trustVerified').textContent=stats.verifications||0;
    document.getElementById('trustBlocked').textContent=stats.injections_blocked||0;
    document.getElementById('trustSources').textContent=stats.trusted_sources||0;
    document.getElementById('trustStripped').textContent=stats.stripped||0;
  }
  const sources=await apiRequest(API.integrity+'/sources');
  if(sources&&sources.length){
    document.getElementById('trustTable').innerHTML=sources.map(s=>`<tr>
      <td class="td-mono">${s.name||'â€”'}</td>
      <td>${s.trust_score!=null?Math.round(s.trust_score*100)+'%':'â€”'}</td>
      <td><span class="badge badge-${s.trusted?'active':'pending'}">${s.trusted?'Trusted':'Unverified'}</span></td>
      <td class="td-mono">${timeAgo(s.last_checked)}</td>
    </tr>`).join('');
  } else {
    document.getElementById('trustTable').innerHTML='<tr><td colspan="4" class="empty-state">No sources tracked</td></tr>';
  }
}
async function verifyContent(){
  const content=document.getElementById('verifyContent').value;
  const source=document.getElementById('verifySource').value;
  if(!content)return;
  const r=await apiRequest(API.integrity+'/verify',{method:'POST',body:JSON.stringify({content,source})});
  closeModal('verify');
  if(r){addFeed('trustFeed',new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}),r.safe?'green':'red',`<strong>Verify result:</strong> ${r.safe?'Safe âœ“':'BLOCKED âœ—'} â€” ${r.reason||''}`)}
}

// â”€â”€â”€ SHADOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadShadow(){
  const stats=await apiRequest(API.shadow+'/stats');
  if(stats){
    document.getElementById('shadowHoney').textContent=stats.honeypots||0;
    document.getElementById('shadowCanary').textContent=stats.canaries||0;
    document.getElementById('shadowAlerts').textContent=stats.alerts_24h||0;
    document.getElementById('shadowTTPs').textContent=stats.ttps||0;
  }
  const honeypots=await apiRequest(API.shadow+'/honeypots');
  if(honeypots&&honeypots.length){
    document.getElementById('shadowTable').innerHTML=honeypots.map(h=>`<tr>
      <td class="td-mono">${h.path||'â€”'}</td>
      <td>${h.type||'â€”'}</td>
      <td>${h.hits||0}</td>
      <td class="td-mono">${timeAgo(h.last_hit)}</td>
    </tr>`).join('');
  } else {
    document.getElementById('shadowTable').innerHTML='<tr><td colspan="4" class="empty-state">No honeypots configured</td></tr>';
  }
}

// â”€â”€â”€ TREASURY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTreasury(){
  try {
    const r = await apiRequest(API.treasury + '/status');
    if (r && r.success) {
      document.getElementById('treasDaena').textContent = String(r.daena_balance ?? '0');
      document.getElementById('treasNFT').textContent = String(r.nft_minted ?? 0);
      document.getElementById('treasETH').textContent = String(r.eth_held ?? '0');
      document.getElementById('treasSpend').textContent = String(r.monthly_spend ?? '$0');
      const txs = r.transactions || [];
      document.getElementById('treasTable').innerHTML = txs.length
        ? txs.map(t => `<tr><td>${t.type || 'â€”'}</td><td>${t.amount || 'â€”'}</td><td>${t.approved_by || 'â€”'}</td><td>${t.time || 'â€”'}</td></tr>`).join('')
        : '<tr><td colspan="4" class="empty-state">No transactions yet</td></tr>';
    } else {
      _setTreasuryPlaceholder();
    }
  } catch (e) {
    _setTreasuryPlaceholder();
  }
}
function _setTreasuryPlaceholder(){
  document.getElementById('treasDaena').textContent = '0';
  document.getElementById('treasNFT').textContent = '0';
  document.getElementById('treasETH').textContent = '0';
  document.getElementById('treasSpend').textContent = '$0';
  document.getElementById('treasTable').innerHTML = '<tr><td colspan="4" class="empty-state">Treasury API unavailable â€” check backend</td></tr>';
}

// â”€â”€â”€ AGENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAgents(){
  // Simulated agent registry (will wire to real agent service)
  const depts=['Research','Security','DeFi','Communication','Data','Operations','Innovation','Strategy'];
  const agents=depts.flatMap(d=>[
    {name:`${d} Lead`,dept:d,status:'online',last:'Just now',actions:Math.floor(Math.random()*20)},
    {name:`${d} Analyst`,dept:d,status:Math.random()>.3?'online':'idle',last:timeAgo(Date.now()-Math.random()*3600000),actions:Math.floor(Math.random()*10)}
  ]);
  document.getElementById('agentOnline').textContent=agents.filter(a=>a.status==='online').length;
  document.getElementById('agentActions').textContent=agents.reduce((s,a)=>s+a.actions,0);
  document.getElementById('agentDepts').textContent=depts.length;
  document.getElementById('agentPending').textContent=Math.floor(Math.random()*5);
  document.getElementById('agentsTable').innerHTML=agents.map(a=>`<tr>
    <td><strong>${a.name}</strong></td>
    <td>${a.dept}</td>
    <td><span class="badge badge-${a.status}">${a.status}</span></td>
    <td class="td-mono">${a.last}</td>
    <td>${a.actions}</td>
  </tr>`).join('');
}

// â”€â”€â”€ RESEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runResearch(){
  const query=document.getElementById('researchQuery').value;
  const sources=document.getElementById('researchSrc').value;
  if(!query)return;
  addFeed('brainFeed',new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}),'blue',`<strong>Research:</strong> "${query.slice(0,60)}â€¦"`);
  await apiRequest(API.research+'/query',{method:'POST',body:JSON.stringify({query,sources})});
  closeModal('research');
}

// â”€â”€â”€ UTIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(ts){
  if(!ts)return 'â€”';
  const d=typeof ts==='number'?ts:new Date(ts).getTime();
  const diff=Date.now()-d;
  if(diff<60000)return 'Just now';
  if(diff<3600000)return Math.floor(diff/60000)+'m ago';
  if(diff<86400000)return Math.floor(diff/3600000)+'h ago';
  return Math.floor(diff/86400000)+'d ago';
}

// â”€â”€â”€ CAPABILITY HANDSHAKE (on load: tools + MCP for Daena awareness) â”€â”€â”€
async function runCapabilityHandshake(){
  try{
    const logRes=await apiRequest(API.execution+'/logs');
    const mcpRes=await apiRequest(API.integrations+'/mcp-servers');
    const logCount=(logRes&&logRes.logs) ? logRes.logs.length : 0;
    const mcpCount=(mcpRes&&mcpRes.servers) ? mcpRes.servers.length : (mcpRes&&mcpRes.mcp_servers ? mcpRes.mcp_servers.length : 0);
    const el=document.getElementById('executionCapSummary');
    if(el) el.textContent='Execution logs: '+logCount+' | MCP servers: '+mcpCount+'. Daena can use tools and integrations (subject to approval).';
  }catch(e){}
}

// â”€â”€â”€ INIT (run when DOM ready so Skills table and stats elements exist) â”€â”€â”€
function initControlPanel(){
  connectWS();
  checkBackendSync();
  loadAutopilotFromBackend();
  loadAwareness();
  loadSkills();
  runCapabilityHandshake();
  initAccessScopeToggles();
  window._newSkillRisk='low'; window._newSkillApproval='auto';
  setInterval(function(){
    const active=document.querySelector('.tab-btn.active');
    if(active)loadTabData(active.dataset.tab);
  },30000);
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',initControlPanel); }
else { initControlPanel(); }
</script>
{% endblock %}
