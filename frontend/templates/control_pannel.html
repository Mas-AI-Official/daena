{% extends "base.html" %}
{# Control Pannel: do NOT open this file directly (file://). Use the server: http://127.0.0.1:8000/ui/control-pannel #}
{% block title %}Daena — Control Pannel{% endblock %}
{% block head %}
<style>
  /* Control Pannel: match Daena VP (base) — gold, glass, same font sizes (13–16px) */
  .control-plane-content {
    --gold: var(--daena-gold);
    --gold-dim: #a07a2e;
    --card: var(--glass-bg);
    --card-hover: rgba(255, 255, 255, .08);
    --surface: rgba(0, 0, 0, .25);
    --border: var(--glass-border);
    --border-light: rgba(255, 255, 255, .15);
    --text: #e5e7eb;
    --text-dim: #9CA3AF;
    --text-bright: #fff;
    --green: #3ecf8e;
    --blue: #5b9bd5;
    --amber: #f0a84b;
    --red: #e05565;
    --purple: #9b7bea;
    --cyan: #4dd9e6;
    --radius: 10px;
    --radius-lg: 14px;
    --transition: .18s ease;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text);
  }

  /* ─── LAYOUT: SIDEBAR + MAIN ─── */
  .shell {
    display: flex;
    height: 100vh
  }

  /* SIDEBAR */
  .sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .sidebar-logo {
    padding: 20px 18px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-logo svg {
    width: 28px;
    height: 28px;
    flex-shrink: 0
  }

  .sidebar-logo-text {
    font-family: var(--font-mono);
    font-size: 16px;
    font-weight: 600;
    color: var(--gold);
    letter-spacing: 2px;
    text-transform: uppercase
  }

  .sidebar-logo-sub {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 1px
  }

  .sidebar-section-label {
    font-size: 9px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 18px 18px 6px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 18px;
    color: var(--text-dim);
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    font-size: 13px;
    white-space: nowrap;
    border-left: 3px solid transparent;
    position: relative;
  }

  .nav-item:hover {
    background: var(--card);
    color: var(--text)
  }

  .nav-item.active {
    background: var(--card);
    color: var(--gold);
    border-left-color: var(--gold);
  }

  .nav-item svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: .6
  }

  .nav-item.active svg,
  .nav-item:hover svg {
    opacity: 1
  }

  .nav-item .badge {
    margin-left: auto;
    background: var(--red);
    color: #fff;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 8px;
  }

  .sidebar-bottom {
    margin-top: auto;
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--gold), var(--amber));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 11px;
    color: #0a0e14
  }

  .sidebar-bottom-info {
    flex: 1;
    min-width: 0
  }

  .sidebar-bottom-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-bright);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis
  }

  .sidebar-bottom-role {
    font-size: 10px;
    color: var(--text-dim)
  }

  .backend-sync {
    font-size: 10px;
    margin-top: 6px;
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-block
  }

  .backend-sync.ok {
    background: rgba(34, 197, 94, .2);
    color: var(--green)
  }

  .backend-sync.off {
    background: rgba(239, 68, 68, .2);
    color: var(--red)
  }

  /* MAIN CONTENT */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden
  }

  /* Navbar/topbar: use base + partials/topbar (no overrides so Dashboard, Control Pannel, Web3/DeFi match) */

  /* AGI AUTOPILOT TOGGLE (in-page only) */
  .autopilot-wrap {
    display: flex;
    align-items: center;
    gap: 8px
  }

  .autopilot-label {
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 500
  }

  .toggle-switch {
    width: 40px;
    height: 22px;
    border-radius: 11px;
    background: var(--border);
    position: relative;
    cursor: pointer;
    transition: background .2s;
    border: 1px solid var(--border-light);
  }

  .toggle-switch.on {
    background: var(--green);
    border-color: var(--green)
  }

  .toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #fff;
    transition: left .2s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .3);
  }

  .toggle-switch.on::after {
    left: 20px
  }

  /* Segmented pill (Creator: Founder | Daena | Agent) — dark theme, no white dropdown */
  .segmented-pill {
    display: inline-flex;
    gap: 0;
    border-radius: var(--radius);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2px
  }

  .segmented-pill-btn {
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dim);
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 2px);
    cursor: pointer;
    transition: var(--transition)
  }

  .segmented-pill-btn:hover {
    color: var(--text);
    background: var(--card)
  }

  .segmented-pill-btn.active {
    background: var(--gold);
    color: #0a0a0a;
    border-color: var(--gold)
  }

  /* Category chips (single-select, no native select) */
  .category-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px
  }

  .category-chip {
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition)
  }

  .category-chip:hover {
    color: var(--text);
    border-color: var(--gold);
    background: var(--card)
  }

  .category-chip.active {
    background: var(--gold);
    color: #0a0a0a;
    border-color: var(--gold)
  }

  /* Access scope checkboxes */
  .access-scope-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 20px;
    align-items: center
  }

  .access-scope-row label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text)
  }

  .access-scope-row input[type=checkbox] {
    accent-color: var(--gold)
  }

  .operator-chip {
    padding: 3px 8px;
    font-size: 10px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
    cursor: pointer;
    transition: var(--transition)
  }

  .operator-chip:hover {
    color: var(--text);
    border-color: var(--gold)
  }

  .operator-chip.on {
    background: var(--gold);
    color: #0a0a0a;
    border-color: var(--gold)
  }

  .operator-tabs {
    display: inline-flex;
    gap: 2px
  }

  .operator-tab {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
    cursor: pointer;
    transition: var(--transition)
  }

  .operator-tab:hover {
    color: var(--text)
  }

  .operator-tab.active {
    background: var(--gold);
    color: #0a0a0a;
    border-color: var(--gold)
  }

  .form-hint {
    margin-top: 2px
  }

  .tooltip-wrap {
    position: relative;
    display: inline-block
  }

  .tooltip-wrap[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 0;
    bottom: 100%;
    margin-bottom: 4px;
    padding: 6px 8px;
    font-size: 10px;
    max-width: 240px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    white-space: normal;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .3)
  }

  .autopilot-mode {
    font-size: 10px;
    font-weight: 600;
    color: var(--green);
    text-transform: uppercase;
    letter-spacing: .5px
  }

  .autopilot-mode.manual {
    color: var(--amber)
  }

  /* TAB NAVIGATION */
  .tab-nav {
    display: flex;
    gap: 2px;
    padding: 10px 24px 0;
    background: var(--surface);
    flex-shrink: 0;
    overflow-x: auto;
    border-bottom: 1px solid var(--border);
  }

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 12px;
    font-family: var(--font-sans);
    border-radius: var(--radius) var(--radius) 0 0;
    white-space: nowrap;
    transition: var(--transition);
    position: relative;
    bottom: -1px;
    pointer-events: auto;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  .tab-btn:hover {
    background: var(--card);
    color: var(--text)
  }

  .tab-btn.active {
    background: var(--card);
    color: var(--text-bright);
    border-bottom: 2px solid var(--gold)
  }

  .tab-btn svg {
    width: 14px;
    height: 14px;
    opacity: .5
  }

  .tab-btn.active svg {
    opacity: 1;
    color: var(--gold)
  }

  .tab-btn .tab-badge {
    font-size: 9px;
    background: var(--red);
    color: #fff;
    padding: 1px 5px;
    border-radius: 6px;
    font-weight: 600;
  }

  /* CONTENT AREA */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    background: var(--bg)
  }

  .tab-panel {
    display: none
  }

  .tab-panel.active {
    display: block
  }

  /* Awareness Banner */
  .awareness-banner {
    background: var(--red);
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 8px 16px;
    text-align: center;
    position: relative;
    z-index: 100;
    width: 100%;
    margin-bottom: 12px;
    border-radius: var(--radius);
  }

  /* ─── SHARED COMPONENTS ─── */

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 14px 16px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .stat-card:hover {
    border-color: var(--border-light);
    box-shadow: var(--shadow)
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px
  }

  .stat-card.c-blue::before {
    background: var(--blue)
  }

  .stat-card.c-green::before {
    background: var(--green)
  }

  .stat-card.c-amber::before {
    background: var(--amber)
  }

  .stat-card.c-red::before {
    background: var(--red)
  }

  .stat-card.c-purple::before {
    background: var(--purple)
  }

  .stat-card.c-cyan::before {
    background: var(--cyan)
  }

  .stat-card.c-gold::before {
    background: var(--gold)
  }

  .stat-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: .8px;
    font-weight: 500;
    margin-bottom: 6px
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 22px;
    font-weight: 700;
    color: var(--text-bright)
  }

  .stat-value.c-blue {
    color: var(--blue)
  }

  .stat-value.c-green {
    color: var(--green)
  }

  .stat-value.c-amber {
    color: var(--amber)
  }

  .stat-value.c-red {
    color: var(--red)
  }

  .stat-value.c-purple {
    color: var(--purple)
  }

  .stat-value.c-cyan {
    color: var(--cyan)
  }

  .stat-value.c-gold {
    color: var(--gold)
  }

  .stat-sub {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 3px
  }

  /* Section Header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    display: flex;
    align-items: center;
    gap: 8px
  }

  .section-title svg {
    width: 15px;
    height: 15px;
    color: var(--gold)
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
    background: var(--card);
    color: var(--text);
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    white-space: nowrap;
  }

  .btn:hover {
    background: var(--card-hover);
    border-color: var(--blue);
    color: var(--text-bright)
  }

  .btn-primary {
    background: var(--blue);
    border-color: var(--blue);
    color: #fff
  }

  .btn-primary:hover {
    background: var(--blue-dim);
    border-color: var(--blue-dim)
  }

  .btn-green {
    background: var(--green);
    border-color: var(--green);
    color: #0a0e14;
    font-weight: 600
  }

  .btn-green:hover {
    background: var(--green-dim);
    border-color: var(--green-dim)
  }

  .btn-danger {
    background: transparent;
    border-color: var(--red);
    color: var(--red)
  }

  .btn-danger:hover {
    background: var(--red);
    color: #fff
  }

  .btn-gold {
    background: var(--gold);
    border-color: var(--gold);
    color: #0a0e14;
    font-weight: 600
  }

  .btn-gold:hover {
    background: var(--gold-dim);
    border-color: var(--gold-dim)
  }

  .btn svg {
    width: 12px;
    height: 12px
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: .3px;
    text-transform: uppercase
  }

  .badge-active {
    background: rgba(62, 207, 142, .12);
    color: var(--green)
  }

  .badge-pending {
    background: rgba(240, 168, 75, .12);
    color: var(--amber)
  }

  .badge-approved {
    background: rgba(91, 155, 213, .12);
    color: var(--blue)
  }

  .badge-rejected {
    background: rgba(224, 85, 101, .12);
    color: var(--red)
  }

  .badge-sandbox {
    background: rgba(155, 123, 234, .12);
    color: var(--purple)
  }

  .badge-draft {
    background: rgba(45, 160, 170, .12);
    color: var(--cyan)
  }

  .badge-safe {
    background: rgba(62, 207, 142, .12);
    color: var(--green)
  }

  .badge-low {
    background: rgba(91, 155, 213, .12);
    color: var(--blue)
  }

  .badge-medium {
    background: rgba(240, 168, 75, .12);
    color: var(--amber)
  }

  .badge-high {
    background: rgba(224, 85, 101, .12);
    color: var(--red)
  }

  .badge-critical {
    background: rgba(224, 85, 101, .25);
    color: var(--red);
    font-weight: 700
  }

  .badge-online {
    background: rgba(62, 207, 142, .12);
    color: var(--green)
  }

  .badge-idle {
    background: rgba(107, 127, 149, .15);
    color: var(--text-dim)
  }

  /* Table */
  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 16px
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px
  }

  th {
    text-align: left;
    padding: 10px 14px;
    background: var(--card);
    color: var(--text-dim);
    font-weight: 500;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: .8px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle
  }

  tr:last-child td {
    border-bottom: none
  }

  tr:hover td {
    background: rgba(22, 29, 42, .5)
  }

  .td-mono {
    font-family: var(--font-mono);
    font-size: 11px
  }

  /* Live Feed */
  .live-feed {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    max-height: 280px;
    overflow-y: auto;
  }

  .feed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
  }

  .feed-live {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--red);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px
  }

  .feed-live::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--red);
    animation: pulse 1.5s infinite
  }

  @keyframes pulse {

    0%,
    100% {
      opacity: 1
    }

    50% {
      opacity: .3
    }
  }

  .feed-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    animation: feedIn .3s ease;
    font-size: 11px;
  }

  .feed-item:last-child {
    border-bottom: none
  }

  @keyframes feedIn {
    from {
      opacity: 0;
      transform: translateY(-4px)
    }

    to {
      opacity: 1;
      transform: translateY(0)
    }
  }

  .feed-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
    padding-top: 1px;
    width: 46px
  }

  .feed-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px
  }

  .feed-dot.blue {
    background: var(--blue)
  }

  .feed-dot.green {
    background: var(--green)
  }

  .feed-dot.amber {
    background: var(--amber)
  }

  .feed-dot.red {
    background: var(--red)
  }

  .feed-dot.purple {
    background: var(--purple)
  }

  .feed-text {
    flex: 1;
    color: var(--text)
  }

  .feed-text strong {
    color: var(--text-bright)
  }

  .feed-empty {
    padding: 24px;
    text-align: center;
    color: var(--text-dim);
    font-size: 11px
  }

  /* Two-col layout */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px
  }

  .two-col.wide {
    grid-template-columns: 2fr 1fr
  }

  /* Input / Form */
  .input {
    width: 100%;
    padding: 8px 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-bright);
    font-size: 12px;
    font-family: inherit;
    transition: var(--transition);
  }

  .input:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 2px rgba(91, 155, 213, .15)
  }

  .input::placeholder {
    color: var(--text-dim)
  }

  textarea.input {
    resize: vertical;
    min-height: 80px;
    font-family: var(--font-mono);
    font-size: 11px
  }

  select.input {
    appearance: none;
    cursor: pointer
  }

  /* Modal: closed overlays must not block clicks */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
    pointer-events: none;
  }

  .modal-overlay.open {
    display: flex;
    pointer-events: auto
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    width: 480px;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
  }

  .modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 22px;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-bright)
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 18px;
    padding: 2px 6px;
    border-radius: 4px
  }

  .modal-close:hover {
    background: var(--card);
    color: var(--text)
  }

  .modal-body {
    padding: 22px
  }

  .form-row {
    margin-bottom: 14px
  }

  .form-label {
    display: block;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: .5px
  }

  .form-row-inline {
    display: flex;
    gap: 10px
  }

  .form-row-inline .form-row {
    flex: 1
  }

  .modal-foot {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    padding: 14px 22px;
    border-top: 1px solid var(--border);
  }

  /* Think-Plan-Act Pipeline indicator */
  .pipeline {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 16px
  }

  .pipeline-step {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 14px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: .5px;
    text-transform: uppercase;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text-dim);
    transition: var(--transition);
  }

  .pipeline-step.active {
    background: rgba(91, 155, 213, .12);
    border-color: var(--blue);
    color: var(--blue)
  }

  .pipeline-step.done {
    background: rgba(62, 207, 142, .12);
    border-color: var(--green);
    color: var(--green)
  }

  .pipeline-arrow {
    color: var(--border);
    font-size: 12px
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 5px;
    height: 5px
  }

  ::-webkit-scrollbar-track {
    background: transparent
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--border-light)
  }

  /* Filter row */
  .filter-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px
  }

  .filter-chip {
    padding: 4px 10px;
    border-radius: 14px;
    font-size: 11px;
    cursor: pointer;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text-dim);
    transition: var(--transition);
  }

  .filter-chip:hover,
  .filter-chip.active {
    border-color: var(--blue);
    color: var(--blue);
    background: rgba(91, 155, 213, .08)
  }

  /* Operator Tabs */
  .operator-tabs {
    display: flex;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 3px;
    gap: 2px;
  }

  .operator-tab {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    background: transparent;
    border: none;
    color: var(--text-dim);
    transition: all 0.2s ease;
  }

  .operator-tab:hover {
    color: var(--text);
  }

  .operator-tab.active {
    background: var(--surface);
    color: var(--blue);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  /* Operator Chips (inside table) */
  .operator-chip {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 600;
    cursor: pointer;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text-dim);
    transition: all 0.2s;
  }

  .operator-chip.on {
    background: rgba(91, 155, 213, 0.1);
    border-color: var(--blue);
    color: var(--blue);
  }

  /* Empty state */
  .empty-state {
    padding: 40px;
    text-align: center;
    color: var(--text-dim);
    font-size: 12px
  }

  .empty-state svg {
    width: 32px;
    height: 32px;
    opacity: .3;
    margin-bottom: 8px;
    display: block;
    margin-left: auto;
    margin-right: auto
  }

  /* Brain-specific: memory tiers */
  .tier-row {
    display: flex;
    gap: 10px;
    margin-bottom: 16px
  }

  .tier-card {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 12px 14px;
  }

  .tier-card.l1 {
    border-top: 2px solid var(--green)
  }

  .tier-card.l2 {
    border-top: 2px solid var(--blue)
  }

  .tier-card.l3 {
    border-top: 2px solid var(--purple)
  }

  .tier-name {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px
  }

  .tier-val {
    font-family: var(--font-mono);
    font-size: 18px;
    font-weight: 600
  }

  .tier-card.l1 .tier-val {
    color: var(--green)
  }

  .tier-card.l2 .tier-val {
    color: var(--blue)
  }

  .tier-card.l3 .tier-val {
    color: var(--purple)
  }

  .tier-desc {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 3px
  }

  /* DeFi scan box */
  .scan-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-bottom: 16px;
  }

  .scan-input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end
  }

  .scan-input-row .form-row {
    flex: 1;
    margin-bottom: 0
  }

  /* Responsive */
  @media(max-width:900px) {

    .two-col,
    .two-col.wide {
      grid-template-columns: 1fr
    }
  }

  .control-plane-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
    flex: 1
  }

  @media(max-width:700px) {
    .tab-nav {
      flex-wrap: wrap
    }

    .content {
      padding: 12px
    }
  }

  /* Quintessence Expert Grid */
  .expert-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }

  .expert-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 12px;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
  }

  .expert-card:hover {
    border-color: var(--purple);
    background: rgba(147, 112, 219, 0.1);
    transform: translateY(-2px);
  }

  .expert-icon {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .expert-name {
    font-weight: 600;
    font-size: 11px;
    color: var(--text);
    margin-bottom: 2px;
  }

  .expert-title {
    font-size: 9px;
    color: var(--text-dim);
  }

  .precedent-item {
    padding: 10px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }

  .precedent-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .deliberation-step {
    padding: 8px 0;
    font-size: 12px;
    border-left: 2px solid var(--purple);
    padding-left: 12px;
    margin-bottom: 12px;
  }
</style>
{% endblock %}
{% block content %}
<script>
  (function () {
    if (typeof location !== 'undefined' && (location.protocol === 'file:' || !location.origin || String(location.origin).indexOf('file') === 0)) {
      var el = document.body || document.documentElement;
      if (el) { el.insertAdjacentHTML(el === document.body ? 'afterbegin' : 'afterbegin', '<div id="file-protocol-banner" style="position:fixed;top:0;left:0;right:0;z-index:10000;background:#b45309;color:#fff;padding:14px 20px;font-size:14px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.4);font-family:sans-serif;"><strong>Control Pannel must be opened via the server.</strong> You opened this as a file (<code>file://</code>), so panels and backend will not sync. Start the backend, then open: <a href="http://127.0.0.1:8000/ui/control-pannel" style="color:#fff;text-decoration:underline;font-weight:bold;">http://127.0.0.1:8000/ui/control-pannel</a></div>'); document.body && (document.body.style.paddingTop = '56px'); }
    }
  })();
</script>
<div class="control-plane-content">
  <!-- TAB BAR (sections inside page; sidebar from base) -->
  <div class="tab-nav" id="tabNav">
    <button class="tab-btn active" data-tab="skills">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 3h10v10H3z" />
        <path d="M6 6l2 2 4-3" />
      </svg>
      Skills
    </button>
    <button class="tab-btn" data-tab="daenabot">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v3.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5V12z" />
        <path d="M1 4h14M1 9h14M5 1v14M11 1v14" />
      </svg>
      DaenaBot
    </button>
    <button class="tab-btn" data-tab="use-cases">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2 2h12v4H2V2z" />
        <path d="M2 10h12v4H2v-4z" />
      </svg>
      Use Cases
    </button>
    <button class="tab-btn" data-tab="packages">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2 5l6-3 6 3v6l-6 3-6-3V5z" />
        <path d="M2 5l6 3m0 0v6m0-6l6-3" />
      </svg>
      Packages
    </button>
    <button class="tab-btn" data-tab="governance">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 1L1 5v2h14V5z" />
        <path d="M3 7v5M8 7v5M13 7v5M1 12h14" />
      </svg>
      Governance
    </button>
    <button class="tab-btn" data-tab="quintessence">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 2L2 14h12L8 2z" />
        <path d="M8 6v4M8 12h.01" />
      </svg>
      The Quintessence
    </button>
    <button class="tab-btn" data-tab="execution">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2 4h12v8H2z" />
        <path d="M6 8l2 2 4-4" />
      </svg>
      Execution
    </button>
    <button class="tab-btn" data-tab="daenabot-tools">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2 4h4v4H2z" />
        <path d="M10 4h4v4h-4z" />
        <path d="M2 10h4v2H2z" />
        <path d="M10 10h4v2h-4z" />
      </svg>
      <span id="daenabot-tools-label">DaenaBot Tools</span><span class="tab-badge" id="daenabot-tools-badge"
        style="display:none">0</span>
    </button>
    <button class="tab-btn" data-tab="integrations">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 2v4M8 10v4M4 6h8M6 4v8M10 4v8" />
      </svg>
      Integrations
    </button>
    <button class="tab-btn" data-tab="proactive">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.5 3.5l1.4 1.4M11.1 11.1l1.4 1.4M3.5 12.5l1.4-1.4M11.1 4.9l1.4-1.4" />
      </svg>
      Proactive
    </button>
    <button class="tab-btn" data-tab="council">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="5" cy="6" r="2" />
        <circle cx="11" cy="6" r="2" />
        <path d="M2 13c0-2 1.3-3 3-3s3 1 3 3" />
        <path d="M8.5 13c.3-.9 1-1.7 2.5-1.7s2.5.9 2.5 1.7" />
      </svg>
      Council
    </button>
    <button class="tab-btn" data-tab="trust">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M8 1L2 4v4c0 3.5 2.5 6.5 6 7.5 3.5-1 6-4 6-7.5V4z" />
      </svg>
      Trust
    </button>
    <button class="tab-btn" data-tab="shadow">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M2 13l4-8 3 4 3-6 2 10" />
      </svg>
      Shadow
    </button>
    <button class="tab-btn" data-tab="treasury">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="8" cy="8" r="6" />
        <path d="M8 4v8M6 5.5h3.5a1.5 1.5 0 010 3H6.5a1.5 1.5 0 000 3H10.5" />
      </svg>
      Treasury
    </button>
    <button class="tab-btn" data-tab="agents">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="5" cy="5" r="2" />
        <circle cx="11" cy="5" r="2" />
        <circle cx="8" cy="10" r="2" />
        <path d="M3 14c0-1 .9-2 2-2s2 1 2 2" />
        <path d="M6 14c0-1 .9-2 2-2s2 1 2 2" />
        <path d="M9 14c0-1 .9-2 2-2s2 1 2 2" />
      </svg>
      Agents
    </button>
    <span id="backendSyncStatus" class="backend-sync off" style="margin-left:auto;margin-right:12px">Backend: …</span>
  </div>

  <!-- Hands offline banner (shown when GET /api/v1/system/capabilities says hands_gateway is not available) -->
  <div id="handsOfflineBanner" class="awareness-banner" style="display:none">
    <span>DaenaBot can plan but cannot act (Hands offline).</span>
  </div>

  <!-- CONTENT PANELS (Brain & Web3 at /ui/brain-api and /ui/web3) -->
  <div class="content">

    <!-- DAENABOT PANEL -->
    <div class="tab-panel" data-tab="daenabot">
      <div class="section-header">
        <div class="section-title">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v3.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5V12z" />
          </svg>
          DaenaBot Automation
        </div>
      </div>

      <!-- Hands Service Status -->
      <div class="scan-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h4 style="margin:0; color:var(--text-bright);">Hands Service (Desktop Automation)</h4>
            <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">Sandboxed execution environment</div>
          </div>
          <div>
            <button class="btn btn-primary" id="pingHandsBtn" onclick="testHandsConnection()">Test Connection</button>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:20px; font-size:12px;">
          <div>Status: <span id="pingHandsResult" style="color:var(--text-dim); font-weight:600;">Unknown</span></div>
        </div>
      </div>

      <!-- Tool Approval Queue -->
      <div class="section-header" style="margin-top:24px;">
        <div class="section-title">Approval Queue <span class="badge badge-pending" id="daenabot-tools-badge"
            style="display:none; margin-left:8px;">0</span></div>
        <button class="btn" onclick="loadDaenaBotTools()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor">
            <path d="M8 2v12M2 8h12" />
          </svg> Refresh</button>
      </div>
      <div
        style="background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:0; overflow:hidden; margin-bottom:24px;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="border-bottom:1px solid var(--border); text-align:left; color:var(--text-dim);">
              <th style="padding:10px;">Time</th>
              <th style="padding:10px;">Requester</th>
              <th style="padding:10px;">Risk</th>
              <th style="padding:10px;">Action</th>
              <th style="padding:10px;">Control</th>
            </tr>
          </thead>
          <tbody id="toolsQueueTable">
            <tr>
              <td colspan="5" class="empty-state">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- History -->
      <div class="section-header">
        <div class="section-title">Execution History</div>
      </div>
      <div
        style="background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:0; overflow:hidden;">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="border-bottom:1px solid var(--border); text-align:left; color:var(--text-dim);">
              <th style="padding:10px;">Time</th>
              <th style="padding:10px;">Requester</th>
              <th style="padding:10px;">Risk</th>
              <th style="padding:10px;">Status</th>
              <th style="padding:10px;">Result</th>
            </tr>
          </thead>
          <tbody id="toolsHistoryTable">
            <tr>
              <td colspan="5" class="empty-state">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>

    <!-- ═══ SKILLS ═══ -->
    <div class="tab-panel active" id="panel-skills" data-tab="skills">
      <div class="stats-row">
        <div class="stat-card c-blue">
          <div class="stat-label">Total Skills</div>
          <div class="stat-value c-blue" id="skillTotal">—</div>
          <div class="stat-sub">Registered</div>
        </div>
        <div class="stat-card c-green">
          <div class="stat-label">Active</div>
          <div class="stat-value c-green" id="skillActive">—</div>
          <div class="stat-sub">Running</div>
        </div>
        <div class="stat-card c-amber">
          <div class="stat-label">Pending</div>
          <div class="stat-value c-amber" id="skillPending">—</div>
          <div class="stat-sub">Awaiting review</div>
        </div>
        <div class="stat-card c-purple">
          <div class="stat-label">Self-Created</div>
          <div class="stat-value c-purple" id="skillSelf">—</div>
          <div class="stat-sub">By Daena</div>
        </div>
      </div>
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 3h10v10H3z" />
            <path d="M6 6l2 2 4-3" />
          </svg> Skill Registry</div>
        <p class="text-dim" style="font-size:11px;margin:0 12px 0 0">Creator = who authored. Operators = who can run.
        </p>
      </div>
      <!-- New Unified Filter UI -->
      <div class="skill-registry-filters" style="margin-bottom:16px; display:flex; flex-direction:column; gap:12px;">
        <!-- Operators Row (Primary) -->
        <div style="display:flex; align-items:center; gap:12px; padding: 4px 0;">
          <span class="text-dim"
            style="font-size:11px; text-transform:uppercase; letter-spacing:1px; width:120px;">Operators</span>
          <div class="operator-tabs" role="group">
            <button type="button" class="operator-tab active" data-operator=""
              onclick="setOperatorTab('',this)">All</button>
            <button type="button" class="operator-tab" data-operator="founder"
              onclick="setOperatorTab('founder',this)">Founder</button>
            <button type="button" class="operator-tab" data-operator="daena"
              onclick="setOperatorTab('daena',this)">Daena</button>
            <button type="button" class="operator-tab" data-operator="agent"
              onclick="setOperatorTab('agent',this)">Agents</button>
          </div>
        </div>

        <!-- Category Row -->
        <div style="display:flex; align-items:center; gap:12px; padding: 4px 0;">
          <span class="text-dim"
            style="font-size:11px; text-transform:uppercase; letter-spacing:1px; width:120px;">Category</span>
          <div id="categoryChips" style="display:flex; flex-wrap:wrap; gap:6px;">
            <span class="filter-chip active" data-category="" onclick="filterSkillsByCategory('',this)">All</span>
            <span class="filter-chip" data-category="utility"
              onclick="filterSkillsByCategory('utility',this)">Utility</span>
            <span class="filter-chip" data-category="filesystem"
              onclick="filterSkillsByCategory('filesystem',this)">Filesystem</span>
            <span class="filter-chip" data-category="code_exec"
              onclick="filterSkillsByCategory('code_exec',this)">Code</span>
            <span class="filter-chip" data-category="security"
              onclick="filterSkillsByCategory('security',this)">Security</span>
            <span class="filter-chip" data-category="research"
              onclick="filterSkillsByCategory('research',this)">Research</span>
            <span class="filter-chip" data-category="ai_tool" onclick="filterSkillsByCategory('ai_tool',this)">AI</span>
            <span class="filter-chip" data-category="network"
              onclick="filterSkillsByCategory('network',this)">Network</span>
            <span class="filter-chip" data-category="custom"
              onclick="filterSkillsByCategory('custom',this)">Custom</span>
          </div>
        </div>

        <!-- Risk & Approval Row -->
        <div style="display:flex; align-items:center; gap:12px; padding: 4px 0; flex-wrap:wrap;">
          <div style="display:flex; align-items:center; gap:8px; margin-right:16px;">
            <span class="text-dim"
              style="font-size:11px; text-transform:uppercase; letter-spacing:1px; width:120px;">Risk Level</span>
            <span class="filter-chip active" data-risk="" onclick="filterSkillsByRisk('',this)">All</span>
            <span class="filter-chip" data-risk="low" onclick="filterSkillsByRisk('low',this)">Low</span>
            <span class="filter-chip" data-risk="medium" onclick="filterSkillsByRisk('medium',this)">Med</span>
            <span class="filter-chip" data-risk="high" onclick="filterSkillsByRisk('high',this)">High</span>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="text-dim" style="font-size:11px; text-transform:uppercase; letter-spacing:1px;">Approval</span>
            <span class="filter-chip active" data-approval="" onclick="filterSkillsByApproval('',this)">All</span>
            <span class="filter-chip" data-approval="auto" onclick="filterSkillsByApproval('auto',this)">Auto</span>
            <span class="filter-chip" data-approval="approval_required"
              onclick="filterSkillsByApproval('approval_required',this)">Required</span>
            <span class="filter-chip" data-approval="always_approval"
              onclick="filterSkillsByApproval('always_approval',this)">Always</span>
          </div>
        </div>

        <!-- Status & Search Row -->
        <div
          style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 4px 0; flex-wrap:wrap; border-top:1px solid var(--border); padding-top:12px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="text-dim"
              style="font-size:11px; text-transform:uppercase; letter-spacing:1px; width:120px;">Status</span>
            <span class="filter-chip active" data-status="" onclick="filterSkillsByStatus('',this)">All</span>
            <span class="filter-chip" data-status="active" onclick="filterSkillsByStatus('active',this)">Enabled</span>
            <span class="filter-chip" data-status="disabled"
              onclick="filterSkillsByStatus('disabled',this)">Disabled</span>
          </div>
          <div style="display:flex; align-items:center; gap:8px; flex-grow:1; max-width:400px;">
            <input type="text" class="input" id="skillSearch" placeholder="Search skills by name or description..."
              style="font-size:12px;flex-grow:1" oninput="debouncedSkillSearch()" />
            <button class="btn btn-primary" onclick="openSkillCreateModal()">+ New Skill</button>
            <button class="btn" onclick="resetAllSkillFilters()" title="Reset all filters"><i
                class="fas fa-undo"></i></button>
          </div>
        </div>
      </div>
      <!-- Bulk actions bar (shown when rows selected) -->
      <div id="skillBulkBar" class="skill-bulk-bar"
        style="display:none;align-items:center;gap:10px;margin-bottom:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)">
        <span class="text-dim" style="font-size:11px"><span id="skillBulkCount">0</span> selected</span>
        <button type="button" class="btn" style="font-size:11px" onclick="bulkUpdateAccessSkills()">Bulk update
          access</button>
        <button type="button" class="btn" style="font-size:11px" onclick="bulkDisableSkills()">Bulk disable</button>
        <button type="button" class="btn btn-danger" style="font-size:11px" onclick="bulkArchiveSkills()">Bulk
          archive</button>
        <button type="button" class="btn" style="font-size:11px" onclick="clearSkillSelection()">Clear</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:36px"><input type="checkbox" id="skillSelectAll" title="Select all"
                  onclick="toggleSkillSelectAll(this)" /></th>
              <th>Name</th>
              <th>Category</th>
              <th>Operators (who can run)</th>
              <th>Approval</th>
              <th>Risk</th>
              <th>Creator</th>
              <th>Uses</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="skillsTable">
            <tr>
              <td colspan="9" class="empty-state">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ═══ USE CASES ═══ -->
    <div class="tab-panel" id="panel-use-cases" data-tab="use-cases">
      <div class="stats-row">
        <div class="stat-card c-blue">
          <div class="stat-label">Use Cases</div>
          <div class="stat-value c-blue" id="useCasesTotal">—</div>
          <div class="stat-sub">Defined</div>
        </div>
      </div>
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2 2h12v4H2V2z" />
            <path d="M2 10h12v4H2v-4z" />
          </svg> Use Case Library</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Operator scope</th>
              <th>Approval</th>
              <th>Default skills</th>
              <th>Enabled</th>
            </tr>
          </thead>
          <tbody id="useCasesTable">
            <tr>
              <td colspan="5" class="empty-state">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ═══ PACKAGES ═══ -->
    <div class="tab-panel" id="panel-packages" data-tab="packages">
      <div class="stats-row">
        <div class="stat-card c-blue">
          <div class="stat-label">Total Requests</div>
          <div class="stat-value c-blue" id="pkgTotal">—</div>
          <div class="stat-sub">All time</div>
        </div>
        <div class="stat-card c-amber">
          <div class="stat-label">Pending Audit</div>
          <div class="stat-value c-amber" id="pkgPending">—</div>
          <div class="stat-sub">In pipeline</div>
        </div>
        <div class="stat-card c-green">
          <div class="stat-label">Approved</div>
          <div class="stat-value c-green" id="pkgApproved">—</div>
          <div class="stat-sub">Ready to install</div>
        </div>
        <div class="stat-card c-red">
          <div class="stat-label">Rejected</div>
          <div class="stat-value c-red" id="pkgRejected">—</div>
          <div class="stat-sub">Blocked</div>
        </div>
      </div>
      <div class="section-header">
        <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2 5l6-3 6 3v6l-6 3-6-3V5z" />
            <path d="M2 5l6 3m0 0v6m0-6l6-3" />
          </svg> Package Audit Queue</div>
        <button class="btn btn-primary" onclick="openModal('package')">+ Request Install</button>
      </div>
      <div class="two-col wide">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Package</th>
                <th>Version</th>
                <th>Manager</th>
                <th>Risk</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="pkgTable">
              <tr>
                <td colspan="6" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="section-header">
            <div class="section-title">Audit Feed</div>
          </div>
          <div class="live-feed" id="pkgFeed">
            <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
            <div class="feed-empty">Package audit events…</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ GOVERNANCE ═══ -->
    <div class="tab-panel" id="panel-governance" data-tab="governance">
      <div class="stats-row">
        <div class="stat-card c-green">
          <div class="stat-label">Auto-Approved</div>
          <div class="stat-value c-green" id="govAuto">0</div>
          <div class="stat-sub">Autopilot actions</div>
        </div>
        <div class="stat-card c-amber">
          <div class="stat-label">Pending Approval</div>
          <div class="stat-value c-amber" id="govPending">0</div>
          <div class="stat-sub">Awaiting Founder</div>
        </div>
        <div class="stat-card c-blue">
          <div class="stat-label">Actions Today</div>
          <div class="stat-value c-blue" id="govToday">0</div>
          <div class="stat-sub">Last 24h</div>
        </div>
        <div class="stat-card c-red">
          <div class="stat-label">Blocked</div>
          <div class="stat-value c-red" id="govBlocked">0</div>
          <div class="stat-sub">High/Critical risk</div>
        </div>
      </div>

      <!-- AGI Autopilot (synced with backend: GET/POST /api/v1/brain/autopilot + governance/toggle-autopilot) -->
      <div class="autopilot-wrap" style="margin-bottom:14px">
        <span class="autopilot-label">AGI Autopilot</span>
        <div class="toggle-switch" id="autopilotToggle" onclick="toggleAutopilot()" role="button" aria-pressed="false"
          title="Toggle autopilot"></div>
        <span class="autopilot-mode" id="autopilotMode">—</span>
      </div>
      <!-- DaenaBot Awareness (GET /api/v1/system/capabilities) -->
      <div class="awareness-panel" id="awarenessPanel">
        <div class="ap-title">DaenaBot Awareness</div>
        <div class="ap-row"><span class="ap-label">Hands</span><span class="ap-value" id="awarenessHands">—</span></div>
        <div class="ap-row"><span class="ap-label">Local LLM</span><span class="ap-value" id="awarenessLLM">—</span>
        </div>
        <div class="ap-row"><span class="ap-label">Governance</span><span class="ap-value" id="awarenessGov">—</span>
        </div>
        <div class="ap-row" id="awarenessRemoteRow" style="display:none"><span class="ap-label">Security</span><span
            class="ap-value off" id="awarenessRemote">—</span></div>
      </div>
      <!-- Think-Plan-Act Pipeline Status -->
      <div class="section-header">
        <div class="section-title">Active Pipeline</div>
      </div>
      <div class="pipeline" id="pipeline">
        <div class="pipeline-step" id="pipe-think">🧠 Think</div>
        <div class="pipeline-arrow">→</div>
        <div class="pipeline-step" id="pipe-plan">📋 Plan</div>
        <div class="pipeline-arrow">→</div>
        <div class="pipeline-step" id="pipe-act">⚡ Act</div>
        <div class="pipeline-arrow">→</div>
        <div class="pipeline-step" id="pipe-report">📊 Report</div>
      </div>
      <div id="pipeline-details"
        style="font-size:11px;color:var(--text-dim);margin:-10px 0 16px 8px;min-height:16px;font-style:italic"></div>
    </div>

    <!-- ═══ THE QUINTESSENCE ═══ -->
    <div class="tab-panel" id="panel-quintessence" data-tab="quintessence">
      <div class="section-header">
        <div class="section-title">Tier 2: The Quintessence</div>
        <div class="badge badge-purple">Supreme Deliberation</div>
      </div>

      <div class="two-col wide">
        <div>
          <!-- Supreme Deliberation Form -->
          <div class="card" style="margin-bottom:16px; padding: 16px; background: var(--bg-card);">
            <div class="card-title" style="margin-bottom: 12px; font-weight: 600;">Initiate Deliberation</div>
            <div class="form-row">
              <label style="display:block; font-size: 11px; margin-bottom: 4px; color: var(--text-dim);">Strategic
                Problem</label>
              <textarea id="quintProblem" class="input"
                placeholder="Enter a high-stakes problem requiring Supreme Council review..."
                style="height:100px; width: 100%; box-sizing: border-box;"></textarea>
            </div>
            <div class="form-row">
              <label style="display:block; font-size: 11px; margin-bottom: 4px; color: var(--text-dim);">Domain</label>
              <select id="quintDomain" class="input" style="width: 100%;">
                <option value="strategic">Strategic Positioning</option>
                <option value="technical">Technical Architecture</option>
                <option value="risk">Risk & Security</option>
                <option value="org">Organizational Alignment</option>
                <option value="empirical">Empirical Validation</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="invokeQuintessence()" id="quintBtn"
              style="width:100%; margin-top: 12px;">Invoke Supreme Council</button>
          </div>

          <!-- Experts Grid -->
          <div class="expert-grid" id="expertGrid">
            <!-- Loaded via JS -->
          </div>
        </div>

        <div>
          <!-- Deliberation Results / Live Trace -->
          <div class="live-feed" id="quintResults" style="min-height:400px; background: var(--card);">
            <div class="feed-header"><span>Deliberation Trace</span><span class="feed-live" id="quintStatus">Idle</span>
            </div>
            <div class="feed-content" id="quintFeedContent" style="padding: 12px; overflow-y: auto; max-height: 500px;">
              <div class="feed-empty" id="quintEmpty">Results will appear here. No deliberation in progress.</div>
            </div>
          </div>

          <!-- Precedents Library -->
          <div class="card" style="margin-top:16px; padding: 16px; background: var(--bg-card);">
            <div class="section-header" style="justify-content: space-between;">
              <div class="section-title">Precedent Library</div>
              <input type="text" id="precedentSearch" class="input" placeholder="Search precedents..."
                style="width:150px; font-size:12px;" onkeyup="searchPrecedents()">
            </div>
            <div id="precedentList" style="max-height:300px; overflow-y:auto; font-size:12px;">
              <div style="padding: 20px; text-align: center; color: var(--text-dim);">Search for past decisions...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Pending Actions (Founder Approval Required)</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Action</th>
                <th>Risk</th>
                <th>Agent</th>
                <th>Time</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="govPendingTable">
              <tr>
                <td colspan="5" class="empty-state">No pending actions</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="section-header" style="margin-top:16px">
          <div class="section-title">Execution Log</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Action</th>
                <th>Risk</th>
                <th>Outcome</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="govLogTable">
              <tr>
                <td colspan="4" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Governance Feed</div>
        </div>
        <div class="live-feed" id="govFeed">
          <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Governance events…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ EXECUTION ═══ -->
  <div class="tab-panel" id="panel-execution" data-tab="execution">
    <div class="section-header">
      <div class="section-title"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M2 4h12v8H2z" />
        </svg> Execution Layer</div>
      <span class="text-dim" style="font-size:11px" id="executionCapSummary">—</span>
    </div>
    <p class="text-dim" style="font-size:12px;margin-bottom:12px">Tools and run history. Daena runs approved tools;
      agents submit requests for approval.</p>
    <!-- Execution token: auth-status + optional paste token for session -->
    <div class="scan-box" id="executionAuthBox" style="margin-bottom:16px">
      <div class="section-header" style="margin-bottom:8px">
        <div class="section-title">Execution auth</div><span class="badge badge-active" id="executionAuthBadge">—</span>
      </div>
      <p class="text-dim" style="font-size:11px;margin-bottom:8px" id="executionAuthMessage">Loading…</p>
      <div id="executionTokenRow" style="display:none;align-items:center;gap:8px;flex-wrap:wrap">
        <input type="password" class="input" id="executionTokenInput" placeholder="Paste EXECUTION_TOKEN (from .env)"
          style="max-width:280px;font-family:var(--font-mono);font-size:12px" autocomplete="off" />
        <button class="btn btn-primary" onclick="saveExecutionToken()">Save for session</button>
        <button class="btn" onclick="clearExecutionToken()">Clear</button>
      </div>
      <p class="text-dim" style="font-size:10px;margin-top:6px">Token is stored in sessionStorage only; use same value
        as backend <code>EXECUTION_TOKEN</code>. For local dev, set <code>ALLOW_INSECURE_EXECUTION_LOCAL=1</code> to
        skip token from 127.0.0.1.</p>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Execution Log</div><a href="#" onclick="loadExecution();return false" class="btn"
            style="font-size:11px">Refresh</a>
        </div>
        <div class="table-wrap" style="max-height:320px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Tool</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody id="executionLogTable">
              <tr>
                <td colspan="3" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Capability Handshake</div>
        </div>
        <div class="scan-box">
          <p class="text-dim" style="font-size:11px;margin-bottom:8px">On load, Control Pannel calls
            <code>/api/v1/execution/logs</code> and <code>/api/v1/integrations/mcp-servers</code>. Daena is informed
            of available tools and MCP servers (subject to approval).
          </p>
          <p id="capabilitySummary" class="text-dim" style="font-size:11px">—</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ DAENABOT TOOLS (OpenClaw / Hands) ═══ -->
  <div class="tab-panel" id="panel-daenabot-tools" data-tab="daenabot-tools">
    <div class="stats-row">
      <div class="stat-card c-blue">
        <div class="stat-label">Gateway</div>
        <div class="stat-value c-blue" id="toolsGatewayStatus">—</div>
        <div class="stat-sub" id="toolsGatewaySub">Connection</div>
      </div>
      <div class="stat-card c-amber">
        <div class="stat-label">Pending</div>
        <div class="stat-value c-amber" id="toolsPendingCount">0</div>
        <div class="stat-sub">Awaiting approval</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">Display name</div>
        <div class="stat-value c-green" id="toolsDisplayName" style="font-size:12px">—</div>
      </div>
    </div>
    <div class="section-header" style="margin-bottom:8px">
      <div class="section-title">Hands connection</div>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="pingHandsResult" class="text-dim" style="font-size:11px"></span>
        <button type="button" class="btn btn-primary" id="pingHandsBtn" onclick="testHandsConnection()">Test Hands
          Connection</button>
      </div>
    </div>
    <div class="section-header">
      <div class="section-title">Pending tool requests</div><a href="#" onclick="loadDaenaBotTools();return false"
        class="btn" style="font-size:11px">Refresh</a>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Requested by</th>
            <th>Risk</th>
            <th>Action</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="toolsQueueTable">
          <tr>
            <td colspan="5" class="empty-state">Loading…</td>
        </tbody>
      </table>
    </div>
    <div class="section-header" style="margin-top:16px">
      <div class="section-title">Hands Allowlist Configuration</div>
    </div>
    <div class="scan-box">
      <p class="text-dim" style="font-size:11px;margin-bottom:8px">Restrict file operations and shell commands to
        specific paths/commands.</p>
      <textarea class="input" id="handsAllowlist" style="height:120px; font-family:var(--font-mono); font-size:11px;"
        placeholder='{
  "files": {
    "read": ["D:/Ideas/Daena_old_upgrade_20251213/**"],
    "write": ["D:/Ideas/Daena_old_upgrade_20251213/tmp/**"]
  },
  "shell": {
    "allowed_commands": ["npm test", "git status"]
  }
}'></textarea>
      <div style="margin-top:8px; display:flex; justify-content:flex-end;">
        <button class="btn btn-primary" onclick="saveHandsAllowlist()">Update Allowlist</button>
      </div>
    </div>

    <div class="section-header" style="margin-top:16px">
      <div class="section-title">Test Action Dispatcher</div>
    </div>
    <div
      style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:16px;">
      <button class="btn" style="height:40px" onclick="testAction('browser.screenshot', {})">📸 Screenshot</button>
      <button class="btn" style="height:40px" onclick="testAction('filesystem.list', {path: './'})">📁 List
        Files</button>
      <button class="btn btn-danger" style="height:40px"
        onclick="testAction('shell.run', {command: 'echo hollow world'})">🐚 Run Shell</button>
    </div>

    <div class="section-header" style="margin-top:16px">
      <div class="section-title">Recent history</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Requested by</th>
            <th>Risk</th>
            <th>Status</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody id="toolsHistoryTable">
          <tr>
            <td colspan="5" class="empty-state">Loading…</td>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ═══ INTEGRATIONS ═══ -->
  <div class="tab-panel" id="panel-integrations" data-tab="integrations">
    <div class="stats-row">
      <div class="stat-card c-blue">
        <div class="stat-label">Integrations</div>
        <div class="stat-value c-blue" id="intTotal">—</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">MCP Servers</div>
        <div class="stat-value c-green" id="intMcp">—</div>
      </div>
    </div>
    <div class="section-header">
      <div class="section-title">Integration List</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody id="integrationsTable">
          <tr>
            <td colspan="3" class="empty-state">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="section-header" style="margin-top:16px">
      <div class="section-title">MCP Servers</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>URL</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="mcpServersTable">
          <tr>
            <td colspan="3" class="empty-state">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ═══ PROACTIVE ═══ -->
  <div class="tab-panel" id="panel-proactive" data-tab="proactive">
    <div class="section-header">
      <div class="section-title">Proactive Rules &amp; Events</div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">Rules</div>
        <div id="proactiveRulesList" class="scan-box">Loading…</div>
      </div>
      <div>
        <div class="section-header">Recent Events</div>
        <div id="proactiveEventsList" class="scan-box" style="max-height:280px;overflow:auto">Loading…</div>
      </div>
    </div>
  </div>

  <!-- ═══ COUNCIL ═══ -->
  <div class="tab-panel" id="panel-council" data-tab="council">
    <div class="stats-row">
      <div class="stat-card c-blue">
        <div class="stat-label">Active Debates</div>
        <div class="stat-value c-blue" id="councilActive">0</div>
        <div class="stat-sub">In progress</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">Resolved</div>
        <div class="stat-value c-green" id="councilResolved">0</div>
        <div class="stat-sub">Completed</div>
      </div>
      <div class="stat-card c-amber">
        <div class="stat-label">Pending Vote</div>
        <div class="stat-value c-amber" id="councilPending">0</div>
        <div class="stat-sub">Awaiting decision</div>
      </div>
      <div class="stat-card c-purple">
        <div class="stat-label">Experts</div>
        <div class="stat-value c-purple" id="councilExperts">0</div>
        <div class="stat-sub">Active members</div>
      </div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Active Debates</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Topic</th>
                <th>Status</th>
                <th>Experts</th>
                <th>Started</th>
              </tr>
            </thead>
            <tbody id="councilTable">
              <tr>
                <td colspan="4" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Council Feed</div>
        </div>
        <div class="live-feed" id="councilFeed">
          <div class="feed-header"><span>Debates</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Council activity…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ TRUST ═══ -->
  <div class="tab-panel" id="panel-trust" data-tab="trust">
    <div class="stats-row">
      <div class="stat-card c-blue">
        <div class="stat-label">Verifications</div>
        <div class="stat-value c-blue" id="trustVerified">0</div>
        <div class="stat-sub">Content checks</div>
      </div>
      <div class="stat-card c-red">
        <div class="stat-label">Injections Blocked</div>
        <div class="stat-value c-red" id="trustBlocked">0</div>
        <div class="stat-sub">Prompt attacks</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">Trusted Sources</div>
        <div class="stat-value c-green" id="trustSources">0</div>
        <div class="stat-sub">Whitelisted</div>
      </div>
      <div class="stat-card c-amber">
        <div class="stat-label">Stripped</div>
        <div class="stat-value c-amber" id="trustStripped">0</div>
        <div class="stat-sub">Sanitized inputs</div>
      </div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Verify Content</div>
          <button class="btn btn-primary" onclick="openModal('verify')">+ Verify</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Source</th>
                <th>Trust Score</th>
                <th>Status</th>
                <th>Last Check</th>
              </tr>
            </thead>
            <tbody id="trustTable">
              <tr>
                <td colspan="4" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Trust Feed</div>
        </div>
        <div class="live-feed" id="trustFeed">
          <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Trust events…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ SHADOW ═══ -->
  <div class="tab-panel" id="panel-shadow" data-tab="shadow">
    <div class="stats-row">
      <div class="stat-card c-purple">
        <div class="stat-label">Honeypots Active</div>
        <div class="stat-value c-purple" id="shadowHoney">0</div>
        <div class="stat-sub">Decoy routes</div>
      </div>
      <div class="stat-card c-cyan">
        <div class="stat-label">Canary Tokens</div>
        <div class="stat-value c-cyan" id="shadowCanary">0</div>
        <div class="stat-sub">Trip wires</div>
      </div>
      <div class="stat-card c-red">
        <div class="stat-label">Alerts 24h</div>
        <div class="stat-value c-red" id="shadowAlerts">0</div>
        <div class="stat-sub">Recent events</div>
      </div>
      <div class="stat-card c-blue">
        <div class="stat-label">TTPs Logged</div>
        <div class="stat-value c-blue" id="shadowTTPs">0</div>
        <div class="stat-sub">Attack patterns</div>
      </div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Honeypot Routes</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Decoy Path</th>
                <th>Type</th>
                <th>Hits</th>
                <th>Last Hit</th>
              </tr>
            </thead>
            <tbody id="shadowTable">
              <tr>
                <td colspan="4" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Threat Feed</div>
        </div>
        <div class="live-feed" id="shadowFeed">
          <div class="feed-header"><span>Alerts</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Shadow dept events…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ TREASURY ═══ -->
  <div class="tab-panel" id="panel-treasury" data-tab="treasury">
    <div class="stats-row">
      <div class="stat-card c-gold">
        <div class="stat-label">$DAENA Balance</div>
        <div class="stat-value c-gold" id="treasDaena">0</div>
        <div class="stat-sub">Token supply</div>
      </div>
      <div class="stat-card c-purple">
        <div class="stat-label">NFTs Minted</div>
        <div class="stat-value c-purple" id="treasNFT">0</div>
        <div class="stat-sub">Agent licenses</div>
      </div>
      <div class="stat-card c-blue">
        <div class="stat-label">ETH Held</div>
        <div class="stat-value c-blue" id="treasETH">0</div>
        <div class="stat-sub">Treasury reserve</div>
      </div>
      <div class="stat-card c-green">
        <div class="stat-label">Monthly Spend</div>
        <div class="stat-value c-green" id="treasSpend">$0</div>
        <div class="stat-sub">Operations</div>
      </div>
    </div>
    <div class="two-col">
      <div>
        <div class="section-header">
          <div class="section-title">Treasury Transactions</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Amount</th>
                <th>Approved By</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="treasTable">
              <tr>
                <td colspan="4" class="empty-state">No transactions yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Treasury Feed</div>
        </div>
        <div class="live-feed" id="treasFeed">
          <div class="feed-header"><span>Events</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Treasury events…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ AGENTS (operator scope: who can run skills — Founder, Daena, Agents; sidebar "Agents" is the full Agents app) ═══ -->
  <div class="tab-panel" id="panel-agents" data-tab="agents">
    <p class="text-dim" style="font-size:11px;margin:0 0 8px 0">Operator scope: who can run skills (Founder, Daena,
      Agents). This tab shows agent registry and activity from /api/v1/agents.</p>
    <div class="stats-row">
      <div class="stat-card c-green">
        <div class="stat-label">Online</div>
        <div class="stat-value c-green" id="agentOnline">0</div>
        <div class="stat-sub">Active agents</div>
      </div>
      <div class="stat-card c-blue">
        <div class="stat-label">Actions Today</div>
        <div class="stat-value c-blue" id="agentActions">0</div>
        <div class="stat-sub">Executed</div>
      </div>
      <div class="stat-card c-amber">
        <div class="stat-label">Departments</div>
        <div class="stat-value c-amber" id="agentDepts">8</div>
        <div class="stat-sub">Sunflower structure</div>
      </div>
      <div class="stat-card c-purple">
        <div class="stat-label">Pending Tasks</div>
        <div class="stat-value c-purple" id="agentPending">0</div>
        <div class="stat-sub">Queued</div>
      </div>
    </div>
    <div class="two-col wide">
      <div>
        <div class="section-header">
          <div class="section-title">Agent Registry</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Agent</th>
                <th>Department</th>
                <th>Status</th>
                <th>Last Activity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="agentsTable">
              <tr>
                <td colspan="5" class="empty-state">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-header">
          <div class="section-title">Agent Activity Feed</div>
        </div>
        <div class="live-feed" id="agentFeed">
          <div class="feed-header"><span>Activity</span><span class="feed-live">Live</span></div>
          <div class="feed-empty">Agent events…</div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /content -->
</div><!-- /main -->
</div><!-- /shell -->

<!-- ═══ MODALS ═══ -->
<div class="modal-overlay" id="modal-skill">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Create New Skill</span><button class="modal-close"
        onclick="closeModal('skill')">×</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Skill Name</label><input class="input" id="newSkillName"
          placeholder="e.g. web_scraper" /></div>
      <div class="form-row"><label class="form-label">Display Name</label><input class="input" id="newSkillDisplay"
          placeholder="Web Scraper" /></div>
      <div class="form-row"><label class="form-label">Description</label><input class="input" id="newSkillDesc"
          placeholder="Scrapes web pages and extracts structured data" /></div>
      <div class="form-row">
        <label class="form-label">Category</label>
        <select class="input" style="font-size:12px;max-width:180px;padding:6px 10px" id="newSkillCatSelect"
          onchange="setSkillCategory(this.value)">
          <option value="utility" selected>Utility</option>
          <option value="research">Research</option>
          <option value="security">Security</option>
          <option value="data">Data</option>
          <option value="communication">Communication</option>
          <option value="devops">DevOps</option>
          <option value="web3">Web3/DeFi</option>
          <option value="admin">Admin</option>
        </select>
        <input type="hidden" id="newSkillCat" value="utility" />
      </div>
      <div class="form-row">
        <label class="form-label">Creator</label>
        <p class="form-hint" style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Who authored this skill
          definition (not who can run it).</p>
        <div class="segmented-pill" role="group" aria-label="Creator">
          <button type="button" class="segmented-pill-btn active" data-creator="founder" id="skillCreatorFounder"
            onclick="setSkillCreator('founder')">Founder</button>
          <button type="button" class="segmented-pill-btn" data-creator="daena" id="skillCreatorDaena"
            onclick="setSkillCreator('daena')">Daena</button>
          <button type="button" class="segmented-pill-btn" data-creator="agent" id="skillCreatorAgent"
            onclick="setSkillCreator('agent')">Agent</button>
        </div>
        <input type="hidden" name="creator" id="newSkillCreator" value="founder" />
      </div>
      <div class="form-row">
        <label class="form-label">Access Scope (who can run this skill)</label>
        <div class="access-scope-row">
          <label><input type="checkbox" id="accessFounder" checked /> Founder</label>
          <label><input type="checkbox" id="accessDaena" checked /> Daena (VP)</label>
          <label><input type="checkbox" id="accessDeptAgents" /> Department Agents</label>
          <label><input type="checkbox" id="accessSpecificDepts" /> Specific Departments</label>
          <label><input type="checkbox" id="accessSpecificAgents" /> Specific Agents</label>
        </div>
        <div style="margin-top:8px;display:none" id="accessSpecificDeptsRow">
          <input class="input" id="accessDeptsList" placeholder="e.g. Finance, Ops, Research"
            style="max-width:280px;font-size:11px" />
        </div>
        <div style="margin-top:8px;display:none" id="accessSpecificAgentsRow">
          <input class="input" id="accessAgentsList" placeholder="e.g. agent_1, agent_2"
            style="max-width:280px;font-size:11px" />
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Execution Policy</label>
        <p class="form-hint" style="font-size:11px;color:var(--text-dim);margin-bottom:6px">Governance: low=auto,
          medium=approval (or auto in Unleashed), high=always approval. Red-zone always requires founder confirm.</p>
        <div style="display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center">
          <span style="font-size:11px;color:var(--text-dim)">Risk</span>
          <div class="segmented-pill" role="group" aria-label="Risk level">
            <button type="button" class="segmented-pill-btn active" id="riskLow"
              onclick="setSkillRisk('low')">Low</button>
            <button type="button" class="segmented-pill-btn" id="riskMed"
              onclick="setSkillRisk('medium')">Medium</button>
            <button type="button" class="segmented-pill-btn" id="riskHigh" onclick="setSkillRisk('high')">High</button>
          </div>
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px">Approval</span>
          <div class="segmented-pill" role="group" aria-label="Approval policy">
            <button type="button" class="segmented-pill-btn active" id="approvalAuto"
              onclick="setSkillApproval('auto')">Auto</button>
            <button type="button" class="segmented-pill-btn" id="approvalRequired"
              onclick="setSkillApproval('approval_required')">Needs approval</button>
            <button type="button" class="segmented-pill-btn" id="approvalAlways"
              onclick="setSkillApproval('always_approval')">Always approval</button>
          </div>
        </div>
        <div class="form-row-inline" style="align-items:center;gap:8px;margin-top:10px">
          <div class="tooltip-wrap"
            data-tooltip="Credentials entry / money movement / destructive commands always require founder confirm.">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px">
              <input type="checkbox" id="requiresStepUpConfirm" checked />
              Red-zone: require step-up confirm
            </label>
          </div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Enabled</label>
        <div class="form-row-inline" style="align-items:center;gap:12px">
          <div class="toggle-switch on" id="newSkillEnabledToggle" onclick="toggleNewSkillEnabled()" role="button"
            aria-pressed="true" title="Skill enabled when created"></div>
          <span class="text-dim" style="font-size:12px" id="newSkillEnabledLabel">On (skill can be used after
            creation)</span>
        </div>
      </div>
      <div class="form-row"><label class="form-label">Code Body</label><textarea class="input" id="newSkillCode"
          placeholder="def execute(input_data):\n    # skill implementation\n    pass"></textarea></div>
    </div>
    <input type="hidden" id="editSkillId" value="" />
    <div class="modal-foot"><button class="btn" onclick="closeModal('skill')">Cancel</button><button
        class="btn btn-primary" id="skillModalSubmit" onclick="createOrUpdateSkill()">Create Skill</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-access-more">
  <div class="modal" style="max-width:420px">
    <div class="modal-head"><span class="modal-title">Access: Departments &amp; Agents</span><button class="modal-close"
        onclick="closeModal('access-more')">×</button></div>
    <div class="modal-body">
      <p class="form-hint text-dim" style="font-size:11px;margin-bottom:8px">Optional: restrict who can run by
        department or specific agent IDs. Leave empty for no restriction.</p>
      <div class="form-row"><label class="form-label">Allowed departments (comma-separated)</label><input class="input"
          id="accessMoreDepts" placeholder="e.g. Finance, Ops, Research" style="font-size:12px" /></div>
      <div class="form-row"><label class="form-label">Allowed agents (comma-separated)</label><input class="input"
          id="accessMoreAgents" placeholder="e.g. agent_1, agent_2" style="font-size:12px" /></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('access-more')">Cancel</button><button
        class="btn btn-primary" onclick="saveAccessMore()">Save</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-package">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Request Package Install</span><button class="modal-close"
        onclick="closeModal('package')">×</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Package Name</label><input class="input" id="newPkgName"
          placeholder="e.g. lodash" /></div>
      <div class="form-row-inline">
        <div class="form-row"><label class="form-label">Version</label><input class="input" id="newPkgVer"
            placeholder="4.17.21" /></div>
        <div class="form-row"><label class="form-label">Manager</label><select class="input" id="newPkgMgr">
            <option value="npm">npm</option>
            <option value="pip">pip</option>
            <option value="yarn">yarn</option>
          </select></div>
      </div>
      <div class="form-row"><label class="form-label">Requested By</label><input class="input" id="newPkgBy"
          placeholder="founder" value="founder" /></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('package')">Cancel</button><button
        class="btn btn-primary" onclick="requestPackage()">Request Install</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-research">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">New Research Query</span><button class="modal-close"
        onclick="closeModal('research')">×</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Query</label><textarea class="input" id="researchQuery"
          placeholder="What are the latest DeFi attack vectors in 2026?"></textarea></div>
      <div class="form-row"><label class="form-label">Sources</label><select class="input" id="researchSrc">
          <option value="all">All Sources</option>
          <option value="web">Web Only</option>
          <option value="memory">Local Memory</option>
          <option value="mcp">MCP Tools</option>
        </select></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('research')">Cancel</button><button
        class="btn btn-primary" onclick="runResearch()">Run Research</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-verify">
  <div class="modal">
    <div class="modal-head"><span class="modal-title">Verify Content</span><button class="modal-close"
        onclick="closeModal('verify')">×</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Content to Verify</label><textarea class="input"
          id="verifyContent" placeholder="Paste content to check for prompt injection or manipulation…"></textarea>
      </div>
      <div class="form-row"><label class="form-label">Source</label><input class="input" id="verifySource"
          placeholder="e.g. external_api_response" /></div>
    </div>
    <div class="modal-foot"><button class="btn" onclick="closeModal('verify')">Cancel</button><button
        class="btn btn-primary" onclick="verifyContent()">Verify</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-approve">
  <div class="modal">
    <div class="modal-head"><span class="modal-title" id="approveTitle">Approve Action</span><button class="modal-close"
        onclick="closeModal('approve')">×</button></div>
    <div class="modal-body">
      <div class="form-row"><label class="form-label">Action Details</label>
        <div class="input" id="approveDetails"
          style="background:var(--card);min-height:60px;white-space:pre-wrap;font-family:var(--font-mono);font-size:11px">
          —</div>
      </div>
      <div class="form-row"><label class="form-label">Notes (optional)</label><input class="input" id="approveNotes"
          placeholder="Approval reason…" /></div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal('approve')">Cancel</button>
      <button class="btn btn-danger" onclick="rejectAction()">Reject</button>
      <button class="btn btn-green" onclick="approveAction()">Approve</button>
    </div>
  </div>
</div>

<!-- ═══ JAVASCRIPT ═══ -->
<script>
  // ─── FILE PROTOCOL CHECK: page must be served by backend, not opened as file ─────────────────
  (function () {
    var proto = (typeof location !== 'undefined' && location.protocol) ? location.protocol : '';
    var origin = (typeof location !== 'undefined' && location.origin) ? location.origin : '';
    if (proto === 'file:' || !origin || origin === 'null' || origin.indexOf('file') === 0) {
      window._controlPannelFileProtocol = true;
      document.addEventListener('DOMContentLoaded', function () {
        var root = document.querySelector('.control-plane-content') || document.body;
        if (!root) return;
        var banner = document.createElement('div');
        banner.id = 'control-pannel-file-banner';
        banner.style.cssText = 'position:sticky;top:0;z-index:9999;background:#b45309;color:#fff;padding:12px 20px;font-size:14px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.3);';
        banner.innerHTML = '<strong>Control Pannel is not connected.</strong> This page was opened as a file (<code>file://</code>). ' +
          'To sync with the backend and use all features, open it through the server: ' +
          '<a href="http://127.0.0.1:8000/ui/control-pannel" style="color:#fff;text-decoration:underline;font-weight:bold;">http://127.0.0.1:8000/ui/control-pannel</a> ' +
          '(start the backend first with <code>python -m uvicorn backend.main:app</code> or your start script).';
        root.insertBefore(banner, root.firstChild);
      });
    }
  })();

  // ─── CONFIG (wire to backend; same origin = page origin) ─────────────────────────────────────
  function apiBase() { try { return (typeof window !== 'undefined' && window.location && window.location.origin) ? window.location.origin : ''; } catch (e) { return ''; } }
  const API = {
    skills: '/api/v1/skills',
    useCases: '/api/v1/use-cases',
    skillPacks: '/api/v1/skill-packs',
    packages: '/api/v1/packages',
    governance: '/api/v1/governance',
    execution: '/api/v1/execution',
    tools: '/api/v1/tools',
    hands: '/api/v1/hands',
    integrations: '/api/v1/integrations',
    proactive: '/api/v1/proactive',
    memory: '/api/v1/memory',
    research: '/api/v1/research',
    defi: '/api/v1/defi',
    integrity: '/api/v1/integrity',
    shadow: '/api/v1/shadow',
    council: '/api/v1/council',
    brain: '/api/v1/brain',
    treasury: '/api/v1/treasury',
    agents: '/api/v1/agents',
    system: '/api/v1/system',
    capabilities: '/api/v1/capabilities',
    quintessence: '/api/v1/quintessence',
    chat: '/api/v1/daena/chat/stream'
  };

  let ws = null;
  let autopilotState = true;
  let currentApproveId = null;
  let skillFilter = 'all';
  let operatorRoleFilter = '';  // server-side: '' | 'founder' | 'daena' | 'agent' (who can run)
  let skillAccessFilter = '';
  let skillCategoryFilter = '';
  let skillRiskFilter = '';
  let skillApprovalFilter = '';
  let skillStatusFilter = '';
  let skillSearchQuery = '';
  let skillSelectAllChecked = false;
  let selectedSkillIds = new Set();

  // ─── CLOCK (safe: only if #clock exists) ──────────────────────────────────────
  setInterval(function () {
    var el = document.getElementById('clock');
    if (el) el.textContent = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  }, 1000);

  // ─── TAB SWITCHING (wired in initControlPanel so DOM is ready) ──────────────────────────────
  function initTabButtons() {
    const root = document.querySelector('.control-plane-content') || document.body;
    const tabButtons = root ? root.querySelectorAll('.tab-btn') : document.querySelectorAll('.tab-btn');
    if (!tabButtons.length) {
      if (!window._controlPanelTabRetry) {
        window._controlPanelTabRetry = true;
        setTimeout(initTabButtons, 150);
      } else {
        console.warn('Control Pannel: no .tab-btn found');
      }
      return;
    }
    tabButtons.forEach(function (btn) {
      const tabName = btn.getAttribute('data-tab');
      if (!tabName) return;
      btn.removeEventListener('click', btn._controlPanelTabHandler);
      btn._controlPanelTabHandler = function (e) {
        e.preventDefault();
        e.stopPropagation();
        switchTab(tabName);
      };
      btn.addEventListener('click', btn._controlPanelTabHandler);
    });
  }
  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(function (b) {
      b.classList.remove('active');
      b.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.tab-panel').forEach(function (p) {
      p.classList.remove('active');
      p.style.display = 'none';
    });
    const btn = document.querySelector('.tab-btn[data-tab="' + tab + '"]');
    let panel = document.querySelector('.tab-panel[data-tab="' + tab + '"]');
    if (!panel) panel = document.getElementById('panel-' + tab);
    if (!btn) {
      console.warn('Control Pannel: tab button not found:', tab);
      return;
    }
    if (!panel) {
      console.warn('Control Pannel: tab panel not found:', tab);
      return;
    }
    btn.classList.add('active');
    btn.setAttribute('aria-selected', 'true');
    panel.classList.add('active');
    panel.style.display = 'block';
    if (history.pushState) {
      history.pushState(null, null, '#' + tab);
    } else {
      window.location.hash = tab;
    }
    try {
      loadTabData(tab);
    } catch (e) {
      console.warn('Control Pannel: loadTabData error:', e);
    }
  }
  window.addEventListener('hashchange', function () {
    const hash = (window.location.hash || '').slice(1);
    if (hash && document.querySelector('.tab-btn[data-tab="' + hash + '"]')) {
      switchTab(hash);
    }
  });

  // ─── WEBSOCKET (persist on window, reconnect with backoff) ──────────────────────────────────
  window.wsReconnectDelay = 3000;
  window.wsReconnectMax = 60000;
  function connectWS() {
    try {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/ws/events`);
      window.ws = ws;
      ws.onopen = () => { setWSStatus(true); window.wsReconnectDelay = 3000 };
      ws.onclose = () => {
        setWSStatus(false);
        const delay = Math.min(window.wsReconnectDelay, window.wsReconnectMax);
        window.wsReconnectDelay = Math.min(delay * 2, window.wsReconnectMax);
        setTimeout(connectWS, delay);
      };
      ws.onerror = () => { };
      ws.onmessage = (e) => {
        try { handleWSEvent(JSON.parse(e.data)) } catch (x) { }
      };
    } catch (e) { setTimeout(connectWS, window.wsReconnectDelay || 3000) }
  }
  function setWSStatus(on) {
    document.getElementById('wsDot').className = 'ws-dot' + (on ? '' : ' off');
    document.getElementById('wsLabel').textContent = on ? 'Connected' : 'Reconnecting…';
  }
  function handleWSEvent(ev) {
    const type = (ev.event_type || ev.type || '');
    const payload = ev.payload || ev;
    const t = ev.timestamp ? new Date(ev.timestamp) : new Date();
    const timeStr = t.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    const msg = payload.message || ev.message || type;

    if (type.startsWith('agent') || type === 'task_created' || type === 'task_completed') {
      addFeed('agentFeed', timeStr, 'green', msg);
    }
    if (type.startsWith('council') || type === 'debate' || type === 'vote') {
      addFeed('councilFeed', timeStr, 'blue', msg);
    }
    if (type.startsWith('trust') || type === 'integrity' || type === 'injection_detected') {
      addFeed('trustFeed', timeStr, type.includes('block') || type.includes('inject') ? 'red' : 'blue', msg);
    }
    if (type.startsWith('shadow') || type === 'threat' || type === 'honeypot' || type === 'canary') {
      addFeed('shadowFeed', timeStr, 'purple', msg);
    }
    if (type.startsWith('treasury') || type === 'token' || type === 'nft') {
      addFeed('treasFeed', timeStr, 'amber', msg);
    }
    if (type.startsWith('package') || type === 'audit') {
      addFeed('pkgFeed', timeStr, 'blue', msg);
    }
    if (type.startsWith('skill') || type === 'skill_update') {
      addFeed('brainFeed', timeStr, 'green', msg);
      if (typeof loadSkills === 'function') loadSkills();
    }
    if (type.startsWith('governance') || type === 'approval' || type === 'autopilot') {
      addFeed('govFeed', timeStr, 'amber', msg);
      if (payload.stage && typeof animatePipeline === 'function') animatePipeline(payload.stage, payload.details);
      if (type === 'governance_autopilot_changed' && typeof loadTabData === 'function') loadTabData('governance');
    }
    if (type.startsWith('brain') || type === 'memory' || type === 'research' || type === 'llm') {
      addFeed('brainFeed', timeStr, 'blue', msg);
    }
    if (type.startsWith('defi') || type === 'scan') {
      addFeed('defiFeed', timeStr, 'amber', msg);
    }
  }
  function addFeed(feedId, time, color, html) {
    const feed = document.getElementById(feedId);
    if (!feed) return;
    const empty = feed.querySelector('.feed-empty');
    if (empty) empty.remove();
    const item = document.createElement('div');
    item.className = 'feed-item';
    item.innerHTML = `<span class="feed-time">${time}</span><div class="feed-dot ${color}"></div><div class="feed-text">${html}</div>`;
    const header = feed.querySelector('.feed-header');
    if (header) header.after(item);
    // Keep max 40 items
    const items = feed.querySelectorAll('.feed-item');
    if (items.length > 40) items[items.length - 1].remove();
  }

  // ─── DAENABOT AWARENESS (GET /api/v1/capabilities; fallback /api/v1/system/capabilities) ───────────────────────────
  async function loadAwareness() {
    try {
      let r = await apiRequest(API.capabilities);
      if (!r || r.error) r = await apiRequest('/api/v1/system/capabilities');
      if (!r || r.error) return;
      const avail = r.available || {};
      const health = r.health || {};
      const hands = health.hands || {};
      const llm = health.local_llm || {};
      const gov = health.governance || r.governance || {};
      const banner = document.getElementById('handsOfflineBanner');
      if (banner) {
        if (r.remote_hands_warning) {
          banner.className = 'awareness-banner warning-remote';
          banner.textContent = 'Hands URL is not localhost. Set ENABLE_REMOTE_HANDS=true to acknowledge.';
          banner.style.display = 'block';
        } else if (!avail.hands_gateway) {
          banner.className = 'awareness-banner';
          banner.innerHTML = '<span>DaenaBot can plan but cannot act (Hands offline). Start DaenaBot Hands (Moltbot) and set DAENABOT_HANDS_URL + DAENABOT_HANDS_TOKEN, or use Control Pannel → DaenaBot Tools → Test.</span>';
          banner.style.display = 'block';
        } else {
          banner.style.display = 'none';
        }
      }
      const handsEl = document.getElementById('awarenessHands');
      if (handsEl) {
        const conn = hands.connected ? 'Connected' : 'Offline';
        const auth = hands.authenticated ? ', authenticated' : (hands.token_present ? ', auth pending' : '');
        handsEl.textContent = conn + auth + (hands.url_host ? ' (' + hands.url_host + ')' : '');
        handsEl.className = 'ap-value ' + (hands.connected ? 'ok' : 'off');
      }
      const llmEl = document.getElementById('awarenessLLM');
      if (llmEl) {
        const prov = llm.provider || '—';
        const model = llm.model ? ' · ' + llm.model : '';
        llmEl.textContent = (llm.healthy ? 'OK' : 'Offline') + ' · ' + prov + model;
        llmEl.className = 'ap-value ' + (llm.healthy ? 'ok' : 'off');
      }
      const govEl = document.getElementById('awarenessGov');
      if (govEl) {
        const mode = gov.autopilot_enabled ? 'Autopilot' : 'Manual';
        const pending = (gov.pending_count || 0) > 0 ? ' · ' + gov.pending_count + ' pending' : '';
        govEl.textContent = mode + pending;
        govEl.className = 'ap-value';
      }
      const remoteRow = document.getElementById('awarenessRemoteRow');
      const remoteEl = document.getElementById('awarenessRemote');
      if (remoteRow && remoteEl && r.remote_hands_warning) {
        remoteRow.style.display = 'flex';
        remoteEl.textContent = 'Hands URL is not localhost (set ENABLE_REMOTE_HANDS=true to acknowledge)';
      } else if (remoteRow) remoteRow.style.display = 'none';
    } catch (_) { }
  }

  // ─── AUTOPILOT TOGGLE (synced: brain/autopilot + governance/toggle-autopilot) ───────────────────────────
  async function loadAutopilotFromBackend() {
    try {
      const r = await apiRequest('/api/v1/brain/autopilot');
      if (r && typeof r.enabled === 'boolean') {
        autopilotState = r.enabled;
        const el = document.getElementById('autopilotToggle');
        const modeEl = document.getElementById('autopilotMode');
        if (el) { el.className = 'toggle-switch' + (autopilotState ? ' on' : ''); el.setAttribute('aria-pressed', autopilotState); }
        if (modeEl) { modeEl.textContent = autopilotState ? 'On' : 'Manual'; modeEl.className = 'autopilot-mode' + (autopilotState ? '' : ' manual'); }
        if (window.loadTopbarAutopilot) window.loadTopbarAutopilot();
      }
    } catch (_) { }
  }
  window.refreshControlPanelAutopilot = loadAutopilotFromBackend;
  async function toggleAutopilot() {
    const nextState = !autopilotState;
    const el = document.getElementById('autopilotToggle');
    const modeEl = document.getElementById('autopilotMode');
    autopilotState = nextState;
    if (el) { el.className = 'toggle-switch' + (autopilotState ? ' on' : ''); el.setAttribute('aria-pressed', autopilotState); }
    if (modeEl) { modeEl.className = 'autopilot-mode' + (autopilotState ? '' : ' manual'); modeEl.textContent = autopilotState ? 'On' : 'Manual'; }
    try {
      var r = await fetch(apiBase() + API.governance + '/toggle-autopilot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: autopilotState }) });
      if (r.ok) {
        if (window.loadTopbarAutopilot) window.loadTopbarAutopilot();
        addFeed('govFeed', new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }), 'amber', `<strong>Autopilot</strong> switched to <strong>${autopilotState ? 'ON' : 'Manual'}</strong>`);
      } else {
        await loadAutopilotFromBackend();
      }
    } catch (_) {
      await loadAutopilotFromBackend();
    }
  }

  // ─── PIPELINE ANIMATION ─────────────────────────
  function animatePipeline(stage, details) {
    const map = { think: 'pipe-think', plan: 'pipe-plan', act: 'pipe-act', report: 'pipe-report' };
    const order = ['think', 'plan', 'act', 'report'];
    const idx = order.indexOf(stage);
    order.forEach((s, i) => {
      const el = document.getElementById(map[s]);
      if (!el) return;
      el.className = 'pipeline-step' + (i < idx ? ' done' : (i === idx ? ' active' : ''));
    });
    const detEl = document.getElementById('pipeline-details');
    if (detEl) detEl.textContent = details ? (details.length > 120 ? details.slice(0, 120) + '...' : details) : '';
  }
  // ─── MODAL HELPERS ──────────────────────────────
  function openModal(id) { document.getElementById('modal-' + id).classList.add('open') }
  function closeModal(id) { document.getElementById('modal-' + id).classList.remove('open'); if (id === 'skill') { document.getElementById('editSkillId').value = ''; const btn = document.getElementById('skillModalSubmit'); if (btn) btn.textContent = 'Create Skill'; } }
  function openSkillCreateModal() {
    document.getElementById('editSkillId').value = '';
    document.getElementById('skillModalSubmit').textContent = 'Create Skill';
    // Default enabled to ON for new skills
    const toggleEl = document.getElementById('newSkillEnabledToggle');
    if (toggleEl) {
      toggleEl.classList.add('on');
      toggleEl.setAttribute('aria-pressed', 'true');
    }
    const labelEl = document.getElementById('newSkillEnabledLabel');
    if (labelEl) label.textContent = 'On (skill can be used after creation)';
    openModal('skill');
  }
  document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', (e) => { if (e.target === o) o.classList.remove('open') }) });

  // ─── API HELPER (full URL = same origin so backend stays in sync) ───
  async function apiRequest(url, opts = {}) {
    var fullUrl = (url.indexOf('http') === 0) ? url : (apiBase() + url);
    try {
      var r = await fetch(fullUrl, { credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, ...opts });
      if (!r.ok) { if (window._controlPanelSyncFail === undefined) window._controlPanelSyncFail = true; return null; }
      var text = await r.text();
      if (!text) return null;
      try { return JSON.parse(text); } catch (_) { return null; }
    } catch (e) { if (window._controlPanelSyncFail === undefined) window._controlPanelSyncFail = true; return null; }
  }
  /** Run once on load: ping backend (capabilities → system/capabilities → brain/autopilot → skills/stats). */
  async function checkBackendSync() {
    var el = document.getElementById('backendSyncStatus');
    if (!el) return;
    var base = apiBase();
    var opts = { method: 'GET', headers: { 'Content-Type': 'application/json' } };
    try {
      var r = await fetch(base + API.capabilities, opts);
      if (!r || !r.ok) r = await fetch(base + '/api/v1/system/capabilities', opts);
      if (!r || !r.ok) r = await fetch(base + API.brain + '/autopilot', opts);
      if (!r || !r.ok) r = await fetch(base + API.skills + '/stats', opts);
      if (r && r.ok) { el.textContent = 'Backend: OK'; el.className = 'backend-sync ok'; }
      else { el.textContent = 'Backend: Unavailable'; el.className = 'backend-sync off'; }
    } catch (e) { el.textContent = 'Backend: Unavailable'; el.className = 'backend-sync off'; }
  }

  // ─── EXECUTION TOKEN (sessionStorage; for X-Execution-Token on protected routes) ───
  const EXECUTION_TOKEN_KEY = 'daena_execution_token';
  function getExecutionToken() { try { return sessionStorage.getItem(EXECUTION_TOKEN_KEY) || null; } catch (e) { return null; } }
  function setExecutionToken(val) { try { if (val) sessionStorage.setItem(EXECUTION_TOKEN_KEY, val); else sessionStorage.removeItem(EXECUTION_TOKEN_KEY); } catch (e) { } }
  function clearExecutionToken() { setExecutionToken(null); document.getElementById('executionTokenInput').value = ''; loadExecutionAuthStatus(); loadExecution(); }
  /** Call execution API with X-Execution-Token when set. Full URL so backend stays in sync. */
  async function apiExecution(url, opts = {}) {
    var fullUrl = (url.indexOf('http') === 0) ? url : (apiBase() + url);
    var token = getExecutionToken();
    var headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (token) headers['X-Execution-Token'] = token;
    try {
      var r = await fetch(fullUrl, { ...opts, headers });
      if (!r.ok) return null;
      return await r.json();
    } catch (e) { return null; }
  }
  async function loadExecutionAuthStatus() {
    const res = await apiRequest(API.execution + '/auth-status');
    const msgEl = document.getElementById('executionAuthMessage');
    const badgeEl = document.getElementById('executionAuthBadge');
    const rowEl = document.getElementById('executionTokenRow');
    if (!res || !msgEl) return;
    msgEl.textContent = res.message || '—';
    if (res.localhost_bypass) { badgeEl.textContent = 'Local dev (no token)'; badgeEl.className = 'badge badge-active'; rowEl.style.display = 'none'; }
    else if (!res.execution_enabled) { badgeEl.textContent = 'Disabled'; badgeEl.className = 'badge badge-pending'; rowEl.style.display = 'none'; }
    else if (res.token_required_for_ui) { badgeEl.textContent = getExecutionToken() ? 'Token set' : 'Token needed'; badgeEl.className = 'badge ' + (getExecutionToken() ? 'badge-active' : 'badge-pending'); rowEl.style.display = 'flex'; }
    else { badgeEl.textContent = 'OK'; badgeEl.className = 'badge badge-active'; rowEl.style.display = 'none'; }
  }
  function saveExecutionToken() {
    const val = document.getElementById('executionTokenInput').value.trim();
    setExecutionToken(val || null);
    loadExecutionAuthStatus();
    loadExecution();
    if (window.showToast) window.showToast(val ? 'Token saved for this session' : 'Token cleared', 'info');
  }

  // ─── LOAD TAB DATA ──────────────────────────────
  function loadTabData(tab) {
    switch (tab) {
      case 'brain': loadBrain(); break;
      case 'defi': loadDefi(); break;
      case 'skills': loadSkills(); break;
      case 'use-cases': loadUseCases(); break;
      case 'packages': loadPackages(); break;
      case 'governance': loadAutopilotFromBackend(); loadGovernance(); loadAwareness(); break;
      case 'execution': loadExecution(); break;
      case 'daenabot-tools': loadDaenaBotTools(); break;
      case 'integrations': loadIntegrations(); break;
      case 'proactive': loadProactive(); break;
      case 'council': loadCouncil(); break;
      case 'trust': loadTrust(); break;
      case 'shadow': loadShadow(); break;
      case 'treasury': loadTreasury(); break;
      case 'agents': loadAgents(); break;
      case 'quintessence': loadExperts(); searchPrecedents(); break;
    }
  }

  // ─── BRAIN ──────────────────────────────────────
  async function loadBrain() {
    const mem = await apiRequest(API.memory + '/stats');
    if (mem) {
      const l1 = mem.l1 || 0, l2 = mem.l2 || 0, l3 = mem.l3 || 0;
      document.getElementById('brainL1').textContent = l1;
      document.getElementById('brainL2').textContent = l2;
      document.getElementById('brainL3').textContent = l3;
      document.getElementById('tierL1Val').textContent = l1;
      document.getElementById('tierL2Val').textContent = l2;
      document.getElementById('tierL3Val').textContent = l3;
    }
    const res = await apiRequest(API.research + '/history');
    if (res && res.length) {
      document.getElementById('brainQueries').textContent = res.filter(r => { const d = new Date(r.created_at || 0); return (Date.now() - d) < 86400000 }).length;
    }
    const sources = await apiRequest(API.research + '/sources');
    if (sources) {
      document.getElementById('researchSources').innerHTML = sources.map(s => `<tr>
      <td class="td-mono">${s.name || ''}</td>
      <td>${s.type || ''}</td>
      <td><span class="badge badge-active">Active</span></td>
      <td class="td-mono">${timeAgo(s.last_used)}</td>
    </tr>`).join('') || '<tr><td colspan="4" class="empty-state">No sources</td></tr>';
    }
  }

  // ─── DEFI ───────────────────────────────────────
  async function loadDefi() {
    const tools = await apiRequest(API.defi + '/tools');
    if (tools) {
      document.getElementById('defiTools').innerHTML = tools.map(t => `<tr>
      <td class="td-mono">${t.name}</td>
      <td class="td-mono">${t.version || '—'}</td>
      <td><span class="badge ${t.installed ? 'badge-active' : 'badge-pending'}">${t.installed ? 'Installed' : 'Not Found'}</span></td>
    </tr>`).join('') || '<tr><td colspan="3" class="empty-state">No tools</td></tr>';
    }
  }
  async function startDefiScan() {
    const val = document.getElementById('defiInput').value.trim();
    if (!val) return;
    addFeed('defiFeed', new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }), 'amber', `<strong>Scanning</strong> ${val}…`);
    const r = await apiRequest(API.defi + '/scan', { method: 'POST', body: JSON.stringify({ contract_path: val }) });
    if (r) {
      addFeed('defiFeed', new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }), 'green', `<strong>Scan started</strong> ID: ${r.scan_id || '—'}`);
      loadDefiResults();
    }
  }
  async function loadDefiResults() {
    const results = await apiRequest(API.defi + '/results');
    if (results && results.length) {
      document.getElementById('defiScans').textContent = results.length;
      const vulns = results.reduce((a, r) => a + (r.vulnerabilities || 0), 0);
      document.getElementById('defiVulns').textContent = vulns;
      document.getElementById('defiCritical').textContent = results.reduce((a, r) => a + (r.critical || 0), 0);
      document.getElementById('defiOK').textContent = results.filter(r => !(r.vulnerabilities)).length;
      document.getElementById('defiResults').innerHTML = results.map(r => `<tr>
      <td class="td-mono">${r.contract || '—'}</td>
      <td><span class="badge ${r.status === 'complete' ? 'badge-active' : 'badge-pending'}">${r.status || '—'}</span></td>
      <td>${r.vulnerabilities || 0}</td>
      <td class="td-mono">${timeAgo(r.created_at)}</td>
      <td><button class="btn" onclick="viewDefiReport('${r.scan_id}')">Report</button></td>
    </tr>`).join('');
    }
  }
  function viewDefiReport(id) {
    apiRequest(API.defi + '/report/' + id).then(r => { if (r) { document.getElementById('approveTitle').textContent = 'DeFi Scan Report'; document.getElementById('approveDetails').textContent = JSON.stringify(r, null, 2); document.getElementById('approveNotes').value = ''; openModal('approve') } });
  }

  // ─── SKILLS (full URL so backend stays in sync) ───
  function skillsFetchWithTimeout(url, timeoutMs) {
    var fullUrl = (url.indexOf('http') === 0) ? url : (apiBase() + url);
    if (fullUrl.indexOf('?') === -1) fullUrl += '?_t=' + Date.now();
    else fullUrl += '&_t=' + Date.now();
    var ctrl = new AbortController();
    var t = setTimeout(function () { ctrl.abort(); }, timeoutMs || 15000);
    return fetch(fullUrl, { credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, signal: ctrl.signal })
      .then(function (r) { clearTimeout(t); return r; })
      .then(function (r) { return r.ok ? r.json() : null; })
      .catch(function () { clearTimeout(t); return null; });
  }
  async function loadSkills() {
    const tableEl = document.getElementById('skillsTable');
    const setTable = (html) => { if (tableEl) tableEl.innerHTML = html; };
    try {
      const stats = await skillsFetchWithTimeout(API.skills + '/stats', 10000);
      const totalEl = document.getElementById('skillTotal');
      const activeEl = document.getElementById('skillActive');
      const pendingEl = document.getElementById('skillPending');
      const selfEl = document.getElementById('skillSelf');
      if (totalEl) totalEl.textContent = (stats && stats.total != null) ? stats.total : '—';
      if (activeEl) activeEl.textContent = (stats && stats.active != null) ? stats.active : '—';
      if (pendingEl) pendingEl.textContent = (stats && stats.pending != null) ? stats.pending : '—';
      if (selfEl) selfEl.textContent = (stats && stats.self_created != null) ? stats.self_created : '—';

      const url = operatorRoleFilter ? (API.skills + '?operator_role=' + encodeURIComponent(operatorRoleFilter)) : API.skills;
      const res = await skillsFetchWithTimeout(url, 12000);
      const remoteSkills = (res && res.skills && Array.isArray(res.skills)) ? res.skills : (Array.isArray(res) ? res : []);

      if (res === null && !remoteSkills.length) {
        setTable('<tr><td colspan="9" class="empty-state">Could not load skills — backend unavailable or timeout. <button type="button" class="btn" style="margin-left:8px" onclick="loadSkills()">Retry</button></td></tr>');
        return;
      }

      let list = remoteSkills;
      // Multi-filter logic
      if (skillFilter && skillFilter !== 'all') {
        list = list.filter(s => (s.enabled ? 'active' : 'disabled') === skillFilter);
      }
      if (skillCategoryFilter) {
        list = list.filter(s => (s.category || '').toLowerCase() === skillCategoryFilter.toLowerCase());
      }
      if (skillRiskFilter) {
        list = list.filter(s => (s.risk || '').toLowerCase() === skillRiskFilter.toLowerCase());
      }
      if (skillApprovalFilter) {
        list = list.filter(s => (s.approval_policy || 'auto') === skillApprovalFilter);
      }
      if (skillStatusFilter) {
        list = list.filter(s => (s.enabled ? 'active' : 'disabled') === skillStatusFilter);
      }
      if (skillSearchQuery) {
        const q = skillSearchQuery.toLowerCase();
        list = list.filter(s => ((s.name || '') + (s.description || '')).toLowerCase().includes(q));
      }

      window._lastSkillsList = list;
      const operatorToggles = (s) => {
        const a = s.access || {};
        const roles = (a.allowed_roles || []).map(r => r.toLowerCase());
        const idSafe = (s.id || '').toString().replace(/"/g, '&quot;');
        const idEsc = (s.id || '').toString().replace(/'/g, "\\'");
        const isRegistry = s.source === 'registry';
        const F = (label, role) => {
          const on = roles.includes(role);
          if (!isRegistry) return `<span class="badge badge-${on ? 'active' : 'pending'}" style="font-size:9px">${label}</span>`;
          return `<button type="button" class="operator-chip ${on ? 'on' : ''}" onclick="patchSkillAccess('${idEsc}','${role}',${!on})" title="Toggle ${label}">${label}</button>`;
        };
        const moreBtn = isRegistry ? `<button type="button" class="btn" style="padding:2px 6px;font-size:10px;margin-left:2px" data-skill-id="${idSafe}" onclick="openAccessMorePanel(this)" title="Departments / Agents">⋯</button>` : '';
        return F('Founder', 'founder') + F('Daena', 'daena') + F('Agents', 'agent') + moreBtn;
      };
      const approvalLabel = (p) => { const v = (p || 'auto'); return v === 'always_approval' ? 'Always' : v === 'approval_required' ? 'Needs approval' : 'Auto'; };
      setTable(list.map(s => {
        const status = s.enabled ? 'active' : 'disabled';
        const creator = (s.creator || '—').toString().replace(/</g, '&lt;');
        const idSafe = (s.id || '').toString().replace(/"/g, '&quot;').replace(/</g, '&lt;');
        const idEsc = (s.id || '').toString().replace(/'/g, "\\'");
        const name = (s.name || '').toString().replace(/</g, '&lt;');
        const risk = (s.risk_level || s.risk || 'low').toLowerCase();
        const cat = (s.category || '—').toString().replace(/</g, '&lt;');
        const approval = approvalLabel(s.approval_policy);
        const uses = (s.usage_count != null) ? s.usage_count : 0;
        const checked = selectedSkillIds.has(s.id) ? ' checked' : '';
        const canEdit = s.source === 'registry' || !s.source;

        // Only show checkbox if in Founder tab
        const showCheckbox = window._skillRegistryMode === 'founder';
        const checkboxHtml = showCheckbox ? `<td><input type="checkbox" class="skill-row-cb" data-skill-id="${idSafe}" ${checked} onclick="toggleSkillSelection(this)"/></td>` : `<td></td>`;

        return `<tr>
        ${checkboxHtml}
        <td><strong>${name}</strong><div style="font-size:10px;color:var(--text-dim)">${s.id || ''}</div></td>
        <td><span class="badge badge-pending" style="font-size:10px">${cat}</span></td>
        <td style="font-size:10px;display:flex;flex-wrap:wrap;gap:4px;align-items:center">${operatorToggles(s)}</td>
        <td><span class="badge badge-${risk === 'high' ? 'pending' : risk === 'medium' ? 'pending' : 'active'}" style="font-size:10px">${approval}</span></td>
        <td><span class="badge badge-${risk === 'high' ? 'high' : risk === 'medium' ? 'medium' : 'low'}" style="font-size:10px">${risk}</span></td>
        <td class="td-mono">${creator}</td>
        <td>${uses}</td>
        <td style="white-space:nowrap">
          <button class="btn" style="padding:3px 8px;font-size:10px" onclick="toggleSkill('${idEsc}',${!s.enabled})">${s.enabled ? 'Disable' : 'Enable'}</button>
          ${canEdit ? `<button class="btn" style="padding:3px 8px;font-size:10px;margin-left:2px" onclick="openEditSkillModal('${idEsc}')">Edit</button>` : ''}
          ${canEdit ? `<button class="btn btn-danger" style="padding:3px 8px;font-size:10px;margin-left:2px" onclick="archiveSkill('${idEsc}')">Archive</button>` : ''}
        </td>
      </tr>`;
      }).join('') || `<tr><td colspan="9" class="empty-state">No skills match.</td></tr>`);
      updateSkillBulkBar();
    } catch (e) {
      setTable('<tr><td colspan="9" class="empty-state">Error loading skills.</td></tr>');
    }
  }

  // --- HANDS ACTIONS ---
  async function saveHandsAllowlist() {
    const val = document.getElementById('handsAllowlist').value;
    try {
      const config = JSON.parse(val);
      await apiRequest(API.hands + '/allowlist', { method: 'POST', body: JSON.stringify(config) });
      if (window.showToast) window.showToast('Allowlist updated', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Invalid JSON or update error', 'error');
    }
  }

  async function testAction(name, args) {
    if (window.showToast) window.showToast(`Dispatching ${name}...`, 'info');
    try {
      const res = await apiRequest(API.hands + '/execute', { method: 'POST', body: JSON.stringify({ action: name, args }) });
      if (res && res.status === 'pending_approval') {
        if (window.showToast) window.showToast('Action queued for approval', 'amber');
        loadDaenaBotTools();
      } else if (res && res.success) {
        if (window.showToast) window.showToast('Action success', 'success');
      } else {
        if (window.showToast) window.showToast('Action failed: ' + (res.error || 'Unknown'), 'error');
      }
    } catch (e) {
      if (window.showToast) window.showToast('Dispatch failed', 'error');
    }
  }
  // ─── USE CASES (GET /api/v1/use-cases) ───
  async function loadUseCases() {
    const tableEl = document.getElementById('useCasesTable');
    if (!tableEl) return;
    try {
      const res = await apiRequest(API.useCases || '/api/v1/use-cases');
      const list = (res && res.use_cases && Array.isArray(res.use_cases)) ? res.use_cases : (Array.isArray(res) ? res : []);
      tableEl.innerHTML = list.map(u => {
        const name = (u.name || '').toString().replace(/</g, '&lt;');
        const op = (u.operator_scope || 'all').replace(/</g, '&lt;');
        const approval = (u.approval_profile || 'auto').replace(/</g, '&lt;');
        const skills = (u.default_skills || []).slice(0, 3).join(', ') + ((u.default_skills || []).length > 3 ? '…' : '');
        const enabled = u.enabled !== false ? 'Yes' : 'No';
        return `<tr><td><strong>${name}</strong></td><td>${op}</td><td>${approval}</td><td style="font-size:10px">${skills}</td><td>${enabled}</td></tr>`;
      }).join('') || '<tr><td colspan="5" class="empty-state">No use cases. Backend may be starting.</td></tr>';
    } catch (e) {
      tableEl.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading use cases. <button type="button" class="btn" onclick="loadUseCases()">Retry</button></td></tr>';
    }
  }
  async function toggleSkill(id, enabled) {
    await apiExecution(API.skills + '/toggle', { method: 'POST', body: JSON.stringify({ skill_id: id, enabled }) });
    loadSkills();
  }
  async function archiveSkill(id) {
    if (!confirm('Archive this skill? It will be soft-deleted and removed from the list.')) return;
    const r = await apiRequest(API.skills + '/' + encodeURIComponent(id), { method: 'DELETE' });
    if (r && r.success) { if (window.showToast) window.showToast('Skill archived', 'success'); loadSkills(); }
    else if (window.showToast) window.showToast(r?.detail || 'Archive failed', 'error');
  }
  function toggleSkillSelectAll(checkbox) {
    skillSelectAllChecked = checkbox && checkbox.checked;
    document.querySelectorAll('.skill-row-cb:not([disabled])').forEach(cb => { cb.checked = skillSelectAllChecked; if (skillSelectAllChecked) selectedSkillIds.add(cb.getAttribute('data-skill-id')); else selectedSkillIds.delete(cb.getAttribute('data-skill-id')); });
    updateSkillBulkBar();
  }
  function toggleSkillSelection(checkbox) {
    const id = checkbox && checkbox.getAttribute('data-skill-id');
    if (!id) return;
    if (checkbox.checked) selectedSkillIds.add(id); else selectedSkillIds.delete(id);
    skillSelectAllChecked = false;
    if (document.getElementById('skillSelectAll')) document.getElementById('skillSelectAll').checked = false;
    updateSkillBulkBar();
  }
  function updateSkillBulkBar() {
    const bar = document.getElementById('skillBulkBar');
    const countEl = document.getElementById('skillBulkCount');
    if (bar && countEl) {
      const n = selectedSkillIds.size;
      const isFounder = window._skillRegistryMode === 'founder';
      countEl.textContent = n;
      bar.style.display = (n && isFounder) ? 'flex' : 'none';
    }
  }
  function clearSkillSelection() {
    selectedSkillIds.clear();
    skillSelectAllChecked = false;
    const cb = document.getElementById('skillSelectAll'); if (cb) cb.checked = false;
    document.querySelectorAll('.skill-row-cb').forEach(c => c.checked = false);
    updateSkillBulkBar();
  }
  async function bulkUpdateAccessSkills() {
    const ids = Array.from(selectedSkillIds);
    if (!ids.length) return;
    const rolesStr = prompt('Set allowed_roles (comma-separated): founder, daena, agent');
    if (rolesStr === null) return;
    const roles = rolesStr.split(/[\s,]+/).map(s => s.trim().toLowerCase()).filter(s => ['founder', 'daena', 'agent'].includes(s));
    if (!roles.length) { if (window.showToast) window.showToast('Enter at least one role: founder, daena, agent', 'error'); return; }
    for (const id of ids) {
      const s = window._lastSkillsList && window._lastSkillsList.find(x => x.id === id);
      if (!s || s.source !== 'registry') continue;
      await apiRequest(API.skills + '/' + encodeURIComponent(id) + '/access', { method: 'PATCH', body: JSON.stringify({ allowed_roles: roles }) });
    }
    if (window.showToast) window.showToast('Access updated for ' + ids.length + ' skill(s)', 'success');
    clearSkillSelection(); loadSkills();
  }
  async function bulkDisableSkills() {
    const ids = Array.from(selectedSkillIds);
    if (!ids.length) return;
    if (!confirm('Disable ' + ids.length + ' skill(s)?')) return;
    for (const id of ids) {
      await apiRequest(API.skills + '/toggle', { method: 'POST', body: JSON.stringify({ skill_id: id, enabled: false }) });
    }
    if (window.showToast) window.showToast('Disabled ' + ids.length + ' skill(s)', 'success');
    clearSkillSelection(); loadSkills();
  }
  async function bulkArchiveSkills() {
    const ids = Array.from(selectedSkillIds);
    if (!ids.length) return;
    if (!confirm('Archive ' + ids.length + ' skill(s)? They will be soft-deleted.')) return;
    for (const id of ids) {
      const s = window._lastSkillsList && window._lastSkillsList.find(x => x.id === id);
      if (s && s.source === 'registry') await apiRequest(API.skills + '/' + encodeURIComponent(id), { method: 'DELETE' });
    }
    if (window.showToast) window.showToast('Archived ' + ids.length + ' skill(s)', 'success');
    clearSkillSelection(); loadSkills();
  }
  let _accessMoreSkillId = '';
  function openAccessMorePanel(btn) {
    const skillId = btn && (btn.getAttribute && btn.getAttribute('data-skill-id'));
    if (!skillId) return;
    const s = window._lastSkillsList && window._lastSkillsList.find(x => x.id === skillId);
    if (!s || s.source !== 'registry') return;
    _accessMoreSkillId = skillId;
    const a = s.access || {};
    document.getElementById('accessMoreDepts').value = (a.allowed_departments || []).join(', ');
    document.getElementById('accessMoreAgents').value = (a.allowed_agents || []).join(', ');
    openModal('access-more');
  }
  async function saveAccessMore() {
    if (!_accessMoreSkillId) return;
    const depts = (document.getElementById('accessMoreDepts').value || '').split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
    const agents = (document.getElementById('accessMoreAgents').value || '').split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
    const s = window._lastSkillsList && window._lastSkillsList.find(x => x.id === _accessMoreSkillId);
    const roles = (s && s.access && s.access.allowed_roles) ? s.access.allowed_roles : [];
    const res = await apiRequest(API.skills + '/' + encodeURIComponent(_accessMoreSkillId) + '/access', { method: 'PATCH', body: JSON.stringify({ allowed_roles: roles, allowed_departments: depts, allowed_agents: agents }) });
    if (res && res.success) { if (window.showToast) window.showToast('Access updated', 'success'); closeModal('access-more'); loadSkills(); }
    else if (window.showToast) window.showToast(res?.detail || 'Update failed', 'error');
    _accessMoreSkillId = '';
  }
  async function openEditSkillModal(id) {
    const res = await apiRequest(API.skills + '/' + encodeURIComponent(id));
    const s = res && res.skill;
    if (!s) { if (window.showToast) window.showToast('Skill not found', 'error'); return; }
    if (s.source !== 'registry') { if (window.showToast) window.showToast('Only registry skills can be edited', 'error'); return; }
    document.getElementById('editSkillId').value = id;
    document.getElementById('newSkillName').value = s.name || s.id || '';
    document.getElementById('newSkillDisplay').value = s.display_name || s.name || '';
    document.getElementById('newSkillDesc').value = s.description || '';
    const cat = (s.category || s.category_slug || 'utility').toLowerCase();
    setSkillCategory(cat);
    document.getElementById('newSkillCat').value = cat;
    setSkillCreator((s.creator || 'founder').toLowerCase());
    document.getElementById('newSkillCreator').value = s.creator || 'founder';
    const a = s.access || {};
    const roles = (a.allowed_roles || []).map(r => r.toLowerCase());
    document.getElementById('accessFounder').checked = roles.includes('founder');
    document.getElementById('accessDaena').checked = roles.includes('daena');
    document.getElementById('accessDeptAgents').checked = roles.includes('agent');
    const depts = a.allowed_departments || [];
    const agents = a.allowed_agents || [];
    document.getElementById('accessSpecificDepts').checked = depts.length > 0;
    document.getElementById('accessSpecificAgents').checked = agents.length > 0;
    document.getElementById('accessDeptsList').value = depts.join(', ');
    document.getElementById('accessAgentsList').value = agents.join(', ');
    document.getElementById('accessSpecificDeptsRow').style.display = depts.length > 0 ? 'block' : 'none';
    document.getElementById('accessSpecificAgentsRow').style.display = agents.length > 0 ? 'block' : 'none';
    const risk = (s.risk_level || s.risk || 'low').toLowerCase();
    setSkillRisk(risk);
    window._newSkillRisk = risk;
    const approval = (s.approval_policy || 'auto').toLowerCase();
    setSkillApproval(approval);
    window._newSkillApproval = approval;
    document.getElementById('requiresStepUpConfirm').checked = s.requires_step_up_confirm !== false;
    const enabled = s.enabled !== false;
    const toggleEl = document.getElementById('newSkillEnabledToggle');
    if (toggleEl) { toggleEl.classList.toggle('on', enabled); toggleEl.setAttribute('aria-pressed', enabled); }
    document.getElementById('newSkillEnabledLabel').textContent = enabled ? 'On (skill can be used after save)' : 'Off (skill disabled)';
    document.getElementById('skillModalSubmit').textContent = 'Save';
    openModal('skill');
  }
  function createOrUpdateSkill() {
    const editId = document.getElementById('editSkillId') && document.getElementById('editSkillId').value;
    if (editId) updateSkill(editId); else createSkill();
  }
  async function updateSkill(id) {
    const display = document.getElementById('newSkillDisplay').value?.trim() || document.getElementById('newSkillName').value?.trim();
    const desc = document.getElementById('newSkillDesc').value?.trim() || '';
    const cat = document.getElementById('newSkillCat').value || 'utility';
    const creator = document.getElementById('newSkillCreator').value || 'founder';
    const enabled = document.getElementById('newSkillEnabledToggle').classList.contains('on');
    if (!window._newSkillRisk) window._newSkillRisk = 'low'; if (!window._newSkillApproval) window._newSkillApproval = 'auto';
    const access = getNewSkillAccessScope();
    const policyObj = getNewSkillExecutionPolicy();
    const payload = { display_name: display, description: desc, category: cat, creator, enabled, access, policy: { risk_level: policyObj.risk_level, approval_policy: policyObj.approval_policy, requires_step_up_confirm: policyObj.requires_step_up_confirm } };
    try {
      const r = await apiRequest(API.skills + '/' + encodeURIComponent(id), { method: 'PUT', body: JSON.stringify(payload) });
      if (r && (r.success || r.id)) { if (window.showToast) window.showToast('Skill updated', 'success'); document.getElementById('editSkillId').value = ''; document.getElementById('skillModalSubmit').textContent = 'Create Skill'; closeModal('skill'); loadSkills(); }
      else if (window.showToast) window.showToast(r?.detail || 'Update failed', 'error');
    } catch (e) { if (window.showToast) window.showToast('Failed: ' + (e.message || e), 'error'); }
  }
  function filterSkills(f, el) {
    skillFilter = f;
    document.querySelectorAll('.filter-chip[data-filter]').forEach(c => c.classList.remove('active'));
    if (el) el.classList.add('active');
    loadSkills();
  }
  function setOperatorTab(v, el) {
    operatorRoleFilter = v;
    document.querySelectorAll('.operator-tab[data-operator]').forEach(c => c.classList.toggle('active', (c.getAttribute('data-operator') || '') === v));

    // Toggle Founder-only features
    const isFounder = v === 'founder';
    const bulkBar = document.getElementById('skillBulkBar');
    if (bulkBar) {
      // We only show selection column and bulk bar if in Founder mode
      // Or we just allow selection but show actions only for founder
      // Actually the prompt says: Bulk actions (Visible ONLY in Founder Tab)
      window._skillRegistryMode = v;
    }

    loadSkills();
  }
  function filterSkillsByAccess(v, el) { setOperatorTab(v, el); }
  function filterSkillsByCategory(v, el) {
    skillCategoryFilter = (v || '').toLowerCase();
    document.querySelectorAll('.filter-chip[data-category]').forEach(c => c.classList.toggle('active', (c.getAttribute('data-category') || '') === (v || '')));
    loadSkills();
  }
  function resetAllSkillFilters() {
    skillFilter = 'all';
    skillCategoryFilter = '';
    skillRiskFilter = '';
    skillApprovalFilter = '';
    skillStatusFilter = '';
    skillSearchQuery = '';
    operatorRoleFilter = '';
    document.getElementById('skillSearch').value = '';
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', !c.getAttribute('data-category') && !c.getAttribute('data-risk') && !c.getAttribute('data-approval') && !c.getAttribute('data-status') && !c.getAttribute('data-operator')));
    document.querySelectorAll('.operator-tab').forEach(c => c.classList.toggle('active', !c.getAttribute('data-operator')));
    loadSkills();
  }
  function filterSkillsByStatus(v, el) {
    skillStatusFilter = v;
    document.querySelectorAll('.filter-chip[data-status]').forEach(c => c.classList.toggle('active', (c.getAttribute('data-status') || '') === v));
    loadSkills();
  }
  let _skillSearchTimer;
  function debouncedSkillSearch() {
    clearTimeout(_skillSearchTimer);
    _skillSearchTimer = setTimeout(() => { skillSearchQuery = document.getElementById('skillSearch')?.value?.trim() || ''; loadSkills(); }, 280);
  }
  async function patchSkillAccess(skillId, role, add) {
    const s = window._lastSkillsList?.find(x => x.id === skillId); if (!s) return;
    const roles = [...(s.access?.allowed_roles || [])].map(r => r.toLowerCase());
    const r = role.toLowerCase();
    if (add && !roles.includes(r)) roles.push(r);
    if (!add && roles.includes(r)) roles.splice(roles.indexOf(r), 1);
    const res = await apiRequest(API.skills + '/' + encodeURIComponent(skillId) + '/access', { method: 'PATCH', body: JSON.stringify({ allowed_roles: roles }) });
    if (res && res.success) loadSkills(); else if (window.showToast) window.showToast(res?.detail || 'Failed to update access', 'error');
  }
  function filterSkillsByRisk(v, el) {
    skillRiskFilter = v;
    document.querySelectorAll('.filter-chip[data-risk]').forEach(c => c.classList.toggle('active', c.getAttribute('data-risk') === v));
    loadSkills();
  }
  function filterSkillsByApproval(v, el) {
    skillApprovalFilter = v;
    document.querySelectorAll('.filter-chip[data-approval]').forEach(c => c.classList.toggle('active', c.getAttribute('data-approval') === v));
    loadSkills();
  }
  function setSkillCreator(v) {
    document.querySelectorAll('.segmented-pill-btn[data-creator]').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector('.segmented-pill-btn[data-creator="' + v + '"]');
    if (btn) btn.classList.add('active');
    const hid = document.getElementById('newSkillCreator');
    if (hid) hid.value = v;
  }
  function toggleNewSkillEnabled() {
    const el = document.getElementById('newSkillEnabledToggle');
    const label = document.getElementById('newSkillEnabledLabel');
    if (!el) return;
    const on = !el.classList.contains('on');
    el.classList.toggle('on', on);
    el.setAttribute('aria-pressed', on);
    if (label) label.textContent = on ? 'On (skill can be used after creation)' : 'Off (skill disabled when created)';
  }
  function getNewSkillEnabled() { return document.getElementById('newSkillEnabledToggle').classList.contains('on'); }
  function setSkillCategory(v) {
    const val = (v || 'utility').toLowerCase();
    const hid = document.getElementById('newSkillCat'); if (hid) hid.value = val;
    const sel = document.getElementById('newSkillCatSelect'); if (sel) sel.value = val;
  }
  function setSkillRisk(v) {
    ['riskLow', 'riskMed', 'riskHigh'].forEach((id, i) => { const b = document.getElementById(id); if (b) b.classList.toggle('active', ['low', 'medium', 'high'][i] === v); });
    window._newSkillRisk = v;
  }
  function setSkillApproval(v) {
    ['approvalAuto', 'approvalRequired', 'approvalAlways'].forEach((id, i) => { const b = document.getElementById(id); if (b) b.classList.toggle('active', ['auto', 'approval_required', 'always_approval'][i] === v); });
    window._newSkillApproval = v;
  }
  function initAccessScopeToggles() {
    const cbDepts = document.getElementById('accessSpecificDepts'), rowDepts = document.getElementById('accessSpecificDeptsRow');
    const cbAgents = document.getElementById('accessSpecificAgents'), rowAgents = document.getElementById('accessSpecificAgentsRow');
    if (cbDepts && rowDepts) cbDepts.addEventListener('change', function () { rowDepts.style.display = this.checked ? 'block' : 'none'; });
    if (cbAgents && rowAgents) cbAgents.addEventListener('change', function () { rowAgents.style.display = this.checked ? 'block' : 'none'; });
  }
  function getNewSkillAccessScope() {
    const roles = []; if (document.getElementById('accessFounder')?.checked) roles.push('founder'); if (document.getElementById('accessDaena')?.checked) roles.push('daena'); if (document.getElementById('accessDeptAgents')?.checked) roles.push('agent');
    let depts = [], agents = []; if (document.getElementById('accessSpecificDepts')?.checked) { const r = document.getElementById('accessDeptsList')?.value?.trim() || ''; if (r) depts = r.split(/[\s,]+/).map(s => s.trim()).filter(Boolean); }
    if (document.getElementById('accessSpecificAgents')?.checked) { const r = document.getElementById('accessAgentsList')?.value?.trim() || ''; if (r) agents = r.split(/[\s,]+/).map(s => s.trim()).filter(Boolean); }
    return { allowed_roles: roles, allowed_departments: depts, allowed_agents: agents };
  }
  function getNewSkillExecutionPolicy() { return { risk_level: window._newSkillRisk || 'low', approval_policy: window._newSkillApproval || 'auto', requires_step_up_confirm: document.getElementById('requiresStepUpConfirm')?.checked !== false }; }
  async function createSkill() {
    const name = document.getElementById('newSkillName').value?.trim();
    const display = document.getElementById('newSkillDisplay').value?.trim() || name;
    const desc = document.getElementById('newSkillDesc').value?.trim() || '';
    const cat = document.getElementById('newSkillCat').value || 'utility';
    const creator = document.getElementById('newSkillCreator').value || 'founder';
    const enabled = getNewSkillEnabled();
    const code = document.getElementById('newSkillCode').value?.trim() || '';
    if (!name) { if (window.showToast) window.showToast('Enter a skill name', 'error'); return; }
    if (!window._newSkillRisk) window._newSkillRisk = 'low'; if (!window._newSkillApproval) window._newSkillApproval = 'auto';
    const access = getNewSkillAccessScope();
    const policy = getNewSkillExecutionPolicy();
    try {
      const payload = { name, display_name: display, description: desc, category: cat, creator, enabled, code_body: code, access, risk_level: policy.risk_level, approval_policy: policy.approval_policy, requires_step_up_confirm: policy.requires_step_up_confirm };
      const r = await apiRequest(API.skills, { method: 'POST', body: JSON.stringify(payload) });
      if (r && (r.id || r.skill_id || r.success)) { if (window.showToast) window.showToast('Skill created', 'success'); closeModal('skill'); loadSkills(); }
      else { if (window.showToast) window.showToast(r?.detail || r?.error || 'Skill creation: use backend API', 'info'); closeModal('skill'); loadSkills(); }
    } catch (e) { if (window.showToast) window.showToast('Failed: ' + (e.message || e), 'error'); }
  }

  // ─── PACKAGES (sync: GET /, GET /stats, POST /audit, POST /audit/{id}/run|approve|reject|install) ───
  async function loadPackages() {
    const stats = await apiRequest(API.packages + '/stats');
    if (stats) {
      document.getElementById('pkgTotal').textContent = stats.total || stats.queued || 0;
      document.getElementById('pkgPending').textContent = stats.pending || stats.pending_approval || 0;
      document.getElementById('pkgApproved').textContent = stats.approved || 0;
      document.getElementById('pkgRejected').textContent = stats.rejected || 0;
    }
    const res = await apiRequest(API.packages + '/');
    const records = (res && res.records) || [];
    const idKey = (r) => r.id || r.record_id || r.audit_id || '';
    document.getElementById('pkgTable').innerHTML = records.map(p => {
      const id = idKey(p);
      const status = (p.status || '').toLowerCase();
      const risk = (p.risk_level || p.risk || '—').toLowerCase();
      let actions = '';
      if (status === 'pending_approval') actions = `<button class="btn btn-green" style="padding:3px 8px;font-size:10px" onclick="approvePkg('${id}')">✓</button> <button class="btn btn-danger" style="padding:3px 8px;font-size:10px" onclick="rejectPkg('${id}')">✗</button>`;
      else if (status === 'approved') actions = `<button class="btn btn-gold" style="padding:3px 8px;font-size:10px" onclick="installPkg('${id}')">Install</button>`;
      if (status === 'queued' || status === 'pending_audit') actions += `<button class="btn btn-primary" style="padding:3px 8px;font-size:10px" onclick="auditPkg('${id}')">Run Audit</button>`;
      return `<tr><td class="td-mono"><strong>${p.package_name || p.name || '—'}</strong></td><td class="td-mono">${p.version || '—'}</td><td>${p.manager || '—'}</td><td><span class="badge badge-${risk}">${p.risk_level || p.risk || '—'}</span></td><td><span class="badge badge-${status}">${p.status || '—'}</span></td><td>${actions}</td></tr>`;
    }).join('') || '<tr><td colspan="6" class="empty-state">No packages</td></tr>';
  }
  async function requestPackage() {
    const payload = { package_name: document.getElementById('newPkgName').value, version: document.getElementById('newPkgVer').value || 'latest', manager: document.getElementById('newPkgMgr').value || 'npm', requested_by: document.getElementById('newPkgBy').value || 'founder' };
    if (!payload.package_name) return;
    await apiRequest(API.packages + '/audit', { method: 'POST', body: JSON.stringify(payload) });
    closeModal('package'); loadPackages();
  }
  async function auditPkg(id) { await apiRequest(API.packages + '/audit/' + id + '/run', { method: 'POST' }); loadPackages() }
  async function approvePkg(id) { await apiRequest(API.packages + '/audit/' + id + '/approve', { method: 'POST', body: JSON.stringify({ approver: 'founder', notes: '' }) }); loadPackages() }
  async function rejectPkg(id) { await apiRequest(API.packages + '/audit/' + id + '/reject', { method: 'POST', body: JSON.stringify({ reason: 'Founder review', rejector: 'founder' }) }); loadPackages() }
  async function installPkg(id) { await apiRequest(API.packages + '/audit/' + id + '/install', { method: 'POST' }); loadPackages() }

  // ─── GOVERNANCE (sync: GET /stats, GET /pending, POST /approve, POST /reject with body.decision_id) ───
  async function loadGovernance() {
    const stats = await apiRequest(API.governance + '/stats');
    if (stats) {
      document.getElementById('govAuto').textContent = stats.auto_approved || 0;
      document.getElementById('govPending').textContent = stats.pending || 0;
      document.getElementById('govToday').textContent = stats.today || 0;
      document.getElementById('govBlocked').textContent = stats.blocked || 0;
    }
    const pendRes = await apiRequest(API.governance + '/pending');
    const pending = (pendRes && pendRes.pending) || [];
    const decisionId = (a) => a.decision_id || a.id || '';
    if (pending.length) {
      document.getElementById('govPendingTable').innerHTML = pending.map(a => {
        const id = decisionId(a);
        const desc = (a.description || a.action || '').replace(/'/g, "\\'");
        return `<tr><td><strong>${a.action_type || a.action || '—'}</strong><div style="font-size:10px;color:var(--text-dim)">${a.description || ''}</div></td><td><span class="badge badge-${(a.risk_level || a.risk || '').toLowerCase()}">${a.risk_level || a.risk || '—'}</span></td><td class="td-mono">${a.agent_id || a.agent || '—'}</td><td class="td-mono">${timeAgo(a.created_at)}</td><td><button class="btn btn-green" style="padding:3px 8px;font-size:10px" onclick="openApproveModal('${id}','${(a.action_type || a.action || '').slice(0, 30)}','${desc.slice(0, 200)}')">Approve</button> <button class="btn btn-danger" style="padding:3px 8px;font-size:10px" onclick="openRejectModal('${id}')">Reject</button></td></tr>`;
      }).join('');
    } else {
      document.getElementById('govPendingTable').innerHTML = '<tr><td colspan="5" class="empty-state">No pending actions — Autopilot handling everything</td></tr>';
    }
    const logRes = await apiRequest(API.execution + '/logs');
    const log = (logRes && logRes.logs) || [];
    if (log.length) {
      document.getElementById('govLogTable').innerHTML = log.slice(0, 20).map(a => `<tr><td><strong>${a.tool || a.action || '—'}</strong></td><td><span class="badge badge-${(a.risk || '').toLowerCase()}">${a.risk || '—'}</span></td><td><span class="badge badge-active">${a.status || '—'}</span></td><td class="td-mono">${timeAgo(a.timestamp || a.created_at)}</td></tr>`).join('');
    } else {
      document.getElementById('govLogTable').innerHTML = '<tr><td colspan="4" class="empty-state">No execution log yet — <a href="#" onclick="loadTabData(\'execution\');return false" class="link">View Execution</a></td></tr>';
    }
  }
  function openApproveModal(id, action, details) {
    currentApproveId = id;
    document.getElementById('approveTitle').textContent = 'Approve: ' + action;
    document.getElementById('approveDetails').textContent = details;
    document.getElementById('approveNotes').value = '';
    openModal('approve');
  }
  function openRejectModal(id) { currentApproveId = id; document.getElementById('approveTitle').textContent = 'Reject Action'; document.getElementById('approveDetails').textContent = 'Reject this action?'; document.getElementById('approveNotes').value = ''; openModal('approve') }
  async function approveAction() {
    if (!currentApproveId) return;
    await apiRequest(API.governance + '/approve', { method: 'POST', body: JSON.stringify({ decision_id: currentApproveId, approver_id: 'founder', notes: document.getElementById('approveNotes').value }) });
    closeModal('approve'); loadGovernance();
  }
  async function rejectAction() {
    if (!currentApproveId) return;
    await apiRequest(API.governance + '/reject', { method: 'POST', body: JSON.stringify({ decision_id: currentApproveId, approver_id: 'founder', notes: document.getElementById('approveNotes').value || 'Founder rejected' }) });
    closeModal('approve'); loadGovernance();
  }

  // ─── EXECUTION (sync: GET /logs [no token], GET /tools, /config [with token via apiExecution]) ───
  async function loadExecution() {
    await loadExecutionAuthStatus();
    const logRes = await apiRequest(API.execution + '/logs');
    const logs = (logRes && logRes.logs) || [];
    const table = document.getElementById('executionLogTable');
    if (table) {
      table.innerHTML = logs.slice(0, 50).map(e => `<tr><td class="td-mono">${timeAgo(e.timestamp || e.time)}</td><td>${e.tool || e.name || '—'}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${(e.result || e.status || '—').toString().slice(0, 80)}</td></tr>`).join('') || '<tr><td colspan="3" class="empty-state">No execution log yet</td></tr>';
    }
    let toolsCount = 0;
    const toolsRes = await apiExecution(API.execution + '/tools');
    if (toolsRes && toolsRes.tools) toolsCount = toolsRes.tools.length;
    const capEl = document.getElementById('capabilitySummary');
    if (capEl) capEl.textContent = toolsCount ? `${logs.length} log entries; ${toolsCount} tools available to Daena (subject to approval).` : logs.length + ' log entries. Tools list requires Execution token or localhost bypass.';
  }

  // ─── DAENABOT TOOLS (sync: GET /status, /queue, /history; POST /{id}/approve, /{id}/reject) ───
  async function loadDaenaBotTools() {
    try {
      const statusRes = await apiRequest(API.tools + '/status');
      const status = statusRes || {};
      const connected = status.connected === true;
      const displayName = status.display_name || 'DaenaBot';
      const el = document.getElementById('toolsGatewayStatus');
      if (el) { el.textContent = connected ? 'Connected' : 'Disconnected'; el.style.color = connected ? 'var(--green)' : 'var(--text-dim)'; }
      const sub = document.getElementById('toolsGatewaySub');
      if (sub) sub.textContent = status.authenticated ? 'Authenticated' : 'Connection';
      document.getElementById('toolsDisplayName').textContent = displayName;
      const label = document.getElementById('daenabot-tools-label');
      if (label) label.textContent = displayName + ' Tools';

      const queueRes = await apiRequest(API.tools + '/queue');
      const pending = (queueRes && queueRes.pending) || [];
      document.getElementById('toolsPendingCount').textContent = pending.length;
      const badge = document.getElementById('daenabot-tools-badge');
      if (badge) { badge.textContent = pending.length; badge.style.display = pending.length ? 'inline' : 'none'; }

      const queueTable = document.getElementById('toolsQueueTable');
      if (queueTable) {
        queueTable.innerHTML = pending.length ? pending.map(r => {
          const action = r.action_json || {};
          const actionStr = (action.action_type || action.tool_name || action.type || JSON.stringify(action).slice(0, 40)).toString().replace(/</g, '&lt;');
          const idSafe = (r.id || '').toString().replace(/'/g, "\\'");
          return `<tr><td class="td-mono">${timeAgo(r.created_at)}</td><td>${(r.requested_by || '—').toString().replace(/</g, '&lt;')}</td><td><span class="badge badge-${(r.risk_level || 'medium').toLowerCase()}">${(r.risk_level || '—').toString().replace(/</g, '&lt;')}</span></td><td class="td-mono" style="max-width:180px;overflow:hidden;text-overflow:ellipsis">${actionStr}</td><td><button class="btn" style="padding:3px 8px;font-size:10px;margin-right:4px" onclick="approveToolRequest('${idSafe}')">Approve</button><button class="btn" style="padding:3px 8px;font-size:10px" onclick="rejectToolRequest('${idSafe}')">Reject</button></td></tr>`;
        }).join('') : '<tr><td colspan="5" class="empty-state">No pending requests</td></tr>';
      }

      const historyRes = await apiRequest(API.tools + '/history');
      const history = (historyRes && historyRes.history) || [];
      const historyTable = document.getElementById('toolsHistoryTable');
      if (historyTable) {
        historyTable.innerHTML = history.length ? history.slice(0, 20).map(r => {
          const action = r.action_json || {};
          const actionStr = (action.action_type || action.tool_name || action.type || '—').toString().replace(/</g, '&lt;');
          const resultStr = r.result_json ? (r.result_json.success === true ? 'OK' : (r.result_json.error || 'Failed')) : (r.status === 'rejected' ? 'Rejected' : r.status || '—');
          return `<tr><td class="td-mono">${timeAgo(r.created_at)}</td><td>${(r.requested_by || '—').toString().replace(/</g, '&lt;')}</td><td><span class="badge">${(r.risk_level || '—').toString().replace(/</g, '&lt;')}</span></td><td><span class="badge badge-${(r.status || '').toLowerCase()}">${(r.status || '—').toString().replace(/</g, '&lt;')}</span></td><td class="td-mono">${resultStr.toString().replace(/</g, '&lt;').slice(0, 30)}</td></tr>`;
        }).join('') : '<tr><td colspan="5" class="empty-state">No history</td></tr>';
      }
    } catch (e) {
      const q = document.getElementById('toolsQueueTable');
      if (q) q.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading: ' + (e.message || String(e)).replace(/</g, '&lt;') + '</td></tr>';
      const h = document.getElementById('toolsHistoryTable');
      if (h) h.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading history</td></tr>';
    }
  }
  async function testHandsConnection() {
    const btn = document.getElementById('pingHandsBtn');
    const resultEl = document.getElementById('pingHandsResult');
    if (btn) btn.disabled = true;
    if (resultEl) resultEl.textContent = 'Checking…';
    try {
      const r = await apiRequest(API.hands + '/status');
      const ok = r && (r.configured === true && r.reachable === true);
      const msg = (r && r.message) ? r.message : (r && r.reachable ? 'Connected' : 'Disconnected');
      if (resultEl) {
        resultEl.textContent = msg;
        resultEl.style.color = ok ? 'var(--green)' : (r && r.configured ? 'var(--text-dim)' : 'var(--red)');
      }
      if (window.showToast) window.showToast(msg, ok ? 'success' : 'error');
      loadDaenaBotTools();
    } catch (e) {
      if (resultEl) { resultEl.textContent = (e.message || String(e)).slice(0, 60); resultEl.style.color = 'var(--red)'; }
      if (window.showToast) window.showToast('Check failed: ' + (e.message || e), 'error');
    }
    if (btn) btn.disabled = false;
  }
  async function approveToolRequest(id) {
    if (!id) return;
    try {
      await apiRequest(API.tools + '/' + encodeURIComponent(id) + '/approve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ approver: 'founder', notes: '' }) });
      if (window.showToast) window.showToast('Request approved and executed', 'success');
      loadDaenaBotTools();
    } catch (e) {
      if (window.showToast) window.showToast('Approve failed: ' + (e.message || e), 'error');
      loadDaenaBotTools();
    }
  }
  async function rejectToolRequest(id) {
    if (!id) return;
    try {
      await apiRequest(API.tools + '/' + encodeURIComponent(id) + '/reject', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reason: 'Founder rejected', rejector: 'founder' }) });
      if (window.showToast) window.showToast('Request rejected', 'info');
      loadDaenaBotTools();
    } catch (e) {
      if (window.showToast) window.showToast('Reject failed: ' + (e.message || e), 'error');
      loadDaenaBotTools();
    }
  }

  async function testAction(type, params) {
    if (window.showToast) window.showToast('Dispatching...', 'info');
    try {
      const r = await apiRequest(API.tools + '/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action_type: type, parameters: params, requested_by: 'founder' })
      });
      if (r && r.status) {
        if (r.status === 'approved_and_executed') {
          const success = r.result && r.result.success;
          window.showToast(success ? 'Executed: Success' : 'Executed: Failed (' + (r.result.error || '') + ')', success ? 'success' : 'error');
        } else if (r.status === 'queued_for_approval') {
          window.showToast('Queued for approval', 'warning');
        } else {
          window.showToast('Status: ' + r.status + (r.message ? ' (' + r.message + ')' : ''), 'info');
        }
        loadDaenaBotTools();
      } else {
        window.showToast('Dispatch failed', 'error');
      }
    } catch (e) {
      window.showToast('Error: ' + (e.message || e), 'error');
    }
  }

  // ─── INTEGRATIONS (sync: GET /, GET /mcp-servers) ───
  async function loadIntegrations() {
    const list = await apiRequest(API.integrations);
    const integrations = (list && list.integrations) || (Array.isArray(list) ? list : []);
    document.getElementById('intTotal').textContent = integrations.length || 0;
    const mcpRes = await apiRequest(API.integrations + '/mcp-servers');
    const mcp = (mcpRes && mcpRes.servers) || (mcpRes && mcpRes.mcp_servers) || [];
    document.getElementById('intMcp').textContent = mcp.length || 0;
    const table = document.getElementById('integrationsTable');
    if (table) table.innerHTML = integrations.map(i => `<tr><td>${i.name || i.id || '—'}</td><td><span class="badge badge-${(i.status || 'unknown').toLowerCase()}">${i.status || '—'}</span></td><td>${i.type || '—'}</td></tr>`).join('') || '<tr><td colspan="3" class="empty-state">No integrations</td></tr>';
    const mcpTable = document.getElementById('mcpServersTable');
    if (mcpTable) mcpTable.innerHTML = mcp.map(s => `<tr><td>${s.name || s.id || '—'}</td><td class="td-mono">${(s.url || s.endpoint || '—').toString().slice(0, 40)}</td><td>${s.status || '—'}</td></tr>`).join('') || '<tr><td colspan="3" class="empty-state">No MCP servers</td></tr>';
  }

  // ─── PROACTIVE (sync: GET /rules, GET /events) ───
  async function loadProactive() {
    const rulesRes = await apiRequest(API.proactive + '/rules');
    const rules = (rulesRes && rulesRes.rules) || (Array.isArray(rulesRes) ? rulesRes : []);
    document.getElementById('proactiveRulesList').innerHTML = rules.length ? rules.map(r => `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">${r.name || r.id || '—'}: ${(r.schedule || r.trigger || '—')}</div>`).join('') : '<p class="text-dim">No proactive rules</p>';
    const eventsRes = await apiRequest(API.proactive + '/events');
    const events = (eventsRes && eventsRes.events) || (Array.isArray(eventsRes) ? eventsRes : []);
    document.getElementById('proactiveEventsList').innerHTML = events.length ? events.slice(0, 20).map(e => `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:11px">${timeAgo(e.timestamp || e.time)} — ${(e.type || e.name || '—').toString().slice(0, 40)}</div>`).join('') : '<p class="text-dim">No recent events</p>';
  }

  // ─── COUNCIL ────────────────────────────────────
  async function loadCouncil() {
    const debates = await apiRequest(API.council + '/debates');
    if (debates && debates.length) {
      document.getElementById('councilActive').textContent = debates.filter(d => d.status === 'active').length;
      document.getElementById('councilResolved').textContent = debates.filter(d => d.status === 'resolved').length;
      document.getElementById('councilPending').textContent = debates.filter(d => d.status === 'pending_vote').length;
      document.getElementById('councilExperts').textContent = [...new Set(debates.flatMap(d => d.experts || []))].length;
      document.getElementById('councilTable').innerHTML = debates.map(d => `<tr>
      <td><strong>${d.topic || '—'}</strong></td>
      <td><span class="badge badge-${d.status === 'active' ? 'active' : 'pending'}">${d.status || '—'}</span></td>
      <td>${(d.experts || []).length}</td>
      <td class="td-mono">${timeAgo(d.created_at)}</td>
    </tr>`).join('');
    } else {
      document.getElementById('councilTable').innerHTML = '<tr><td colspan="4" class="empty-state">No active debates</td></tr>';
    }
  }

  // ─── TRUST ──────────────────────────────────────
  async function loadTrust() {
    const stats = await apiRequest(API.integrity + '/stats');
    if (stats) {
      document.getElementById('trustVerified').textContent = stats.verifications || 0;
      document.getElementById('trustBlocked').textContent = stats.injections_blocked || 0;
      document.getElementById('trustSources').textContent = stats.trusted_sources || 0;
      document.getElementById('trustStripped').textContent = stats.stripped || 0;
    }
    const sources = await apiRequest(API.integrity + '/sources');
    if (sources && sources.length) {
      document.getElementById('trustTable').innerHTML = sources.map(s => `<tr>
      <td class="td-mono">${s.name || '—'}</td>
      <td>${s.trust_score != null ? Math.round(s.trust_score * 100) + '%' : '—'}</td>
      <td><span class="badge badge-${s.trusted ? 'active' : 'pending'}">${s.trusted ? 'Trusted' : 'Unverified'}</span></td>
      <td class="td-mono">${timeAgo(s.last_checked)}</td>
    </tr>`).join('');
    } else {
      document.getElementById('trustTable').innerHTML = '<tr><td colspan="4" class="empty-state">No sources tracked</td></tr>';
    }
  }
  async function verifyContent() {
    const content = document.getElementById('verifyContent').value;
    const source = document.getElementById('verifySource').value;
    if (!content) return;
    const r = await apiRequest(API.integrity + '/verify', { method: 'POST', body: JSON.stringify({ content, source }) });
    closeModal('verify');
    if (r) { addFeed('trustFeed', new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }), r.safe ? 'green' : 'red', `<strong>Verify result:</strong> ${r.safe ? 'Safe ✓' : 'BLOCKED ✗'} — ${r.reason || ''}`) }
  }

  // ─── SHADOW ─────────────────────────────────────
  async function loadShadow() {
    const stats = await apiRequest(API.shadow + '/stats');
    if (stats) {
      document.getElementById('shadowHoney').textContent = stats.honeypots || 0;
      document.getElementById('shadowCanary').textContent = stats.canaries || 0;
      document.getElementById('shadowAlerts').textContent = stats.alerts_24h || 0;
      document.getElementById('shadowTTPs').textContent = stats.ttps || 0;
    }
    const honeypots = await apiRequest(API.shadow + '/honeypots');
    if (honeypots && honeypots.length) {
      document.getElementById('shadowTable').innerHTML = honeypots.map(h => `<tr>
      <td class="td-mono">${h.path || '—'}</td>
      <td>${h.type || '—'}</td>
      <td>${h.hits || 0}</td>
      <td class="td-mono">${timeAgo(h.last_hit)}</td>
    </tr>`).join('');
    } else {
      document.getElementById('shadowTable').innerHTML = '<tr><td colspan="4" class="empty-state">No honeypots configured</td></tr>';
    }
  }

  // ─── TREASURY ───────────────────────────────────
  async function loadTreasury() {
    try {
      const r = await apiRequest(API.treasury + '/status');
      if (r && r.success) {
        document.getElementById('treasDaena').textContent = String(r.daena_balance ?? '0');
        document.getElementById('treasNFT').textContent = String(r.nft_minted ?? 0);
        document.getElementById('treasETH').textContent = String(r.eth_held ?? '0');
        document.getElementById('treasSpend').textContent = String(r.monthly_spend ?? '$0');
        const txs = r.transactions || [];
        document.getElementById('treasTable').innerHTML = txs.length
          ? txs.map(t => `<tr><td>${t.type || '—'}</td><td>${t.amount || '—'}</td><td>${t.approved_by || '—'}</td><td>${t.time || '—'}</td></tr>`).join('')
          : '<tr><td colspan="4" class="empty-state">No transactions yet</td></tr>';
      } else {
        _setTreasuryPlaceholder();
      }
    } catch (e) {
      _setTreasuryPlaceholder();
    }
  }
  function _setTreasuryPlaceholder() {
    document.getElementById('treasDaena').textContent = '0';
    document.getElementById('treasNFT').textContent = '0';
    document.getElementById('treasETH').textContent = '0';
    document.getElementById('treasSpend').textContent = '$0';
    document.getElementById('treasTable').innerHTML = '<tr><td colspan="4" class="empty-state">Treasury API unavailable — check backend</td></tr>';
  }

  // ─── AGENTS (Operator scope: who can run skills — Founder, Daena, Agents. Tab shows agent registry from /api/v1/agents) ───
  async function loadAgents() {
    const tableEl = document.getElementById('agentsTable');
    const setTable = (html) => { if (tableEl) tableEl.innerHTML = html; };
    try {
      const res = await apiRequest(API.agents || '/api/v1/agents');
      const list = (res && Array.isArray(res)) ? res : (res && res.agents) ? res.agents : (res && res.items) ? res.items : null;
      if (list && list.length > 0) {
        const online = list.filter(a => (a.status || a.state || '').toLowerCase() === 'online' || a.active).length;
        const actions = list.reduce((s, a) => s + (a.actions_count || a.actions || 0), 0);
        document.getElementById('agentOnline').textContent = online;
        document.getElementById('agentActions').textContent = actions;
        document.getElementById('agentDepts').textContent = [...new Set((list.map(a => a.department || a.dept || a.department_id || '—')))].length;
        document.getElementById('agentPending').textContent = (res && res.pending != null) ? res.pending : list.filter(a => (a.status || '').toLowerCase() === 'pending').length;
        setTable(list.map(a => {
          const name = (a.name || a.display_name || a.agent_id || '—').toString().replace(/</g, '&lt;');
          const dept = (a.department || a.dept || a.department_id || '—').toString().replace(/</g, '&lt;');
          const status = (a.status || a.state || 'idle').toLowerCase();
          const last = timeAgo(a.last_activity || a.updated_at || a.last_seen);
          const acts = a.actions_count || a.actions || 0;
          return `<tr><td><strong>${name}</strong></td><td>${dept}</td><td><span class="badge badge-${status}">${status}</span></td><td class="td-mono">${last}</td><td>${acts}</td></tr>`;
        }).join(''));
      } else {
        const depts = ['Research', 'Security', 'DeFi', 'Communication', 'Data', 'Operations', 'Innovation', 'Strategy'];
        const fallback = depts.flatMap(d => [
          { name: d + ' Lead', dept: d, status: 'online', last: 'Just now', actions: 0 },
          { name: d + ' Analyst', dept: d, status: 'idle', last: '—', actions: 0 }
        ]);
        document.getElementById('agentOnline').textContent = fallback.filter(a => a.status === 'online').length;
        document.getElementById('agentActions').textContent = '0';
        document.getElementById('agentDepts').textContent = depts.length;
        document.getElementById('agentPending').textContent = '0';
        setTable(fallback.map(a => `<tr><td><strong>${a.name}</strong></td><td>${a.dept}</td><td><span class="badge badge-${a.status}">${a.status}</span></td><td class="td-mono">${a.last}</td><td>${a.actions}</td></tr>`).join('') || '<tr><td colspan="5" class="empty-state">No agents — backend /api/v1/agents returned empty. Connect agents or check backend.</td></tr>');
      }
    } catch (e) {
      setTable('<tr><td colspan="5" class="empty-state">Agents API unavailable — check backend. <button type="button" class="btn" onclick="loadAgents()">Retry</button></td></tr>');
      if (document.getElementById('agentOnline')) document.getElementById('agentOnline').textContent = '—';
      if (document.getElementById('agentActions')) document.getElementById('agentActions').textContent = '—';
      if (document.getElementById('agentDepts')) document.getElementById('agentDepts').textContent = '—';
      if (document.getElementById('agentPending')) document.getElementById('agentPending').textContent = '—';
    }
  }

  // ─── RESEARCH ───────────────────────────────────
  async function runResearch() {
    const query = document.getElementById('researchQuery').value;
    const sources = document.getElementById('researchSrc').value;
    if (!query) return;
    addFeed('brainFeed', new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }), 'blue', `<strong>Research:</strong> "${query.slice(0, 60)}…"`);
    await apiRequest(API.research + '/query', { method: 'POST', body: JSON.stringify({ query, sources }) });
    closeModal('research');
  }

  // ─── THE QUINTESSENCE ──────────────────────────────────────────────────────────────────────────
  async function loadExperts() {
    try {
      const res = await fetch(apiBase() + API.quintessence + '/experts');
      const data = await res.json();
      const grid = document.getElementById('expertGrid');
      if (!grid) return;
      grid.innerHTML = '';

      Object.entries(data.experts).forEach(([id, exp]) => {
        const card = document.createElement('div');
        card.className = 'expert-card';
        card.onclick = () => alert(`${exp.name}: ${exp.thinking_style}`);
        card.innerHTML = `
          <div class="expert-icon">${exp.icon}</div>
          <div class="expert-name">${exp.name}</div>
          <div class="expert-title">${exp.title}</div>
        `;
        grid.appendChild(card);
      });
    } catch (e) {
      console.error("Quintessence experts error:", e);
    }
  }

  async function invokeQuintessence() {
    const problem = document.getElementById('quintProblem').value;
    const domain = document.getElementById('quintDomain').value;
    const status = document.getElementById('quintStatus');
    const feed = document.getElementById('quintFeedContent');
    const empty = document.getElementById('quintEmpty');
    const btn = document.getElementById('quintBtn');

    if (!problem) return alert("Please enter a strategic problem.");

    btn.disabled = true;
    btn.textContent = "Deliberating...";
    status.textContent = "Processing";
    status.classList.add('live');
    if (empty) empty.style.display = 'none';

    // Simulated progress logging since we don't have streaming for this yet
    const addTrace = (text, type = 'info') => {
      const div = document.createElement('div');
      div.className = 'deliberation-step';
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${text}`;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
    };

    try {
      addTrace("Initializing Supreme Council (Tier 2)...");
      addTrace("Establishing consensus baseline (Tier 1)...");

      const res = await fetch(apiBase() + API.quintessence + '/deliberate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ problem, domain })
      });

      const data = await res.json();

      addTrace("Experts consulted. Synthesizing supreme decision...");

      const resDiv = document.createElement('div');
      resDiv.style.background = 'rgba(147, 112, 219, 0.1)';
      resDiv.style.border = '1px solid var(--purple)';
      resDiv.style.borderRadius = '8px';
      resDiv.style.padding = '12px';
      resDiv.style.marginTop = '12px';
      resDiv.innerHTML = `
        <div style="font-weight:600; color: var(--purple); margin-bottom: 8px;">SUPREME DECISION</div>
        <div style="font-size: 13px; white-space: pre-wrap;">${data.decision}</div>
        <div style="margin-top: 10px; font-size: 10px; color: var(--text-dim);">Precedent ID: ${data.precedent_id}</div>
      `;
      feed.appendChild(resDiv);
      feed.scrollTop = feed.scrollHeight;

      searchPrecedents(); // Refresh list
    } catch (e) {
      addTrace("Error during deliberation: " + e.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Invoke Supreme Council";
      status.textContent = "Idle";
      status.classList.remove('live');
    }
  }

  async function searchPrecedents() {
    const q = document.getElementById('precedentSearch').value;
    const list = document.getElementById('precedentList');
    if (!list) return;

    try {
      const res = await fetch(apiBase() + API.quintessence + '/precedents/search?q=' + encodeURIComponent(q || ''));
      const data = await res.json();

      if (data.precedents.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No precedents found.</div>';
        return;
      }

      list.innerHTML = '';
      data.precedents.forEach(p => {
        const item = document.createElement('div');
        item.className = 'precedent-item';
        item.innerHTML = `
          <div style="font-weight:600; font-size: 11px;">${p.problem_summary.substring(0, 50)}...</div>
          <div style="font-size: 9px; color: var(--text-dim); margin-top: 2px;">Domain: ${p.domain} | ${p.pattern_type || 'General'}</div>
        `;
        item.onclick = () => {
          document.getElementById('quintProblem').value = p.problem_summary;
          document.getElementById('quintDomain').value = p.domain;
          alert("Precedent Loaded. You can re-deliberate or review logic.");
        };
        list.appendChild(item);
      });
    } catch (e) {
      console.error("Precedent search error:", e);
    }
  }

  // ─── UTIL ───────────────────────────────────────
  function timeAgo(ts) {
    if (!ts) return '—';
    let d = typeof ts === 'number' ? ts : new Date(ts).getTime();
    // Fix for python time.time() (seconds) vs js (ms). 
    // If timestamp is small (e.g. < 100000000000, roughly year 5138), assume seconds.
    if (typeof ts === 'number' && ts < 100000000000) {
      d = ts * 1000;
    }
    const diff = Date.now() - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    return Math.floor(diff / 86400000) + 'd ago';
  }

  // ─── CAPABILITY HANDSHAKE (on load: tools + MCP for Daena awareness) ───
  async function runCapabilityHandshake() {
    try {
      const logRes = await apiRequest(API.execution + '/logs');
      const mcpRes = await apiRequest(API.integrations + '/mcp-servers');
      const logCount = (logRes && logRes.logs) ? logRes.logs.length : 0;
      const mcpCount = (mcpRes && mcpRes.servers) ? mcpRes.servers.length : (mcpRes && mcpRes.mcp_servers ? mcpRes.mcp_servers.length : 0);
      const el = document.getElementById('executionCapSummary');
      if (el) el.textContent = 'Execution logs: ' + logCount + ' | MCP servers: ' + mcpCount + '. Daena can use tools and integrations (subject to approval).';
    } catch (e) { }
  }

  // ─── INIT (run when DOM ready; tab buttons wired first) ───
  function initControlPanel() {
    initTabButtons();
    connectWS();
    checkBackendSync();
    loadAutopilotFromBackend();
    loadAwareness();
    loadSkills();
    loadUseCases();
    runCapabilityHandshake();
    initAccessScopeToggles();
    window._newSkillRisk = 'low'; window._newSkillApproval = 'auto';
    var hash = (window.location.hash || '').slice(1);
    if (hash && document.querySelector('.tab-btn[data-tab="' + hash + '"]')) {
      switchTab(hash);
    }
    setInterval(function () {
      var active = document.querySelector('.tab-btn.active');
      if (active) loadTabData(active.dataset.tab);
    }, 30000);
  }
  // Run init when DOM is ready (ensures .tab-btn and .tab-panel exist and base layout is complete). Runs only once.
  function runInit() {
    if (window._controlPanelInitDone) return;
    window._controlPanelInitDone = true;
    try { initControlPanel(); } catch (e) { console.error('Control Pannel init error:', e); }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInit);
  } else {
    setTimeout(runInit, 0);
  }
  // Fallback: if init did not run (e.g. DOM not ready), retry once after a short delay
  setTimeout(function () { if (!window._controlPanelInitDone) runInit(); }, 200);
</script>
{% endblock %}