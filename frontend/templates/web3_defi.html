{% extends "base.html" %}

{% block title %}Web3 / DeFi — Daena VP{% endblock %}

{% block head %}
<style>
/* Web3/DeFi: match Daena VP — same font sizes and glass as Brain & API / Dashboard */
.defi-page-container { padding: 24px; max-width: 1400px; margin: 0 auto; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.5; }
.defi-page-container h1 { font-size: 26px; font-weight: 700; color: white; margin-bottom: 6px; }
.defi-page-container .subtitle { color: #9CA3AF; font-size: 14px; margin-bottom: 24px; }
.defi-stat { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 14px 16px; }
.defi-stat.blue { border-top: 2px solid #5b9bd5; }
.defi-stat.amber { border-top: 2px solid #f0a84b; }
.defi-stat.red { border-top: 2px solid #e05565; }
.defi-stat.green { border-top: 2px solid #3ecf8e; }
.defi-stat .stat-label { font-size: 11px; color: #9CA3AF; text-transform: uppercase; letter-spacing: .5px; }
.defi-stat .stat-value { font-size: 20px; font-weight: 700; }
.defi-panel h2 { font-size: 16px; font-weight: 600; color: white; margin-bottom: 12px; }
.defi-panel .hint, .defi-panel .text-muted { font-size: 12px; color: #9CA3AF; }
</style>
{% endblock %}

{% block content %}
<div class="defi-page-container">
    <h1 class="flex items-center gap-2">
        <i class="fas fa-link text-daena-gold"></i>
        Web3 / DeFi
    </h1>
    <p class="subtitle">Contract Scan, Risk Summary, Audit Report, Monitoring, Demo Mode (Consensus).</p>

    <!-- Status from GET /api/v1/defi/status -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="defi-stat blue">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Scans Run</div>
            <div class="text-xl font-mono font-semibold text-blue-400" id="defiScans">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Total</div>
        </div>
        <div class="defi-stat amber">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Vulns Found</div>
            <div class="text-xl font-mono font-semibold text-amber-400" id="defiVulns">0</div>
            <div class="text-[10px] text-gray-500 mt-1">All severity</div>
        </div>
        <div class="defi-stat red">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Critical</div>
            <div class="text-xl font-mono font-semibold text-red-400" id="defiCritical">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Needs action</div>
        </div>
        <div class="defi-stat green">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Contracts OK</div>
            <div class="text-xl font-mono font-semibold text-green-400" id="defiOK">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Clean</div>
        </div>
    </div>

    <!-- Panel: Contract Scan -->
    <div class="glass-panel rounded-xl p-5 mb-6 defi-panel">
        <h2 class="flex items-center gap-2">
            <i class="fas fa-search text-daena-gold"></i>
            Contract Scan
        </h2>
        <div class="flex flex-wrap gap-3 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-[10px] uppercase text-gray-500 mb-1">Contract path or address</label>
                <input type="text" id="defiInput" placeholder="e.g. contracts/DemoVault.sol or 0x…"
                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-daena-gold/50"/>
            </div>
            <button type="button" onclick="startDefiScan()"
                class="px-4 py-2 bg-daena-gold hover:bg-yellow-500 text-black font-bold rounded-lg text-sm flex items-center gap-2">
                <i class="fas fa-play"></i> Scan
            </button>
            <button type="button" onclick="loadDefiScans()"
                class="px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Panel: Scan Results / Risk Summary -->
        <div class="glass-panel rounded-xl p-5 defi-panel">
            <h2>Scan Results / Risk Summary</h2>
            <div class="overflow-x-auto border border-white/10 rounded-lg">
                <table class="w-full text-[13px]">
                    <thead><tr class="border-b border-white/10"><th class="text-left p-2 text-gray-500">Contract</th><th class="text-left p-2 text-gray-500">Status</th><th class="text-left p-2 text-gray-500">Vulns</th><th class="text-left p-2 text-gray-500">Time</th><th class="text-left p-2 text-gray-500"></th></tr></thead>
                    <tbody id="defiResults"><tr><td colspan="5" class="p-4 text-gray-500 text-center">No scans yet. Run a scan above.</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Panel: Monitoring & Alerts / Security Checklist -->
        <div class="glass-panel rounded-xl p-5 defi-panel">
            <h2>Monitoring & Security Checklist</h2>
            <div class="space-y-2 mb-4">
                <div class="flex items-center gap-2 text-[13px] text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Never broadcast transaction without explicit approval</div>
                <div class="flex items-center gap-2 text-[13px] text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Static analysis (e.g. Slither) — proposal step only</div>
                <div class="flex items-center gap-2 text-[13px] text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Dependency & pattern scanning (Semgrep for Solidity)</div>
                <div class="flex items-center gap-2 text-[13px] text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Fuzzing harness (Foundry/Echidna) — proposal only</div>
            </div>
            <div class="p-3 bg-black/20 rounded-lg border border-white/5 max-h-40 overflow-y-auto">
                <div class="text-[10px] text-gray-500 uppercase mb-1">Scan Log</div>
                <div id="defiFeed" class="text-xs text-gray-400 space-y-1">Scan output appears here…</div>
            </div>
        </div>
    </div>

    <!-- Panel: Audit Report (link to report per scan) -->
    <div class="mt-6 glass-panel rounded-xl p-5 defi-panel">
        <h2>Audit Report</h2>
        <p class="hint mb-2">Generate investor-ready report for a completed scan via POST /api/v1/defi/report/{scan_id}.</p>
        <div id="defiReportStatus" class="text-muted text-[12px]">Run a scan and use Report button in the table above.</div>
    </div>

    <!-- Panel: Demo Mode (Consensus hackathon) -->
    <div class="mt-6 glass-panel rounded-xl p-5 defi-panel">
        <h2>Demo Mode (Consensus)</h2>
        <p class="hint">Pick a known sample contract → run analyze → show issues → generate report → log approvals → show audit trail.</p>
        <div class="mt-2 flex flex-wrap gap-2">
            <span class="px-2 py-1 rounded bg-white/5 text-gray-400 text-[12px]">Sample: contracts/DemoVault.sol</span>
        </div>
    </div>

    <!-- Available Tools (GET /api/v1/defi/dependencies) -->
    <div class="mt-6 glass-panel rounded-xl p-5 defi-panel">
        <h2>Available Tools</h2>
        <div class="overflow-x-auto border border-white/10 rounded-lg">
            <table class="w-full text-[13px]">
                <thead><tr class="border-b border-white/10"><th class="text-left p-2 text-gray-500">Tool</th><th class="text-left p-2 text-gray-500">Version</th><th class="text-left p-2 text-gray-500">Status</th></tr></thead>
                <tbody id="defiTools"><tr><td colspan="3" class="p-4 text-gray-500 text-center">Loading…</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const API_DEFI = '/api/v1/defi';
function timeAgo(ts) {
    if (!ts) return '—';
    const d = typeof ts === 'number' ? ts : new Date(ts).getTime();
    const diff = Date.now() - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
    return Math.floor(diff/86400000) + 'd ago';
}
async function loadDefiStatus() {
    try {
        const st = await fetch(API_DEFI + '/status').then(r => r.ok ? r.json() : null);
        if (st) {
            document.getElementById('defiScans').textContent = st.scans_count || 0;
        }
    } catch (e) { console.warn('Defi status:', e); }
}
async function loadDefiTools() {
    try {
        const r = await fetch(API_DEFI + '/dependencies').then(res => res.ok ? res.json() : null);
        if (r && r.tools && r.tools.length) {
            document.getElementById('defiTools').innerHTML = r.tools.map(t =>
                '<tr class="border-b border-white/5"><td class="p-2 font-mono">' + (t.tool || '') + '</td><td class="p-2 font-mono">' + (t.version || '—') + '</td><td class="p-2"><span class="' + (t.installed ? 'text-green-400' : 'text-amber-400') + '">' + (t.installed ? 'Installed' : 'Not Found') + '</span></td></tr>'
            ).join('');
        } else {
            document.getElementById('defiTools').innerHTML = '<tr><td colspan="3" class="p-4 text-gray-500 text-center">No tools</td></tr>';
        }
    } catch (e) { document.getElementById('defiTools').innerHTML = '<tr><td colspan="3" class="p-4 text-gray-500 text-center">Not available</td></tr>'; }
}
async function startDefiScan() {
    const val = document.getElementById('defiInput').value.trim();
    if (!val) return;
    const feed = document.getElementById('defiFeed');
    if (feed) feed.innerHTML = '<div>Scanning ' + val + '…</div>' + feed.innerHTML;
    try {
        const r = await fetch(API_DEFI + '/scan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contract_path: val, workspace: '.' }) });
        const data = r.ok ? await r.json() : null;
        if (data && feed) feed.innerHTML = '<div class="text-green-400">Scan started ID: ' + (data.scan_id || '—') + '</div>' + feed.innerHTML;
        loadDefiScans();
        loadDefiStatus();
    } catch (e) { if (feed) feed.innerHTML = '<div class="text-red-400">Scan failed</div>' + feed.innerHTML; }
}
async function loadDefiScans() {
    try {
        const results = await fetch(API_DEFI + '/scans').then(r => r.ok ? r.json() : null);
        if (results && Array.isArray(results)) {
            document.getElementById('defiScans').textContent = results.length;
            const vulns = results.reduce((a, r) => a + (r.vulnerabilities || 0), 0);
            document.getElementById('defiVulns').textContent = vulns;
            document.getElementById('defiCritical').textContent = results.reduce((a, r) => a + (r.critical || 0), 0);
            document.getElementById('defiOK').textContent = results.filter(r => !(r.vulnerabilities)).length;
            document.getElementById('defiResults').innerHTML = results.map(r =>
                '<tr class="border-b border-white/5"><td class="p-2 font-mono">' + (r.contract_path || '—') + '</td><td class="p-2">' + (r.status === 'completed' ? '<span class="text-green-400">Complete</span>' : '<span class="text-amber-400">' + (r.status || '—') + '</span>') + '</td><td class="p-2">' + (r.vulnerabilities || 0) + '</td><td class="p-2 font-mono text-gray-500">' + timeAgo(r.started_at) + '</td><td class="p-2"><a href="#" onclick="requestReport(\'' + r.scan_id + '\');return false" class="text-daena-gold hover:underline">Report</a></td></tr>'
            ).join('');
        }
    } catch (e) { console.warn('DeFi scans:', e); }
}
function requestReport(scanId) {
    fetch(API_DEFI + '/report/' + scanId, { method: 'POST' }).then(r => r.ok ? r.json() : null).then(data => {
        document.getElementById('defiReportStatus').textContent = data ? 'Report generated: ' + (data.report_id || data.download_url || 'ok') : 'Report request failed';
    }).catch(() => { document.getElementById('defiReportStatus').textContent = 'Report request failed'; });
}
loadDefiStatus();
loadDefiTools();
loadDefiScans();
// Realtime: refresh every 30s
setInterval(function(){ loadDefiStatus(); loadDefiScans(); }, 30000);
</script>
{% endblock %}
