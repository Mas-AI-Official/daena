{% extends "base.html" %}

{% block title %}AI Agents Registry - Daena VP{% endblock %}

{% block head %}
<style>
    .agents-container {
        padding: 12px 20px;
        max-width: 100%;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .page-header h1 {
        font-size: 18px;
        font-weight: 700;
        color: white;
    }

    .page-header p {
        color: #9CA3AF;
        font-size: 11px;
        margin-top: 2px;
    }

    .header-actions {
        display: flex;
        gap: 6px;
    }

    .filter-btn,
    .new-agent-btn {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
    }

    .filter-btn {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: #9CA3AF;
    }

    .new-agent-btn {
        background: var(--daena-gold);
        color: black;
        font-weight: 600;
        border: none;
    }

    .dept-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 6px;
    }

    .dept-pill {
        padding: 3px 8px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        color: #9CA3AF;
        cursor: pointer;
        font-size: 9px;
        transition: all 0.2s ease;
    }

    .dept-pill:hover,
    .dept-pill.active {
        background: var(--daena-gold);
        color: black;
        border-color: var(--daena-gold);
    }

    /* 3 cards per row; bigger and detailed as requested */
    .agents-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .agent-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 0;
        overflow: hidden;
        border-left-width: 3px;
    }

    .agent-card:hover {
        border-color: rgba(212, 175, 55, 0.4);
        transform: translateY(-1px);
    }

    /* Department colors: each card gets its own border + subtle background tint */
    .agent-card[data-dept="engineering"] {
        border-left-color: #4169E1;
        background: rgba(65, 105, 225, 0.08);
    }

    .agent-card[data-dept="product"] {
        border-left-color: #9370DB;
        background: rgba(147, 112, 219, 0.08);
    }

    .agent-card[data-dept="sales"] {
        border-left-color: #32CD32;
        background: rgba(50, 205, 50, 0.08);
    }

    .agent-card[data-dept="marketing"] {
        border-left-color: #FF6B6B;
        background: rgba(255, 107, 107, 0.08);
    }

    .agent-card[data-dept="finance"] {
        border-left-color: #00CED1;
        background: rgba(0, 206, 209, 0.08);
    }

    .agent-card[data-dept="hr"] {
        border-left-color: #E91E7F;
        background: rgba(233, 30, 127, 0.08);
    }

    .agent-card[data-dept="legal"] {
        border-left-color: #8B5CF6;
        background: rgba(139, 92, 246, 0.08);
    }

    .agent-card[data-dept="customer"] {
        border-left-color: #10B981;
        background: rgba(16, 185, 129, 0.08);
    }

    .agent-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
        min-width: 0;
    }

    .agent-avatar {
        width: 24px;
        height: 24px;
        min-width: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 9px;
        color: white;
        flex-shrink: 0;
    }

    .agent-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }

    .agent-name {
        font-weight: 600;
        color: white;
        font-size: 10px;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .agent-role {
        color: #9CA3AF;
        font-size: 9px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dept-badge {
        padding: 2px 5px;
        border-radius: 4px;
        font-size: 8px;
        font-weight: 600;
        margin-top: 2px;
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .status-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        position: absolute;
        top: 6px;
        right: 6px;
    }

    .status-indicator.online {
        background: #32CD32;
        box-shadow: 0 0 4px #32CD32;
    }

    .status-indicator.busy {
        background: #FF8C00;
    }

    .agent-stats {
        display: flex;
        justify-content: space-around;
        padding-top: 6px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        gap: 4px;
    }

    .stat-item {
        text-align: center;
        min-width: 0;
    }

    .stat-value {
        font-size: 10px;
        font-weight: 700;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .stat-label {
        font-size: 8px;
        color: #9CA3AF;
        text-transform: uppercase;
    }

    /* Modal */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #1a1a2e;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 100%;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 700;
        color: white;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 12px;
        color: #9CA3AF;
        margin-bottom: 6px;
    }

    .form-input,
    .form-select {
        width: 100%;
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 14px;
    }

    .btn-primary {
        width: 100%;
        padding: 12px;
        background: var(--daena-gold);
        color: black;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    /* Keep all card content inside box */
    .agent-card * {
        box-sizing: border-box;
    }

    .agent-card .stat-value,
    .agent-card .stat-label {
        max-width: 100%;
    }

    @media (max-width: 1400px) {
        .agents-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    @media (max-width: 1100px) {
        .agents-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @media (max-width: 900px) {
        .agents-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 600px) {
        .agents-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="agents-container">
    <div class="page-header">
        <div>
            <h1>AI Agents Registry</h1>
            <p>Monitor and manage <span id="agent-count">48</span> specialized agents across 8 departments</p>
            <div style="display: flex; gap: 10px; margin-top: 8px;">
                <div id="routing-status"></div>
                <div id="reasoning-status"></div>
            </div>
        </div>
        <div class="header-actions">
            <button class="filter-btn"><i class="fas fa-filter"></i> Filter</button>
            <button class="new-agent-btn" onclick="showNewAgentModal()"><i class="fas fa-plus"></i> New Agent</button>
        </div>
    </div>

    <div class="dept-filters">
        <div class="dept-pill active" data-dept="all" onclick="filterDept('all')">
            <i class="fas fa-th"></i> All (48)
        </div>
        <div class="dept-pill" data-dept="engineering" onclick="filterDept('engineering')">‚öôÔ∏è Engineering</div>
        <div class="dept-pill" data-dept="product" onclick="filterDept('product')">üöÄ Product</div>
        <div class="dept-pill" data-dept="sales" onclick="filterDept('sales')">üí∞ Sales</div>
        <div class="dept-pill" data-dept="marketing" onclick="filterDept('marketing')">üìä Marketing</div>
        <div class="dept-pill" data-dept="finance" onclick="filterDept('finance')">üíµ Finance</div>
        <div class="dept-pill" data-dept="hr" onclick="filterDept('hr')">üë• HR</div>
        <div class="dept-pill" data-dept="legal" onclick="filterDept('legal')">‚öñÔ∏è Legal</div>
        <div class="dept-pill" data-dept="customer" onclick="filterDept('customer')">üéØ Customer</div>
    </div>

    <div class="agents-grid" id="agents-grid">
        <div style="text-align: center; padding: 20px; color: #9CA3AF; font-size: 11px;">
            <i class="fas fa-circle-notch fa-spin"></i>
            <p style="margin-top: 8px;">Loading agents...</p>
        </div>
    </div>
</div>

<!-- New Agent Modal -->
<div class="modal" id="new-agent-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Create New Agent</div>
            <button onclick="closeModal()" style="background: none; border: none; color: #9CA3AF; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form onsubmit="createAgent(event)">
            <div class="form-group">
                <label class="form-label">Department *</label>
                <select class="form-select" id="new-dept" required>
                    <option value="">Select department...</option>
                    <option value="engineering">Engineering</option>
                    <option value="product">Product</option>
                    <option value="sales">Sales</option>
                    <option value="marketing">Marketing</option>
                    <option value="finance">Finance</option>
                    <option value="hr">HR</option>
                    <option value="legal">Legal</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Agent Name *</label>
                <input type="text" class="form-input" id="new-name" placeholder="e.g. Alex Builder" required>
            </div>
            <div class="form-group">
                <label class="form-label">Role *</label>
                <select class="form-select" id="new-role" required>
                    <option value="advisor_a">Advisor A (Senior)</option>
                    <option value="advisor_b">Advisor B (Strategy)</option>
                    <option value="scout_internal">Scout Internal</option>
                    <option value="scout_external">Scout External</option>
                    <option value="synth">Synth (Knowledge)</option>
                    <option value="executor">Executor (Action)</option>
                </select>
            </div>
            <button type="submit" class="btn-primary">Create Agent</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // UNIQUE colors for each department
    const DEPT_COLORS = {
        'engineering': '#4169E1',  // Royal Blue
        'product': '#9370DB',      // Purple
        'sales': '#32CD32',        // Green
        'marketing': '#FF6B6B',    // Coral Red
        'finance': '#00CED1',      // Cyan
        'hr': '#E91E7F',           // Pink
        'legal': '#8B5CF6',        // Violet
        'customer': '#10B981'      // Emerald
    };

    const AGENT_NAMES = {
        'engineering': ['Alex CodeMaster', 'Emma BuildPro', 'Noah DevOps', 'Sophia TechLead', 'Liam Backend', 'Olivia Frontend'],
        'product': ['Ava Strategy', 'Ethan Roadmap', 'Mia ProductViz', 'Lucas Innovator', 'Amelia UXMaster', 'Mason Metrics'],
        'sales': ['Morgan Closer', 'Charlotte Deal', 'Benjamin Revenue', 'Harper Pipeline', 'Logan ClientPro', 'Ella Convert'],
        'marketing': ['DaVinci Creative', 'Sofia Brand', 'Jackson Campaign', 'Aria Growth', 'Carter SEO', 'Layla Social'],
        'finance': ['Penny Wise', 'Sebastian Budget', 'Chloe Analytics', 'Oliver Forecast', 'Zoe Accounting', 'Henry Capital'],
        'hr': ['Scarlett People', 'Daniel Culture', 'Grace Talent', 'Matthew Recruiter', 'Lily Learning', 'Owen Benefits'],
        'legal': ['Sarah Shield', 'William Contracts', 'Victoria Compliance', 'James Policy', 'Hannah IP', 'Ryan Risk'],
        'customer': ['Fix-It Felix', 'Evelyn Support', 'Michael Success', 'Abigail Advocate', 'Alexander Solutions', 'Emily Happiness']
    };

    const ROLES = ['Advisor A', 'Advisor B', 'Scout Internal', 'Scout External', 'Synth', 'Executor'];
    const DEPTS = ['engineering', 'product', 'sales', 'marketing', 'finance', 'hr', 'legal', 'customer'];

    let allAgents = [];
    let currentDept = 'all';

    async function loadAgents() {
        try {
            const response = await fetch('/api/v1/agents/?limit=100');
            const data = await response.json();

            if (data.success && data.agents && data.agents.length > 0) {
                // Transform backend format to frontend format
                allAgents = data.agents.map(agent => ({
                    id: agent.cell_id || agent.id,
                    name: agent.name,
                    role: agent.role || 'Agent',
                    department_id: agent.department || agent.department_id || 'unknown',
                    efficiency: agent.efficiency || (85 + Math.random() * 15).toFixed(2),
                    tasks: agent.tasks_count || 0,
                    uptime: agent.uptime || 'N/A',
                    status: agent.status || (agent.is_active ? 'online' : 'offline')
                }));
            } else {
                allAgents = [];
            }
        } catch (e) {
            console.error('Failed to load agents:', e);
            allAgents = [];
        }

        document.getElementById('agent-count').textContent = allAgents.length;
        renderAgents(allAgents);
    }

    function renderAgents(agents) {
        const grid = document.getElementById('agents-grid');

        if (agents.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 12px; color: #9CA3AF; font-size: 9px; grid-column: 1 / -1;">No agents found</div>';
            return;
        }

        grid.innerHTML = agents.map(agent => {
            const color = DEPT_COLORS[agent.department_id] || '#888';
            const initials = agent.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            return `
        <div class="agent-card" data-dept="${(agent.department_id || 'engineering').toLowerCase()}" style="position: relative; display: flex; flex-direction: column; height: 100%;">
            <div class="status-indicator ${agent.status || 'online'}"></div>
            <div class="agent-header">
                <div class="agent-avatar" style="background: linear-gradient(135deg, ${color}, ${color}99);">
                    ${initials}
                </div>
                <div class="agent-info">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-role">${agent.role}</div>
                    <span class="dept-badge" style="background: ${color}22; color: ${color};">
                        ${agent.department_id.toUpperCase()}
                    </span>
                </div>
            </div>
            <div class="agent-stats" style="margin-bottom: 12px; flex-grow: 1;">
                <div class="stat-item">
                    <div class="stat-value" style="color: #32CD32;">${agent.efficiency}%</div>
                    <div class="stat-label">Efficiency</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${agent.tasks}</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${agent.uptime}</div>
                    <div class="stat-label">Uptime</div>
                </div>
            </div>
            <button class="btn-primary" onclick="openAgent('${agent.id}')" style="margin-top: auto; padding: 8px; font-size: 11px;">View Details</button>
        </div>
        `;
        }).join('');
    }

    function filterDept(dept) {
        currentDept = dept;
        document.querySelectorAll('.dept-pill').forEach(pill => {
            pill.classList.toggle('active', pill.dataset.dept === dept);
        });

        if (dept === 'all') {
            renderAgents(allAgents);
        } else {
            renderAgents(allAgents.filter(a => a.department_id === dept));
        }
    }

    function openAgent(id) {
        window.location.href = `/ui/agents/${id}`;
    }

    function showNewAgentModal() {
        document.getElementById('new-agent-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('new-agent-modal').classList.remove('active');
    }

    async function createAgent(e) {
        e.preventDefault();
        const dept = document.getElementById('new-dept').value;
        const name = document.getElementById('new-name').value;
        const role = document.getElementById('new-role').value;

        try {
            const response = await fetch('/api/v1/agents/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ department_id: dept, name, role })
            });

            if (response.ok) {
                window.showToast('Agent created successfully!', 'success');
                closeModal();
                loadAgents();
            } else {
                window.showToast('Failed to create agent', 'error');
            }
        } catch (e) {
            // Add locally for now
            const newAgent = {
                id: `${dept}_custom_${Date.now()}`,
                name,
                role: role.replace('_', ' '),
                department_id: dept,
                efficiency: '95.00',
                tasks: 0,
                uptime: '0h',
                status: 'online'
            };
            allAgents.push(newAgent);
            renderAgents(currentDept === 'all' ? allAgents : allAgents.filter(a => a.department_id === currentDept));
            window.showToast('Agent created locally', 'success');
            closeModal();
        }
    }

    document.addEventListener('DOMContentLoaded', loadAgents);
</script>
<script src="/static/js/automation-ui.js"></script>
<script src="/static/js/agents.js"></script>
{% endblock %}