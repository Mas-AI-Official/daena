{% extends "base.html" %}

{% block title %}Brain & API — Daena VP{% endblock %}

{% block head %}
<style>
.brain-stat { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.1); border-radius: 10px; padding: 14px 16px; }
.brain-stat.l1 { border-top: 2px solid #3ecf8e; }
.brain-stat.l2 { border-top: 2px solid #5b9bd5; }
.brain-stat.l3 { border-top: 2px solid #9b7bea; }
.tier-val { font-family: 'SF Mono', Consolas, monospace; font-size: 18px; font-weight: 600; }
.api-key-mask { font-family: monospace; color: #6b7f95; }
</style>
{% endblock %}

{% block content %}
<div class="p-6 max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <i class="fas fa-brain text-daena-gold"></i>
        Brain & API
    </h1>
    <p class="text-gray-400 text-sm mb-6">Model routing, API keys (redacted), health checks, OpenAPI link, and brain settings.</p>

    <!-- Stats row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="brain-stat l1">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">L1 Hot Cache</div>
            <div class="tier-val text-green-400" id="brainL1">—</div>
            <div class="text-[10px] text-gray-500 mt-1">Vector entries</div>
        </div>
        <div class="brain-stat l2">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">L2 Warm</div>
            <div class="tier-val text-blue-400" id="brainL2">—</div>
            <div class="text-[10px] text-gray-500 mt-1">NBMF encoded</div>
        </div>
        <div class="brain-stat l3">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">L3 Cold</div>
            <div class="tier-val text-purple-400" id="brainL3">—</div>
            <div class="text-[10px] text-gray-500 mt-1">Archived</div>
        </div>
        <div class="brain-stat">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Research (24h)</div>
            <div class="tier-val text-daena-gold" id="brainQueries">—</div>
            <div class="text-[10px] text-gray-500 mt-1">Queries</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Memory Tiers -->
        <div class="glass-panel rounded-xl p-5">
            <h2 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-layer-group text-daena-gold"></i>
                Memory Tiers
            </h2>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-black/20 rounded-lg p-3 border border-green-500/30">
                    <div class="text-[10px] font-bold text-gray-500 uppercase">L1 · HOT</div>
                    <div class="text-lg font-mono font-semibold text-green-400" id="tierL1Val">0</div>
                    <div class="text-[10px] text-gray-500">p95 &lt;25ms</div>
                </div>
                <div class="bg-black/20 rounded-lg p-3 border border-blue-500/30">
                    <div class="text-[10px] font-bold text-gray-500 uppercase">L2 · WARM</div>
                    <div class="text-lg font-mono font-semibold text-blue-400" id="tierL2Val">0</div>
                    <div class="text-[10px] text-gray-500">AES-256</div>
                </div>
                <div class="bg-black/20 rounded-lg p-3 border border-purple-500/30">
                    <div class="text-[10px] font-bold text-gray-500 uppercase">L3 · COLD</div>
                    <div class="text-lg font-mono font-semibold text-purple-400" id="tierL3Val">0</div>
                    <div class="text-[10px] text-gray-500">Archives</div>
                </div>
            </div>
            <h3 class="text-xs font-semibold text-gray-400 mb-2">Research Sources</h3>
            <div class="overflow-x-auto border border-white/10 rounded-lg">
                <table class="w-full text-xs">
                    <thead><tr class="border-b border-white/10"><th class="text-left p-2 text-gray-500">Source</th><th class="text-left p-2 text-gray-500">Type</th><th class="text-left p-2 text-gray-500">Status</th><th class="text-left p-2 text-gray-500">Last Hit</th></tr></thead>
                    <tbody id="researchSources"><tr><td colspan="4" class="p-4 text-gray-500 text-center">Loading…</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- API & Health -->
        <div class="glass-panel rounded-xl p-5">
            <h2 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-key text-daena-gold"></i>
                API Keys & Health
            </h2>
            <div class="space-y-3 mb-4">
                <div class="flex items-center justify-between py-2 border-b border-white/5">
                    <span class="text-gray-400 text-sm">OpenAI</span>
                    <span class="api-key-mask text-xs" id="api-openai">••••••••</span>
                </div>
                <div class="flex items-center justify-between py-2 border-b border-white/5">
                    <span class="text-gray-400 text-sm">Anthropic</span>
                    <span class="api-key-mask text-xs" id="api-anthropic">••••••••</span>
                </div>
                <div class="flex items-center justify-between py-2 border-b border-white/5">
                    <span class="text-gray-400 text-sm">Local / Ollama</span>
                    <span class="text-green-400 text-xs" id="api-local">—</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="/openapi.json" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm text-gray-300 border border-white/10">
                    <i class="fas fa-book"></i> OpenAPI
                </a>
                <a href="/docs" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm text-gray-300 border border-white/10">
                    <i class="fas fa-file-code"></i> Swagger UI
                </a>
                <button type="button" onclick="loadBrainHealth()" class="inline-flex items-center gap-2 px-3 py-2 bg-daena-gold/20 hover:bg-daena-gold/30 rounded-lg text-sm text-daena-gold border border-daena-gold/40">
                    <i class="fas fa-heartbeat"></i> Health Check
                </button>
            </div>
            <div class="mt-4 p-3 bg-black/20 rounded-lg border border-white/5 max-h-40 overflow-y-auto">
                <div class="text-[10px] text-gray-500 uppercase mb-1">Brain Live Feed</div>
                <div id="brainFeed" class="text-xs text-gray-400 space-y-1">Waiting for events…</div>
            </div>
        </div>
    </div>

    <!-- Brain Settings link -->
    <div class="mt-6 glass-panel rounded-xl p-4 flex items-center justify-between">
        <span class="text-gray-400 text-sm">Brain settings (model routing, context size, temperature)</span>
        <a href="/ui/control-panel" class="text-daena-gold hover:text-yellow-400 text-sm font-medium">Open in Control Panel →</a>
    </div>
</div>

<script>
const API = { memory: '/api/v1/memory', research: '/api/v1/research', health: '/api/v1/health' };
function timeAgo(ts) {
    if (!ts) return '—';
    const d = typeof ts === 'number' ? ts : new Date(ts).getTime();
    const diff = Date.now() - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
    return Math.floor(diff/86400000) + 'd ago';
}
async function loadBrain() {
    try {
        const mem = await fetch(API.memory + '/stats').then(r => r.ok ? r.json() : null);
        if (mem) {
            document.getElementById('brainL1').textContent = mem.l1 ?? '—';
            document.getElementById('brainL2').textContent = mem.l2 ?? '—';
            document.getElementById('brainL3').textContent = mem.l3 ?? '—';
            document.getElementById('tierL1Val').textContent = mem.l1 ?? 0;
            document.getElementById('tierL2Val').textContent = mem.l2 ?? 0;
            document.getElementById('tierL3Val').textContent = mem.l3 ?? 0;
        }
        const res = await fetch(API.research + '/history').then(r => r.ok ? r.json() : null);
        if (res && Array.isArray(res)) {
            const last24 = res.filter(r => (Date.now() - new Date(r.created_at || 0)) < 86400000).length;
            document.getElementById('brainQueries').textContent = last24;
        }
        const sources = await fetch(API.research + '/sources').then(r => r.ok ? r.json() : null);
        if (sources && sources.length) {
            document.getElementById('researchSources').innerHTML = sources.map(s =>
                '<tr class="border-b border-white/5"><td class="p-2 font-mono">' + (s.name || '') + '</td><td class="p-2">' + (s.type || '') + '</td><td class="p-2"><span class="text-green-400">Active</span></td><td class="p-2 font-mono text-gray-500">' + timeAgo(s.last_used) + '</td></tr>'
            ).join('');
        } else {
            document.getElementById('researchSources').innerHTML = '<tr><td colspan="4" class="p-4 text-gray-500 text-center">No sources</td></tr>';
        }
    } catch (e) { console.warn('Brain load:', e); }
}
async function loadBrainHealth() {
    try {
        const h = await fetch(API.health).then(r => r.ok ? r.json() : null);
        if (h) alert('Health: ' + JSON.stringify(h, null, 2));
    } catch (e) { alert('Health check failed'); }
}
loadBrain();
</script>
{% endblock %}
