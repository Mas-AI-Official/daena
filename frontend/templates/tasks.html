{% extends "base.html" %}

{% block title %}Tasks - Daena VP{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">Tasks</h1>
            <p class="text-gray-400 text-sm mt-1">Autonomous task queue: create, run, view status and artifacts</p>
        </div>
        <button onclick="loadTasks()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-white transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Create task</h2>
        <p class="text-gray-400 text-sm mb-2">Requires Execution Token (set in App Setup / Dashboard).</p>
        <div class="flex flex-wrap gap-3 items-end">
            <div>
                <label class="block text-gray-400 text-xs mb-1">Goal</label>
                <input type="text" id="new-task-goal" placeholder="e.g. Fix build errors" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10 text-white w-64">
            </div>
            <div>
                <label class="block text-gray-400 text-xs mb-1">Max steps</label>
                <input type="number" id="new-task-max-steps" value="50" min="1" max="200" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10 text-white w-20">
            </div>
            <button onclick="createTask()" class="px-4 py-2 rounded-lg bg-daena-gold text-black font-medium text-sm">Create</button>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Task queue</h2>
        <div id="tasks-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500">Loading...</div>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl hidden" id="task-detail-panel">
        <h2 class="text-lg font-medium text-white mb-4">Task detail</h2>
        <div id="task-detail-meta" class="text-sm text-gray-400 mb-4"></div>
        <h3 class="text-sm font-medium text-white mb-2">Step timeline</h3>
        <div id="task-detail-timeline" class="space-y-2 mb-4"></div>
        <h3 class="text-sm font-medium text-white mb-2">Artifacts</h3>
        <div id="task-detail-artifacts" class="space-y-1 text-sm font-mono text-gray-400"></div>
        <div id="task-detail-raw" class="text-sm text-gray-500 font-mono whitespace-pre-wrap mt-4 border-t border-white/10 pt-4 hidden"></div>
    </div>
    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-2">Runbook</h2>
        <p class="text-gray-400 text-sm mb-2">Suggested next actions when a task fails</p>
        <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
            <li>Check Execution logs (Execution page) for the failing step</li>
            <li>Re-run the task step (Run step) or create a new task with a narrower goal</li>
            <li>Ensure Execution Token is set and lockdown is inactive (Incident Room)</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = (window.DAENA_API_BASE || (window.location.origin + '/api/v1')).replace(/\/+$/, '') || (window.location.origin + '/api/v1');

    function getExecutionToken() {
        try { return sessionStorage.getItem('daena_execution_token') || sessionStorage.getItem('execution_token') || ''; } catch (e) { return ''; }
    }

    function escapeHtml(s) {
        if (s == null) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    async function loadTasks() {
        const el = document.getElementById('tasks-list');
        const token = getExecutionToken();
        if (!token) {
            el.innerHTML = '<p class="text-yellow-400">Set Execution Token in App Setup / Dashboard to list tasks.</p>';
            return;
        }
        try {
            const r = await fetch(API_BASE + '/execution/tasks?limit=50', { headers: { 'X-Execution-Token': token } });
            const data = await r.json();
            if (r.status === 401) {
                el.innerHTML = '<p class="text-red-400">' + escapeHtml(data.detail || 'Unauthorized') + '</p>';
                return;
            }
            if (!data.success || !data.tasks) {
                el.innerHTML = '<div class="text-gray-500">No tasks</div>';
                return;
            }
            el.innerHTML = data.tasks.length === 0
                ? '<p class="text-gray-500">No tasks yet. Create one above.</p>'
                : data.tasks.map(t => `
                    <div class="flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10">
                        <div>
                            <span class="font-medium text-white">${escapeHtml(t.goal || t.task_id)}</span>
                            <span class="ml-2 text-xs ${t.status === 'running' ? 'text-yellow-400' : t.status === 'completed' ? 'text-green-400' : 'text-gray-500'}">${escapeHtml(t.status)}</span>
                            <p class="text-gray-400 text-xs mt-1">${escapeHtml(t.task_id)} · steps ${t.step_count || 0}/${t.max_steps || 50}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewTask('${escapeHtml(t.task_id)}')" class="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm">View</button>
                            ${(t.status === 'pending' || t.status === 'running') ? '<button onclick="runTask(\'' + escapeHtml(t.task_id) + '\')" class="px-3 py-1.5 rounded-lg bg-daena-gold/20 text-daena-gold text-sm">Run step</button>' : ''}
                        </div>
                    </div>
                `).join('');
        } catch (e) {
            el.innerHTML = '<div class="text-red-400">Error: ' + escapeHtml(String(e)) + '</div>';
        }
    }

    async function createTask() {
        const token = getExecutionToken();
        if (!token) { if (window.showToast) window.showToast('Set Execution Token first', 'error'); return; }
        const goal = document.getElementById('new-task-goal').value.trim();
        if (!goal) { if (window.showToast) window.showToast('Enter goal', 'error'); return; }
        const maxSteps = parseInt(document.getElementById('new-task-max-steps').value, 10) || 50;
        try {
            const r = await fetch(API_BASE + '/execution/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Execution-Token': token },
                body: JSON.stringify({ goal, max_steps: maxSteps, max_retries: 3 })
            });
            const data = await r.json();
            if (data.success) {
                document.getElementById('new-task-goal').value = '';
                loadTasks();
                if (window.showToast) window.showToast('Task created: ' + data.task_id, 'success');
            } else {
                if (window.showToast) window.showToast(data.detail || 'Create failed', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Request failed', 'error');
        }
    }

    async function runTask(taskId) {
        const token = getExecutionToken();
        if (!token) { if (window.showToast) window.showToast('Set Execution Token first', 'error'); return; }
        try {
            const r = await fetch(API_BASE + '/execution/tasks/' + encodeURIComponent(taskId) + '/run', {
                method: 'POST',
                headers: { 'X-Execution-Token': token }
            });
            const data = await r.json();
            if (data.success) {
                loadTasks();
                if (data.task) viewTask(taskId);
                if (window.showToast) window.showToast('Step run', 'success');
            } else {
                if (window.showToast) window.showToast(data.detail || 'Run failed', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Request failed', 'error');
        }
    }

    async function viewTask(taskId) {
        const token = getExecutionToken();
        if (!token) return;
        try {
            const r = await fetch(API_BASE + '/execution/tasks/' + encodeURIComponent(taskId), { headers: { 'X-Execution-Token': token } });
            const data = await r.json();
            const panel = document.getElementById('task-detail-panel');
            const metaEl = document.getElementById('task-detail-meta');
            const timelineEl = document.getElementById('task-detail-timeline');
            const artifactsEl = document.getElementById('task-detail-artifacts');
            const rawEl = document.getElementById('task-detail-raw');
            if (data.success && data.task) {
                const t = data.task;
                panel.classList.remove('hidden');
                metaEl.innerHTML = 'Goal: <span class="text-white">' + escapeHtml(t.goal || '') + '</span> · Status: <span class="' + (t.status === 'completed' ? 'text-green-400' : t.status === 'running' ? 'text-yellow-400' : 'text-gray-400') + '">' + escapeHtml(t.status) + '</span> · Steps: ' + (t.step_count || 0) + '/' + (t.max_steps || 50);
                const artifacts = t.artifacts || [];
                timelineEl.innerHTML = artifacts.length === 0 ? '<p class="text-gray-500">No steps yet. Click Run step.</p>' : artifacts.map(a => {
                    const ts = a.ts ? new Date(a.ts * 1000).toISOString() : '';
                    return '<div class="flex items-start gap-2 p-2 rounded bg-white/5"><span class="text-daena-gold">Step ' + (a.step || '?') + '</span> <span class="text-gray-400">' + escapeHtml(a.tool_name || '') + '</span> <span class="text-xs ' + (a.result_status === 'ok' ? 'text-green-400' : 'text-red-400') + '">' + escapeHtml(a.result_status || '') + '</span><span class="text-gray-500 text-xs">' + escapeHtml(ts) + '</span></div>';
                }).join('');
                const files = [];
                artifacts.forEach(a => { (a.artifact_files || []).forEach(f => files.push(f)); });
                const base = API_BASE + '/execution/tasks/' + encodeURIComponent(taskId) + '/artifacts/';
                const tok = getExecutionToken();
                artifactsEl.innerHTML = files.length === 0 ? '<p class="text-gray-500">No artifact files</p>' : files.map(f => {
                    const name = f.split(/[/\\]/).pop() || f;
                    const url = base + encodeURIComponent(name);
                    return '<div class="truncate flex items-center gap-2"><span class="text-gray-400">' + escapeHtml(name) + '</span><button type="button" class="artifact-dl text-xs px-2 py-0.5 rounded bg-white/10 text-daena-gold hover:bg-white/20" data-task-id="' + escapeHtml(taskId) + '" data-filename="' + escapeHtml(name) + '">Download</button></div>';
                }).join('');
                rawEl.classList.add('hidden');
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                document.querySelectorAll('#task-detail-artifacts .artifact-dl').forEach(function(btn) {
                    btn.onclick = function() { downloadArtifact(btn.dataset.taskId, btn.dataset.filename); };
                });
            }
        } catch (e) {
            document.getElementById('task-detail-meta').textContent = 'Error: ' + (e && e.message ? e.message : e);
            document.getElementById('task-detail-panel').classList.remove('hidden');
        }
    }

    async function downloadArtifact(taskId, filename) {
        const token = getExecutionToken();
        if (!token) { if (window.showToast) window.showToast('Set Execution Token to download', 'error'); return; }
        const url = API_BASE + '/execution/tasks/' + encodeURIComponent(taskId) + '/artifacts/' + encodeURIComponent(filename);
        try {
            const r = await fetch(url, { headers: { 'X-Execution-Token': token } });
            if (!r.ok) throw new Error(r.statusText);
            const blob = await r.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
            if (window.showToast) window.showToast('Downloaded ' + filename, 'success');
        } catch (e) {
            if (window.showToast) window.showToast('Download failed', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadTasks);
</script>
{% endblock %}
