{% extends "base.html" %}

{% block title %}QA Guardian Dashboard - Daena VP{% endblock %}

{% block head %}
<style>
    .qa-dashboard { max-width: 1400px; margin: 0 auto; padding: 1rem 1.5rem; }
    .qa-dashboard .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .qa-dashboard .page-header h1 { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; color: white; }
    .qa-dashboard .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .qa-dashboard .btn {
        padding: 0.5rem 1rem; border-radius: 8px; border: none; font-weight: 500; cursor: pointer;
        transition: all 0.2s; font-size: 0.8125rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .qa-dashboard .btn-primary { background: rgba(59, 130, 246, 0.9); color: white; }
    .qa-dashboard .btn-primary:hover { background: #2563eb; }
    .qa-dashboard .btn-danger { background: rgba(239, 68, 68, 0.9); color: white; }
    .qa-dashboard .btn-danger:hover { background: #dc2626; }
    .qa-dashboard .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #E5E7EB; }
    .qa-dashboard .btn-outline:hover { background: rgba(255,255,255,0.1); border-color: var(--daena-gold); color: white; }
    .qa-dashboard .status-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;
    }
    .qa-dashboard .status-card {
        background: rgba(255,255,255,0.03); border-radius: 10px; padding: 1rem 1.25rem;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .qa-dashboard .status-card .label { font-size: 0.8125rem; color: #9CA3AF; margin-bottom: 0.25rem; }
    .qa-dashboard .status-card .value { font-size: 1.5rem; font-weight: 700; color: white; }
    .qa-dashboard .status-card .indicator {
        display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;
        font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 6px;
    }
    .qa-dashboard .indicator-success { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
    .qa-dashboard .indicator-warning { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
    .qa-dashboard .indicator-danger { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .qa-dashboard .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; }
    .qa-dashboard .panel {
        background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden;
    }
    .qa-dashboard .panel-header {
        padding: 0.75rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
    }
    .qa-dashboard .panel-header h2 { font-size: 0.9375rem; font-weight: 600; color: white; margin: 0; }
    .qa-dashboard .panel-body { padding: 1rem 1.25rem; max-height: 380px; overflow-y: auto; }
    .qa-dashboard .incident-list { list-style: none; padding: 0; margin: 0; }
    .qa-dashboard .incident-item {
        padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem;
        background: rgba(0,0,0,0.2); border-left: 4px solid #3b82f6; cursor: pointer; transition: all 0.2s;
    }
    .qa-dashboard .incident-item:hover { background: rgba(0,0,0,0.35); }
    .qa-dashboard .incident-item.severity-p0 { border-left-color: #ef4444; }
    .qa-dashboard .incident-item.severity-p1 { border-left-color: #f97316; }
    .qa-dashboard .incident-item.severity-p2 { border-left-color: #f59e0b; }
    .qa-dashboard .incident-item.severity-p3 { border-left-color: #3b82f6; }
    .qa-dashboard .incident-item.severity-p4 { border-left-color: #9CA3AF; }
    .qa-dashboard .incident-header { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }
    .qa-dashboard .incident-title { font-weight: 500; font-size: 0.8125rem; color: #E5E7EB; }
    .qa-dashboard .incident-meta { display: flex; gap: 0.5rem; font-size: 0.6875rem; color: #9CA3AF; flex-wrap: wrap; }
    .qa-dashboard .badge {
        display: inline-block; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.625rem; font-weight: 600; text-transform: uppercase;
    }
    .qa-dashboard .badge-p0 { background: rgba(239,68,68,0.3); color: #fca5a5; }
    .qa-dashboard .badge-p1 { background: rgba(249,115,22,0.3); color: #fdba74; }
    .qa-dashboard .badge-p2 { background: rgba(245,158,11,0.3); color: #fde047; }
    .qa-dashboard .badge-p3 { background: rgba(59,130,246,0.3); color: #93c5fd; }
    .qa-dashboard .badge-p4 { background: rgba(156,163,175,0.3); color: #d1d5db; }
    .qa-dashboard .badge-status { background: rgba(59,130,246,0.2); color: #93c5fd; }
    .qa-dashboard .badge-approval { background: rgba(245,158,11,0.2); color: #fde047; }
    .qa-dashboard .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 0.8125rem; }
    .qa-dashboard .summary-item:last-child { border-bottom: none; }
    .qa-dashboard .summary-label { color: #9CA3AF; }
    .qa-dashboard .action-buttons { display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem 1.25rem; }
    .qa-dashboard .action-btn {
        width: 100%; padding: 0.625rem 1rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
        background: transparent; color: #E5E7EB; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; gap: 0.5rem;
    }
    .qa-dashboard .action-btn:hover { background: rgba(255,255,255,0.05); }
    .qa-dashboard .action-btn.running { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); }
    .qa-dashboard .empty-state { text-align: center; padding: 2rem; color: #9CA3AF; font-size: 0.8125rem; }
    .qa-dashboard .empty-state .icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .qa-dashboard select {
        background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 0.375rem 0.5rem;
        border-radius: 6px; color: #E5E7EB; font-size: 0.75rem;
    }
    @media (max-width: 1024px) {
        .qa-dashboard .status-grid { grid-template-columns: repeat(2, 1fr); }
        .qa-dashboard .main-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
        .qa-dashboard .status-grid { grid-template-columns: 1fr; }
        .qa-dashboard .page-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="qa-dashboard">
    <header class="page-header">
        <h1><i class="fas fa-shield-alt text-red-400"></i> QA Guardian Dashboard</h1>
        <div class="header-actions">
            <a href="/ui/dashboard" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <a href="/incident-room" class="btn btn-outline"><i class="fas fa-exclamation-triangle"></i> Incident Room</a>
            <button type="button" class="btn btn-outline" onclick="qaGuardianRefresh()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button type="button" class="btn btn-primary" onclick="qaGuardianRequestReview()">Request QA Review</button>
            <button type="button" class="btn btn-danger" id="killSwitchBtn" onclick="qaGuardianToggleKillSwitch()">Kill Switch</button>
        </div>
    </header>

    <div class="status-grid">
        <div class="status-card">
            <div class="label">Guardian Status</div>
            <div class="value" id="guardianStatus">--</div>
            <div class="indicator indicator-success" id="statusIndicator"><span>‚óè</span> <span id="statusText">Loading...</span></div>
        </div>
        <div class="status-card">
            <div class="label">Open Incidents</div>
            <div class="value" id="openIncidents">0</div>
            <div class="indicator indicator-warning" id="incidentIndicator"><span id="incidentText">0 awaiting approval</span></div>
        </div>
        <div class="status-card">
            <div class="label">Auto-Fix Rate Limit</div>
            <div class="value" id="rateLimit">5/5</div>
            <div class="indicator indicator-success"><span>Available this hour</span></div>
        </div>
        <div class="status-card">
            <div class="label">Last 24h Incidents</div>
            <div class="value" id="incidents24h">0</div>
            <div class="indicator indicator-success" id="trend24h"><span>No critical issues</span></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-list"></i> Recent Incidents</h2>
                <select id="incidentFilter" onchange="qaGuardianFilterIncidents()">
                    <option value="all">All</option>
                    <option value="open">Open</option>
                    <option value="awaiting_approval">Awaiting Approval</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div class="panel-body">
                <ul class="incident-list" id="incidentList">
                    <li class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <p>No incidents to display</p>
                    </li>
                </ul>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1.25rem;">
            <div class="panel">
                <div class="panel-header"><h2><i class="fas fa-bolt"></i> Quick Actions</h2></div>
                <div class="action-buttons">
                    <button type="button" class="action-btn" onclick="qaGuardianRunRegression('smoke')"><i class="fas fa-fire"></i> Run Smoke Tests</button>
                    <button type="button" class="action-btn" onclick="qaGuardianRunRegression('golden')"><i class="fas fa-star"></i> Run Golden Workflows</button>
                    <button type="button" class="action-btn" onclick="qaGuardianRunSecurityScan()"><i class="fas fa-lock"></i> Security Scan</button>
                    <button type="button" class="action-btn" onclick="qaGuardianStart()"><i class="fas fa-play"></i> Start Guardian Loop</button>
                    <button type="button" class="action-btn" onclick="qaGuardianStop()"><i class="fas fa-stop"></i> Stop Guardian Loop</button>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h2><i class="fas fa-chart-bar"></i> Summary</h2></div>
                <div class="panel-body">
                    <div class="summary-item"><span class="summary-label">Auto-Fix</span><span id="autoFixStatus">Disabled</span></div>
                    <div class="summary-item"><span class="summary-label">Last Regression</span><span id="lastRegression">Never</span></div>
                    <div class="summary-item"><span class="summary-label">Last Security Scan</span><span id="lastSecurityScan">Never</span></div>
                    <div class="summary-item"><span class="summary-label">Critical Issues</span><span id="criticalCount" style="color: #6ee7b7;">0</span></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const API_BASE = (window.DAENA_API_BASE || '/api/v1') + '/qa';
    function escapeHtml(s) {
        if (s == null || s === undefined) return '';
        if (typeof window.escapeHtml === 'function') return window.escapeHtml(s);
        var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML;
    }

    async function fetchAPI(endpoint, options) {
        try {
            var res = await fetch(API_BASE + endpoint, { headers: { 'Content-Type': 'application/json' }, ...options });
            return await res.json();
        } catch (e) { console.error('QA API Error:', e); return null; }
    }

    async function refreshDashboard() {
        var status = await fetchAPI('/status');
        if (status) {
            var el = document.getElementById('guardianStatus'); if (el) el.textContent = status.running ? 'Running' : 'Stopped';
            el = document.getElementById('statusText'); if (el) el.textContent = status.enabled ? 'Enabled' : 'Disabled';
            el = document.getElementById('statusIndicator'); if (el) el.className = 'indicator ' + (status.enabled ? 'indicator-success' : 'indicator-danger');
            el = document.getElementById('openIncidents'); if (el) el.textContent = status.open_incidents;
            el = document.getElementById('rateLimit'); if (el) el.textContent = (status.rate_limit_remaining != null ? status.rate_limit_remaining : 5) + '/5';
            el = document.getElementById('incidents24h'); if (el) el.textContent = status.total_incidents_24h != null ? status.total_incidents_24h : 0;
            el = document.getElementById('autoFixStatus'); if (el) el.textContent = status.auto_fix_enabled ? 'Enabled' : 'Disabled';
            var killBtn = document.getElementById('killSwitchBtn');
            if (killBtn) {
                killBtn.textContent = status.kill_switch_active ? 'üî¥ Kill Switch ON' : 'Kill Switch';
                killBtn.className = 'btn ' + (status.kill_switch_active ? 'btn-danger' : 'btn-outline');
            }
        }
        var incidents = await fetchAPI('/incidents?limit=20');
        if (incidents && Array.isArray(incidents)) {
            renderIncidents(incidents);
            var awaiting = incidents.filter(function(i) { return i.status === 'awaiting_approval'; }).length;
            el = document.getElementById('incidentText'); if (el) el.textContent = awaiting + ' awaiting approval';
            var critical = incidents.filter(function(i) { return i.severity === 'P0' || i.severity === 'P1'; }).length;
            el = document.getElementById('criticalCount'); if (el) { el.textContent = critical; el.style.color = critical > 0 ? '#fca5a5' : '#6ee7b7'; }
        }
    }

    function renderIncidents(incidents) {
        var list = document.getElementById('incidentList');
        if (!list) return;
        if (!incidents || incidents.length === 0) {
            list.innerHTML = '<li class="empty-state"><div class="icon">‚úÖ</div><p>No incidents to display</p></li>';
            return;
        }
        list.innerHTML = incidents.map(function(inc) {
            var id = (inc.incident_id || inc.id || '').toString().replace(/'/g, '&#39;');
            var summary = escapeHtml((inc.summary || '').substring(0, 60)) + ((inc.summary || '').length > 60 ? '...' : '');
            var sev = (inc.severity || 'P3').toLowerCase();
            var subsys = escapeHtml(inc.subsystem || '');
            var cat = escapeHtml(inc.category || '');
            var st = escapeHtml(inc.status || '');
            var approval = inc.approval_required ? '<span class="badge badge-approval">Needs Approval</span>' : '';
            return '<li class="incident-item severity-' + sev + '" onclick="window.qaGuardianViewIncident(\'' + id + '\')">' +
                '<div class="incident-header"><span class="incident-title">' + summary + '</span><span class="badge badge-' + sev + '">' + escapeHtml(inc.severity || '') + '</span></div>' +
                '<div class="incident-meta"><span>üìÅ ' + subsys + '</span><span>üè∑Ô∏è ' + cat + '</span><span class="badge badge-status">' + st + '</span>' + approval + '</div></li>';
        }).join('');
    }

    window.qaGuardianViewIncident = async function(incidentId) {
        var inc = await fetchAPI('/incidents/' + incidentId);
        if (inc && window.showToast) window.showToast('Incident: ' + (inc.summary || incidentId).substring(0, 50), 'info');
        else if (inc) alert(JSON.stringify(inc, null, 2));
    };

    window.qaGuardianRefresh = refreshDashboard;
    window.qaGuardianFilterIncidents = async function() {
        var filter = document.getElementById('incidentFilter');
        var val = filter ? filter.value : 'all';
        var endpoint = val === 'all' ? '/incidents?limit=20' : '/incidents?status=' + encodeURIComponent(val) + '&limit=20';
        var incidents = await fetchAPI(endpoint);
        if (incidents) renderIncidents(incidents);
    };

    window.qaGuardianToggleKillSwitch = async function() {
        var status = await fetchAPI('/status');
        if (!status) return;
        var newState = !status.kill_switch_active;
        if (newState && !confirm('Activate kill switch? This will stop all auto-fixes.')) return;
        await fetchAPI('/kill-switch', { method: 'POST', body: JSON.stringify({ enable: newState }) });
        refreshDashboard();
    };

    window.qaGuardianRequestReview = async function() {
        var target = prompt('What to review? (full, security, regression)', 'full');
        if (!target) return;
        var result = await fetchAPI('/request-review', { method: 'POST', body: JSON.stringify({ target: target, notes: 'Requested from dashboard' }) });
        if (result && result.success) {
            if (window.showToast) window.showToast('Review requested: ' + (result.request_id || ''), 'success');
            else alert('Review requested: ' + result.request_id);
            refreshDashboard();
        }
    };

    window.qaGuardianRunRegression = async function(type) {
        var result = await fetchAPI('/run-regression', { method: 'POST', body: JSON.stringify({ run_type: type }) });
        if (result && result.success) {
            if (window.showToast) window.showToast('Regression started', 'success');
            else alert('Regression started: ' + (result.run_id || ''));
            refreshDashboard();
        }
    };

    window.qaGuardianRunSecurityScan = async function() {
        var result = await fetchAPI('/run-security-scan', { method: 'POST', body: JSON.stringify({ scan_type: 'full' }) });
        if (result && result.success) {
            if (window.showToast) window.showToast('Security scan started', 'success');
            else alert('Security scan started: ' + (result.scan_id || ''));
            refreshDashboard();
        }
    };

    window.qaGuardianStart = async function() {
        var result = await fetchAPI('/start', { method: 'POST' });
        if (result && result.success) { if (window.showToast) window.showToast('Guardian loop started', 'success'); refreshDashboard(); }
    };

    window.qaGuardianStop = async function() {
        var result = await fetchAPI('/stop', { method: 'POST' });
        if (result && result.success) { if (window.showToast) window.showToast('Guardian loop stopped', 'success'); refreshDashboard(); }
    };

    var qaLink = document.querySelector('#sidebar a[href="/api/v1/qa/ui"]');
    if (qaLink) { qaLink.classList.add('bg-white/10', 'text-white'); qaLink.classList.remove('text-gray-300'); }
    refreshDashboard();
    setInterval(refreshDashboard, 30000);
})();
</script>
{% endblock %}
