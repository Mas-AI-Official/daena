{% extends "base.html" %}

{% block title %}Web3 / DeFi — Daena VP{% endblock %}

{% block head %}
<style>
.defi-stat { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.1); border-radius: 10px; padding: 14px 16px; }
.defi-stat.blue { border-top: 2px solid #5b9bd5; }
.defi-stat.amber { border-top: 2px solid #f0a84b; }
.defi-stat.red { border-top: 2px solid #e05565; }
.defi-stat.green { border-top: 2px solid #3ecf8e; }
</style>
{% endblock %}

{% block content %}
<div class="p-6 max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <i class="fas fa-link text-daena-gold"></i>
        Web3 / DeFi
    </h1>
    <p class="text-gray-400 text-sm mb-6">Contract scanner, risk summary, monitoring, and security checklist.</p>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="defi-stat blue">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Scans Run</div>
            <div class="text-xl font-mono font-semibold text-blue-400" id="defiScans">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Total lifetime</div>
        </div>
        <div class="defi-stat amber">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Vulns Found</div>
            <div class="text-xl font-mono font-semibold text-amber-400" id="defiVulns">0</div>
            <div class="text-[10px] text-gray-500 mt-1">All severity</div>
        </div>
        <div class="defi-stat red">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Critical</div>
            <div class="text-xl font-mono font-semibold text-red-400" id="defiCritical">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Needs action</div>
        </div>
        <div class="defi-stat green">
            <div class="text-[10px] uppercase tracking-wider text-gray-500 font-medium mb-1">Contracts OK</div>
            <div class="text-xl font-mono font-semibold text-green-400" id="defiOK">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Clean</div>
        </div>
    </div>

    <!-- Scan Contract -->
    <div class="glass-panel rounded-xl p-5 mb-6">
        <h2 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
            <i class="fas fa-search text-daena-gold"></i>
            Scan Contract
        </h2>
        <div class="flex flex-wrap gap-3 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-[10px] uppercase text-gray-500 mb-1">Contract path or address</label>
                <input type="text" id="defiInput" placeholder="e.g. contracts/DemoVault.sol or 0x…"
                    class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-daena-gold/50"/>
            </div>
            <button type="button" onclick="startDefiScan()"
                class="px-4 py-2 bg-daena-gold hover:bg-yellow-500 text-black font-bold rounded-lg text-sm flex items-center gap-2">
                <i class="fas fa-play"></i> Scan
            </button>
            <button type="button" onclick="loadDefiResults()"
                class="px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Scan Results -->
        <div class="glass-panel rounded-xl p-5">
            <h2 class="text-sm font-semibold text-white mb-3">Scan Results</h2>
            <div class="overflow-x-auto border border-white/10 rounded-lg">
                <table class="w-full text-xs">
                    <thead><tr class="border-b border-white/10"><th class="text-left p-2 text-gray-500">Contract</th><th class="text-left p-2 text-gray-500">Status</th><th class="text-left p-2 text-gray-500">Vulns</th><th class="text-left p-2 text-gray-500">Time</th><th class="text-left p-2 text-gray-500"></th></tr></thead>
                    <tbody id="defiResults"><tr><td colspan="5" class="p-4 text-gray-500 text-center">No scans yet. Run a scan above.</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Monitoring & Security Checklist -->
        <div class="glass-panel rounded-xl p-5">
            <h2 class="text-sm font-semibold text-white mb-3">Monitoring & Security Checklist</h2>
            <div class="space-y-2 mb-4">
                <div class="flex items-center gap-2 text-sm text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Never broadcast transaction without explicit approval</div>
                <div class="flex items-center gap-2 text-sm text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Static analysis (e.g. Slither) — proposal step only</div>
                <div class="flex items-center gap-2 text-sm text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Dependency & pattern scanning (Semgrep for Solidity)</div>
                <div class="flex items-center gap-2 text-sm text-gray-400"><i class="fas fa-check-circle text-green-400 w-4"></i> Fuzzing harness (Foundry/Echidna) — proposal only</div>
            </div>
            <div class="p-3 bg-black/20 rounded-lg border border-white/5 max-h-40 overflow-y-auto">
                <div class="text-[10px] text-gray-500 uppercase mb-1">Scan Log</div>
                <div id="defiFeed" class="text-xs text-gray-400 space-y-1">Scan output appears here…</div>
            </div>
        </div>
    </div>

    <!-- Available Tools -->
    <div class="mt-6 glass-panel rounded-xl p-5">
        <h2 class="text-sm font-semibold text-white mb-3">Available Tools</h2>
        <div class="overflow-x-auto border border-white/10 rounded-lg">
            <table class="w-full text-xs">
                <thead><tr class="border-b border-white/10"><th class="text-left p-2 text-gray-500">Tool</th><th class="text-left p-2 text-gray-500">Version</th><th class="text-left p-2 text-gray-500">Status</th></tr></thead>
                <tbody id="defiTools"><tr><td colspan="3" class="p-4 text-gray-500 text-center">Loading…</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const API_DEFI = '/api/v1/defi';
function timeAgo(ts) {
    if (!ts) return '—';
    const d = typeof ts === 'number' ? ts : new Date(ts).getTime();
    const diff = Date.now() - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
    return Math.floor(diff/86400000) + 'd ago';
}
async function loadDefi() {
    try {
        const tools = await fetch(API_DEFI + '/tools').then(r => r.ok ? r.json() : null);
        if (tools && tools.length) {
            document.getElementById('defiTools').innerHTML = tools.map(t =>
                '<tr class="border-b border-white/5"><td class="p-2 font-mono">' + (t.name || '') + '</td><td class="p-2 font-mono">' + (t.version || '—') + '</td><td class="p-2"><span class="' + (t.installed ? 'text-green-400' : 'text-amber-400') + '">' + (t.installed ? 'Installed' : 'Not Found') + '</span></td></tr>'
            ).join('');
        } else {
            document.getElementById('defiTools').innerHTML = '<tr><td colspan="3" class="p-4 text-gray-500 text-center">No tools</td></tr>';
        }
    } catch (e) { console.warn('DeFi load:', e); }
}
async function startDefiScan() {
    const val = document.getElementById('defiInput').value.trim();
    if (!val) return;
    const feed = document.getElementById('defiFeed');
    if (feed) feed.innerHTML = '<div>Scanning ' + val + '…</div>' + feed.innerHTML;
    try {
        const r = await fetch(API_DEFI + '/scan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contract_path: val }) });
        const data = r.ok ? await r.json() : null;
        if (data && feed) feed.innerHTML = '<div class="text-green-400">Scan started ID: ' + (data.scan_id || '—') + '</div>' + feed.innerHTML;
        loadDefiResults();
    } catch (e) { if (feed) feed.innerHTML = '<div class="text-red-400">Scan failed</div>' + feed.innerHTML; }
}
async function loadDefiResults() {
    try {
        const results = await fetch(API_DEFI + '/results').then(r => r.ok ? r.json() : null);
        if (results && results.length) {
            document.getElementById('defiScans').textContent = results.length;
            const vulns = results.reduce((a, r) => a + (r.vulnerabilities || 0), 0);
            document.getElementById('defiVulns').textContent = vulns;
            document.getElementById('defiCritical').textContent = results.reduce((a, r) => a + (r.critical || 0), 0);
            document.getElementById('defiOK').textContent = results.filter(r => !(r.vulnerabilities)).length;
            document.getElementById('defiResults').innerHTML = results.map(r =>
                '<tr class="border-b border-white/5"><td class="p-2 font-mono">' + (r.contract || '—') + '</td><td class="p-2">' + (r.status === 'complete' ? '<span class="text-green-400">Complete</span>' : '<span class="text-amber-400">' + (r.status || '—') + '</span>') + '</td><td class="p-2">' + (r.vulnerabilities || 0) + '</td><td class="p-2 font-mono text-gray-500">' + timeAgo(r.created_at) + '</td><td class="p-2"><a href="#" class="text-daena-gold hover:underline">Report</a></td></tr>'
            ).join('');
        }
    } catch (e) { console.warn('DeFi results:', e); }
}
loadDefi();
</script>
{% endblock %}
