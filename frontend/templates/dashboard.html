{% extends "base.html" %}

{% block title %}Dashboard - Daena AI VP{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/hexagonal-dashboard.css">
<style>
    /* Additional Dashboard Styles */
    .dashboard-grid {
        width: 100%;
        max-width: 1200px;
        margin-top: 15px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .dashboard-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px 14px;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-header i {
        font-size: 14px;
        color: var(--daena-gold);
    }

    .card-header h4 {
        font-size: 11px;
        color: #9CA3AF;
        text-transform: uppercase;
        margin: 0;
    }

    /* Activity Feed */
    .activity-list {
        max-height: 130px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-text {
        font-size: 11px;
        color: #E5E7EB;
        line-height: 1.3;
    }

    .activity-time {
        font-size: 9px;
        color: #6B7280;
        margin-top: 2px;
    }

    /* Task Progress */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Execution Layer panel */
    .execution-layer { display: flex; flex-direction: column; gap: 10px; }
    .execution-layer .exec-tools-section,
    .execution-layer .exec-logs-section,
    .execution-layer .exec-config-section { display: flex; flex-direction: column; gap: 4px; }
    .execution-layer .exec-label { font-size: 9px; color: #6B7280; text-transform: uppercase; }
    .execution-layer .exec-value { font-size: 11px; color: #E5E7EB; }
    .execution-layer .exec-loading { font-size: 10px; color: #6B7280; }
    .exec-tool-list, .exec-logs-list { max-height: 90px; overflow-y: auto; }
    .exec-tool-row { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; }
    .exec-tool-row .tool-name { color: #E5E7EB; }
    .exec-tool-row .tool-toggle { cursor: pointer; color: var(--daena-gold); }
    .exec-log-row { font-size: 10px; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #9CA3AF; }
    .exec-log-row .log-status { font-weight: 600; }
    .exec-log-row .log-status.ok { color: #22C55E; }
    .exec-log-row .log-status.error { color: #EF4444; }
    .exec-token-section .exec-token-row { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
    .exec-token-input { flex: 1; padding: 4px 8px; font-size: 11px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #E5E7EB; }
    .exec-token-btn { padding: 4px 10px; font-size: 10px; background: var(--daena-gold); color: #0a0a0a; border: none; border-radius: 4px; cursor: pointer; }
    .exec-token-error { font-size: 10px; color: #EF4444; margin-top: 4px; }
    .exec-run-section .exec-run-row { display: flex; gap: 8px; align-items: center; margin-top: 4px; flex-wrap: wrap; }
    .exec-run-select { flex: 1; min-width: 100px; padding: 4px 6px; font-size: 11px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #E5E7EB; }
    .exec-run-dry { font-size: 10px; color: #9CA3AF; display: flex; align-items: center; gap: 4px; }
    .exec-run-btn { padding: 4px 10px; font-size: 10px; background: #22C55E; color: #0a0a0a; border: none; border-radius: 4px; cursor: pointer; }
    .exec-run-result { font-size: 10px; margin-top: 6px; padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px; color: #9CA3AF; max-height: 60px; overflow-y: auto; }

    .task-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .task-bar {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .task-progress {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .task-label {
        font-size: 10px;
        color: #9CA3AF;
        min-width: 70px;
    }

    .task-percent {
        font-size: 10px;
        font-weight: 600;
        min-width: 35px;
        text-align: right;
    }

    /* Agent Status */
    .agent-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
    }

    .agent-mini {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 4px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .agent-mini:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
    }

    .agent-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-bottom: 4px;
    }

    .agent-dot.active {
        background: #22C55E;
        box-shadow: 0 0 6px #22C55E;
    }

    .agent-dot.busy {
        background: #F59E0B;
        box-shadow: 0 0 6px #F59E0B;
    }

    .agent-dot.idle {
        background: #6B7280;
    }

    .agent-name {
        font-size: 8px;
        color: #9CA3AF;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 50px;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }

    .quick-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: #E5E7EB;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-btn:hover {
        background: rgba(212, 175, 55, 0.1);
        border-color: var(--daena-gold);
        color: var(--daena-gold);
    }

    .quick-btn i {
        font-size: 11px;
    }

    @media (min-width: 1100px) {
        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 900px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="hex-container">
    <div class="hex-grid">
        <!-- Central Daena (NO SPINNING) -->
        <div class="center-daena" onclick="openDaenaChat()">
            <div class="daena-ring">
                <div class="daena-inner">
                    <i class="fas fa-brain daena-brain-icon"></i>
                    <div class="daena-title">Daena VP</div>
                </div>
            </div>
            <div class="daena-stats">
                <div class="agents" id="total-agents">48 Agents</div>
                <div class="efficiency" id="efficiency">94.20% Efficiency</div>
            </div>
        </div>

        <!-- Customer (Top - Green) -->
        <div class="hex-item hex-pos-customer" onclick="openDepartment('customer')">
            <i class="hex-icon fas fa-bullseye"></i>
            <div class="hex-title">Customer</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Legal (Top-Right - Purple) -->
        <div class="hex-item hex-pos-legal" onclick="openDepartment('legal')">
            <i class="hex-icon fas fa-balance-scale"></i>
            <div class="hex-title">Legal</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Engineering (Right - Blue) -->
        <div class="hex-item hex-pos-engineering" onclick="openDepartment('engineering')">
            <i class="hex-icon fas fa-cog"></i>
            <div class="hex-title">Engineering</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Product (Bottom-Right - Magenta) -->
        <div class="hex-item hex-pos-product" onclick="openDepartment('product')">
            <i class="hex-icon fas fa-rocket"></i>
            <div class="hex-title">Product</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Sales (Bottom - Green) -->
        <div class="hex-item hex-pos-sales" onclick="openDepartment('sales')">
            <i class="hex-icon fas fa-dollar-sign"></i>
            <div class="hex-title">Sales</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Marketing (Bottom-Left - Orange) -->
        <div class="hex-item hex-pos-marketing" onclick="openDepartment('marketing')">
            <i class="hex-icon fas fa-chart-bar"></i>
            <div class="hex-title">Marketing</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Finance (Left - Cyan) -->
        <div class="hex-item hex-pos-finance" onclick="openDepartment('finance')">
            <i class="hex-icon fas fa-chart-line"></i>
            <div class="hex-title">Finance</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- HR (Top-Left - Pink) -->
        <div class="hex-item hex-pos-hr" onclick="openDepartment('hr')">
            <i class="hex-icon fas fa-users"></i>
            <div class="hex-title">HR</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>
    </div>

    <!-- Company Info Panels -->
    <div class="company-info">
        <div class="info-card">
            <h4>Operations</h4>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-value" id="active-projects" style="color: #32CD32;">12</div>
                    <div class="info-label">Active Projects</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="tasks-today" style="color: #FFD700;">247</div>
                    <div class="info-label">Tasks Today</div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <h4>System Health</h4>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-value" id="uptime" style="color: #00CED1;">99.2%</div>
                    <div class="info-label">Uptime</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="avg-response" style="color: #32CD32;">1.2s</div>
                    <div class="info-label">Avg Response</div>
                </div>
            </div>
        </div>

        <div class="info-card">
            <h4>Brain Status</h4>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-value" style="color: #FF69B4;">Ollama</div>
                    <div class="info-label">LLM Provider</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="brain-status-card" style="color: #7ED321;">Active</div>
                    <div class="info-label">Status</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extended Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Recent Activity -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-stream"></i>
                <h4>Recent Activity</h4>
            </div>
            <div class="activity-list" id="activity-list">
                <!-- Activity items loaded dynamically from EventLog API -->
                <div class="activity-item">
                    <div class="activity-icon" style="background: rgba(107, 114, 128, 0.2); color: #6B7280;">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">Loading recent activity...</div>
                        <div class="activity-time">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Progress -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-tasks"></i>
                <h4>Task Progress</h4>
            </div>
            <div class="task-list" id="task-progress-list">
                <!-- Task progress loaded dynamically from Tasks API -->
                <div class="task-item">
                    <span class="task-label">Loading...</span>
                    <div class="task-bar">
                        <div class="task-progress" style="width: 0%;"></div>
                    </div>
                    <span class="task-percent">--</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-bolt"></i>
                <h4>Quick Actions</h4>
            </div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="openDaenaChat()">
                    <i class="fas fa-comments"></i> Ask Daena
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/agents'">
                    <i class="fas fa-robot"></i> View Agents
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/projects'">
                    <i class="fas fa-project-diagram"></i> Projects
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/analytics'">
                    <i class="fas fa-chart-pie"></i> Analytics
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/brain-settings'">
                    <i class="fas fa-brain"></i> Brain Settings
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/app-setup'">
                    <i class="fas fa-sliders-h"></i> App Setup
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/founder-panel'">
                    <i class="fas fa-user-shield"></i> Founder Panel
                </button>
                <button class="quick-btn" onclick="window.location.href='/ui/connections'">
                    <i class="fas fa-plug"></i> Connections
                </button>
                <button class="quick-btn" onclick="window.location.href='/incident-room'">
                    <i class="fas fa-shield-alt"></i> Incident Room
                </button>
                <button class="quick-btn" onclick="window.location.href='/api/v1/qa/ui'">
                    <i class="fas fa-clipboard-check"></i> QA Guardian
                </button>
            </div>
        </div>

        <!-- Execution Layer (Moltbot-style control plane) -->
        <div class="dashboard-card" id="execution-layer">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h4>Execution Layer</h4>
            </div>
            <div class="execution-layer">
                <div class="exec-token-section" id="exec-token-section">
                    <span class="exec-label">Token (if EXECUTION_TOKEN set on server)</span>
                    <div class="exec-token-row">
                        <input type="password" id="exec-token-input" class="exec-token-input" placeholder="X-Execution-Token" autocomplete="off" />
                        <button type="button" class="exec-token-btn" onclick="saveExecutionToken()">Save</button>
                    </div>
                    <div id="exec-token-error" class="exec-token-error" style="display:none;"></div>
                </div>
                <div class="exec-tools-section">
                    <span class="exec-label">Tools</span>
                    <div class="exec-tool-list" id="exec-tool-list">
                        <span class="exec-loading">Loading...</span>
                    </div>
                </div>
                <div class="exec-run-section">
                    <span class="exec-label">Run tool</span>
                    <div class="exec-run-row">
                        <select id="exec-run-tool" class="exec-run-select"><option value="">Select tool</option></select>
                        <label class="exec-run-dry"><input type="checkbox" id="exec-run-dry" checked /> Dry run</label>
                        <button type="button" class="exec-run-btn" onclick="runExecutionTool()">Run</button>
                    </div>
                    <div id="exec-run-result" class="exec-run-result" style="display:none;"></div>
                </div>
                <div class="exec-logs-section">
                    <span class="exec-label">Recent runs</span>
                    <div class="exec-logs-list" id="exec-logs-list">
                        <span class="exec-loading">Loading...</span>
                    </div>
                </div>
                <div class="exec-config-section">
                    <span class="exec-label">Approval</span>
                    <span id="exec-approval-mode" class="exec-value">—</span>
                    <span class="exec-label">Budget (max steps / retries)</span>
                    <span id="exec-budget" class="exec-value">—</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openDepartment(dept) {
        window.location.href = `/ui/office/${dept}`;
    }

    function openDaenaChat() {
        window.location.href = '/ui/daena-office';
    }

    // Animate hexagons on load
    document.addEventListener('DOMContentLoaded', () => {
        const hexItems = document.querySelectorAll('.hex-item');
        hexItems.forEach((hex, i) => {
            hex.style.opacity = '0';
            setTimeout(() => {
                hex.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                hex.style.opacity = '1';
            }, 100 + i * 80);
        });

        // Update brain status in card
        updateDashboardData();
    });

    // Fetch and update dashboard data (brain from API; sync with top bar)
    async function updateDashboardData() {
        try {
            const brainStatus = document.getElementById('brain-status-card');
            const topIndicator = document.getElementById('brain-status-indicator');

            const response = await fetch('/api/v1/brain/status');
            const data = await response.ok ? response.json() : {};
            const isConnected = data.connected === true && data.ollama_available === true && (data.llm_available !== false);
            const activeModel = data.active_model || 'daena-brain:latest';

            const usingFallback = !!data.using_fallback;
            if (brainStatus) {
                brainStatus.textContent = isConnected ? (usingFallback ? 'Active (fallback)' : 'Active') : 'Offline';
                brainStatus.style.color = isConnected ? '#7ED321' : '#EF4444';
            }
            if (topIndicator) {
                if (isConnected) {
                    topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20 text-green-400';
                    topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span>BRAIN ONLINE: ' + (activeModel.split(':')[0]) + (usingFallback ? ' (fallback)' : '') + '</span>';
                } else {
                    topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400';
                    topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span>BRAIN OFFLINE</span>';
                }
            }
            if (window.RealtimeStatusManager) {
                window.RealtimeStatusManager.updateStatus('brain', data);
            }
        } catch (e) {
            const brainStatus = document.getElementById('brain-status-card');
            const topIndicator = document.getElementById('brain-status-indicator');
            if (brainStatus) { brainStatus.textContent = 'Offline'; brainStatus.style.color = '#EF4444'; }
            if (topIndicator) {
                topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400';
                topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span>BRAIN OFFLINE</span>';
            }
            console.log('Dashboard brain status:', e);
        }
        loadRecentActivity();
        loadTaskProgress();
    }

    // Load recent activity from EventLog API
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/v1/events/recent?limit=10');
            if (response.ok) {
                const data = await response.json();
                const activityList = document.getElementById('activity-list');
                if (!activityList) return;

                if (data.events && data.events.length > 0) {
                    activityList.innerHTML = data.events.map(event => {
                        const iconMap = {
                            'task.completed': { icon: 'fa-check', color: '#22C55E' },
                            'agent.created': { icon: 'fa-robot', color: '#3B82F6' },
                            'chat.message': { icon: 'fa-comments', color: '#F59E0B' },
                            'task.progress': { icon: 'fa-tasks', color: '#8B5CF6' }
                        };
                        const iconInfo = iconMap[event.event_type] || { icon: 'fa-circle', color: '#6B7280' };
                        const timeAgo = getTimeAgo(new Date(event.created_at));

                        return `
                            <div class="activity-item">
                                <div class="activity-icon" style="background: rgba(${hexToRgb(iconInfo.color)}, 0.2); color: ${iconInfo.color};">
                                    <i class="fas ${iconInfo.icon}"></i>
                                    </div>
                                <div class="activity-content">
                                    <div class="activity-text">${formatEventText(event)}</div>
                                    <div class="activity-time">${timeAgo}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    activityList.innerHTML = '<div class="activity-item"><div class="activity-text" style="color: #6B7280;">No recent activity</div></div>';
                }
            }
        } catch (e) {
            console.error('Failed to load recent activity:', e);
        }
    }

    // Load task progress by department
    async function loadTaskProgress() {
        try {
            const response = await fetch('/api/v1/tasks/stats/overview');
            if (response.ok) {
                const data = await response.json();
                const taskList = document.getElementById('task-progress-list');
                if (!taskList || !data.department_distribution) return;

                const deptColors = {
                    'engineering': { color: '#4169E1', gradient: 'linear-gradient(90deg, #4169E1, #60A5FA)' },
                    'product': { color: '#9370DB', gradient: 'linear-gradient(90deg, #9370DB, #A78BFA)' },
                    'sales': { color: '#22C55E', gradient: 'linear-gradient(90deg, #22C55E, #4ADE80)' },
                    'marketing': { color: '#FF6B6B', gradient: 'linear-gradient(90deg, #FF6B6B, #F87171)' },
                    'finance': { color: '#00CED1', gradient: 'linear-gradient(90deg, #00CED1, #22D3EE)' },
                    'hr': { color: '#E91E7F', gradient: 'linear-gradient(90deg, #E91E7F, #F472B6)' },
                    'legal': { color: '#8B5CF6', gradient: 'linear-gradient(90deg, #8B5CF6, #A78BFA)' },
                    'customer': { color: '#32CD32', gradient: 'linear-gradient(90deg, #32CD32, #4ADE80)' }
                };

                const deptProgress = {};
                for (const dept in data.department_distribution) {
                    try {
                        const deptTasks = await fetch(`/api/v1/tasks/department/${dept}`).then(r => r.ok ? r.json() : []);
                        if (deptTasks.length > 0) {
                            const completed = deptTasks.filter(t => t.status === 'completed').length;
                            const total = deptTasks.length;
                            deptProgress[dept] = Math.round((completed / total) * 100);
                        }
                    } catch (e) {
                        deptProgress[dept] = 0;
                    }
                }

                taskList.innerHTML = Object.entries(deptProgress).slice(0, 5).map(([dept, progress]) => {
                    const colorInfo = deptColors[dept.toLowerCase()] || { color: '#6B7280', gradient: 'linear-gradient(90deg, #6B7280, #9CA3AF)' };
                    return `
                        <div class="task-item">
                            <span class="task-label">${dept.charAt(0).toUpperCase() + dept.slice(1)}</span>
                            <div class="task-bar">
                                <div class="task-progress" style="width: ${progress}%; background: ${colorInfo.gradient};"></div>
                                        </div>
                            <span class="task-percent" style="color: ${colorInfo.color};">${progress}%</span>
                                </div>
                            `;
                }).join('') || '<div class="task-item"><span class="task-label">No tasks</span></div>';
            }
        } catch (e) {
            console.error('Failed to load task progress:', e);
        }
    }

    // Load operations summary
    async function loadOperationsSummary() {
        try {
            const taskStats = await fetch('/api/v1/tasks/stats/overview').then(r => r.ok ? r.json() : {});
            if (taskStats.total_tasks !== undefined) {
                const activeProjectsEl = document.getElementById('active-projects');
                const tasksTodayEl = document.getElementById('tasks-today');
                if (activeProjectsEl) {
                    activeProjectsEl.textContent = Object.keys(taskStats.department_distribution || {}).length || 0;
                }
                if (tasksTodayEl) {
                    tasksTodayEl.textContent = taskStats.total_tasks || 0;
                }
            }
        } catch (e) {
            console.error('Failed to load operations summary:', e);
        }
    }

    // Helper functions
    function formatEventText(event) {
        const payload = event.payload_json || {};
        switch (event.event_type) {
            case 'task.completed':
                return `Task "${payload.title || event.entity_id}" completed`;
            case 'task.progress':
                return `Task "${payload.title || event.entity_id}" progress: ${Math.round(payload.progress || 0)}%`;
            case 'agent.created':
                return `Agent "${payload.name || event.entity_id}" created`;
            case 'chat.message':
                return `New message in chat`;
            default:
                return `${event.event_type} - ${event.entity_id}`;
        }
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '107, 114, 128';
    }

    // Execution Layer: add X-Execution-Token when set (sessionStorage.execution_token)
    function executionHeaders() {
        const t = sessionStorage.getItem('execution_token');
        return t ? { 'X-Execution-Token': t } : {};
    }
    async function executionFetch(url, options) {
        const opts = options || {};
        opts.headers = { ...opts.headers, ...executionHeaders() };
        const r = await fetch(url, opts);
        if (r.status === 401) {
            sessionStorage.removeItem('execution_token');
            throw new Error('Execution Layer requires token. Set EXECUTION_TOKEN in env and add X-Execution-Token header, or store token in sessionStorage.execution_token');
        }
        return r;
    }
    function saveExecutionToken() {
        const input = document.getElementById('exec-token-input');
        const errEl = document.getElementById('exec-token-error');
        if (!input || !errEl) return;
        const token = (input.value || '').trim();
        if (token) {
            sessionStorage.setItem('execution_token', token);
            errEl.style.display = 'none';
            errEl.textContent = '';
            loadExecutionLayer();
        } else {
            sessionStorage.removeItem('execution_token');
            errEl.textContent = 'Token cleared.';
            errEl.style.display = 'block';
        }
    }
    async function runExecutionTool() {
        const sel = document.getElementById('exec-run-tool');
        const dry = document.getElementById('exec-run-dry');
        const resultEl = document.getElementById('exec-run-result');
        if (!sel || !sel.value || !resultEl) return;
        resultEl.style.display = 'block';
        resultEl.textContent = 'Running...';
        try {
            const r = await executionFetch('/api/v1/execution/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool_name: sel.value, args: {}, dry_run: dry && dry.checked })
            });
            const data = await r.json();
            resultEl.textContent = JSON.stringify(data, null, 2).slice(0, 500);
            loadExecutionLayer();
        } catch (e) {
            resultEl.textContent = 'Error: ' + (e.message || String(e));
            const te = document.getElementById('exec-token-error');
            if (te && e.message && e.message.includes('X-Execution-Token')) {
                te.textContent = e.message;
                te.style.display = 'block';
            }
        }
    }
    async function loadExecutionLayer() {
        try {
            const [toolsRes, logsRes, configRes] = await Promise.all([
                executionFetch('/api/v1/execution/tools'),
                executionFetch('/api/v1/execution/logs?limit=5'),
                executionFetch('/api/v1/execution/config')
            ]);
            if (toolsRes.ok) {
                const data = await toolsRes.json();
                const listEl = document.getElementById('exec-tool-list');
                if (listEl && data.tools && data.tools.length > 0) {
                    listEl.innerHTML = data.tools.map(t => `
                        <div class="exec-tool-row">
                            <span class="tool-name">${t.name}</span>
                            <button type="button" class="tool-toggle" data-tool="${t.name}" data-enabled="${t.enabled}" onclick="toggleExecutionTool('${t.name}', ${!t.enabled})" title="${t.enabled ? 'Disable' : 'Enable'}">
                                ${t.enabled ? 'ON' : 'OFF'}
                            </button>
                        </div>
                    `).join('');
                    const runSel = document.getElementById('exec-run-tool');
                    if (runSel && data.tools && data.tools.length > 0) {
                        const prev = runSel.value;
                        runSel.innerHTML = '<option value="">Select tool</option>' + data.tools.filter(t => t.enabled).map(t => `<option value="${t.name}">${t.name}</option>`).join('');
                        if (prev && data.tools.some(t => t.name === prev)) runSel.value = prev;
                    }
                } else if (listEl) {
                    listEl.innerHTML = '<span class="exec-loading">No tools</span>';
                }
            }
            if (logsRes.ok) {
                const data = await logsRes.json();
                const listEl = document.getElementById('exec-logs-list');
                if (listEl) {
                    if (data.logs && data.logs.length > 0) {
                        listEl.innerHTML = data.logs.map(log => {
                            const status = (log.status === 'ok' || log.status === 'dry_run') ? 'ok' : 'error';
                            const ts = log.ts ? new Date(log.ts * 1000).toLocaleTimeString() : '—';
                            return `<div class="exec-log-row"><span class="log-status ${status}">${log.tool_name || '?'}</span> ${ts} — ${log.status || ''}</div>`;
                        }).join('');
                    } else {
                        listEl.innerHTML = '<span class="exec-loading">No runs yet</span>';
                    }
                }
            }
            if (configRes.ok) {
                const data = await configRes.json();
                const cfg = data.config || {};
                const approvalEl = document.getElementById('exec-approval-mode');
                const budgetEl = document.getElementById('exec-budget');
                if (approvalEl) approvalEl.textContent = cfg.approval_mode === 'require_approval' ? 'Require approval' : 'Auto';
                if (budgetEl) budgetEl.textContent = `${cfg.max_steps_per_run ?? '—'} / ${cfg.max_retries_per_tool ?? '—'}`;
            }
        } catch (e) {
            console.error('Execution Layer load failed:', e);
            const listEl = document.getElementById('exec-tool-list');
            if (listEl) listEl.innerHTML = '<span class="exec-loading">Failed to load</span>';
            const errEl = document.getElementById('exec-token-error');
            if (errEl && e.message && (e.message.includes('X-Execution-Token') || e.message.includes('401'))) {
                errEl.textContent = e.message;
                errEl.style.display = 'block';
            }
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const tokenInput = document.getElementById('exec-token-input');
        if (tokenInput && sessionStorage.getItem('execution_token')) tokenInput.placeholder = '•••••••• (set)';
    });
    async function toggleExecutionTool(name, enabled) {
        try {
            const r = await executionFetch(`/api/v1/execution/tools/${encodeURIComponent(name)}/enabled?enabled=${enabled}`, { method: 'PATCH' });
            if (r.ok) loadExecutionLayer();
        } catch (e) { console.error('Toggle failed:', e); }
    }

    // Refresh dashboard data periodically
    setInterval(() => {
        updateDashboardData();
        loadRecentActivity();
        loadTaskProgress();
        loadOperationsSummary();
        loadExecutionLayer();
    }, 10000);

    // Initial load
    updateDashboardData();
    loadRecentActivity();
    loadTaskProgress();
    loadOperationsSummary();
    loadExecutionLayer();
</script>
{% endblock %}