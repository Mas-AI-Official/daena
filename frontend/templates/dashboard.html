{% extends "base.html" %}

{% block title %}Dashboard - Daena AI VP{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/hexagonal-dashboard.css">
<style>
    /* Additional Dashboard Styles */
    .dashboard-grid {
        width: 100%;
        max-width: 1200px;
        margin-top: 15px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .dashboard-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 12px 14px;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-header i {
        font-size: 14px;
        color: var(--daena-gold);
    }

    .card-header h4 {
        font-size: 11px;
        color: #9CA3AF;
        text-transform: uppercase;
        margin: 0;
    }

    /* Activity Feed */
    .activity-list {
        max-height: 130px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-text {
        font-size: 11px;
        color: #E5E7EB;
        line-height: 1.3;
    }

    .activity-time {
        font-size: 9px;
        color: #6B7280;
        margin-top: 2px;
    }

    /* Task Progress */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .task-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .task-bar {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .task-progress {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .task-label {
        font-size: 10px;
        color: #9CA3AF;
        min-width: 70px;
    }

    .task-percent {
        font-size: 10px;
        font-weight: 600;
        min-width: 35px;
        text-align: right;
    }

    /* Agent Status */
    .agent-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
    }

    .agent-mini {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 4px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .agent-mini:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
    }

    .agent-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-bottom: 4px;
    }

    .agent-dot.active {
        background: #22C55E;
        box-shadow: 0 0 6px #22C55E;
    }

    .agent-dot.busy {
        background: #F59E0B;
        box-shadow: 0 0 6px #F59E0B;
    }

    .agent-dot.idle {
        background: #6B7280;
    }

    .agent-name {
        font-size: 8px;
        color: #9CA3AF;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 50px;
    }

    @media (min-width: 1100px) {
        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 900px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="hex-container">
    <div class="hex-grid">
        <!-- Central Daena (NO SPINNING) -->
        <div class="center-daena" onclick="openDaenaChat()">
            <div class="daena-ring">
                <div class="daena-inner">
                    <i class="fas fa-brain daena-brain-icon"></i>
                    <div class="daena-title">Daena VP</div>
                </div>
            </div>
            <div class="daena-stats">
                <div class="agents" id="total-agents">48 Agents</div>
                <div class="efficiency" id="efficiency">94.20% Efficiency</div>
            </div>
        </div>

        <!-- Customer (Top - Green) -->
        <div class="hex-item hex-pos-customer" onclick="openDepartment('customer')">
            <i class="hex-icon fas fa-bullseye"></i>
            <div class="hex-title">Customer</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Legal (Top-Right - Purple) -->
        <div class="hex-item hex-pos-legal" onclick="openDepartment('legal')">
            <i class="hex-icon fas fa-balance-scale"></i>
            <div class="hex-title">Legal</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Engineering (Right - Blue) -->
        <div class="hex-item hex-pos-engineering" onclick="openDepartment('engineering')">
            <i class="hex-icon fas fa-cog"></i>
            <div class="hex-title">Engineering</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Product (Bottom-Right - Magenta) -->
        <div class="hex-item hex-pos-product" onclick="openDepartment('product')">
            <i class="hex-icon fas fa-rocket"></i>
            <div class="hex-title">Product</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Sales (Bottom - Green) -->
        <div class="hex-item hex-pos-sales" onclick="openDepartment('sales')">
            <i class="hex-icon fas fa-dollar-sign"></i>
            <div class="hex-title">Sales</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Marketing (Bottom-Left - Orange) -->
        <div class="hex-item hex-pos-marketing" onclick="openDepartment('marketing')">
            <i class="hex-icon fas fa-chart-bar"></i>
            <div class="hex-title">Marketing</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- Finance (Left - Cyan) -->
        <div class="hex-item hex-pos-finance" onclick="openDepartment('finance')">
            <i class="hex-icon fas fa-chart-line"></i>
            <div class="hex-title">Finance</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>

        <!-- HR (Top-Left - Pink) -->
        <div class="hex-item hex-pos-hr" onclick="openDepartment('hr')">
            <i class="hex-icon fas fa-users"></i>
            <div class="hex-title">HR</div>
            <div class="hex-agents">6 agents</div>
            <div class="status-dot"></div>
        </div>
    </div>

    <!-- Company Info Panels -->
    <div class="company-info">
        <div class="info-card">
            <h4>Operations</h4>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-value" id="active-projects" style="color: #32CD32;">12</div>
                    <div class="info-label">Active Projects</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="tasks-today" style="color: #FFD700;">247</div>
                    <div class="info-label">Tasks Today</div>
                </div>
            </div>
        </div>

        <div class="info-card" style="flex: 2;">
            <h4><i class="fas fa-heartbeat text-daena-gold mr-2"></i>System Monitor</h4>
            <div class="grid grid-cols-4 gap-4 mt-2">
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">Backend</div>
                    <div id="system-backend-status" class="font-bold text-lg text-green-400">Checking...</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">Brain</div>
                    <div id="system-brain-status" class="font-bold text-lg text-gray-400">Checking...</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">Endpoints</div>
                    <div id="system-api-count" class="font-bold text-lg text-white">—</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">Events</div>
                    <div id="system-events-status" class="font-bold text-lg text-blue-400">Active</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extended Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Recent Activity -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-stream"></i>
                <h4>Recent Activity</h4>
            </div>
            <div class="activity-list" id="activity-list">
                <!-- Activity items loaded dynamically from EventLog API -->
                <div class="activity-item">
                    <div class="activity-icon" style="background: rgba(107, 114, 128, 0.2); color: #6B7280;">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">Loading recent activity...</div>
                        <div class="activity-time">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Progress -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-tasks"></i>
                <h4>Task Progress</h4>
            </div>
            <div class="task-list" id="task-progress-list">
                <!-- Task progress loaded dynamically from Tasks API -->
                <div class="task-item">
                    <span class="task-label">Loading...</span>
                    <div class="task-bar">
                        <div class="task-progress" style="width: 0%;"></div>
                    </div>
                    <span class="task-percent">--</span>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Safety check for hasExecutionToken & executionHeaders
    if (typeof window.hasExecutionToken !== 'function') {
        window.hasExecutionToken = function () {
            try { return !!(localStorage.getItem('execution_token') || (document.cookie.match(/daena_execution_token=([^;]+)/) || [])[1]); } catch (e) { return false; }
        };
    }
    if (typeof window.executionHeaders !== 'function') {
        window.executionHeaders = function () {
            try {
                const token = localStorage.getItem('execution_token') || (document.cookie.match(/daena_execution_token=([^;]+)/) || [])[1];
                return token ? { 'Authorization': 'Bearer ' + token, 'X-Execution-Token': token } : {};
            } catch (e) { return {}; }
        };
    }

    function openDepartment(dept) {
        window.location.href = `/ui/office/${dept}`;
    }

    function openDaenaChat() {
        window.location.href = '/ui/daena-office';
    }

    // Animate hexagons on load
    document.addEventListener('DOMContentLoaded', () => {
        const hexItems = document.querySelectorAll('.hex-item');
        hexItems.forEach((hex, i) => {
            hex.style.opacity = '0';
            setTimeout(() => {
                hex.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                hex.style.opacity = '1';
            }, 100 + i * 80);
        });

        // Update brain status in card
        updateDashboardData();
    });

    let brainStatusFailCount = 0;
    const BRAIN_OFFLINE_AFTER_FAILS = 2;

    async function fetchBrainStatusWithRetry() {
        const url = '/api/v1/brain/status';
        try {
            const r = await fetch(url, { signal: AbortSignal.timeout(6000) });
            if (r.ok) return await r.json();
        } catch (_) { }
        try {
            await new Promise(r => setTimeout(r, 1200));
            const r = await fetch(url, { signal: AbortSignal.timeout(6000) });
            if (r.ok) return await r.json();
        } catch (_) { }
        return null;
    }

    async function updateDashboardData() {
        const brainStatus = document.getElementById('brain-status-card');
        const topIndicator = document.getElementById('brain-status-indicator');
        if (brainStatus) { brainStatus.textContent = 'Checking…'; brainStatus.style.color = '#9CA3AF'; }

        let data = null;
        try {
            data = await fetchBrainStatusWithRetry();
        } catch (e) {
            console.log('Dashboard brain status:', e);
        }

        if (data) {
            brainStatusFailCount = 0;
            const isConnected = data.connected === true && data.ollama_available === true && (data.llm_available !== false);
            const activeModel = data.active_model || 'daena-brain:latest';
            const usingFallback = !!data.using_fallback;
            if (brainStatus) {
                brainStatus.textContent = isConnected ? (usingFallback ? 'Active (fallback)' : 'Active') : 'Offline';
                brainStatus.style.color = isConnected ? '#7ED321' : '#EF4444';
            }
            if (topIndicator) {
                if (isConnected) {
                    topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20 text-green-400';
                    topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span>BRAIN ONLINE: ' + (window.escapeHtml ? window.escapeHtml(activeModel.split(':')[0]) : activeModel.split(':')[0]) + (usingFallback ? ' (fallback)' : '') + '</span>';
                } else {
                    topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400';
                    topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span>BRAIN OFFLINE</span>';
                }
            }
            if (window.RealtimeStatusManager) window.RealtimeStatusManager.updateStatus('brain', data);
        } else {
            brainStatusFailCount = (brainStatusFailCount || 0) + 1;
            if (brainStatusFailCount >= BRAIN_OFFLINE_AFTER_FAILS) {
                if (brainStatus) { brainStatus.textContent = 'Offline'; brainStatus.style.color = '#EF4444'; }
                if (topIndicator) {
                    topIndicator.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400';
                    topIndicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span>BRAIN OFFLINE</span>';
                }
            } else if (brainStatus) {
                brainStatus.textContent = 'Checking…';
                brainStatus.style.color = '#9CA3AF';
            }
        }

        loadRecentActivity();
        loadTaskProgress();
        loadSystemStatus();
    }
    async function loadSystemStatus() {
        const backendEl = document.getElementById('system-backend-status');
        const countEl = document.getElementById('system-api-count');
        const brainEl = document.getElementById('system-brain-status');

        try {
            // Check Backend & Endpoints
            const r = await fetch('/api/v1/system-summary/summary').catch(() => fetch('/api/v1/health'));
            if (r.ok) {
                const data = await r.json().catch(() => ({}));
                if (backendEl) backendEl.textContent = (data.status === 'ok' || data.healthy) ? 'Online' : 'Issues';
                if (backendEl) backendEl.className = (data.status === 'ok' || data.healthy) ? 'font-bold text-green-400' : 'font-bold text-red-400';
                if (countEl) countEl.textContent = data.endpoint_count ?? data.routes ?? '—';
            } else {
                if (backendEl) backendEl.textContent = 'Offline';
                if (backendEl) backendEl.className = 'font-bold text-red-500';
            }

            // Check Brain
            if (brainEl) {
                const bFunc = window.fetchBrainStatusWithRetry || (() => Promise.resolve(null));
                const bData = await bFunc().catch(() => null);
                if (bData && bData.connected) {
                    brainEl.textContent = bData.using_fallback ? 'Fallback' : 'Online';
                    brainEl.className = 'font-bold text-green-400';
                } else {
                    brainEl.textContent = 'Offline';
                    brainEl.className = 'font-bold text-red-400';
                }
            }
        } catch (e) {
            console.error(e);
            if (backendEl) backendEl.textContent = 'Offline';
        }
    }

    // Load recent activity from EventLog API
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/v1/events/recent?limit=10');
            if (response.ok) {
                const data = await response.json();
                const activityList = document.getElementById('activity-list');
                if (!activityList) return;

                if (data.events && data.events.length > 0) {
                    activityList.innerHTML = data.events.map(event => {
                        const iconMap = {
                            'task.completed': { icon: 'fa-check', color: '#22C55E' },
                            'agent.created': { icon: 'fa-robot', color: '#3B82F6' },
                            'chat.message': { icon: 'fa-comments', color: '#F59E0B' },
                            'task.progress': { icon: 'fa-tasks', color: '#8B5CF6' }
                        };
                        const iconInfo = iconMap[event.event_type] || { icon: 'fa-circle', color: '#6B7280' };
                        const timeAgo = getTimeAgo(new Date(event.created_at));

                        return `
                            <div class="activity-item">
                                <div class="activity-icon" style="background: rgba(${hexToRgb(iconInfo.color)}, 0.2); color: ${iconInfo.color};">
                                    <i class="fas ${iconInfo.icon}"></i>
                                    </div>
                                <div class="activity-content">
                                    <div class="activity-text">${(window.escapeHtml ? window.escapeHtml(formatEventText(event)) : formatEventText(event))}</div>
                                    <div class="activity-time">${(window.escapeHtml ? window.escapeHtml(timeAgo) : timeAgo)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    activityList.innerHTML = '<div class="activity-item"><div class="activity-text" style="color: #6B7280;">No recent activity</div></div>';
                }
            }
        } catch (e) {
            console.error('Failed to load recent activity:', e);
        }
    }

    // Load task progress: execution tasks when token set, else department stats
    async function loadTaskProgress() {
        const taskList = document.getElementById('task-progress-list');
        if (!taskList) return;
        const esc = window.escapeHtml || (s => (s == null ? '' : String(s)));
        try {
            if (window.hasExecutionToken && window.hasExecutionToken()) {
                const r = await fetch('/api/v1/execution/tasks?limit=10', { headers: executionHeaders() });
                if (r.ok) {
                    const data = await r.json();
                    const tasks = (data.tasks || []).slice(0, 8);
                    if (tasks.length > 0) {
                        taskList.innerHTML = tasks.map(t => {
                            const goal = (t.goal || t.task_id || '').slice(0, 28);
                            const status = (t.status || 'pending').toLowerCase();
                            const statusColor = status === 'completed' ? '#22C55E' : status === 'running' ? '#F59E0B' : '#6B7280';
                            return `<div class="task-item"><span class="task-label">${esc(goal)}</span><span style="font-size:10px;color:${statusColor}">${esc(status)}</span></div>`;
                        }).join('');
                        return;
                    }
                }
            }
            const response = await fetch('/api/v1/tasks/stats/overview');
            if (response.ok) {
                const data = await response.json();
                if (data.department_distribution && Object.keys(data.department_distribution).length > 0) {
                    const deptColors = {
                        'engineering': { color: '#4169E1', gradient: 'linear-gradient(90deg, #4169E1, #60A5FA)' },
                        'product': { color: '#9370DB', gradient: 'linear-gradient(90deg, #9370DB, #A78BFA)' },
                        'sales': { color: '#22C55E', gradient: 'linear-gradient(90deg, #22C55E, #4ADE80)' },
                        'marketing': { color: '#FF6B6B', gradient: 'linear-gradient(90deg, #FF6B6B, #F87171)' },
                        'finance': { color: '#00CED1', gradient: 'linear-gradient(90deg, #00CED1, #22D3EE)' },
                        'hr': { color: '#E91E7F', gradient: 'linear-gradient(90deg, #E91E7F, #F472B6)' },
                        'legal': { color: '#8B5CF6', gradient: 'linear-gradient(90deg, #8B5CF6, #A78BFA)' },
                        'customer': { color: '#32CD32', gradient: 'linear-gradient(90deg, #32CD32, #4ADE80)' }
                    };
                    const deptProgress = {};
                    for (const dept in data.department_distribution) {
                        try {
                            const deptTasks = await fetch(`/api/v1/tasks/department/${dept}`).then(r => r.ok ? r.json() : []);
                            if (deptTasks.length > 0) {
                                const completed = deptTasks.filter(t => t.status === 'completed').length;
                                const total = deptTasks.length;
                                deptProgress[dept] = Math.round((completed / total) * 100);
                            }
                        } catch (e) {
                            deptProgress[dept] = 0;
                        }
                    }
                    taskList.innerHTML = Object.entries(deptProgress).slice(0, 5).map(([dept, progress]) => {
                        const colorInfo = deptColors[dept.toLowerCase()] || { color: '#6B7280', gradient: 'linear-gradient(90deg, #6B7280, #9CA3AF)' };
                        return `<div class="task-item"><span class="task-label">${esc(dept.charAt(0).toUpperCase() + dept.slice(1))}</span><div class="task-bar"><div class="task-progress" style="width: ${progress}%; background: ${colorInfo.gradient};"></div></div><span class="task-percent" style="color: ${colorInfo.color};">${progress}%</span></div>`;
                    }).join('');
                    return;
                }
            }
        } catch (e) {
            console.error('Failed to load task progress:', e);
        }
        taskList.innerHTML = (window.hasExecutionToken && window.hasExecutionToken()) ? '<div class="task-item"><span class="task-label">No execution tasks yet</span></div>' : '<div class="task-item"><span class="task-label">No tasks (set Execution Token to show execution tasks)</span></div>';
    }

    // Load operations summary
    async function loadOperationsSummary() {
        try {
            const taskStats = await fetch('/api/v1/tasks/stats/overview').then(r => r.ok ? r.json() : {});
            if (taskStats.total_tasks !== undefined) {
                const activeProjectsEl = document.getElementById('active-projects');
                const tasksTodayEl = document.getElementById('tasks-today');
                if (activeProjectsEl) {
                    activeProjectsEl.textContent = Object.keys(taskStats.department_distribution || {}).length || 0;
                }
                if (tasksTodayEl) {
                    tasksTodayEl.textContent = taskStats.total_tasks || 0;
                }
            }
        } catch (e) {
            console.error('Failed to load operations summary:', e);
        }
    }

    // Helper functions
    function formatEventText(event) {
        const payload = event.payload_json || {};
        switch (event.event_type) {
            case 'task.completed':
                return `Task "${payload.title || event.entity_id}" completed`;
            case 'task.progress':
                return `Task "${payload.title || event.entity_id}" progress: ${Math.round(payload.progress || 0)}%`;
            case 'agent.created':
                return `Agent "${payload.name || event.entity_id}" created`;
            case 'chat.message':
                return `New message in chat`;
            default:
                return `${event.event_type} - ${event.entity_id}`;
        }
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '107, 114, 128';
    }

    // Refresh dashboard data periodically
    setInterval(() => {
        updateDashboardData();
        loadRecentActivity();
        loadTaskProgress();
        loadOperationsSummary();
    }, 10000);

    // Initial load
    updateDashboardData();
    loadRecentActivity();
    loadTaskProgress();
    loadOperationsSummary();
</script>
{% endblock %}