{% extends "base.html" %}

{% block title %}Crypto — Daena VP{% endblock %}

{% block head %}
<style>
.crypto-page { padding: 24px; max-width: 1400px; margin: 0 auto; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.5; color: #e5e7eb; }
.crypto-page h1 { font-size: 26px; font-weight: 700; color: white; margin-bottom: 6px; }
.crypto-page .subtitle { color: #9CA3AF; font-size: 14px; margin-bottom: 24px; }
.crypto-stat { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 14px 16px; }
.crypto-stat.blue { border-top: 2px solid #5b9bd5; }
.crypto-stat.amber { border-top: 2px solid #f0a84b; }
.crypto-stat.green { border-top: 2px solid #3ecf8e; }
.crypto-stat .stat-label { font-size: 11px; color: #9CA3AF; text-transform: uppercase; letter-spacing: .5px; }
.crypto-stat .stat-value { font-size: 20px; font-weight: 700; }
.crypto-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 18px; margin-bottom: 20px; }
.crypto-panel h2 { font-size: 16px; font-weight: 600; color: white; margin-bottom: 12px; }
.crypto-sync { font-size: 11px; color: #9CA3AF; margin-top: 8px; }
.crypto-sync.ok { color: #3ecf8e; }
.crypto-sync.off { color: #e05565; }
</style>
{% endblock %}

{% block content %}
<div class="crypto-page">
    <h1 class="flex items-center gap-2">
        <i class="fas fa-coins text-daena-gold"></i>
        Crypto Monitor
    </h1>
    <p class="subtitle">Price, status, and DeFi tools — synced with backend (<code>/api/v1/crypto/dashboard</code>).</p>

    <!-- Backend sync status -->
    <p id="cryptoSyncStatus" class="crypto-sync off">Backend: …</p>

    <!-- Summary: Price + DeFi -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="crypto-stat blue">
            <div class="stat-label">Symbol</div>
            <div class="stat-value text-blue-400" id="cryptoSymbol">—</div>
            <div class="text-[10px] text-gray-500 mt-1">Token</div>
        </div>
        <div class="crypto-stat amber">
            <div class="stat-label">Price (USD)</div>
            <div class="stat-value text-amber-400" id="cryptoPrice">—</div>
            <div class="text-[10px] text-gray-500 mt-1" id="cryptoPriceUpdated">—</div>
        </div>
        <div class="crypto-stat green">
            <div class="stat-label">DeFi Status</div>
            <div class="stat-value text-green-400" id="cryptoDefiStatus">—</div>
            <div class="text-[10px] text-gray-500 mt-1">Module</div>
        </div>
        <div class="crypto-stat blue">
            <div class="stat-label">Scans</div>
            <div class="stat-value text-blue-400" id="cryptoScans">0</div>
            <div class="text-[10px] text-gray-500 mt-1">Total / Active</div>
        </div>
    </div>

    <!-- Tools (from dashboard) -->
    <div class="crypto-panel">
        <h2 class="flex items-center gap-2"><i class="fas fa-tools text-daena-gold"></i> Tools</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead><tr><th class="text-left py-2 text-gray-500 font-medium">Name</th><th class="text-left py-2 text-gray-500 font-medium">Endpoint</th><th class="text-left py-2 text-gray-500 font-medium">Status</th></tr></thead>
                <tbody id="cryptoToolsBody"><tr><td colspan="3" class="text-gray-500 py-4">Loading…</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- Recent scans (from DeFi) -->
    <div class="crypto-panel">
        <h2 class="flex items-center gap-2"><i class="fas fa-list text-daena-gold"></i> Recent Scans</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead><tr><th class="text-left py-2 text-gray-500 font-medium">Scan ID</th><th class="text-left py-2 text-gray-500 font-medium">Contract</th><th class="text-left py-2 text-gray-500 font-medium">Status</th><th class="text-left py-2 text-gray-500 font-medium">Vulns</th></tr></thead>
                <tbody id="cryptoScansBody"><tr><td colspan="4" class="text-gray-500 py-4">Loading…</td></tr></tbody>
            </table>
        </div>
    </div>

    <p class="text-gray-500 text-xs mt-4"><a href="/ui/web3" class="text-daena-gold hover:underline">Web3 / DeFi</a> — contract scanner. <a href="/ui/control-pannel" class="text-daena-gold hover:underline">Control Pannel</a> — governance &amp; tools.</p>
</div>

<script>
const CRYPTO_API = '/api/v1/crypto';

async function loadCryptoDashboard() {
    const syncEl = document.getElementById('cryptoSyncStatus');
    try {
        const r = await fetch(CRYPTO_API + '/dashboard', { headers: { 'Content-Type': 'application/json' } });
        if (!r.ok) { syncEl.textContent = 'Backend: Unavailable'; syncEl.className = 'crypto-sync off'; return; }
        const data = await r.json();
        syncEl.textContent = 'Backend: OK (synced)'; syncEl.className = 'crypto-sync ok';

        const sum = data.summary || {};
        const prices = sum.prices || [];
        if (prices.length) {
            const p = prices[0];
            document.getElementById('cryptoSymbol').textContent = p.symbol || '—';
            document.getElementById('cryptoPrice').textContent = p.price_usd != null ? '$' + Number(p.price_usd).toFixed(4) : '—';
            document.getElementById('cryptoPriceUpdated').textContent = p.updated_at ? new Date(p.updated_at).toLocaleString() : '—';
        } else {
            document.getElementById('cryptoSymbol').textContent = '—';
            document.getElementById('cryptoPrice').textContent = '—';
            document.getElementById('cryptoPriceUpdated').textContent = 'Set CRYPTO_SYMBOL / CRYPTO_PRICE_USD';
        }
        document.getElementById('cryptoDefiStatus').textContent = sum.defi_status || '—';
        document.getElementById('cryptoScans').textContent = (sum.scans_count || 0) + ' / ' + (sum.active_scans || 0);

        const tools = data.tools || [];
        const tbody = document.getElementById('cryptoToolsBody');
        tbody.innerHTML = tools.length ? tools.map(t => '<tr><td class="py-2">' + (t.name || t.id) + '</td><td class="py-2 text-gray-400">' + (t.endpoint || '') + '</td><td class="py-2">' + (t.status || '—') + '</td></tr>').join('') : '<tr><td colspan="3" class="text-gray-500 py-2">No tools</td></tr>';

        const scans = data.scans || [];
        const sbody = document.getElementById('cryptoScansBody');
        sbody.innerHTML = scans.length ? scans.map(s => '<tr><td class="py-2 font-mono text-xs">' + (s.scan_id || '') + '</td><td class="py-2 truncate max-w-[200px]">' + (s.contract_path || '') + '</td><td class="py-2">' + (s.status || '') + '</td><td class="py-2">' + (s.vulnerabilities != null ? s.vulnerabilities : '—') + '</td></tr>').join('') : '<tr><td colspan="4" class="text-gray-500 py-2">No scans yet</td></tr>';
    } catch (e) {
        syncEl.textContent = 'Backend: Unavailable'; syncEl.className = 'crypto-sync off';
    }
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadCryptoDashboard);
else loadCryptoDashboard();
setInterval(loadCryptoDashboard, 60000);
</script>
{% endblock %}
