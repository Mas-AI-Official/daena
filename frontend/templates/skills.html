{% extends "base.html" %}

{% block title %}Skills - Daena VP{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">Skills</h1>
            <p class="text-gray-400 text-sm mt-1">Server-side skills that use the Execution Layer</p>
        </div>
        <button onclick="loadSkills()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-white transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Skill list</h2>
        <div id="skills-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500">Loading...</div>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Run skill</h2>
        <p class="text-gray-400 text-sm mb-4">Execution token is required (set in App Setup / Dashboard and stored in session).</p>
        <div id="run-result" class="hidden mt-4 p-4 rounded-lg bg-black/30 border border-white/10 text-sm font-mono text-gray-300"></div>
        <div id="run-artifact-link" class="hidden mt-2">
            <a href="#" id="view-artifact-btn" target="_blank" class="text-daena-gold hover:underline text-sm">View last artifact</a>
        </div>
    </div>

    <div class="glass-panel p-6 rounded-xl">
        <h2 class="text-lg font-medium text-white mb-4">Recent artifacts</h2>
        <p class="text-gray-400 text-sm mb-2">Artifacts produced by skill runs (requires Execution Token).</p>
        <div id="artifacts-list" class="space-y-2">
            <div class="text-center py-4 text-gray-500">Load with token...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = (window.DAENA_API_BASE || (window.location.origin + '/api/v1')).replace(/\/+$/, '');

    function getExecutionToken() {
        try {
            return sessionStorage.getItem('daena_execution_token') || sessionStorage.getItem('execution_token') || '';
        } catch (e) { return ''; }
    }

    async function loadSkills() {
        const el = document.getElementById('skills-list');
        el.innerHTML = '<div class="text-center py-4 text-gray-500">Loading...</div>';
        const url = API_BASE + '/skills';
        try {
            const r = await fetch(url);
            const data = r.ok ? await r.json().catch(() => ({})) : {};
            if (!r.ok) {
                const detail = (data.detail && (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail))) || r.statusText || (r.status === 404 ? 'Not Found (404) â€” Skills API may not be registered.' : 'Backend error.');
                el.innerHTML = '<div class="rounded-lg p-4 bg-red-500/10 border border-red-500/30"><p class="text-red-400 font-medium">Could not load skills</p><p class="text-gray-400 text-sm mt-1">' + escapeHtml(detail) + '</p><button type="button" onclick="loadSkills()" class="mt-3 px-3 py-1.5 rounded bg-white/10 text-white text-sm">Retry</button></div>';
                return;
            }
            if (!data.success || !data.skills) {
                el.innerHTML = '<div class="rounded-lg p-4 bg-amber-500/10 border border-amber-500/30"><p class="text-amber-400">No skills returned.</p><button type="button" onclick="loadSkills()" class="mt-2 px-3 py-1.5 rounded bg-white/10 text-white text-sm">Retry</button></div>';
                return;
            }
            el.innerHTML = data.skills.map(s => `
                <div class="flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10">
                    <div>
                        <span class="font-medium text-white">${escapeHtml(s.name)}</span>
                        <span class="ml-2 px-2 py-0.5 rounded text-xs ${s.risk === 'high' ? 'bg-red-500/20 text-red-400' : s.risk === 'medium' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'}">${escapeHtml(s.risk)}</span>
                        <p class="text-gray-400 text-sm mt-1">${escapeHtml(s.description || '')}</p>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <span class="text-gray-400 text-sm">Enabled</span>
                        <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleSkill('${escapeHtml(s.id)}', this.checked)">
                    </label>
                    <button onclick="runSkill('${escapeHtml(s.id)}', ${s.risk === 'high' || s.risk === 'medium'})" class="px-3 py-1.5 rounded-lg bg-daena-gold/20 text-daena-gold hover:bg-daena-gold/30 text-sm">Run</button>
                </div>
            `).join('');
        } catch (e) {
            el.innerHTML = '<div class="rounded-lg p-4 bg-red-500/10 border border-red-500/30"><p class="text-red-400 font-medium">Network or server error</p><p class="text-gray-400 text-sm mt-1">' + escapeHtml(String(e.message || e)) + '</p><button type="button" onclick="loadSkills()" class="mt-3 px-3 py-1.5 rounded bg-white/10 text-white text-sm">Retry</button></div>';
        }
    }

    function escapeHtml(s) {
        if (s == null) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    async function toggleSkill(skillId, enabled) {
        try {
            const r = await fetch(API_BASE + '/skills/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ skill_id: skillId, enabled })
            });
            const data = await r.json();
            if (!data.success && r.status >= 400) {
                if (window.showToast) window.showToast(data.detail || 'Toggle failed', 'error');
            }
        } catch (e) {
            if (window.showToast) window.showToast('Request failed', 'error');
        }
    }

    async function runSkill(skillId, preferDryRun) {
        const token = getExecutionToken();
        if (!token) {
            if (window.showToast) window.showToast('Set Execution Token in App Setup / Dashboard first', 'error');
            return;
        }
        const resultEl = document.getElementById('run-result');
        const artifactLinkEl = document.getElementById('run-artifact-link');
        const viewArtifactBtn = document.getElementById('view-artifact-btn');
        resultEl.classList.remove('hidden');
        artifactLinkEl.classList.add('hidden');
        resultEl.textContent = 'Running...';
        try {
            const r = await fetch(API_BASE + '/skills/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Execution-Token': token
                },
                body: JSON.stringify({ skill_id: skillId, params: {}, dry_run: preferDryRun })
            });
            const data = await r.json();
            resultEl.textContent = JSON.stringify(data, null, 2);
            if (!r.ok) resultEl.classList.add('text-red-400'); else resultEl.classList.remove('text-red-400');
            if (data.artifact_path) {
                viewArtifactBtn.href = '#';
                viewArtifactBtn.onclick = function(e) {
                    e.preventDefault();
                    fetch(API_BASE + '/skills/artifacts/' + encodeURIComponent(data.artifact_path), { headers: { 'X-Execution-Token': token } })
                        .then(res => res.blob()).then(blob => {
                            const url = URL.createObjectURL(blob);
                            window.open(url);
                        }).catch(() => {});
                };
                artifactLinkEl.classList.remove('hidden');
            }
            loadArtifacts();
        } catch (e) {
            resultEl.textContent = 'Error: ' + e.message;
            resultEl.classList.add('text-red-400');
        }
    }

    async function loadArtifacts() {
        const el = document.getElementById('artifacts-list');
        const token = getExecutionToken();
        if (!token) {
            el.innerHTML = '<p class="text-gray-500">Set Execution Token to list artifacts.</p>';
            return;
        }
        try {
            const r = await fetch(API_BASE + '/skills/artifacts?limit=10', { headers: { 'X-Execution-Token': token } });
            const data = await r.json();
            if (!data.success || !data.artifacts || data.artifacts.length === 0) {
                el.innerHTML = '<p class="text-gray-500">No artifacts yet. Run a skill to generate one.</p>';
                return;
            }
            el.innerHTML = data.artifacts.map(f => `
                <div class="flex items-center justify-between p-2 rounded bg-black/20 border border-white/5">
                    <span class="font-mono text-gray-300 text-sm">${escapeHtml(f)}</span>
                    <button type="button" onclick="viewArtifact('${escapeHtml(f).replace(/'/g, "\\'")}')" class="px-2 py-1 rounded bg-daena-gold/20 text-daena-gold text-xs hover:bg-daena-gold/30">View</button>
                </div>
            `).join('');
        } catch (e) {
            el.innerHTML = '<p class="text-red-400 text-sm">Failed to load artifacts.</p>';
        }
    }

    function viewArtifact(filename) {
        const token = getExecutionToken();
        if (!token) return;
        fetch(API_BASE + '/skills/artifacts/' + encodeURIComponent(filename), { headers: { 'X-Execution-Token': token } })
            .then(res => res.blob()).then(blob => {
                const url = URL.createObjectURL(blob);
                window.open(url);
            }).catch(() => {});
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSkills();
        loadArtifacts();
    });
</script>
{% endblock %}
