{% extends "base.html" %}

{% block title %}Provider Onboarding - Daena{% endblock %}

{% block head %}
<style>
    .provider-onboarding { max-width: 900px; margin: 0 auto; padding: 1.5rem; }
    .provider-onboarding .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .provider-onboarding .page-header h1 { font-size: 1.25rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 0.75rem; }
    .provider-onboarding .btn {
        padding: 0.5rem 1rem; border-radius: 8px; border: none; font-weight: 500; cursor: pointer;
        font-size: 0.8125rem; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .provider-onboarding .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #E5E7EB; }
    .provider-onboarding .btn-outline:hover { background: rgba(255,255,255,0.1); border-color: var(--daena-gold); }
    .provider-onboarding .btn-primary { background: rgba(59, 130, 246, 0.9); color: white; }
    .provider-onboarding .btn-primary:hover { background: #2563eb; }
    .provider-onboarding .steps { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .provider-onboarding .step-tab {
        padding: 0.5rem 1rem; border-radius: 8px; background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1); color: #9CA3AF; cursor: pointer; font-size: 0.8125rem;
    }
    .provider-onboarding .step-tab.active { background: rgba(212, 175, 55, 0.2); border-color: var(--daena-gold); color: var(--daena-gold); }
    .provider-onboarding .step-tab.done { color: #6ee7b7; }
    .provider-onboarding .panel {
        background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);
        padding: 1.25rem; margin-bottom: 1rem;
    }
    .provider-onboarding .panel h2 { font-size: 0.9375rem; margin-bottom: 1rem; color: white; }
    .provider-onboarding .panel label { display: block; font-size: 0.8125rem; color: #9CA3AF; margin-bottom: 0.25rem; }
    .provider-onboarding .panel input, .provider-onboarding .panel textarea, .provider-onboarding .panel select {
        width: 100%; padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.3); color: #E5E7EB; font-size: 0.8125rem; margin-bottom: 0.75rem;
    }
    .provider-onboarding .panel textarea { min-height: 80px; resize: vertical; }
    .provider-onboarding .provider-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
    .provider-onboarding .provider-card {
        padding: 1rem; border-radius: 8px; border: 2px solid rgba(255,255,255,0.1);
        cursor: pointer; text-align: center; transition: all 0.2s;
    }
    .provider-onboarding .provider-card.selected { border-color: var(--daena-gold); background: rgba(212, 175, 55, 0.1); }
    .provider-onboarding .provider-card .name { font-weight: 600; color: white; }
    .provider-onboarding .provider-card .status { font-size: 0.75rem; color: #9CA3AF; margin-top: 0.25rem; }
    .provider-onboarding .test-result { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.8125rem; }
    .provider-onboarding .test-result.success { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
    .provider-onboarding .test-result.error { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .provider-onboarding .empty-state { text-align: center; padding: 2rem; color: #9CA3AF; font-size: 0.8125rem; }
</style>
{% endblock %}

{% block content %}
<div class="provider-onboarding">
    <header class="page-header">
        <h1><i class="fas fa-plug text-blue-400"></i> Provider Onboarding</h1>
        <a href="/ui/dashboard" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </header>

    <div class="steps">
        <button type="button" class="step-tab active" data-step="1" onclick="providerOnboardingStep(1)">1. Choose providers</button>
        <button type="button" class="step-tab" data-step="2" onclick="providerOnboardingStep(2)">2. Tokens / webhook</button>
        <button type="button" class="step-tab" data-step="3" onclick="providerOnboardingStep(3)">3. Standing instructions</button>
        <button type="button" class="step-tab" data-step="4" onclick="providerOnboardingStep(4)">4. Test</button>
    </div>

    <div id="step-1" class="step-content">
        <div class="panel">
            <h2>Select providers to onboard</h2>
            <p class="empty-state" style="padding: 0.5rem 0 1rem;">Store tokens in .env (DISCORD_BOT_TOKEN, TELEGRAM_BOT_TOKEN). Then enable below.</p>
            <div class="provider-cards" id="provider-cards"></div>
        </div>
    </div>

    <div id="step-2" class="step-content" style="display: none;">
        <div class="panel">
            <h2>Tokens & webhook</h2>
            <p style="font-size: 0.8125rem; color: #9CA3AF; margin-bottom: 1rem;">Set in .env (never in git): DISCORD_BOT_TOKEN, TELEGRAM_BOT_TOKEN, TELEGRAM_WEBHOOK_SECRET_TOKEN (optional).</p>
            <button type="button" class="btn btn-primary" onclick="providerConnectSelected()"><i class="fas fa-link"></i> Connect selected</button>
            <div id="connect-result" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <div id="step-3" class="step-content" style="display: none;">
        <div class="panel">
            <h2>Standing instructions (system rules) per provider</h2>
            <label>Provider</label>
            <select id="standing-provider" onchange="providerLoadStanding()"></select>
            <label>Standing instructions</label>
            <textarea id="standing-instructions" placeholder="e.g. Always respond in one sentence. Never run shell_exec."></textarea>
            <button type="button" class="btn btn-primary" onclick="providerSaveStanding()"><i class="fas fa-save"></i> Save</button>
        </div>
        <div class="panel">
            <h2>Allowed tools (allowlist)</h2>
            <p style="font-size: 0.75rem; color: #9CA3AF; margin-bottom: 0.5rem;">Saving allowlist also enables this provider for receiving messages.</p>
            <label>Provider</label>
            <select id="allowlist-provider" onchange="providerLoadAllowlist()"></select>
            <label>Tool names (comma-separated, e.g. git_status, health_check, list_tools)</label>
            <input type="text" id="allowed-tools" placeholder="git_status, health_check, list_tools">
            <button type="button" class="btn btn-primary" onclick="providerSaveAllowlist()"><i class="fas fa-save"></i> Save allowlist &amp; enable</button>
        </div>
    </div>

    <div id="step-4" class="step-content" style="display: none;">
        <div class="panel">
            <h2>Test send/receive</h2>
            <label>Provider</label>
            <select id="test-provider"></select>
            <label>Channel / chat ID (Discord channel id or Telegram chat_id)</label>
            <input type="text" id="test-channel-id" placeholder="e.g. 123456789">
            <button type="button" class="btn btn-primary" onclick="providerTestSend()"><i class="fas fa-paper-plane"></i> Send test message</button>
            <div id="test-result" class="test-result" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const API = (window.DAENA_API_BASE || '/api/v1') + '/providers';
    let providers = [];
    let selectedProviders = new Set();

    async function fetchJSON(url, opts) {
        const r = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
        return r.json();
    }

    function showStep(n) {
        document.querySelectorAll('.step-content').forEach((el, i) => { el.style.display = (i + 1) === n ? 'block' : 'none'; });
        document.querySelectorAll('.step-tab').forEach((el, i) => {
            el.classList.toggle('active', (i + 1) === n);
            el.classList.toggle('done', (i + 1) < n);
        });
    }

    window.providerOnboardingStep = function(n) { showStep(n); };

    async function loadProviders() {
        const data = await fetchJSON(API);
        providers = data.providers || [];
        const cards = document.getElementById('provider-cards');
        cards.innerHTML = providers.map(p => `
            <div class="provider-card ${selectedProviders.has(p.provider_id) ? 'selected' : ''}" data-id="${p.provider_id}" onclick="toggleProvider('${p.provider_id}')">
                <div class="name">${p.provider_id}</div>
                <div class="status">${p.connected ? 'Connected' : 'Disconnected'} Â· ${p.enabled ? 'On' : 'Off'}</div>
            </div>
        `).join('');
        const sel = document.getElementById('standing-provider');
        const allow = document.getElementById('allowlist-provider');
        const test = document.getElementById('test-provider');
        [sel, allow, test].forEach(el => { if (el) { el.innerHTML = providers.map(p => `<option value="${p.provider_id}">${p.provider_id}</option>`).join(''); } });
        if (providers.length) { providerLoadStanding(); providerLoadAllowlist(); }
    }

    window.toggleProvider = function(id) {
        if (selectedProviders.has(id)) selectedProviders.delete(id); else selectedProviders.add(id);
        loadProviders();
    };

    window.providerConnectSelected = async function() {
        const resEl = document.getElementById('connect-result');
        resEl.style.display = 'block';
        resEl.className = 'test-result';
        try {
            for (const id of selectedProviders) {
                const r = await fetch(API + '/' + id + '/connect', { method: 'POST' });
                const d = await r.json();
                if (!d.success) throw new Error(d.detail || d.error || 'Connect failed');
            }
            resEl.classList.add('success');
            resEl.textContent = 'Connected.';
            loadProviders();
        } catch (e) {
            resEl.classList.add('error');
            resEl.textContent = e.message || String(e);
        }
    };

    async function getConfig() {
        return fetchJSON(API + '/config');
    }

    window.providerLoadStanding = function() {
        const id = document.getElementById('standing-provider')?.value;
        if (!id) return;
        getConfig().then(c => {
            const p = (c.providers || {})[id] || {};
            const el = document.getElementById('standing-instructions');
            if (el) el.value = p.standing_instructions || '';
        });
    };

    window.providerSaveStanding = async function() {
        const id = document.getElementById('standing-provider')?.value;
        if (!id) return;
        const text = document.getElementById('standing-instructions')?.value || '';
        await fetch(API + '/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [id]: { standing_instructions: text } }),
        });
        alert('Saved.');
    };

    window.providerLoadAllowlist = function() {
        const id = document.getElementById('allowlist-provider')?.value;
        if (!id) return;
        getConfig().then(c => {
            const p = (c.providers || {})[id] || {};
            const el = document.getElementById('allowed-tools');
            if (el) el.value = (p.allowed_tools || []).join(', ');
        });
    };

    window.providerSaveAllowlist = async function() {
        const id = document.getElementById('allowlist-provider')?.value;
        if (!id) return;
        const raw = document.getElementById('allowed-tools')?.value || '';
        const tools = raw.split(',').map(s => s.trim()).filter(Boolean);
        await fetch(API + '/config', {
            method: 'POST',
            body: JSON.stringify({ [id]: { allowed_tools: tools } }),
        });
        alert('Saved.');
    };

    window.providerTestSend = async function() {
        const id = document.getElementById('test-provider')?.value;
        const channelId = document.getElementById('test-channel-id')?.value?.trim();
        const resEl = document.getElementById('test-result');
        resEl.style.display = 'block';
        resEl.className = 'test-result';
        if (!channelId) { resEl.classList.add('error'); resEl.textContent = 'Enter channel/chat ID'; return; }
        try {
            const r = await fetch(API + '/' + id + '/test', {
                method: 'POST',
                body: JSON.stringify({ channel_id: channelId, text: 'Daena provider test' }),
            });
            const d = await r.json();
            if (d.success !== false && d.result?.success) {
                resEl.classList.add('success');
                resEl.textContent = 'Test message sent.';
            } else {
                resEl.classList.add('error');
                resEl.textContent = d.detail || (d.result?.error) || JSON.stringify(d);
            }
        } catch (e) {
            resEl.classList.add('error');
            resEl.textContent = e.message || String(e);
        }
    };

    loadProviders();
})();
</script>
{% endblock %}
