{% extends "base.html" %}

{% block title %}Incident Room - Daena VP{% endblock %}

{% block head %}
<style>
    /* Incident Room page styles – matches app theme */
    .incident-room {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
    }

    .incident-room .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .incident-room .page-header h1 {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: white;
    }

    .incident-room .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .incident-room .btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.8125rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .incident-room .btn-primary { background: rgba(59, 130, 246, 0.9); color: white; }
    .incident-room .btn-primary:hover { background: #2563eb; }

    .incident-room .btn-danger { background: rgba(239, 68, 68, 0.9); color: white; }
    .incident-room .btn-danger:hover { background: #dc2626; }

    .incident-room .btn-success { background: rgba(16, 185, 129, 0.9); color: white; }
    .incident-room .btn-success:hover { background: #059669; }

    .incident-room .btn-outline {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #E5E7EB;
    }
    .incident-room .btn-outline:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--daena-gold); color: white; }

    .incident-room .lockdown-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        margin-bottom: 1.25rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
    }

    .incident-room .lockdown-bar.active {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.08);
    }

    .incident-room .lockdown-status {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .incident-room .lockdown-status .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .incident-room .lockdown-status .badge-active {
        background: rgba(239, 68, 68, 0.3);
        color: #fca5a5;
    }

    .incident-room .lockdown-status .badge-inactive {
        background: rgba(16, 185, 129, 0.15);
        color: #6ee7b7;
    }

    .incident-room .lockdown-actions { display: flex; gap: 0.75rem; }

    .incident-room .panel {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        margin-bottom: 1.25rem;
    }

    .incident-room .panel-header {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .incident-room .panel-header h2 { font-size: 0.9375rem; font-weight: 600; color: white; margin: 0; }
    .incident-room .panel-body { padding: 1rem 1.25rem; max-height: 420px; overflow: auto; }

    .incident-room table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    .incident-room th, .incident-room td {
        padding: 0.5rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    .incident-room th { color: #9CA3AF; font-weight: 500; position: sticky; top: 0; background: rgba(0,0,0,0.3); }
    .incident-room tr:hover { background: rgba(255, 255, 255, 0.02); }

    .incident-room .empty-state { text-align: center; padding: 2rem; color: #9CA3AF; font-size: 0.8125rem; }
    .incident-room .msg { padding: 0.5rem 1rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.8125rem; }
    .incident-room .msg.error { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .incident-room .msg.success { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
    .incident-room .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.6875rem; }
    #containmentMsg .msg { margin-top: 0.25rem; }
</style>
{% endblock %}

{% block content %}
<div class="incident-room">
    <header class="page-header">
        <h1><i class="fas fa-shield-alt text-red-400"></i> Incident Room</h1>
        <div class="header-actions">
            <a href="/ui/dashboard" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <a href="/api/v1/qa/ui" class="btn btn-outline"><i class="fas fa-clipboard-check"></i> QA Guardian</a>
            <a href="/cmp-canvas" class="btn btn-outline">CMP Canvas</a>
            <button type="button" class="btn btn-outline" id="btnRefresh" onclick="incidentRoomRefreshHits()"><i class="fas fa-sync-alt"></i> Refresh hits</button>
        </div>
    </header>

    <div class="lockdown-bar" id="lockdownBar">
        <div class="lockdown-status">
            <span class="text-gray-400 text-sm">System lockdown:</span>
            <span class="badge badge-inactive" id="lockdownBadge">—</span>
        </div>
        <div class="lockdown-actions">
            <button type="button" class="btn btn-danger" id="btnLockdown" onclick="incidentRoomDoLockdown()">Lockdown</button>
            <button type="button" class="btn btn-success" id="btnUnlock" onclick="incidentRoomDoUnlock()">Unlock</button>
        </div>
    </div>
    <div id="lockdownMsg"></div>

    <div class="panel">
        <div class="panel-header">
            <h2>Containment (blocked IPs)</h2>
            <button type="button" class="btn btn-outline btn-sm" onclick="incidentRoomRefreshContainment()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="panel-body">
            <p class="text-gray-400 text-sm" style="margin-bottom: 0.5rem;">Blocked: <strong id="blockedCount">0</strong></p>
            <ul id="blockedIpsList" style="list-style: none; font-size: 0.8125rem; padding: 0; margin: 0;"></ul>
            <p class="text-gray-500 text-xs" style="margin-top: 0.75rem;" id="containmentConfig">—</p>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>Decoy hits (recent)</h2>
            <span class="text-gray-400 text-sm" id="hitsTotal">0 hits</span>
        </div>
        <div class="panel-body">
            <table>
                <thead>
                    <tr>
                        <th>Time (UTC)</th>
                        <th>Path</th>
                        <th>Method</th>
                        <th>Label</th>
                        <th>Client / X-Forwarded</th>
                        <th>User-Agent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="hitsBody">
                    <tr><td colspan="7" class="empty-state">Loading…</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    // Use same-origin API base so Incident Room works when backend is same host
    const API_BASE = (window.DAENA_API_BASE || (window.location.origin + '/api/v1')).replace(/\/+$/, '');

    function escapeHtml(s) {
        if (s == null || s === undefined) return '';
        if (typeof window.escapeHtml === 'function') return window.escapeHtml(s);
        var div = document.createElement('div');
        div.textContent = String(s);
        return div.innerHTML;
    }
    function escapeAttr(s) {
        if (s == null || s === undefined) return '';
        return escapeHtml(String(s)).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    async function api(endpoint, options = {}) {
        const url = endpoint.startsWith('http') ? endpoint : API_BASE + endpoint;
        const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
        if (!res.ok) {
            let errMsg = await res.text();
            try { var j = JSON.parse(errMsg); errMsg = j.detail || j.message || errMsg; } catch (e) {}
            throw new Error(errMsg || res.statusText);
        }
        return res.json();
    }

    async function refreshLockdownStatus() {
        try {
            const data = await api('/founder-panel/system/emergency/status');
            const active = !!data.lockdown_active;
            const badge = document.getElementById('lockdownBadge');
            const bar = document.getElementById('lockdownBar');
            if (badge) { badge.textContent = active ? 'Active' : 'Inactive'; badge.className = 'badge ' + (active ? 'badge-active' : 'badge-inactive'); }
            if (bar) bar.classList.toggle('active', active);
        } catch (e) {
            const badge = document.getElementById('lockdownBadge');
            if (badge) badge.textContent = '?';
            console.warn('Lockdown status failed', e);
        }
    }

    function hitIp(h) {
        const raw = (h && (h.x_forwarded_for || h.client_host || '')) ? String(h.x_forwarded_for || h.client_host).trim() : '';
        return raw.indexOf(',') >= 0 ? raw.split(',')[0].trim() : raw;
    }

    async function refreshHits() {
        const tbody = document.getElementById('hitsBody');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Loading…</td></tr>';
        try {
            const data = await api('/_decoy/hits?limit=100');
            const hits = data.hits || [];
            const blocked = (window._blockedIpsSet || new Set());
            const totalEl = document.getElementById('hitsTotal');
            if (totalEl) totalEl.textContent = (data.total != null ? data.total : hits.length) + ' hits';
            if (hits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No decoy hits yet.</td></tr>';
                return;
            }
            tbody.innerHTML = hits.map(function(h) {
                const ip = hitIp(h);
                const isBlocked = ip && blocked.has(ip);
                return '<tr>' +
                    '<td>' + escapeHtml(h.ts || '') + '</td>' +
                    '<td>' + escapeHtml(h.path || '') + '</td>' +
                    '<td>' + escapeHtml(h.method || '') + '</td>' +
                    '<td>' + escapeHtml(h.label || '') + '</td>' +
                    '<td>' + escapeHtml((h.x_forwarded_for || h.client_host || '')) + '</td>' +
                    '<td title="' + escapeAttr(h.user_agent || '') + '">' + escapeHtml((h.user_agent || '').slice(0, 50)) + ((h.user_agent || '').length > 50 ? '…' : '') + '</td>' +
                    '<td>' + (ip ? (isBlocked ? '<span class="text-gray-500">Blocked</span>' : '<button type="button" class="btn btn-danger btn-sm" onclick="window.incidentRoomBlockIpFromHit(\'' + escapeAttr(ip) + '\')">Block IP</button>') : '—') + '</td>' +
                '</tr>';
            }).join('');
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Failed to load: ' + escapeHtml(e && e.message ? e.message : String(e)) + '</td></tr>';
        }
    }

    async function refreshContainment() {
        const listEl = document.getElementById('blockedIpsList');
        const countEl = document.getElementById('blockedCount');
        const configEl = document.getElementById('containmentConfig');
        if (!listEl) return;
        try {
            const data = await api('/security/containment/status');
            const ips = data.blocked_ips || [];
            window._blockedIpsSet = new Set(ips);
            if (countEl) countEl.textContent = ips.length;
            if (ips.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">No IPs blocked.</li>';
            } else {
                listEl.innerHTML = ips.map(function(ip) {
                    return '<li style="margin: 0.25rem 0;">' + escapeHtml(ip) + ' <button type="button" class="btn btn-success btn-sm" onclick="window.incidentRoomUnblockIp(\'' + escapeAttr(ip) + '\')">Unblock</button></li>';
                }).join('');
            }
            if (configEl) {
                var cfg = data.config || {};
                configEl.textContent = 'Auto-block after ' + (cfg.deception_hits_before_block != null ? cfg.deception_hits_before_block : '?') + ' decoy hits; auto lockdown: ' + (cfg.auto_lockdown_on_block ? 'on' : 'off');
            }
        } catch (e) {
            listEl.innerHTML = '<li class="text-gray-500">Failed to load: ' + escapeHtml(e && e.message ? e.message : String(e)) + '</li>';
            if (countEl) countEl.textContent = '?';
            if (configEl) configEl.textContent = '—';
        }
    }

    window.incidentRoomBlockIpFromHit = async function(ip) {
        var msgEl = document.getElementById('lockdownMsg');
        if (msgEl) msgEl.innerHTML = '';
        if (!ip) return;
        try {
            await api('/security/containment/block-ip', { method: 'POST', body: JSON.stringify({ ip: ip, reason: 'incident_room' }) });
            if (msgEl) msgEl.innerHTML = '<div class="msg success">IP ' + escapeHtml(ip) + ' blocked.</div>';
            refreshContainment(); refreshHits();
        } catch (e) {
            if (msgEl) msgEl.innerHTML = '<div class="msg error">' + escapeHtml(e && e.message ? e.message : String(e)) + '</div>';
        }
    };

    window.incidentRoomUnblockIp = async function(ip) {
        var msgEl = document.getElementById('lockdownMsg');
        if (msgEl) msgEl.innerHTML = '';
        if (!ip) return;
        try {
            await api('/security/containment/unblock-ip', { method: 'POST', body: JSON.stringify({ ip: ip }) });
            if (msgEl) msgEl.innerHTML = '<div class="msg success">IP ' + escapeHtml(ip) + ' unblocked.</div>';
            refreshContainment(); refreshHits();
        } catch (e) {
            if (msgEl) msgEl.innerHTML = '<div class="msg error">' + escapeHtml(e && e.message ? e.message : String(e)) + '</div>';
        }
    };

    window.incidentRoomDoLockdown = async function() {
        var msgEl = document.getElementById('lockdownMsg');
        if (msgEl) msgEl.innerHTML = '';
        try {
            await api('/founder-panel/system/emergency/lockdown', { method: 'POST' });
            if (msgEl) msgEl.innerHTML = '<div class="msg success">Lockdown activated.</div>';
            refreshLockdownStatus();
        } catch (e) {
            if (msgEl) msgEl.innerHTML = '<div class="msg error">' + escapeHtml(e && e.message ? e.message : String(e)) + '</div>';
        }
    };

    window.incidentRoomDoUnlock = async function() {
        var msgEl = document.getElementById('lockdownMsg');
        if (msgEl) msgEl.innerHTML = '';
        try {
            await api('/founder-panel/system/emergency/unlock', { method: 'POST' });
            if (msgEl) msgEl.innerHTML = '<div class="msg success">Runtime lockdown cleared.</div>';
            refreshLockdownStatus();
        } catch (e) {
            if (msgEl) msgEl.innerHTML = '<div class="msg error">' + escapeHtml(e && e.message ? e.message : String(e)) + '</div>';
        }
    };

    window.incidentRoomRefreshHits = refreshHits;
    window.incidentRoomRefreshContainment = refreshContainment;

    async function init() {
        var link = document.querySelector('#sidebar a[href="/incident-room"]');
        if (link) { link.classList.add('bg-white/10', 'text-white'); link.classList.remove('text-gray-300'); }
        await refreshLockdownStatus();
        await refreshContainment();
        await refreshHits();
    }
    init();
})();
</script>
{% endblock %}
